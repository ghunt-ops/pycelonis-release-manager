import typing
from datetime import datetime, timezone

import pytest
from pycelonis_core.base.base_model import PyCelonisBaseEnum, PyCelonisBaseModel, to_camel, to_unix_timestamp_ms
from pycelonis_core.client.client import Client

try:
    from pydantic.v1 import ValidationError  # type: ignore
except ImportError:
    from pydantic import ValidationError  # type: ignore


class TestToCamel:
    @pytest.mark.parametrize(
        "test_input,expected",
        [
            ("test", "test"),
            ("test2", "test2"),
            ("test_test", "testTest"),
            ("test_2_test", "test2Test"),
            ("test_test_test", "testTestTest"),
            ("Test_test", "TestTest"),
            ("_test", "Test"),
            ("test_", "test"),
            ("", ""),
        ],
    )
    def test_to_camel(self, test_input, expected):
        assert to_camel(test_input) == expected


class TestToUnixTimestampMs:
    @pytest.mark.parametrize(
        "test_input,expected",
        [
            (datetime(year=2000, month=10, day=4, hour=4, minute=2, second=6, tzinfo=timezone.utc), 970632126000),
            (datetime(year=2022, month=12, day=31, hour=12, minute=59, second=59, tzinfo=timezone.utc), 1672491599000),
        ],
    )
    def test_to_unix_timestamp_ms(self, test_input, expected):
        assert to_unix_timestamp_ms(test_input) == expected


class TestPyCelonisBaseModel:
    class PyCelonisBaseModelTest(PyCelonisBaseModel):
        date: typing.Optional[datetime]
        snake_case: typing.Optional[str]

    def test_snake_case_converted_to_camel_case(self):
        model = TestPyCelonisBaseModel.PyCelonisBaseModelTest(
            snake_case="TEST",
        )

        assert "snakeCase" in model.dict(by_alias=True)

    def test_population_by_camel_case(self):
        model = TestPyCelonisBaseModel.PyCelonisBaseModelTest(
            snakeCase="TEST",
        )

        assert model.snake_case

    def test_datetime_converted_to_unix(self):
        date = datetime(year=2000, month=10, day=4, hour=4, minute=2, second=6, tzinfo=timezone.utc)
        model = TestPyCelonisBaseModel.PyCelonisBaseModelTest(
            date=date,
        )

        assert model.dict()["date"] == date
        assert model.json_dict()["date"] == 970632126000

    def test_json_dict_uses_kwargs(self):
        model = TestPyCelonisBaseModel.PyCelonisBaseModelTest(
            snake_case="TEST",
        )

        assert model.json_dict(by_alias=True)["snakeCase"] == "TEST"

    def test_arbitrary_types_allow_in_model(self):
        class ArbitraryTypesAllowTest(PyCelonisBaseModel):
            client: Client

    def test_no_important_attributes_by_default(self):
        model = TestPyCelonisBaseModel.PyCelonisBaseModelTest()

        assert model.__main_attributes__() is None

    def test_repr_only_prints_important_attributes(self):
        class ImportantAttributes(PyCelonisBaseModel):
            id: str
            name: str

            def __main_attributes__(self) -> typing.Optional[typing.List[str]]:
                return ["id"]

        model = ImportantAttributes(id="TEST_ID", name="TEST_NAME")
        representation = repr(model)
        string = str(model)

        assert "id" in representation
        assert "name" not in representation

        assert "id" in string
        assert "name" in string


class TestPyCelonisBaseEnum:
    def test_pycelonis_base_enum_returns_value_when_converted_to_str(self):
        class TestEnum(PyCelonisBaseEnum):
            TEST = "TEST_VALUE"

        assert str(TestEnum.TEST) == "TEST_VALUE"

    def test_validator_accepts_string_enum_values_that_are_in_enum(self):
        class TestEnum(PyCelonisBaseEnum):
            TEST = "TEST_VALUE"

        class Model(PyCelonisBaseModel):
            enum: TestEnum

        model = Model(enum="TEST_VALUE")
        assert isinstance(model.enum, str)
        assert not isinstance(model.enum, TestEnum)
        assert model.enum == TestEnum.TEST
        assert model.enum == "TEST_VALUE"

    def test_validator_accepts_string_enum_values_that_are_not_in_enum(self):
        class TestEnum(PyCelonisBaseEnum):
            TEST = "TEST_VALUE"

        class Model(PyCelonisBaseModel):
            enum: TestEnum

        model = Model(enum="TEST_VALUE_NEW")
        assert isinstance(model.enum, str)
        assert not isinstance(model.enum, TestEnum)
        assert model.enum == "TEST_VALUE_NEW"

    def test_validator_accepts_enum_values(self):
        class TestEnum(PyCelonisBaseEnum):
            TEST = "TEST_VALUE"

        class Model(PyCelonisBaseModel):
            enum: TestEnum

        model = Model(enum=TestEnum.TEST)
        assert isinstance(model.enum, str)
        assert not isinstance(model.enum, TestEnum)
        assert model.enum == TestEnum.TEST
        assert model.enum == "TEST_VALUE"

    def test_validator_raises_validation_error_for_wrong_data_type(self):
        class TestEnum(PyCelonisBaseEnum):
            TEST = "TEST_VALUE"

        class Model(PyCelonisBaseModel):
            enum: TestEnum

        with pytest.raises(ValidationError, match=r"value `1` is not a valid `TestEnum` \(type=value_error\)"):
            Model(enum=1)

    def test_validator_with_use_enum_values_false(self):
        class TestEnum(PyCelonisBaseEnum):
            TEST = "TEST_VALUE"

        class Model(PyCelonisBaseModel):
            enum: TestEnum

            class Config:
                use_enum_values = False

        model = Model(enum=TestEnum.TEST)

        assert isinstance(model.enum, TestEnum)
        assert isinstance(model.enum, str)
        assert model.enum == TestEnum.TEST
        assert model.enum == "TEST_VALUE"

import typing
from datetime import datetime

import pandas as pd
import pytest
from pycelonis_core.base.base_model import PyCelonisBaseModel
from pycelonis_core.base.collection import CelonisCollection
from pycelonis_core.utils.errors import PyCelonisNotFoundError, PyCelonisValueError

try:
    from pydantic.v1 import validator  # type: ignore
except ImportError:
    from pydantic import validator  # type: ignore


class TestModel(PyCelonisBaseModel):
    id: typing.Optional[str]
    name: typing.Optional[str]
    create_date: typing.Optional[datetime]


class TestCelonisCollection:
    def test_find_all_data_models_by_name_returns_correct_list(self):
        example_data_model1 = TestModel(name="TEST_DATA_MODEL1")
        example_data_model2 = TestModel(name="TEST_DATA_MODEL2")

        c = CelonisCollection([example_data_model1, example_data_model2])

        assert c.find_all(example_data_model1.name) == [example_data_model1]

    def test_find_all_nonexistent_name_returns_empty_list(self):
        example_data_model1 = TestModel(name="TEST_DATA_MODEL1")
        example_data_model2 = TestModel(name="TEST_DATA_MODEL2")

        c = CelonisCollection([example_data_model1, example_data_model2])

        assert c.find_all("INVALID") == []

    def test_find_all_in_empty_collection_returns_empty_list(self):
        c = CelonisCollection([])

        assert c.find_all("INVALID") == []

    def test_find_all_data_models_by_create_date_returns_correct_list(self):
        date_time = pd.to_datetime("2020-02-02")
        example_data_model1 = TestModel(create_date=date_time)

        c = CelonisCollection([example_data_model1])

        assert c.find_all(date_time, search_attribute="create_date") == [example_data_model1]

    def test_find_all_data_models_by_nonexistent_attribute_returns_correct_list(self):
        example_data_model1 = TestModel(name="TEST_DATA_MODEL1")

        c = CelonisCollection([example_data_model1])

        assert c.find_all("TEST_DATA_MODEL1", search_attribute="NONEXISTENT") == []

    def test_get_returns_correct_data_model(self):
        example_data_model1 = TestModel(name="TEST_DATA_MODEL1")
        example_data_model2 = TestModel(name="TEST_DATA_MODEL2")

        c = CelonisCollection([example_data_model1, example_data_model2])

        assert c.find(example_data_model1.name) == example_data_model1

    def test_get_with_ambiguous_data_model_raises_error(self):
        example_data_model1 = TestModel(name="TEST_DATA_MODEL")
        example_data_model2 = TestModel(name="TEST_DATA_MODEL")

        c = CelonisCollection([example_data_model1, example_data_model2])

        with pytest.raises(PyCelonisValueError):
            c.find(example_data_model1.name)

    def test_get_nonexistent_data_model_raises_error(self):
        example_data_model = TestModel(name="TEST_DATA_MODEL")

        c = CelonisCollection([example_data_model, example_data_model])

        with pytest.raises(PyCelonisNotFoundError):
            c.find("INVALID")

    def test_get_nonexistent_data_model_returns_default(self):
        example_data_model = TestModel(name="TEST_DATA_MODEL")
        default_data_model = TestModel(name="DEFAULT")

        c = CelonisCollection([example_data_model, example_data_model])

        assert c.find("INVALID", default=default_data_model) == default_data_model

    def test_find_by_id_returns_correct_data_model(self):
        example_data_model1 = TestModel(id="1234")
        example_data_model2 = TestModel(id="5678")

        c = CelonisCollection([example_data_model1, example_data_model2])

        assert c.find_by_id(example_data_model1.id) == example_data_model1

    def test_find_by_id_nonexistent_data_model_raises_error(self):
        example_data_model = TestModel(id="1234")

        c = CelonisCollection([example_data_model, example_data_model])

        with pytest.raises(PyCelonisNotFoundError):
            c.find_by_id("INVALID")

    def test_find_by_id_ambiguous_data_model_raises_error(self):
        example_data_model = TestModel(id="1234")

        c = CelonisCollection([example_data_model, example_data_model])

        with pytest.raises(PyCelonisValueError):
            c.find_by_id("1234")

    def test_celonis_collection_from_list(self):
        example_data_model = TestModel(name="TEST_DATA_MODEL")
        default_data_model = TestModel(name="DEFAULT")

        list_ = [example_data_model, default_data_model]
        c = CelonisCollection.from_list(list_)

        assert example_data_model in c
        assert default_data_model in c
        assert list(c) == list_

    def test_collection_repr_empty_collection(self):
        c = CelonisCollection()

        assert repr(c) == "[]"

    def test_collection_repr_nonempty_collection(self):
        c = CelonisCollection([1, 2])

        assert repr(c) == "[\n\t1,\n\t2\n]"

    def test_serialize_collection_with_nested_object_using_alias(self):
        class NestedClass(PyCelonisBaseModel):
            test_property: str

        class TestClass(PyCelonisBaseModel):
            nested_test: CelonisCollection[NestedClass]

            # validators
            _collection_validators = validator("nested_test", allow_reuse=True)(CelonisCollection.from_list)

        test_object = TestClass(nested_test=[NestedClass(test_property="a"), NestedClass(test_property="b")])

        assert test_object.json_dict(by_alias=True) == {"nestedTest": [{"testProperty": "a"}, {"testProperty": "b"}]}

    def test_serialize_collection_with_nested_object_using_no_alias(self):
        class NestedClass(PyCelonisBaseModel):
            test_property: str

        class TestClass(PyCelonisBaseModel):
            nested_test: CelonisCollection[NestedClass]

            # validators
            _collection_validators = validator("nested_test", allow_reuse=True)(CelonisCollection.from_list)

        test_object = TestClass(nested_test=[NestedClass(test_property="a"), NestedClass(test_property="b")])

        assert test_object.json_dict(by_alias=False) == {
            "nested_test": [{"test_property": "a"}, {"test_property": "b"}]
        }

    def test_set_celonis_collection_of_pydantic_model_with_list(self):
        class TestClass(PyCelonisBaseModel):
            nested_test: CelonisCollection[str]

            # validators
            _collection_validators = validator("nested_test", allow_reuse=True)(CelonisCollection.from_list)

        test_object = TestClass(nested_test=["a", "b"])

        assert isinstance(test_object.nested_test, CelonisCollection)

    def test_set_celonis_collection_of_pydantic_model_with_celonis_collection(self):
        class TestClass(PyCelonisBaseModel):
            nested_test: CelonisCollection[str]

            # validators
            _collection_validators = validator("nested_test", allow_reuse=True)(CelonisCollection.from_list)

        test_object = TestClass(nested_test=CelonisCollection(["a", "b"]))

        assert isinstance(test_object.nested_test, CelonisCollection)

    def test_list_operations(self):
        test_list = CelonisCollection(["a", "b", "c"])

        assert len(test_list) == 3
        assert test_list[0] == "a"
        assert test_list[:2] == ["a", "b"]
        assert test_list[-2:] == ["b", "c"]

        test_list.append("d")
        assert len(test_list) == 4
        assert test_list[-1] == "d"

        test_list.remove("d")
        assert len(test_list) == 3
        assert test_list[-1] == "c"

        test_list.extend(["d", "e"])
        assert len(test_list) == 5
        assert test_list[-2:] == ["d", "e"]

        added_list = CelonisCollection(["a"]) + CelonisCollection(["b", "c"])
        assert len(added_list) == 3

        multiplied_list = 3 * CelonisCollection(["a", "b"])
        assert len(multiplied_list) == 6

from unittest.mock import Mock, patch

import pytest
from pycelonis import get_celonis
from pycelonis_core.utils.errors import PyCelonisNotFoundError


@pytest.mark.skipif(
    "not config.getoption('--disable-vcr')",
    reason="Only run when --disable-vcr is given",
)
class TestRetry:
    @patch("time.sleep", return_value=None)
    def test_no_retries_due_to_correct_response(self, patched_time_sleep: Mock):
        celonis = get_celonis(retries=1, delay=1)

        with pytest.raises(PyCelonisNotFoundError):
            celonis.data_integration.get_data_pool("TEST_ID")

        patched_time_sleep.assert_not_called()

    @patch("time.sleep", return_value=None)
    def test_single_retry_due_to_404_status_code(self, patched_time_sleep: Mock):
        celonis = get_celonis(retries=1, delay=1)
        transport = celonis.data_integration.client.client._transport
        transport.status_forcelist.append(404)

        with pytest.raises(PyCelonisNotFoundError):
            celonis.data_integration.get_data_pool("TEST_ID")

        patched_time_sleep.assert_called_once_with(1)

    @patch("time.sleep", return_value=None)
    def test_single_retry_due_to_404_status_code_with_different_delay(self, patched_time_sleep: Mock):
        celonis = get_celonis(retries=1, delay=3)
        transport = celonis.data_integration.client.client._transport
        transport.status_forcelist.append(404)

        with pytest.raises(PyCelonisNotFoundError):
            celonis.data_integration.get_data_pool("TEST_ID")

        patched_time_sleep.assert_called_once_with(3)

    @patch("time.sleep", return_value=None)
    def test_two_retries_due_to_404_status_code(self, patched_time_sleep: Mock):
        celonis = get_celonis(retries=3, delay=1)
        transport = celonis.data_integration.client.client._transport
        transport.status_forcelist.append(404)

        with pytest.raises(PyCelonisNotFoundError):
            celonis.data_integration.get_data_pool("TEST_ID")

        assert patched_time_sleep.call_count == 3

    @patch("time.sleep", return_value=None)
    def test_no_retries_due_to_total_retries_zero(self, patched_time_sleep: Mock):
        celonis = get_celonis(retries=0, delay=1)
        transport = celonis.data_integration.client.client._transport
        transport.status_forcelist.append(404)

        with pytest.raises(PyCelonisNotFoundError):
            celonis.data_integration.get_data_pool("TEST_ID")

        patched_time_sleep.assert_not_called()

    @patch("time.sleep", return_value=None)
    def test_no_retries_due_non_included_method(self, patched_time_sleep: Mock):
        celonis = get_celonis(retries=1, delay=1)
        transport = celonis.data_integration.client.client._transport
        transport.status_forcelist.append(404)
        transport.allowed_methods.remove("GET")

        with pytest.raises(PyCelonisNotFoundError):
            celonis.data_integration.get_data_pool("TEST_ID")

        patched_time_sleep.assert_not_called()

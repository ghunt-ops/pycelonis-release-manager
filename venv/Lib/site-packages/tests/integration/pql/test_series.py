from unittest.mock import Mock

import pytest
from pycelonis.config import Config
from pycelonis.pql.series import Series


@pytest.mark.vcr
class TestSeries:
    def test_series(self, single_table_data_model):
        table = single_table_data_model.get_tables().find("TEST_TABLE", search_attribute="alias")
        columns = table.get_columns()

        series = Series(columns.find("INT_COLUMN"), data_model=single_table_data_model)

        assert series.shape[0] == 3

    def test_series_initialization(self, single_table_data_model, default_data_model):
        table = single_table_data_model.get_tables().find("TEST_TABLE", search_attribute="alias")
        column = table.get_columns().find("INT_COLUMN")

        # No data exporter given
        series = Series(column)
        assert series._saola_connector is None

        # Explicit data exporter used
        saola_connector_mock = Mock()
        series = Series(column, saola_connector=saola_connector_mock)
        assert series.saola_connector == saola_connector_mock

        # Explicit data model data exporter used
        series = Series(column, data_model=single_table_data_model)
        assert series.saola_connector.data_model == single_table_data_model
        assert series.shape[0] == 3

        # Error raised if both data model and data exporter given
        with pytest.raises(ValueError):
            _ = Series(column, data_model=single_table_data_model, saola_connector=saola_connector_mock)

        try:
            Config.DEFAULT_DATA_MODEL = default_data_model

            # Default data model data exporter used
            series = Series(column)
            assert series.saola_connector.data_model == default_data_model
            assert series.shape[0] == 3

            # Explicit data exporter overrides default
            series = Series(column, saola_connector=saola_connector_mock)
            assert series.saola_connector == saola_connector_mock

            # Explicit data model data exporter overrides default
            series = Series(column, data_model=single_table_data_model)
            assert series.saola_connector.data_model == single_table_data_model
        finally:
            Config.reset()

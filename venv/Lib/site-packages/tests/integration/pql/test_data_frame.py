import pytest
from pycelonis.pql.data_frame import DataFrame
from pycelonis.pql.saola_connector import AnalysisSaolaConnector, DataModelSaolaConnector, KnowledgeModelSaolaConnector
from pycelonis_testing.ems.knowledge_model.fixture import get_content_knowledge_model


@pytest.mark.vcr
class TestDataFrame:
    def test_data_frame(self, single_table_data_model):
        table = single_table_data_model.get_tables().find("TEST_TABLE", search_attribute="alias")
        columns = table.get_columns()

        series = DataFrame(
            {
                "INT_COLUMN": columns.find("INT_COLUMN"),
                "STRING_COLUMN": columns.find("STRING_COLUMN"),
            },
            data_model=single_table_data_model,
        )
        assert series.shape == (3, 2)

    @pytest.mark.parametrize("use_api_v2", [False, True])
    def test_data_frame_with_data_model_saola_connector(self, use_api_v2, single_table_data_model):
        table = single_table_data_model.get_tables().find("TEST_TABLE", search_attribute="alias")
        columns = table.get_columns()

        df = DataFrame(
            {"INT_COLUMN": columns.find("INT_COLUMN")},
            saola_connector=DataModelSaolaConnector(single_table_data_model, use_api_v2),
        )

        assert df.saola_connector.data_model == single_table_data_model
        assert df.shape == (3, 1)

    def test_data_frame_with_knowledge_model_saola_connector(self, pycelonis_package, single_table_data_model):
        data_model_variable = pycelonis_package.create_variable(
            key="DM_VAR", value=single_table_data_model.id, type_="DATA_MODEL", runtime=False
        )
        content = {
            "records": [
                {
                    "id": "ACTIVITY_TABLE",
                    "displayName": "Activity Table",
                    "pql": '"TEST_TABLE"."STRING_COLUMN"',
                    "type": "RECORD",
                }
            ],
        }
        knowledge_model = get_content_knowledge_model(pycelonis_package, data_model_variable, content)
        table = single_table_data_model.get_tables().find("TEST_TABLE", search_attribute="alias")
        columns = table.get_columns()

        df = DataFrame(
            {
                "INT_COLUMN": columns.find("INT_COLUMN"),
                "ACTIVITY_TABLE": knowledge_model.get_content().records.find_by_id("ACTIVITY_TABLE").pql,
            },
            saola_connector=KnowledgeModelSaolaConnector(single_table_data_model, knowledge_model),
        )

        assert df.saola_connector.data_model == single_table_data_model
        assert df.saola_connector.knowledge_model == knowledge_model
        assert df.shape == (3, 2)
        assert df.columns == ["INT_COLUMN", "ACTIVITY_TABLE"]

    @pytest.mark.parametrize("use_api_v2", [False, True])
    def test_data_frame_with_analysis_saola_connector(
        self, use_api_v2, pycelonis_celonis, pycelonis_space, pycelonis_package, single_table_data_model
    ):
        analysis = pycelonis_package.create_analysis(
            "TEST_ANALYSIS_QUERY",
            data_model_id=single_table_data_model.id,
        )

        pycelonis_package.publish()
        published_space = pycelonis_celonis.apps.get_space(pycelonis_space.id)
        published_package = published_space.get_package(pycelonis_package.id)
        published_analysis = published_package.get_analysis(analysis.id)

        df = DataFrame(
            {
                "INT_COLUMN": '"TEST_TABLE"."INT_COLUMN"',
            },
            saola_connector=AnalysisSaolaConnector(single_table_data_model, published_analysis, use_api_v2),
        )

        assert df.saola_connector.data_model == single_table_data_model
        assert df.saola_connector.analysis == published_analysis
        assert df.shape == (3, 1)
        assert df.columns == ["INT_COLUMN"]

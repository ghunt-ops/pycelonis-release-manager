import json

import pytest
from pycelonis.pql.saola_connector import AnalysisSaolaConnector, KnowledgeModelSaolaConnector
from pycelonis.service.process_analytics.service import KpiTransport, ProcessAnalyticsService
from pycelonis_core.utils.errors import PyCelonisValueError
from pycelonis_testing.ems.knowledge_model.fixture import get_content_knowledge_model
from saolapy.pandas.filters import Filters


@pytest.mark.vcr
class TestFilters:
    def test_filters_with_knowledge_model_saola_connector(self, pycelonis_package, single_table_data_model):
        data_model_variable = pycelonis_package.create_variable(
            key="DM_VAR", value=single_table_data_model.id, type_="DATA_MODEL", runtime=False
        )
        content = {
            "records": [
                {
                    "id": "ACTIVITY_TABLE",
                    "displayName": "Activity Table",
                    "pql": '"TEST_TABLE"."STRING_COLUMN"',
                    "type": "RECORD",
                }
            ],
            "variables": [
                {
                    "id": "TEST_VARIABLE",
                    "displayName": "test_variable",
                    "value": '"TEST_TABLE"."STRING_COLUMN"',
                }
            ],
            "kpis": [
                {
                    "id": "TEST_KPI",
                    "displayName": "test_kpi",
                    "pql": "CASE WHEN ${TEST_VARIABLE} LIKE 'ACTIVITY1' THEN 1 ELSE 0 END",
                }
            ],
            "filters": [
                {
                    "id": "TEST_FILTER_VAR",
                    "displayName": "TEST_FILTER_VAR",
                    "pql": "FILTER ${TEST_VARIABLE} IS NOT NULL",
                },
                {
                    "id": "TEST_FILTER_KPI",
                    "displayName": "TEST_FILTER_KPI",
                    "pql": "FILTER KPI('TEST_KPI') = 0",
                },
            ],
        }
        knowledge_model = get_content_knowledge_model(pycelonis_package, data_model_variable, content)

        filter_variable = Filters(
            [knowledge_model.get_content().filters.find_by_id("TEST_FILTER_VAR").pql],
            saola_connector=KnowledgeModelSaolaConnector(single_table_data_model, knowledge_model),
        )

        filter_kpi = Filters(
            [knowledge_model.get_content().filters.find_by_id("TEST_FILTER_KPI").pql],
            saola_connector=KnowledgeModelSaolaConnector(single_table_data_model, knowledge_model),
        )

        assert filter_variable.filter_expression == '( "TEST_TABLE"."STRING_COLUMN" IS NOT NULL )'
        with pytest.raises(PyCelonisValueError):
            filter_kpi.filter_expression

    def test_filters_with_analysis_saola_connector(
        self, pycelonis_celonis, pycelonis_space, pycelonis_package, single_table_data_model
    ):
        analysis = pycelonis_package.create_analysis(
            "TEST_ANALYSIS_QUERY",
            data_model_id=single_table_data_model.id,
        )
        content = json.loads(analysis.serialized_content)
        content["draft"]["document"] = {
            "variables": [
                {
                    "name": "TEST_VARIABLE",
                    "type": "text_replacement",
                    "value": '"TEST_TABLE"."INT_COLUMN"',
                }
            ]
        }
        analysis.serialized_content = json.dumps(content)
        analysis.update()

        ProcessAnalyticsService.post_analysis_v2_api_analysis_analysis_id_kpi(
            pycelonis_celonis.client,
            analysis_id=analysis.id,
            request_body=KpiTransport(
                name="TEST_KPI", template="CASE WHEN <%=TEST_VARIABLE%> IS NULL THEN 1 ELSE 0 END"
            ),
        )

        pycelonis_package.publish()
        published_space = pycelonis_celonis.apps.get_space(pycelonis_space.id)
        published_package = published_space.get_package(pycelonis_package.id)
        published_analysis = published_package.get_analysis(analysis.id)

        filter_variable = Filters(
            ["FILTER <%=TEST_VARIABLE%> IS NOT NULL;"],
            saola_connector=AnalysisSaolaConnector(single_table_data_model, published_analysis),
        )

        filter_kpi = Filters(
            ["FILTER KPI('TEST_KPI') > 0;"],
            saola_connector=AnalysisSaolaConnector(single_table_data_model, published_analysis),
        )

        with pytest.raises(PyCelonisValueError):
            filter_variable.filter_expression
        with pytest.raises(PyCelonisValueError):
            filter_kpi.filter_expression

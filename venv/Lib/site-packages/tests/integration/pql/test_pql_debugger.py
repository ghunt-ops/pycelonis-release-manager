import pytest
from pycelonis.pql.pql_debugger import PQLDebugger
from pycelonis.service.pql_language.service import PqlQueryType


@pytest.mark.vcr
class TestPQLDebugger:
    def test_pql_debugger(self, single_table_data_model):
        # Column no errors
        query = '"TEST_TABLE"."INT_COLUMN"'
        error_messages = PQLDebugger.debug(
            single_table_data_model.client, single_table_data_model.id, query, query_type=PqlQueryType.DIMENSION
        )
        assert len(error_messages) == 0

        # Missing column
        query = '"TEST_TABLE"."INT_COLUMN123"'
        error_messages = PQLDebugger.debug(
            single_table_data_model.client, single_table_data_model.id, query, query_type=PqlQueryType.DIMENSION
        )
        assert len(error_messages) > 0
        assert query in error_messages[0]

        # Filter no errors
        query = 'FILTER "TEST_TABLE"."INT_COLUMN" = 1;'
        error_messages = PQLDebugger.debug(
            single_table_data_model.client, single_table_data_model.id, query, query_type=PqlQueryType.FILTER
        )
        assert len(error_messages) == 0

        # Filter missing column
        query = 'FILTER "TEST_TABLE"."INT_COLUMN123" = 1;'
        error_messages = PQLDebugger.debug(
            single_table_data_model.client, single_table_data_model.id, query, query_type=PqlQueryType.FILTER
        )
        assert len(error_messages) > 0
        assert query in error_messages[0]

import json
import random

import pandas as pd
from saolapy.pql.base import PQL, PQLColumn, OrderByColumn, PQLFilter

import pycelonis.pql as pql
import pytest
from pycelonis.ems.apps import PublishedSpace
from pycelonis.pql.saola_connector import AnalysisSaolaConnector, KnowledgeModelSaolaConnector
from pycelonis.service.process_analytics.service import KpiTransport, ProcessAnalyticsService
from pycelonis.service.semantic_layer.service import KpiMetadata, VariableMetadata
from pycelonis_testing.ems.data_model.fixtures import get_persistent_data_model
from tests.integration.ems.studio.content_node.test_knowledge_model import (
    post_api_knowledge_model_layer_asset_id_kpis,
    post_api_knowledge_model_layer_asset_id_variables,
)
from tests.unit.conftest import assert_frame_equals, assert_series_equals


@pytest.fixture(scope="function")
def saola_connector_data_model(pycelonis_celonis, override_pycelonis_ems_fixtures):
    tables = {
        "ACTIVITY_TABLE": pd.DataFrame(
            {
                "ACTIVITY_EN": ["ACTIVITY1", "ACTIVITY2"],
            }
        ),
    }

    return get_persistent_data_model(
        pycelonis_celonis,
        "PYCELONIS_SAOLA_CONNECTOR",
        tables,
        override=override_pycelonis_ems_fixtures,
    )


@pytest.mark.vcr
@pytest.mark.xdist_group(name="studio")
class TestAnalysisSaolaConnector:
    @pytest.mark.parametrize("use_api_v2", [False, True])
    def test_analysis_saola_connector(
        self, use_api_v2, pycelonis_space, pycelonis_celonis, pycelonis_package, saola_connector_data_model
    ):
        # Create analysis
        analysis = pycelonis_package.create_analysis(
            "TEST_ANALYSIS_QUERY",
            data_model_id=saola_connector_data_model.id,
        )
        content = json.loads(analysis.serialized_content)

        # Create Variables
        content["draft"]["document"] = {
            "components": [],
            "variables": [
                {
                    "name": "TEST_VARIABLE",
                    "type": "text_replacement",
                    "value": '"ACTIVITY_TABLE"."ACTIVITY_EN"',
                }
            ],
        }
        analysis.serialized_content = json.dumps(content)
        analysis.update()

        # Create KPI
        ProcessAnalyticsService.post_analysis_v2_api_analysis_analysis_id_kpi(
            pycelonis_celonis.client,
            analysis_id=analysis.id,
            request_body=KpiTransport(name="TEST_KPI", template="COUNT(<%=TEST_VARIABLE%>)"),
        )

        pycelonis_package.publish()
        published_space: PublishedSpace = pycelonis_celonis.apps.get_space(pycelonis_space.id)
        published_package = published_space.get_package(pycelonis_package.id)
        published_analysis = published_package.get_analysis(analysis.id)

        df = pql.DataFrame(
            {"KPI": 'KPI("TEST_KPI")', "VARIABLE": "<%=TEST_VARIABLE%>"},
            saola_connector=AnalysisSaolaConnector(saola_connector_data_model, published_analysis, use_api_v2),
        )

        assert df.to_pandas().shape == (2, 2)


@pytest.mark.vcr
@pytest.mark.xdist_group(name="studio")
class TestKnowledgeModelSaolaConnector:
    @pytest.mark.parametrize("draft", [True, False])
    def test_knowledge_model_saola_connector(
        self, draft, pycelonis_space, pycelonis_celonis, saola_connector_data_model
    ):
        # Create package
        package = pycelonis_space.create_package("KM_PACKAGE")

        # Create Knowledge Model
        data_model_variable = package.create_variable(
            key="DM_VAR", value=saola_connector_data_model.id, type_="DATA_MODEL", runtime=False
        )
        knowledge_model = package.create_knowledge_model(
            {
                "kind": "BASE",
                "metadata": {"key": f"test-km-{pycelonis_space.name}", "displayName": "test-km"},
                "dataModelId": f"${{{{{data_model_variable.key}}}}}",
            }
        )

        # Create Variable
        post_api_knowledge_model_layer_asset_id_variables(
            client=pycelonis_celonis.client,
            layer_asset_id=knowledge_model.id,
            request_body=VariableMetadata(
                id="test_variable", displayName="TEST_VARIABLE", value='"ACTIVITY_TABLE"."ACTIVITY_EN"'
            ),
        )

        # Create KPI
        post_api_knowledge_model_layer_asset_id_kpis(
            client=pycelonis_celonis.client,
            layer_asset_id=knowledge_model.id,
            request_body=KpiMetadata(id="TEST_KPI", displayName="TEST_KPI", pql="COUNT ( ${test_variable} )"),
        )

        if not draft:
            package.publish()

        df = pql.DataFrame(
            {"KPI": 'KPI("TEST_KPI")'},
            saola_connector=KnowledgeModelSaolaConnector(saola_connector_data_model, knowledge_model, draft=draft),
        )

        assert df.to_pandas().shape == (1, 1)

    def test_knowledge_model_saola_connector_data_export(
        self, pycelonis_celonis, pycelonis_space, pycelonis_package, override_pycelonis_ems_fixtures
    ):
        df = pd.DataFrame({"TEST": [1, 2, 3, 4, 4], "TEST_FLOAT": [4.3, 5.5, 3.3, 2.2, 6.7]})
        data_model = get_persistent_data_model(
            pycelonis_celonis,
            "PYCELONIS_SAOLA_CONNECTOR",
            {
                "TEST": df,
            },
            override=override_pycelonis_ems_fixtures,
        )

        # Create Knowledge Model
        data_model_variable = pycelonis_package.create_variable(
            key="DM_VAR", value=data_model.id, type_="DATA_MODEL", runtime=False
        )
        knowledge_model = pycelonis_package.create_knowledge_model(
            {
                "kind": "BASE",
                "metadata": {"key": f"test-km-{pycelonis_space.name}", "displayName": "test-km"},
                "dataModelId": f"${{{{{data_model_variable.key}}}}}",
            }
        )

        # Test export data frame with single column
        query = PQL()
        query += PQLColumn(name="TEST", query='"TEST"."TEST"')

        result = pql.DataFrame.from_pql(
            query, saola_connector=KnowledgeModelSaolaConnector(data_model, knowledge_model)
        ).to_pandas()
        assert_frame_equals(df[["TEST"]], result)

        # Test export data frame with multiple columns
        query = PQL() + [
            PQLColumn(name="TEST", query='"TEST"."TEST"'),
            PQLColumn(name="TEST2", query='"TEST"."TEST"'),
        ]

        result = pql.DataFrame.from_pql(
            query, saola_connector=KnowledgeModelSaolaConnector(data_model, knowledge_model)
        ).to_pandas()
        assert result.shape == (5, 2)
        assert_frame_equals(df[["TEST"]], result[["TEST"]])
        assert_series_equals(df["TEST"], result["TEST2"], check_names=False)

        # Test export data frame with distinct=True
        result = pql.DataFrame.from_pql(
            query, saola_connector=KnowledgeModelSaolaConnector(data_model, knowledge_model)
        ).to_pandas(distinct=True)

        assert result.shape == (4, 2)
        assert_frame_equals(result.drop_duplicates(), result)

        # Test export data frame with limit=2
        query += OrderByColumn(query='"TEST"."TEST"', ascending=True)
        query += OrderByColumn(query='"TEST"."TEST_FLOAT"', ascending=True)

        result = pql.DataFrame.from_pql(
            query, saola_connector=KnowledgeModelSaolaConnector(data_model, knowledge_model)
        ).to_pandas(limit=2)

        assert result.shape == (2, 2)

        assert_frame_equals(df.iloc[:2][["TEST"]], result[["TEST"]])

        # Test export data frame with limit=2 and offset=2
        query.offset = 2
        query += OrderByColumn(query='"TEST"."TEST_FLOAT"', ascending=True)

        result = pql.DataFrame.from_pql(
            query, saola_connector=KnowledgeModelSaolaConnector(data_model, knowledge_model)
        ).to_pandas(limit=2, offset=2)

        assert result.shape == (2, 2)
        assert_frame_equals(df.iloc[2:4][["TEST"]].reset_index(drop=True), result[["TEST"]])

        # Test export data frame with filter
        query = PQL()
        query += PQLColumn(name="TEST", query='"TEST"."TEST"')
        query += PQLFilter(query='FILTER "TEST"."TEST" != 4')
        query += OrderByColumn(query='"TEST"."TEST"', ascending=True)
        query += OrderByColumn(query='"TEST"."TEST_FLOAT"', ascending=True)

        result = pql.DataFrame.from_pql(
            query, saola_connector=KnowledgeModelSaolaConnector(data_model, knowledge_model)
        ).to_pandas()

        assert result.shape == (3, 1)
        assert_frame_equals(df.iloc[:3][["TEST"]], result)

        # Test export data frame with multiple filters
        query += PQLFilter(query='FILTER "TEST"."TEST" != 3')
        query += OrderByColumn(query='"TEST"."TEST_FLOAT"', ascending=True)
        result = pql.DataFrame.from_pql(
            query, saola_connector=KnowledgeModelSaolaConnector(data_model, knowledge_model)
        ).to_pandas()

        assert result.shape == (2, 1)
        assert_frame_equals(df.iloc[:2][["TEST"]], result)

        # Test export data frame with order by column
        result = pql.DataFrame(
            data={"TEST": PQLColumn(name="TEST", query='"TEST"."TEST"')},
            order_by_columns=[OrderByColumn(query='"TEST"."TEST"', ascending=False)],
            saola_connector=KnowledgeModelSaolaConnector(data_model, knowledge_model),
        ).to_pandas()

        assert result.shape == (5, 1)
        pd.testing.assert_frame_equal(
            df[["TEST"]].sort_values(by="TEST", ascending=False).reset_index(drop=True), result.reset_index(drop=True)
        )

        # Test export data frame with multiple order by column
        result = pql.DataFrame(
            data={"TEST": PQLColumn(name="TEST", query='"TEST"."TEST"')},
            order_by_columns=[
                OrderByColumn(query='"TEST"."TEST_FLOAT"', ascending=False),
                OrderByColumn(query='"TEST"."TEST"', ascending=False),
            ],
            saola_connector=KnowledgeModelSaolaConnector(data_model, knowledge_model),
        ).to_pandas()

        assert result.shape == (5, 1)
        pd.testing.assert_frame_equal(
            df.sort_values(by=["TEST_FLOAT", "TEST"], ascending=False)[["TEST"]].reset_index(drop=True),
            result.reset_index(drop=True),
        )

    def test_knowledge_model_saola_connector_data_export_different_data_types(
        self, pycelonis_celonis, pycelonis_space, pycelonis_package, override_pycelonis_ems_fixtures
    ):
        TABLE_NAME = "DTYPES_TEST"
        df = pd.DataFrame(
            {
                "INT": [1, 2],
                "FLOAT": [3.3, 5.5],
                "STRING": ["abc", "def"],
                "DATETIME": [
                    pd.to_datetime("2020-10-10 10:10:10.123456789"),
                    pd.to_datetime("2021-11-11 04:05:59.923456789"),
                ],
                "BOOL": [True, False],
                "CATEGORY": pd.Series(["a", "b"], dtype="category"),
            }
        )
        # Create Data Model
        data_model = get_persistent_data_model(
            pycelonis_celonis,
            "PYCELONIS_SAOLA_CONNECTOR",
            {
                TABLE_NAME: df,
            },
            override=override_pycelonis_ems_fixtures,
        )

        # Create Knowledge Model
        data_model_variable = pycelonis_package.create_variable(
            key="DM_VAR", value=data_model.id, type_="DATA_MODEL", runtime=False
        )
        knowledge_model = pycelonis_package.create_knowledge_model(
            {
                "kind": "BASE",
                "metadata": {"key": f"test-km-{pycelonis_space.name}", "displayName": "test-km"},
                "dataModelId": f"${{{{{data_model_variable.key}}}}}",
            }
        )

        query = PQL() + [PQLColumn(name=column, query=f'"{TABLE_NAME}"."{column}"') for column in df.columns]
        exported_df = pql.DataFrame.from_pql(
            query, saola_connector=KnowledgeModelSaolaConnector(data_model, knowledge_model)
        )

        assert exported_df.to_pandas().shape == (2, 6)

    @pytest.mark.skipif("not config.getoption('--disable-vcr')", reason="Only run when --disable-vcr is given")
    def test_data_export_large(
        self, pycelonis_celonis, pycelonis_package, pycelonis_space, override_pycelonis_ems_fixtures
    ):
        n_rows = 9000000
        TABLE_NAME = "KM_LARGE_DATA_EXPORT"
        df = pd.DataFrame({"TEST_FLOAT": [random.random() for _ in range(n_rows)]})
        data_model = get_persistent_data_model(
            pycelonis_celonis,
            "PYCELONIS_SAOLA_CONNECTOR",
            {
                TABLE_NAME: df,
            },
            override=override_pycelonis_ems_fixtures,
        )

        # Create Knowledge Model
        data_model_variable = pycelonis_package.create_variable(
            key="DM_VAR", value=data_model.id, type_="DATA_MODEL", runtime=False
        )
        knowledge_model = pycelonis_package.create_knowledge_model(
            {
                "kind": "BASE",
                "metadata": {"key": f"test-km-{pycelonis_space.name}", "displayName": "test-km"},
                "dataModelId": f"${{{{{data_model_variable.key}}}}}",
            }
        )

        query = PQL() + [PQLColumn(name=column, query=f'"{TABLE_NAME}"."{column}"') for column in df.columns]
        exported_df = pql.DataFrame.from_pql(
            query, saola_connector=KnowledgeModelSaolaConnector(data_model, knowledge_model)
        )
        assert_frame_equals(df, exported_df.to_pandas())

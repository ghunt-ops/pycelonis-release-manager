import pandas as pd
import pytest
from pycelonis.ems.data_integration.data_model import DataModel
from pycelonis.errors import PyCelonisNodeAlreadyExistsError
from pycelonis.pql.pql import PQL, PQLColumn, PQLFilter
from pycelonis.service.semantic_layer.service import (
    FilterMetadata,
    KpiMetadata,
    LayerKind,
    PqlBaseMetadata,
    VariableMetadata,
)
from pycelonis_core.client.client import Client
from pycelonis_testing.ems.data_model.fixtures import get_persistent_data_model


def post_api_knowledge_model_layer_asset_id_variables(
    client: Client, layer_asset_id: str, request_body: VariableMetadata
) -> VariableMetadata:
    """This endpoint creates a knowledge model variable"""
    return client.request(
        method="POST",
        url=f"/semantic-layer/api/knowledge-model/{layer_asset_id}/variables",
        request_body=request_body,
        parse_json=True,
        type_=VariableMetadata,
    )


def post_api_knowledge_model_layer_asset_id_kpis(
    client: Client, layer_asset_id: str, request_body: KpiMetadata
) -> KpiMetadata:
    """This endpoint creates a knowledge model KPI"""
    return client.request(
        method="POST",
        url=f"/semantic-layer/api/knowledge-model/{layer_asset_id}/kpis",
        request_body=request_body,
        parse_json=True,
        type_=KpiMetadata,
    )


def post_api_knowledge_model_layer_asset_id_filters(
    client: Client, layer_asset_id: str, request_body: FilterMetadata
) -> FilterMetadata:
    """This endpoint create a knowledge model filter"""
    return client.request(
        method="POST",
        url=f"/semantic-layer/api/knowledge-model/{layer_asset_id}/filters",
        request_body=request_body,
        parse_json=True,
        type_=FilterMetadata,
    )


def post_api_knowledge_model_layer_asset_id_records_record_id_identifier(
    client: Client, layer_asset_id: str, record_id: str, request_body: PqlBaseMetadata
) -> PqlBaseMetadata:
    """This endpoint create a knowledge model record identifier"""
    return client.request(
        method="POST",
        url=f"/semantic-layer/api/knowledge-model/{layer_asset_id}/records/{record_id}/identifier/upsert",
        request_body=request_body,
        parse_json=True,
        type_=PqlBaseMetadata,
    )


@pytest.fixture(scope="function")
def persistent_data_model(pycelonis_celonis):
    tables = {
        "ACTIVITY_TABLE": pd.DataFrame(
            {
                "ACTIVITY_EN": ["ACTIVITY1", "ACTIVITY2"],
            }
        ),
    }

    return get_persistent_data_model(
        pycelonis_celonis,
        "PYCELONIS_KM_QUERY_RESOLUTION",
        tables,
        override=True,
    )


@pytest.mark.vcr
@pytest.mark.xdist_group(name="studio")
class TestKnowledgeModel:
    def test_knowledge_model(
        self, pycelonis_celonis, pycelonis_space, pycelonis_package, pycelonis_data_model, pycelonis_data_pool
    ):
        pycelonis_data_pool.create_table(pd.DataFrame({"TEST_COLUMN": [1, 2, 3]}), "TEST_TABLE")
        pycelonis_data_model.add_table("TEST_TABLE")
        pycelonis_data_model.reload()

        # Test create knowledge_model
        data_model_variable = pycelonis_package.create_variable(
            key="DM_VAR", value=pycelonis_data_model.id, type_="DATA_MODEL", runtime=False
        )
        knowledge_model = pycelonis_package.create_knowledge_model(
            {
                "kind": "BASE",
                "metadata": {"key": f"test-km-{pycelonis_space.name}", "displayName": "test-km-display-name"},
                "dataModelId": f"${{{{{data_model_variable.key}}}}}",
            }
        )

        # Test knowledge_model exists within package
        assert pycelonis_package.get_content_node(knowledge_model.id).id == knowledge_model.id
        assert pycelonis_package.get_knowledge_model(knowledge_model.id).id == knowledge_model.id

        content = knowledge_model.get_content(with_autogenerated_data_model_data=False)

        assert content.kind == LayerKind.BASE
        assert len(content.kpis) == 0
        assert len(content.records) == 0
        assert len(content.variables) == 0
        assert len(content.filters) == 0
        assert len(content.activities) == 0
        assert len(content.actions) == 0
        assert len(content.anomalies) == 0
        assert len(content.event_logs) == 0
        assert len(content.custom_objects) == 0

        content = knowledge_model.get_content(with_autogenerated_data_model_data=True)

        assert content.kind == LayerKind.BASE
        assert len(content.kpis) == 3
        assert len(content.records) == 1
        assert len(content.variables) == 0
        assert len(content.filters) == 0
        assert len(content.activities) == 0
        assert len(content.actions) == 0
        assert len(content.anomalies) == 0
        assert len(content.event_logs) == 0
        assert len(content.custom_objects) == 0

        # Test content representation
        representation = repr(content)
        for attribute in content.__main_attributes__():
            assert attribute in representation

        # Test copy knowledge model
        new_package = pycelonis_space.create_package("NEW_PACKAGE")
        copied_km_transport = knowledge_model.copy_to(new_package, pycelonis_celonis.team.get_team().domain)
        assert copied_km_transport.name == knowledge_model.name

        # Test copy knowledge model, key already exists in destination
        with pytest.raises(PyCelonisNodeAlreadyExistsError):
            knowledge_model.copy_to(new_package, pycelonis_celonis.team.get_team().domain)
        new_package.delete()

        # Test update function
        knowledge_model.serialized_content = knowledge_model.serialized_content.replace(
            "test-km-display-name", "test-km-display-name-updated"
        )
        knowledge_model.update()
        assert "test-km-display-name-updated" in knowledge_model.serialized_content

    def test_resolve_query(
        self, pycelonis_celonis, pycelonis_space, pycelonis_package, persistent_data_model: DataModel
    ):
        data_model_variable = pycelonis_package.create_variable(
            key="DM_VAR", value=persistent_data_model.id, type_="DATA_MODEL", runtime=False
        )
        knowledge_model = pycelonis_package.create_knowledge_model(
            {
                "kind": "BASE",
                "metadata": {"key": f"test-km-{pycelonis_space.name}", "displayName": "test-km"},
                "dataModelId": f"${{{{{data_model_variable.key}}}}}",
            }
        )

        post_api_knowledge_model_layer_asset_id_variables(
            client=pycelonis_celonis.client,
            layer_asset_id=knowledge_model.id,
            request_body=VariableMetadata(
                id="test_variable", displayName="TEST_VARIABLE", value='"ACTIVITY_TABLE"."ACTIVITY_EN"'
            ),
        )

        post_api_knowledge_model_layer_asset_id_kpis(
            client=pycelonis_celonis.client,
            layer_asset_id=knowledge_model.id,
            request_body=KpiMetadata(id="test_kpi", displayName="TEST_KPI", pql="COUNT ( ${test_variable} )"),
        )

        query = PQL() + PQLColumn(name="KPI", query='KPI("test_kpi")')

        data_query, query_environment = knowledge_model.resolve_query(query)
        df = persistent_data_model.export_data_frame(data_query, query_environment)
        assert df.shape == (1, 1)

    def test_component_get_queries(
        self, pycelonis_celonis, pycelonis_space, pycelonis_package, persistent_data_model: DataModel
    ):
        data_model_variable = pycelonis_package.create_variable(
            key="DM_VAR", value=persistent_data_model.id, type_="DATA_MODEL", runtime=False
        )
        knowledge_model = pycelonis_package.create_knowledge_model(
            {
                "kind": "BASE",
                "metadata": {"key": f"test-km-{pycelonis_space.name}", "displayName": "test-km"},
                "dataModelId": f"${{{{{data_model_variable.key}}}}}",
            }
        )

        post_api_knowledge_model_layer_asset_id_filters(
            client=pycelonis_celonis.client,
            layer_asset_id=knowledge_model.id,
            request_body=FilterMetadata(
                id="test_filter", display_name="TEST_FILTER", pql='FILTER "ACTIVITY_TABLE"."ACTIVITY_EN" IS NOT NULL'
            ),
        )

        test_record = knowledge_model.get_content().records.find_by_id("ACTIVITY_TABLE")

        post_api_knowledge_model_layer_asset_id_records_record_id_identifier(
            client=pycelonis_celonis.client,
            layer_asset_id=knowledge_model.id,
            record_id=test_record.id,
            request_body=PqlBaseMetadata(
                id="test_identifier", display_name="TEST_IDENTIFIER", pql='"ACTIVITY_TABLE"."ACTIVITY_EN"'
            ),
        )

        test_identifier_query = (
            knowledge_model.get_content().records.find_by_id("ACTIVITY_TABLE").identifier.get_column()
        )
        test_attribute_query = (
            knowledge_model.get_content()
            .records.find_by_id("ACTIVITY_TABLE")
            .attributes.find_by_id("ACTIVITY_EN")
            .get_column()
        )
        test_filter_query = knowledge_model.get_content().filters.find_by_id("test_filter").get_filter()

        query = PQL() + test_identifier_query + test_attribute_query + test_filter_query
        data_query, query_environment = knowledge_model.resolve_query(query)
        df = persistent_data_model.export_data_frame(data_query, query_environment)

        assert isinstance(test_identifier_query, PQLColumn)
        assert isinstance(test_attribute_query, PQLColumn)
        assert isinstance(test_filter_query, PQLFilter)
        assert df.shape == (2, 2)

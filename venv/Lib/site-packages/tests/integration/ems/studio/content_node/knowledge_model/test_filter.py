import pytest
from pycelonis.ems.studio.content_node.knowledge_model import KnowledgeModel
from pycelonis_core.utils.errors import PyCelonisNotFoundError


@pytest.mark.vcr()
class TestFilter:
    def test_filter(self, pycelonis_knowledge_model: KnowledgeModel):
        # Test create filter
        filter_ = pycelonis_knowledge_model.create_filter("TEST_FILTER", "TEST_FILTER", "FILTER 1=1;")

        # Test filter exists within knowledge pool
        assert pycelonis_knowledge_model.get_filter(filter_.id) == filter_
        assert filter_.id in [k.id for k in pycelonis_knowledge_model.get_filters()]

        # Test sync filter
        original_name = filter_.display_name
        filter_.display_name = filter_.display_name + "_UPDATED"
        filter_.sync()
        assert filter_.display_name == original_name

        # Test update filter
        new_name = filter_.display_name + "_UPDATED"
        filter_.display_name = new_name
        filter_.update()
        assert filter_.display_name == new_name

        # Test delete filter
        filter_.delete()
        assert filter_.id not in [k.id for k in pycelonis_knowledge_model.get_filters()]
        with pytest.raises(PyCelonisNotFoundError):
            pycelonis_knowledge_model.get_filter(filter_.id)

        # Test filter representation
        representation = repr(filter_)
        for attribute in filter_.__main_attributes__():
            assert attribute in representation

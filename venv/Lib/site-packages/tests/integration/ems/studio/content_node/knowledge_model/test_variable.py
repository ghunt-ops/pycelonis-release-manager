import pytest
from pycelonis.ems.studio.content_node.knowledge_model import KnowledgeModel
from pycelonis_core.utils.errors import PyCelonisNotFoundError


@pytest.mark.vcr()
class TestVariable:
    def test_variable(self, pycelonis_knowledge_model: KnowledgeModel):
        # Test create variable
        variable = pycelonis_knowledge_model.create_variable("TEST_VARIABLE", "TEST_VARIABLE", "1")

        # Test variable exists within knowledge pool
        assert pycelonis_knowledge_model.get_variable(variable.id) == variable
        assert variable.id in [k.id for k in pycelonis_knowledge_model.get_variables()]

        # Test sync variable
        original_name = variable.display_name
        variable.display_name = variable.display_name + "_UPDATED"
        variable.sync()
        assert variable.display_name == original_name

        # Test update variable
        new_name = variable.display_name + "_UPDATED"
        variable.display_name = new_name
        variable.update()
        assert variable.display_name == new_name

        # Test delete variable
        variable.delete()
        assert variable.id not in [k.id for k in pycelonis_knowledge_model.get_variables()]
        with pytest.raises(PyCelonisNotFoundError):
            pycelonis_knowledge_model.get_variable(variable.id)

        # Test variable representation
        representation = repr(variable)
        for attribute in variable.__main_attributes__():
            assert attribute in representation

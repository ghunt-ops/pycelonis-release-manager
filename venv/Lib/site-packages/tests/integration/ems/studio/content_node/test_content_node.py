import json

import pytest
from pycelonis.errors import PyCelonisNodeAlreadyExistsError, PyCelonisNotSupportedError
from pycelonis_core.utils.errors import PyCelonisNotFoundError


@pytest.mark.vcr()
@pytest.mark.xdist_group(name="studio")
class TestContentNode:
    def test_folder(self, pycelonis_space, pycelonis_package):
        # Test create folder
        folder = pycelonis_package.create_folder("TEST_FOLDER")

        # Test folder exists within package
        excluded_attributes = {"permissions", "grouped_resource_type_to_actions", "actions"}
        assert pycelonis_package.get_content_node(folder.id).dict(exclude=excluded_attributes) == folder.dict(
            exclude=excluded_attributes
        )
        assert pycelonis_package.get_folder(folder.id).dict(exclude=excluded_attributes) == folder.dict(
            exclude=excluded_attributes
        )
        assert folder.id in [f.id for f in pycelonis_package.get_folders()]

        # Test get folder from different package fails
        package2 = pycelonis_space.create_package("TEST_PACKAGE_2")
        folder2 = package2.create_folder("TEST_FOLDER_2")
        with pytest.raises(PyCelonisNotFoundError):
            pycelonis_package.get_content_node(folder2.id)
        assert package2.get_content_node(folder2.id).dict(exclude=excluded_attributes) == folder2.dict(
            exclude=excluded_attributes
        )

        # Test sync folder
        original_name = folder.name
        folder.name = folder.name + "_UPDATED"
        folder.sync()
        assert folder.name == original_name

        # Test update folder
        new_name = folder.name + "_UPDATED"
        folder.name = new_name
        folder.update()
        assert folder.name == new_name

        # Test copy folder not implemented
        with pytest.raises(PyCelonisNotSupportedError):
            folder.copy_to(pycelonis_package, "TEAM_DOMAIN")

        # Test delete folder
        folder.delete()
        assert folder.id not in [f.id for f in pycelonis_package.get_folders()]
        with pytest.raises(PyCelonisNotFoundError):
            pycelonis_package.get_content_node(folder.id)

        # Test folder representation
        representation = repr(folder)
        for attribute in folder.__main_attributes__():
            assert attribute in representation

    def test_analysis(self, pycelonis_celonis, pycelonis_space, pycelonis_package):
        # Test create analysis
        analysis = pycelonis_package.create_analysis("TEST_ANALYSIS")

        # Test analysis exists within package
        assert pycelonis_package.get_content_node(analysis.id).id == analysis.id
        assert pycelonis_package.get_analysis(analysis.id).id == analysis.id
        assert analysis.id in [f.id for f in pycelonis_package.get_analyses()]

        # Test sync analysis
        updated_title = "NEW_TITLE_123"
        content = json.loads(analysis.serialized_content)
        content["draft"]["title"] = updated_title
        analysis.serialized_content = json.dumps(content, sort_keys=False)
        analysis.sync()
        assert updated_title not in analysis.serialized_content

        # Test update analysis
        analysis.serialized_content = json.dumps(content, sort_keys=False)
        analysis.update()
        assert updated_title in analysis.serialized_content

        # Test copy analysis
        new_package = pycelonis_space.create_package("NEW_PACKAGE")
        copied_analysis_transport = analysis.copy_to(new_package, pycelonis_celonis.team.get_team().domain)
        assert copied_analysis_transport.name == analysis.name

        # Test copy analysis, key already exists in destination
        with pytest.raises(PyCelonisNodeAlreadyExistsError):
            analysis.copy_to(new_package, pycelonis_celonis.team.get_team().domain)
        new_package.delete()

        # Test delete analysis
        analysis.delete()
        assert analysis.id not in [f.id for f in pycelonis_package.get_analyses()]
        with pytest.raises(PyCelonisNotFoundError):
            pycelonis_package.get_content_node(analysis.id)

        # Test analysis representation
        representation = repr(analysis)
        for attribute in analysis.__main_attributes__():
            assert attribute in representation

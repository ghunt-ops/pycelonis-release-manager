import pandas as pd
import pytest
from pycelonis import Celonis
from pycelonis.ems import DataPool
from pycelonis.ems.data_integration.data_model import DataModel
from pycelonis.ems.studio import Space
from pycelonis.ems.studio.content_node.knowledge_model import KnowledgeModel
from pycelonis.ems.studio.content_node.package import Package
from pycelonis.errors import PyCelonisNodeAlreadyExistsError
from pycelonis_core.utils.errors import PyCelonisHTTPStatusError, PyCelonisNotFoundError, PyCelonisPermissionError


@pytest.mark.vcr()
class TestView:
    def test_view(
        self,
        pycelonis_celonis: Celonis,
        pycelonis_space: Space,
        pycelonis_package: Package,
        pycelonis_knowledge_model: KnowledgeModel,
        pycelonis_data_model: DataModel,
        pycelonis_data_pool: DataPool,
    ):
        table_name = "TEST_TABLE"
        df = pd.DataFrame([["test-row-1", "test-column-2"]], columns=["col-1", "col-2"])
        pycelonis_data_pool.create_table(df=df, table_name=table_name)
        pycelonis_data_model.add_table(name=table_name)
        pycelonis_data_model.reload()

        view = pycelonis_package.create_view(
            name="TEST_VIEW",
            knowledge_model_key=pycelonis_knowledge_model.key,
            key="TEST_VIEW_KEY",
        )
        # Test view exists within package
        assert pycelonis_package.get_view(view.id).id == view.id
        assert view.id in [v.id for v in pycelonis_package.get_views()]
        assert pycelonis_knowledge_model.key in view.serialized_content

        # Test whether we can create a view without knowledge model
        view_wo_knowledge_model = pycelonis_package.create_view(
            name="TEST_VIEW_WITHOUT_KNOWLEDGE_MODEL",
            key="TEST_VIEW_WITHOUT_KNOWLEDGE_MODEL_KEY",
        )
        # Test view exists within package
        assert pycelonis_package.get_view(view_wo_knowledge_model.id).id == view_wo_knowledge_model.id
        assert view_wo_knowledge_model.id in [v.id for v in pycelonis_package.get_views()]

        view_extended = pycelonis_package.create_view(
            name="TEST_VIEW_EXTENDED", key="TEST_VIEW_EXTENDED_KEY", base_key="TEST_VIEW_WITHOUT_KNOWLEDGE_MODEL_KEY"
        )
        # Test view exists within package
        assert pycelonis_package.get_view(view_extended.id).id == view_extended.id
        assert view_extended.id in [v.id for v in pycelonis_package.get_views()]

        # Test create view with same key fails
        with pytest.raises(PyCelonisHTTPStatusError):
            pycelonis_package.create_view(
                name="TEST_VIEW",
                knowledge_model_key=pycelonis_knowledge_model.key,
                key="TEST_VIEW_KEY",
            )

        # Test get view with wrong key raises error
        with pytest.raises((PyCelonisNotFoundError, PyCelonisPermissionError)):
            pycelonis_package.get_view("NONEXISTENT_KEY")

        # Test sync view
        original_name = view.name
        view.name = view.name + "_UPDATED"
        view.sync()
        assert view.name == original_name

        # Test update view
        new_name = view.name + "_UPDATED"
        view.serialized_content = view.serialized_content.replace(f'"{view.name}"', new_name)
        view.update()
        assert view.name == new_name

        # Test copy view
        new_package = pycelonis_space.create_package("NEW_PACKAGE")
        copied_view_transport = view.copy_to(new_package, pycelonis_celonis.team.get_team().domain)
        assert copied_view_transport.name == view.name

        # Test copy view, key already exists in destination
        with pytest.raises(PyCelonisNodeAlreadyExistsError):
            view.copy_to(new_package, pycelonis_celonis.team.get_team().domain)
        new_package.delete()

        # Test delete view
        view.delete()
        assert view.id not in [v.id for v in pycelonis_package.get_views()]
        with pytest.raises(PyCelonisNotFoundError):
            assert pycelonis_package.get_view(view.id) == view

        # Test sync after delete raises error
        with pytest.raises(PyCelonisNotFoundError):
            view.sync()

        # Test view representations
        representation = repr(view)
        for attribute in view.__main_attributes__():
            assert attribute in representation

import pytest
from pycelonis.errors import PyCelonisNotSupportedError
from pycelonis_core.utils.errors import PyCelonisHTTPStatusError, PyCelonisNotFoundError, PyCelonisPermissionError


@pytest.mark.vcr()
@pytest.mark.xdist_group(name="studio")
class TestPackage:
    def test_package(self, pycelonis_space, pycelonis_celonis):
        # Test create package
        package = pycelonis_space.create_package("TEST_PACKAGE")

        # Test package exists within data pool
        excluded_attributes = {
            "asset_metadata_transport",
            "base",
            "permissions",
            "tenant_id",
            "serialized_content",
            "grouped_resource_type_to_actions",
            "actions",
        }
        assert pycelonis_space.get_package(package.id).dict(exclude=excluded_attributes) == package.dict(
            exclude=excluded_attributes
        )
        assert package.id in [p.id for p in pycelonis_space.get_packages()]

        # Test create package with same name fails
        with pytest.raises(PyCelonisHTTPStatusError):
            pycelonis_space.create_package(package.name)

        # Test get package with wrong id raises error
        with pytest.raises(
            (PyCelonisNotFoundError, PyCelonisPermissionError)
        ):  # If package does not exist status code 403 is returned
            pycelonis_space.get_package("NONEXISTENT_ID")

        # Test sync package
        original_name = package.name
        package.name = package.name + "_UPDATED"
        package.sync()
        assert package.name == original_name

        # Test update package not implemented
        with pytest.raises(PyCelonisNotSupportedError):
            package.update()

        # Test copy package with unpublished draft
        package2 = pycelonis_space.create_package(f"TEST_PACKAGE_{pycelonis_space.id}")
        with pytest.raises(PyCelonisHTTPStatusError):
            package.copy_to(package2, pycelonis_celonis.team.get_team().domain)

        # Test copy package
        package2.publish()
        copied_package_transport = package.copy_to(package2, pycelonis_celonis.team.get_team().domain)
        assert package.name == copied_package_transport.name
        package2.sync()
        package2.delete()

        # Test copy package, key already exists in destination
        # TODO: This would require connecting to another EMS Team since packages must have unique keys.

        # Test delete package
        package.delete(soft_delete=False)
        assert package.id not in [p.id for p in pycelonis_space.get_packages()]
        with pytest.raises(
            (PyCelonisNotFoundError, PyCelonisPermissionError)
        ):  # If package does not exist status code 403 is returned
            pycelonis_space.get_package(package.id)

        # Test package representation
        representation = repr(package)
        for attribute in package.__main_attributes__():
            assert attribute in representation

    def test_package_history(self, pycelonis_package):
        # Create folder that will be published
        folder = pycelonis_package.create_folder("TEST_FOLDER")

        # Test publish package with version
        VERSION = "0.0.1"
        pycelonis_package.publish(version=VERSION)
        package_history = pycelonis_package.get_history()
        assert len(package_history) == 1
        assert package_history[0].version == VERSION  # Published Version

        # Test sync folder
        original_name = folder.name
        folder.name = folder.name + "_UPDATED"
        folder.sync()
        assert folder.name == original_name

        # Test update folder
        new_name = folder.name + "_UPDATED"
        folder.name = new_name
        folder.update()
        assert folder.name == new_name

        # Test publish package without version
        pycelonis_package.publish()
        package_history = pycelonis_package.get_history()
        assert len(package_history) == 2
        assert package_history[0].version == "0.0.2"  # Second published version
        assert package_history[1].version == VERSION  # First published version

        # Load older version with old folder name
        pycelonis_package.load_version(package_history[1].version, package_history[1].draft_id)
        folder.sync()
        assert folder.name == original_name

        # Load nonexistent version
        with pytest.raises(PyCelonisHTTPStatusError):
            pycelonis_package.load_version("NONEXISTENT_ID", "NONEXISTENT_DRAFT_ID")

        # Load new version with new folder name
        pycelonis_package.load_version(package_history[0].version, package_history[0].draft_id)
        folder.sync()
        assert folder.name == new_name

        # Update folder name and discard update by loading old version
        discarded_name = folder.name + "_DISCARDED"
        folder.name = discarded_name
        folder.update()
        assert folder.name == discarded_name

        pycelonis_package.load_version(package_history[0].version, package_history[0].draft_id)
        folder.sync()
        assert folder.name == new_name
        assert len(pycelonis_package.get_history()) == 2

import pytest
from pycelonis.ems.studio.content_node.knowledge_model import KnowledgeModel
from pycelonis_core.utils.errors import PyCelonisNotFoundError


@pytest.mark.vcr()
class TestKpi:
    def test_kpi(self, pycelonis_knowledge_model: KnowledgeModel):
        # Test create kpi
        kpi = pycelonis_knowledge_model.create_kpi("TEST_KPI", "TEST_KPI", "1")

        # Test kpi exists within knowledge pool
        assert pycelonis_knowledge_model.get_kpi(kpi.id) == kpi
        assert kpi.id in [k.id for k in pycelonis_knowledge_model.get_kpis()]

        # Test sync kpi
        original_name = kpi.display_name
        kpi.display_name = kpi.display_name + "_UPDATED"
        kpi.sync()
        assert kpi.display_name == original_name

        # Test update kpi
        new_name = kpi.display_name + "_UPDATED"
        kpi.display_name = new_name
        kpi.update()
        assert kpi.display_name == new_name

        # Test delete kpi
        kpi.delete()
        assert kpi.id not in [k.id for k in pycelonis_knowledge_model.get_kpis()]
        with pytest.raises(PyCelonisNotFoundError):
            pycelonis_knowledge_model.get_kpi(kpi.id)

        # Test kpi representation
        representation = repr(kpi)
        for attribute in kpi.__main_attributes__():
            assert attribute in representation

import pytest
from pycelonis.errors import PyCelonisNotSupportedError
from pycelonis_core.utils.errors import PyCelonisHTTPStatusError, PyCelonisNotFoundError


@pytest.mark.vcr()
@pytest.mark.xdist_group(name="studio")
class TestVariable:
    def test_variable(self, pycelonis_package):
        # Test create variable
        variable = pycelonis_package.create_variable("TEST_KEY", "TEST_NAME", "DATA_MODEL", runtime=False)

        # Test variable exists within package
        assert pycelonis_package.get_variable(variable.key).key == variable.key
        assert variable.key in [v.key for v in pycelonis_package.get_variables()]

        # Test create variable with same key fails
        with pytest.raises(PyCelonisHTTPStatusError):
            pycelonis_package.create_variable("TEST_KEY", "TEST_NAME", "DATA_MODEL")

        # Test get variable with wrong key raises error
        with pytest.raises(PyCelonisNotFoundError):
            pycelonis_package.get_variable("NONEXISTENT_KEY")

        # Test copy variable raises not supported error
        with pytest.raises(PyCelonisNotSupportedError):
            variable.copy_to(pycelonis_package, "TEAM_DOMAIN")

        # Test sync variable
        original_value = variable.value
        variable.value = variable.value + "_UPDATED"
        variable.sync()
        assert variable.value == original_value

        # Test update variable
        new_value = variable.value + "_UPDATED"
        variable.value = new_value
        variable.update()
        assert variable.value == new_value

        # Test delete variable
        variable.delete()
        assert variable.key not in [v.key for v in pycelonis_package.get_variables()]
        with pytest.raises(PyCelonisNotFoundError):
            pycelonis_package.get_variable(variable.key)

        # Test sync after delete raises error
        with pytest.raises(PyCelonisNotFoundError):
            variable.sync()

        # Test variable representation
        representation = repr(variable)
        for attribute in variable.__main_attributes__():
            assert attribute in representation

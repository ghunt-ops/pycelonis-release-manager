import pytest
from pycelonis.service.integration.service import TaskType, VariableSettingsTransport, VariableValueTransport


@pytest.mark.vcr()
class TestTaskVariable:
    def test_task_variable(self, pycelonis_data_pool, pycelonis_job):
        task = pycelonis_job.create_task("TEST_TASK", TaskType.TRANSFORMATION, "TEST_DESCRIPTION")

        # Test get and create task variable
        task_variables = task.get_task_variables()
        assert len(task_variables) == 0
        task.create_task_variable(
            name="VARIABLE_NAME", placeholder="PLACEHOLDER", values=[VariableValueTransport(value="TEST_VALUE")]
        )
        task_variables = task.get_task_variables()
        assert len(task_variables) == 1

        # Test create task variable from pool variable
        pool_variable = pycelonis_data_pool.create_pool_variable(
            name="VARIABLE_NAME", placeholder="PLACEHOLDER", values=[VariableValueTransport(value="TEST_VALUE")]
        )
        task.create_task_variable(
            name="FROM_POOL_VARIABLE_NAME",
            placeholder="FROM_POOL_VARIABLE_PLACEHOLDER",
            settings=VariableSettingsTransport(pool_variable_id=pool_variable.id),
        )
        task_variables = task.get_task_variables()
        assert len(task_variables) == 2

        # Test update task variable
        task_variable = task_variables[0]
        new_name = task_variable.name + "_UPDATED"
        task_variable.name = new_name
        task_variable.update()  # Simulate local changes
        assert task.get_task_variables()[0].name == task_variable.name

        # Test delete task variable
        task_variable.delete()
        assert task_variable.id not in [tv.id for tv in task.get_task_variables()]

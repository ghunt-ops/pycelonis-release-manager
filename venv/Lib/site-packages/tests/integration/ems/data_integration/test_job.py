import pandas as pd
import pytest
from pycelonis.errors import PyCelonisError, PyCelonisExecutionInProgressError
from pycelonis.pql.pql import PQL, PQLColumn
from pycelonis.service.integration.service import (
    DataModelExecutionConfiguration,
    ExtractionConfiguration,
    TableConfigurationParameterValue,
    TableExtractionColumnTransport,
)
from pycelonis_core.utils.errors import PyCelonisHTTPStatusError, PyCelonisNotFoundError


@pytest.mark.vcr()
class TestJob:
    def test_job(self, pycelonis_celonis, pycelonis_data_pool):
        # Test create job
        job = pycelonis_data_pool.create_job("TEST_JOB")

        # Test create job with same name fails
        with pytest.raises(PyCelonisHTTPStatusError):
            pycelonis_data_pool.create_job(job.name)

        # Test job exists within data pool
        assert pycelonis_data_pool.get_job(job.id) == job
        assert job.id in [j.id for j in pycelonis_data_pool.get_jobs()]

        # Test sync job
        original_name = job.name
        job.name = job.name + "_UPDATED"
        job.sync()
        assert job.name == original_name

        # Test update data model
        new_name = job.name + "_UPDATED"
        job.name = new_name
        job.update()
        assert job.name == new_name

        # Test copy job
        try:
            copy_transport = job.copy_to(
                pycelonis_celonis.team.get_team().name, pycelonis_data_pool.id, job.data_source_id
            )
            copy_job = pycelonis_data_pool.get_job(copy_transport.id)
            assert copy_job.id == copy_transport.id
        finally:
            if "copy_job" in locals():
                copy_job.delete()

        # Test delete job
        job.delete()
        assert job.id not in [j.id for j in pycelonis_data_pool.get_jobs()]
        with pytest.raises(PyCelonisNotFoundError):
            pycelonis_data_pool.get_job(job.id)

        assert job.id not in [j.id for j in pycelonis_data_pool.get_jobs()]

        # Test job representation
        representation = repr(job)
        for attribute in job.__main_attributes__():
            assert attribute in representation

    def test_full_job_execution(self, pycelonis_job, pycelonis_data_pool, pycelonis_data_model):
        df = pd.DataFrame({"TEST_COLUMN": [1, 2, 3]})
        table = pycelonis_data_pool.create_table(df, "TEST_TABLE")
        pycelonis_data_model.add_table(table.name)

        transformation1 = pycelonis_job.create_transformation("TEST_TASK1")
        transformation2 = pycelonis_job.create_transformation("TEST_TASK2")
        pycelonis_job.create_data_model_execution(pycelonis_data_model.id)

        table1 = "CREATE TABLE TABLE_1 (col VARCHAR(64));"
        table2 = "CREATE TABLE TABLE_2 (col VARCHAR(64));"

        transformation1.update_statement(table1)
        transformation2.update_statement(table2)

        pycelonis_job.execute()

        assert pycelonis_data_pool.get_table("TABLE_1")
        assert pycelonis_data_pool.get_table("TABLE_2")
        assert pycelonis_data_model.get_load_status() is not None

        # Execute fails as execution already in progress
        pycelonis_job.execute(wait=False)
        with pytest.raises(PyCelonisExecutionInProgressError):
            pycelonis_job.execute()
        pycelonis_job._wait_for_execution()

        transformation1.update_statement("FAULTY_STATEMENT")
        with pytest.raises(PyCelonisError):
            pycelonis_job.execute()

    def test_partial_job_execution(self, pycelonis_job, pycelonis_data_model, pycelonis_data_pool):
        df = pd.DataFrame({"TEST_COLUMN": [1, 2, 3]})
        table = pycelonis_data_pool.create_table(df, "TEST_TABLE")
        pycelonis_data_model.add_table(table.name)

        data_model2 = pycelonis_data_pool.create_data_model("TEST_DATA_MODEL2")
        data_model2.add_table(table.name)

        table1 = "CREATE TABLE TABLE_1 (col VARCHAR(64));"
        table2 = "CREATE TABLE TABLE_2 (col VARCHAR(64));"

        transformation1 = pycelonis_job.create_transformation("TEST_TASK1")
        transformation2 = pycelonis_job.create_transformation("TEST_TASK2")

        transformation1.update_statement(table1)
        transformation2.update_statement(table2)

        data_model_execution1 = pycelonis_job.create_data_model_execution(pycelonis_data_model.id)
        data_model_execution2 = pycelonis_job.create_data_model_execution(data_model2.id)

        pycelonis_job.execute(transformation_ids=[], data_model_execution_configurations=[])

        with pytest.raises(PyCelonisNotFoundError):
            pycelonis_data_pool.get_table("TABLE_1")
        with pytest.raises(PyCelonisNotFoundError):
            pycelonis_data_pool.get_table("TABLE_2")

        compute_load_dm1 = pycelonis_data_model.get_load_status()
        compute_load_dm2 = data_model2.get_load_status()

        assert compute_load_dm1 is None or compute_load_dm1.load_status is None
        assert compute_load_dm2 is None or compute_load_dm2.load_status is None

        pycelonis_job.execute(
            transformation_ids=[transformation1.id],
            data_model_execution_configurations=[
                DataModelExecutionConfiguration(
                    data_model_execution_id=data_model_execution1.id,
                    tables=[t.id for t in data_model_execution1.tables],
                )
            ],
        )

        assert pycelonis_data_pool.get_table("TABLE_1")
        with pytest.raises(PyCelonisNotFoundError):
            pycelonis_data_pool.get_table("TABLE_2")

        compute_load_dm1 = pycelonis_data_model.get_load_status()
        compute_load_dm2 = data_model2.get_load_status()

        assert compute_load_dm1 is not None or compute_load_dm1.load_status is not None
        assert compute_load_dm2 is None or compute_load_dm2.load_status is None

        pycelonis_job.execute(
            transformation_ids=[transformation2.id],
            data_model_execution_configurations=[
                DataModelExecutionConfiguration(
                    data_model_execution_id=data_model_execution2.id,
                    tables=[t.id for t in data_model_execution2.tables],
                )
            ],
        )
        assert pycelonis_data_pool.get_table("TABLE_2")

        compute_load_dm2 = data_model2.get_load_status()
        assert compute_load_dm2 is not None or compute_load_dm2.load_status is not None

    def test_partial_data_model_reload_for_job_execution(
        self, pycelonis_job, pycelonis_data_model, pycelonis_data_pool
    ):
        df = pd.DataFrame({"TEST_COLUMN": [1, 2, 3]})
        table1 = pycelonis_data_pool.create_table(df, "TEST_TABLE")
        dm_table1 = pycelonis_data_model.add_table(table1.name)

        table2 = pycelonis_data_pool.create_table(df, "TEST_TABLE2")
        dm_table2 = pycelonis_data_model.add_table(table2.name)

        pycelonis_data_model.reload()  # do initial reload

        table1.append(df)
        table2.append(df)

        pycelonis_job.create_data_model_execution(pycelonis_data_model.id, table_ids=[dm_table1.id])

        pycelonis_job.execute()
        pycelonis_data_model._wait_for_reload()

        query1 = PQL() + PQLColumn(name="TEST", query=f'"{dm_table1.name}"."TEST_COLUMN"')
        query2 = PQL() + PQLColumn(name="TEST", query=f'"{dm_table2.name}"."TEST_COLUMN"')

        assert pycelonis_data_model.export_data_frame(query1).shape[0] == 6  # Has been reloaded by job
        assert pycelonis_data_model.export_data_frame(query2).shape[0] == 3  # Has not been reloaded by job

    def test_job_execution_with_extraction(self, pycelonis_data_pool, scoped_data_job, extraction):
        table_extraction = extraction.create_table_extraction(
            table_name="taxi_trips",
            schema_name="bq-project-main.dataset_public_1",
        )

        # Update table extraction to add primary key
        table_extraction.connector_specific_configuration.append(
            TableConfigurationParameterValue(key="MAX_EXTRACTED_RECORDS", value=10)
        )
        table_extraction.columns = [
            TableExtractionColumnTransport(
                column_name="unique_key",
                from_join=False,
                anonymized=False,
                primary_key=True,
            )
        ]
        table_extraction.update()

        # Execute job again
        scoped_data_job.execute()

        # Table should now be available in data pool
        assert pycelonis_data_pool.get_tables().find("taxi_trips")

    def test_partial_job_execution_with_extractions(self, pycelonis_data_pool, scoped_data_job):
        extraction1 = scoped_data_job.create_extraction("EXTRACTION_1")
        table_extraction1 = extraction1.create_table_extraction(
            table_name="taxi_trips",
            schema_name="bq-project-main.dataset_public_1",
        )
        table_extraction1.connector_specific_configuration.append(
            TableConfigurationParameterValue(key="MAX_EXTRACTED_RECORDS", value=10)
        )
        table_extraction1.columns = [
            TableExtractionColumnTransport(
                column_name="unique_key",
                from_join=False,
                anonymized=False,
                primary_key=True,
            )
        ]
        table_extraction1.update()

        scoped_data_job.execute(extraction_configurations=[])

        with pytest.raises(PyCelonisNotFoundError):
            pycelonis_data_pool.get_tables().find("taxi_trips")

        scoped_data_job.execute(
            extraction_configurations=[
                ExtractionConfiguration(
                    extraction_id=extraction1.id,
                )
            ]
        )

        assert pycelonis_data_pool.get_tables().find("taxi_trips")

    def test_detailed_error_log_in_failed_job_execution(self, pycelonis_job, pycelonis_data_pool, pycelonis_data_model):
        transformation1 = pycelonis_job.create_transformation("TEST_TASK1")
        transformation2 = pycelonis_job.create_transformation("TEST_TASK2")
        pycelonis_job.create_data_model_execution(pycelonis_data_model.id)

        statement1 = "CREATE TABLE TABLE_1 (col VARCHAR(64));"
        statement2 = "SELECT NONEXISTING_COLUMN FROM TABLE_1"

        transformation1.update_statement(statement1)
        transformation2.update_statement(statement2)

        with pytest.raises(PyCelonisError):
            pycelonis_job.execute()

    def test_cancel_job_execution(self, pycelonis_job, pycelonis_data_pool, pycelonis_data_model):
        # sometimes job can finish the execution before cancellation. Thus, it can be tested without assert.
        transformation = pycelonis_job.create_transformation("TEST_TASK1")
        create_table_statement = "CREATE TABLE TABLE_1 (col VARCHAR(64));"
        transformation.update_statement(create_table_statement)

        pycelonis_data_pool.get_tables()

        pycelonis_job.execute(wait=False)
        pycelonis_job.cancel_execution()

import pytest


@pytest.mark.vcr()
class TestDataPool:
    def test_data_pool(self, pycelonis_celonis, pycelonis_data_pool):
        assert pycelonis_celonis.data_integration.get_data_pool(pycelonis_data_pool.id) == pycelonis_data_pool
        assert pycelonis_data_pool.id in [dp.id for dp in pycelonis_celonis.data_integration.get_data_pools()]

        original_name = pycelonis_data_pool.name
        pycelonis_data_pool.name = pycelonis_data_pool.name + "_UPDATED"
        pycelonis_data_pool.sync()
        assert pycelonis_data_pool.name == original_name

        new_name = pycelonis_data_pool.name + "_UPDATED"
        pycelonis_data_pool.name = new_name
        pycelonis_data_pool.update()
        assert pycelonis_data_pool.name == new_name

        representation = repr(pycelonis_data_pool)
        for attribute in pycelonis_data_pool.__main_attributes__():
            assert attribute in representation

    def test_copy_data_pool(self, pycelonis_celonis, pycelonis_data_pool):
        dm1 = pycelonis_data_pool.create_data_model("dm-1")
        pycelonis_data_pool.create_data_model("dm-2")

        copy_pool, copy2_pool = None, None
        try:
            # Test default, all data models copied
            copy_transport = pycelonis_data_pool.copy_to(destination_team_domain=pycelonis_celonis.team.get_team().name)
            copy_pool = pycelonis_celonis.data_integration.get_data_pool(copy_transport.id)
            assert copy_pool.id == copy_transport.id
            assert len(copy_pool.get_data_models()) == len(pycelonis_data_pool.get_data_models())

            # Test subset of data models
            selected_data_models = [dm1.id]
            copy2_transport = pycelonis_data_pool.copy_to(
                destination_team_domain=pycelonis_celonis.team.get_team().name,
                selected_data_models=selected_data_models,
            )
            copy2_pool = pycelonis_celonis.data_integration.get_data_pool(copy2_transport.id)
            assert copy2_pool.id == copy2_transport.id
            assert len(copy2_pool.get_data_models()) == len(selected_data_models)

        finally:
            if copy_pool is not None:
                pycelonis_celonis.data_integration.get_data_pool(copy_pool.id).delete()
            if copy2_pool is not None:
                pycelonis_celonis.data_integration.get_data_pool(copy2_pool.id).delete()

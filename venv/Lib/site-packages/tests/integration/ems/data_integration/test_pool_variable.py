import pytest
from pycelonis.service.integration.service import VariableValueTransport
from pycelonis_core.utils.errors import PyCelonisHTTPStatusError, PyCelonisNotFoundError


@pytest.mark.vcr()
class TestPoolVariable:
    def test_pool_variable(self, pycelonis_celonis, pycelonis_data_pool):
        pool_variables = pycelonis_data_pool.get_pool_variables()
        assert len(pool_variables) == 0

        # Test create and get pool variable
        pool_variable = pycelonis_data_pool.create_pool_variable(
            name="VARIABLE_NAME", placeholder="PLACEHOLDER", values=[VariableValueTransport(value="TEST_VALUE")]
        )
        pool_variables = pycelonis_data_pool.get_pool_variables()
        assert len(pool_variables) == 1

        # Test update pool variable
        new_name = pool_variable.name + "_UPDATED"
        pool_variable_id = pool_variable.id
        pool_variable.name = new_name
        pool_variable.update()  # Simulate local changes
        assert pycelonis_data_pool.get_pool_variable(pool_variable_id).name == pool_variable.name

        # Test delete pool variable
        pool_variable.delete()
        assert pool_variable.id not in [pv.id for pv in pycelonis_data_pool.get_pool_variables()]
        with pytest.raises(PyCelonisNotFoundError):
            pycelonis_data_pool.get_pool_variable(pool_variable.id)

    def test_cannot_create_variable_with_same_name(self, pycelonis_data_pool):
        name = "VARIABLE_NAME"
        pycelonis_data_pool.create_pool_variable(
            name=name, placeholder="PLACEHOLDER", values=[VariableValueTransport(value="TEST_VALUE")]
        )

        with pytest.raises(PyCelonisHTTPStatusError, match="400 Bad Request"):
            pycelonis_data_pool.create_pool_variable(
                name=name, placeholder="PLACEHOLDER", values=[VariableValueTransport(value="TEST_VALUE")]
            )

import pytest
from pycelonis_core.utils.errors import PyCelonisNotFoundError


@pytest.mark.vcr()
class TestTableExtraction:
    def test_table_extraction(self, big_query_data_connection, scoped_data_job, extraction):
        table_extraction = extraction.create_table_extraction(
            table_name="taxi_trips",
            schema_name="bq-project-main.dataset_public_1",
        )

        # Test table extraction exists within extraction
        assert extraction.get_table_extraction(table_extraction.id) == table_extraction
        assert table_extraction.id in [j.id for j in extraction.get_table_extractions()]

        # Test sync table extraction
        original_name = table_extraction.target_table_name
        table_extraction.target_table_name = "TARGET_TABLE_NAME"
        table_extraction.sync()
        assert table_extraction.target_table_name == original_name

        # Test update table extraction
        new_disabled = True
        table_extraction.disabled = new_disabled
        table_extraction.update()
        assert table_extraction.disabled == new_disabled

        # Test delete table extraction
        table_extraction.delete()
        assert table_extraction.id not in [j.id for j in extraction.get_table_extractions()]
        with pytest.raises(PyCelonisNotFoundError):
            extraction.get_table_extraction(table_extraction.id)

        # Test table extraction representation
        representation = repr(table_extraction)
        for attribute in table_extraction.__main_attributes__():
            assert attribute in representation

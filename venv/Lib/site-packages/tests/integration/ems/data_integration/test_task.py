import pytest
from pycelonis.service.integration.service import TaskType
from pycelonis_core.utils.errors import PyCelonisNotFoundError


@pytest.mark.vcr()
class TestTask:
    def test_task(self, pycelonis_data_pool, pycelonis_job, big_query_data_connection):
        # Test create task
        task = pycelonis_job.create_task("TEST_TASK", TaskType.TRANSFORMATION, "TEST_DESCRIPTION")

        # Test task exists within data job
        assert pycelonis_job.get_task(task.id) == task
        assert task.id in [j.id for j in pycelonis_job.get_tasks()]

        # Test sync task
        original_name = task.name
        task.name = task.name + "_UPDATED"
        task.sync()
        assert task.name == original_name

        # Test update task
        new_name = task.name + "_UPDATED"
        task.name = new_name
        task.update()
        assert task.name == new_name

        # Test null task statement
        statement = task.get_statement()
        assert statement is None

        # Test update task statement
        new_statement = "DROP TABLE IF EXISTS TEST_TABLE;"
        task.update_statement(new_statement)
        assert task.get_statement() == new_statement

        # Test disable task
        task.disable()
        task.sync()
        assert task.disabled

        # Test enable task
        task.enable()
        task.sync()
        assert not task.disabled

        # Test delete task
        task.delete()
        assert task.id not in [j.id for j in pycelonis_job.get_tasks()]
        with pytest.raises(PyCelonisNotFoundError):
            pycelonis_job.get_task(task.id)

        # Test create transformation
        transformation = pycelonis_job.create_transformation("TEST_TRANSFORMATION", "TEST_DESCRIPTION")

        assert transformation.task_type == TaskType.TRANSFORMATION
        assert pycelonis_job.get_task(transformation.id) == transformation
        assert transformation.id in [j.id for j in pycelonis_job.get_transformations()]

        # Test create extraction (Extractions can only be created for jobs with data connection scope)
        scoped_data_job = pycelonis_data_pool.create_job(
            pycelonis_job.name + "_EXTRACTION", big_query_data_connection.id
        )
        extraction = scoped_data_job.create_extraction("TEST_EXTRACTION")

        assert extraction.task_type == TaskType.EXTRACTION
        assert scoped_data_job.get_task(extraction.id) == extraction
        assert extraction.id in [j.id for j in scoped_data_job.get_extractions()]

        # Test task representation
        representation = repr(task)
        for attribute in task.__main_attributes__():
            assert attribute in representation

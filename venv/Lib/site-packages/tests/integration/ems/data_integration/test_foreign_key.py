import pandas as pd
import pytest
from pycelonis_core.utils.errors import PyCelonisNotFoundError


@pytest.mark.vcr()
class TestForeignKey:
    def test_foreign_key(self, pycelonis_data_pool, pycelonis_data_model):
        # Setup tables to test foreign keys
        TABLE_1_NAME = "TABLE1"
        TABLE_2_NAME = "TABLE2"
        JOIN_COLUMN = "TEST_COL"

        table_1_df = pd.DataFrame(
            {
                JOIN_COLUMN: [1, 2, 3],
            }
        )
        table_2_df = pd.DataFrame(
            {
                JOIN_COLUMN: [2, 3, 4],
            }
        )
        pycelonis_data_pool.create_table(table_1_df, TABLE_1_NAME)
        pycelonis_data_pool.create_table(table_2_df, TABLE_2_NAME)
        table_1 = pycelonis_data_model.add_table(TABLE_1_NAME)
        table_2 = pycelonis_data_model.add_table(TABLE_2_NAME)

        # Test create foreign key
        foreign_key = pycelonis_data_model.create_foreign_key(
            source_table_id=table_1.id, target_table_id=table_2.id, columns=[(JOIN_COLUMN, JOIN_COLUMN)]
        )

        # Test foreign key exists within data model
        assert pycelonis_data_model.get_foreign_key(foreign_key.id) == foreign_key
        assert foreign_key.id in [fk.id for fk in pycelonis_data_model.get_foreign_keys()]

        # Test sync foreign key
        original_source_table_id = foreign_key.source_table_id
        foreign_key.source_table_id = foreign_key.source_table_id + "_UPDATED"
        foreign_key.sync()
        assert foreign_key.source_table_id == original_source_table_id

        # Test update foreign key
        new_source_table_id = foreign_key.target_table_id
        new_target_table_id = foreign_key.source_table_id
        foreign_key.source_table_id = new_source_table_id
        foreign_key.target_table_id = new_target_table_id
        foreign_key.update()
        assert foreign_key.source_table_id == new_source_table_id
        assert foreign_key.target_table_id == new_target_table_id

        # Test delete foreign key
        foreign_key.delete()
        assert foreign_key.id not in [config.id for config in pycelonis_data_model.get_process_configurations()]
        with pytest.raises(PyCelonisNotFoundError):
            pycelonis_data_model.get_process_configuration(foreign_key.id)

        # Test foreign key representation
        representation = repr(foreign_key)
        for attribute in foreign_key.__main_attributes__():
            assert attribute in representation

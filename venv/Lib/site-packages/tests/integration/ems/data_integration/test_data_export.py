import random

import pandas as pd
import pytest
from pycelonis.ems.data_integration.data_model import DataModel
from pycelonis.pql.pql import PQL, OrderByColumn, PQLColumn, PQLFilter
from pycelonis.service.integration.service import ExportType, ProxyQueryEnvironmentV2, ProxySavedFormulaV2
from tests.unit.conftest import assert_frame_equals, assert_series_equals


@pytest.mark.vcr()
class TestDataExport:
    @pytest.mark.parametrize("use_api_v2", [False, True])
    def test_data_export(self, use_api_v2, pycelonis_data_pool, pycelonis_data_model):
        # Setup basic data model
        df = pd.DataFrame({"TEST": [1, 2, 3, 4, 4], "TEST_FLOAT": [4.3, 5.5, 3.3, 2.2, 6.7]})
        pycelonis_data_pool.create_table(df, "TEST")
        pycelonis_data_model.add_table("TEST")
        pycelonis_data_model.reload(wait=True)

        # Test export data frame with single column
        query = PQL()
        query += PQLColumn(name="TEST", query='"TEST"."TEST"')
        result = pycelonis_data_model.export_data_frame(query, use_api_v2=use_api_v2)

        assert_frame_equals(df[["TEST"]], result)

        # Test export data frame with multiple columns
        query = PQL() + [
            PQLColumn(name="TEST", query='"TEST"."TEST"'),
            PQLColumn(name="TEST2", query='"TEST"."TEST"'),
        ]
        result = pycelonis_data_model.export_data_frame(query, use_api_v2=use_api_v2)
        assert result.shape == (5, 2)
        assert_frame_equals(df[["TEST"]], result[["TEST"]])
        assert_series_equals(df["TEST"], result["TEST2"], check_names=False)

        # Test export data frame with distinct=True
        query.distinct = True
        result = pycelonis_data_model.export_data_frame(query, use_api_v2=use_api_v2)

        assert result.shape == (4, 2)
        assert_frame_equals(result.drop_duplicates(), result)

        # Test export data frame with limit=2
        query.distinct = False
        query.limit = 2
        query += OrderByColumn(query='"TEST"."TEST"', ascending=True)
        query += OrderByColumn(query='"TEST"."TEST_FLOAT"', ascending=True)
        result = pycelonis_data_model.export_data_frame(query, use_api_v2=use_api_v2)

        assert result.shape == (2, 2)

        assert_frame_equals(df.iloc[:2][["TEST"]], result[["TEST"]])

        # Test export data frame with limit=2 and offset=2
        query.offset = 2
        query += OrderByColumn(query='"TEST"."TEST_FLOAT"', ascending=True)
        result = pycelonis_data_model.export_data_frame(query, use_api_v2=use_api_v2)

        assert result.shape == (2, 2)
        assert_frame_equals(df.iloc[2:4][["TEST"]].reset_index(drop=True), result[["TEST"]])

        # Test export data frame with filter
        query = PQL()
        query += PQLColumn(name="TEST", query='"TEST"."TEST"')
        query += PQLFilter(query='FILTER "TEST"."TEST" != 4')
        query += OrderByColumn(query='"TEST"."TEST"', ascending=True)
        query += OrderByColumn(query='"TEST"."TEST_FLOAT"', ascending=True)
        result = pycelonis_data_model.export_data_frame(query, use_api_v2=use_api_v2)

        assert result.shape == (3, 1)
        assert_frame_equals(df.iloc[:3][["TEST"]], result)

        # Test export data frame with multiple filters
        query += PQLFilter(query='FILTER "TEST"."TEST" != 3')
        query += OrderByColumn(query='"TEST"."TEST_FLOAT"', ascending=True)
        result = pycelonis_data_model.export_data_frame(query, use_api_v2=use_api_v2)

        assert result.shape == (2, 1)
        assert_frame_equals(df.iloc[:2][["TEST"]], result)

        # Test export data frame with order by column
        query = PQL()
        query += PQLColumn(name="TEST", query='"TEST"."TEST"')
        query += OrderByColumn(query='"TEST"."TEST"', ascending=False)
        result = pycelonis_data_model.export_data_frame(query, use_api_v2=use_api_v2)

        assert result.shape == (5, 1)
        pd.testing.assert_frame_equal(
            df[["TEST"]].sort_values(by="TEST", ascending=False).reset_index(drop=True),
            result,
        )

        # Test export data frame with multiple order by column
        query = PQL()
        query += PQLColumn(name="TEST", query='"TEST"."TEST"')
        query += OrderByColumn(query='"TEST"."TEST_FLOAT"', ascending=False)
        query += OrderByColumn(query='"TEST"."TEST"', ascending=False)

        result = pycelonis_data_model.export_data_frame(query, use_api_v2=use_api_v2)

        assert result.shape == (5, 1)

        pd.testing.assert_frame_equal(
            df.sort_values(by=["TEST_FLOAT", "TEST"], ascending=False)[["TEST"]].reset_index(drop=True),
            result,
        )

        # Test CSV export
        query = PQL()
        query += PQLColumn(name="TEST", query='"TEST"."TEST"')
        export = pycelonis_data_model.create_data_export(query, ExportType.CSV, use_api_v2=use_api_v2)
        export.wait_for_execution()
        result = pd.concat([pd.read_csv(chunk) for chunk in export.get_chunks()])

        assert_frame_equals(df[["TEST"]], result)

        # Test Excel export
        export = pycelonis_data_model.create_data_export(query, ExportType.EXCEL, use_api_v2=use_api_v2)
        export.wait_for_execution()
        result = pd.concat([pd.read_excel(chunk) for chunk in export.get_chunks()])

        assert_frame_equals(df[["TEST"]], result)

        # Test Parquet export
        export = pycelonis_data_model.create_data_export(query, ExportType.PARQUET, use_api_v2=use_api_v2)
        export.wait_for_execution()
        result = pd.concat([pd.read_parquet(chunk, engine="pyarrow") for chunk in export.get_chunks()])

        assert_frame_equals(df[["TEST"]], result)

        # Test data export directly from data model object
        query = PQL() + PQLColumn(name="TEST", query='"TEST"."TEST"')
        result = DataModel.export_data_frame_from(
            pycelonis_data_model.client,
            pycelonis_data_model.pool_id,
            pycelonis_data_model.id,
            query,
            use_api_v2=use_api_v2,
        )

        assert_frame_equals(df[["TEST"]], result)

        # Test data export representation
        representation = repr(export)
        for attribute in export.__main_attributes__():
            assert attribute in representation

    @pytest.mark.parametrize("use_api_v2", [False, True])
    def test_data_export_different_data_types(self, use_api_v2, pycelonis_data_pool):
        TABLE_NAME = "DTYPES_TEST"
        df = pd.DataFrame(
            {
                "INT": [1, 2],
                "FLOAT": [3.3, 5.5],
                "STRING": ["abc", "def"],
                "DATETIME": [
                    pd.to_datetime("2020-10-10 10:10:10.123456789"),
                    pd.to_datetime("2021-11-11 04:05:59.923456789"),
                ],
                "BOOL": [True, False],
                "CATEGORY": pd.Series(["a", "b"], dtype="category"),
            }
        )
        pycelonis_data_pool.create_table(df, TABLE_NAME)
        data_model = pycelonis_data_pool.create_data_model(f"{TABLE_NAME}_DM")
        data_model.add_table(TABLE_NAME)
        data_model.reload(wait=True)

        query = PQL() + [PQLColumn(name=column, query=f'"{TABLE_NAME}"."{column}"') for column in df.columns]
        result = data_model.export_data_frame(query, use_api_v2=use_api_v2)

        assert_series_equals(df["INT"], result["INT"])
        assert_series_equals(df["FLOAT"], result["FLOAT"])
        assert_series_equals(df["STRING"], result["STRING"])
        assert_series_equals(df["DATETIME"].dt.round("ms"), result["DATETIME"])  # EMS only has ms precision
        assert_series_equals(df["BOOL"].astype(int), result["BOOL"])  # PQL engine automatically converts bool to int
        assert_series_equals(df["CATEGORY"].astype(str), result["CATEGORY"])  # Category columns are converted to string

    def test_data_export_with_query_environment_v2(self, pycelonis_data_pool, pycelonis_data_model):
        # Setup basic data model
        df = pd.DataFrame({"TEST": [1, 2, 3, 4, 4], "TEST_FLOAT": [4.3, 5.5, 3.3, 2.2, 6.7]})
        pycelonis_data_pool.create_table(df, "TEST")
        pycelonis_data_model.add_table("TEST")
        pycelonis_data_model.reload(wait=True)

        # Test export data frame with single column
        query = PQL()
        query += PQLColumn(name="TEST", query='"TEST"."TEST"')
        query += PQLColumn(name="TEST_FLOAT", query='"TEST"."TEST_FLOAT"')
        query += PQLColumn(name="TEST_KPI", query='KPI("TEST-FORMULA")')
        result = pycelonis_data_model.export_data_frame(
            query,
            query_environment=ProxyQueryEnvironmentV2(
                saved_formulas=[
                    ProxySavedFormulaV2(
                        name="TEST-FORMULA", parameter_count=0, error=None, formula='COUNT("TEST"."TEST")'
                    )
                ]
            ),
            use_api_v2=True,
        )

        assert_frame_equals(df, result[["TEST", "TEST_FLOAT"]])
        assert result["TEST_KPI"].values.tolist() == [1] * 5

    @pytest.mark.skipif("not config.getoption('--disable-vcr')", reason="Only run when --disable-vcr is given")
    @pytest.mark.parametrize("use_api_v2", [False, True])
    def test_data_export_large(self, use_api_v2, pycelonis_data_pool, pycelonis_data_model):
        n_rows = 9000000
        df = pd.DataFrame({"TEST_FLOAT": [random.random() for _ in range(n_rows)]})
        pycelonis_data_pool.create_table(df, "TEST")
        pycelonis_data_model.add_table("TEST")
        pycelonis_data_model.reload(wait=True)

        # Test CSV export
        query = PQL()
        query += PQLColumn(name="TEST_FLOAT", query='"TEST"."TEST_FLOAT"')
        export = pycelonis_data_model.create_data_export(query, ExportType.PARQUET, use_api_v2=use_api_v2)
        if use_api_v2:
            chunks = [pd.read_parquet(chunk, engine="pyarrow") for chunk in export.get_chunks()]
            assert chunks != []

        export.wait_for_execution()
        all_chunks = [pd.read_parquet(chunk, engine="pyarrow") for chunk in export.get_chunks()]
        result = pd.concat(all_chunks)
        assert_frame_equals(df, result)
        assert len(all_chunks) == 2

import pandas as pd
import pytest
from pycelonis_core.utils.errors import PyCelonisNotFoundError


@pytest.mark.vcr()
class TestDataModelExecution:
    def test_data_model_execution(self, pycelonis_job, pycelonis_data_model, pycelonis_data_pool):
        df = pd.DataFrame({"TEST_COLUMN": [1, 2, 3]})
        pycelonis_data_pool.create_table(df, "TEST_TABLE")
        dm_table = pycelonis_data_model.add_table("TEST_TABLE", alias="TEST_TABLE")

        # Test create data model execution
        data_model_execution = pycelonis_job.create_data_model_execution(pycelonis_data_model.id)

        # Test data model execution exists within data job
        assert pycelonis_job.get_data_model_execution(data_model_execution.id) == data_model_execution
        assert data_model_execution.id in [
            data_model_execution.id for data_model_execution in pycelonis_job.get_data_model_executions()
        ]

        data_model_execution.delete()

        # Create new execution with specific tables
        data_model_execution = pycelonis_job.create_data_model_execution(
            pycelonis_data_model.id, table_ids=[dm_table.id]
        )
        assert data_model_execution.tables is not None

        # Test sync data model execution
        original_disabled = data_model_execution.disabled
        data_model_execution.disabled = not data_model_execution.disabled
        data_model_execution.sync()
        assert data_model_execution.disabled == original_disabled

        # Test delete data model execution
        data_model_execution.delete()
        assert data_model_execution.id not in [j.id for j in pycelonis_job.get_data_model_executions()]
        with pytest.raises(PyCelonisNotFoundError):
            pycelonis_job.get_data_model_execution(data_model_execution.id)

        with pytest.raises(PyCelonisNotFoundError):
            data_model_execution.sync()

        # Test data model execution representation
        representation = repr(data_model_execution)
        for attribute in data_model_execution.__main_attributes__():
            assert attribute in representation

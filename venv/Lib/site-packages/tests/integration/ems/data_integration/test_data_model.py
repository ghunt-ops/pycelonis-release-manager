import pandas as pd
import pytest
from pycelonis.pql import pql
from pycelonis_core.utils.errors import PyCelonisHTTPStatusError, PyCelonisNotFoundError


@pytest.mark.vcr()
class TestDataModel:
    def test_data_model(self, pycelonis_data_pool):
        # Test create data model
        data_model = pycelonis_data_pool.create_data_model("TEST_DATA_MODEL")

        # Test create data model with same name fails
        with pytest.raises(PyCelonisHTTPStatusError):
            pycelonis_data_pool.create_data_model(data_model.name)

        # Test data model exists within data pool
        assert pycelonis_data_pool.get_data_model(data_model.id) == data_model
        assert data_model.id in [dm.id for dm in pycelonis_data_pool.get_data_models()]

        # Test sync data model
        original_name = data_model.name
        data_model.name = data_model.name + "_UPDATED"
        data_model.sync()
        assert data_model.name == original_name

        # Test update data model
        new_name = data_model.name + "_UPDATED"
        data_model.name = new_name
        data_model.update()
        assert data_model.name == new_name

        # Test delete data model
        data_model.delete()
        assert data_model.id not in [dm.id for dm in pycelonis_data_pool.get_data_models()]
        with pytest.raises(PyCelonisNotFoundError):
            pycelonis_data_pool.get_data_model(data_model.id)

        # Test data model representation
        representation = repr(data_model)
        for attribute in data_model.__main_attributes__():
            assert attribute in representation

    def test_data_model_reload(self, pycelonis_data_pool, pycelonis_data_model):
        # Test data model reload with table
        df = pd.DataFrame({"TEST_COLUMN": [1, 2, 3]})
        pycelonis_data_pool.create_table(df, "TEST_TABLE")
        pycelonis_data_model.add_table("TEST_TABLE", alias="TEST_TABLE")

        pycelonis_data_model.reload()

    def test_data_model_partial_reload(self, pycelonis_data_pool, pycelonis_data_model):
        df = pd.DataFrame({"TEST_COLUMN": [1, 2, 3]})
        table1 = pycelonis_data_pool.create_table(df, "TEST_TABLE_1", drop_if_exists=True)
        table2 = pycelonis_data_pool.create_table(df, "TEST_TABLE_2", drop_if_exists=True)
        data_model_table1 = pycelonis_data_model.add_table("TEST_TABLE_1", alias="TEST_TABLE_1")
        pycelonis_data_model.add_table("TEST_TABLE_2", alias="TEST_TABLE_2")

        # complete reload of two datamodels
        pycelonis_data_model.reload()

        table1.append(df)
        table2.append(df)

        query_table1 = pql.PQL() + pql.PQLColumn(name="COLUMN", query='"TEST_TABLE_1"."TEST_COLUMN"')
        query_table2 = pql.PQL() + pql.PQLColumn(name="COLUMN", query='"TEST_TABLE_2"."TEST_COLUMN"')
        table1 = pycelonis_data_model.export_data_frame(query_table1)
        table2 = pycelonis_data_model.export_data_frame(query_table2)

        assert len(table1) == len(table2)
        assert len(table1) == df.shape[0]

        pycelonis_data_model.partial_reload([data_model_table1.id])

        table1 = pycelonis_data_model.export_data_frame(query_table1)
        table2 = pycelonis_data_model.export_data_frame(query_table2)

        assert len(table1) != len(table2)
        assert len(table1) == df.shape[0] * 2
        assert len(table2) == df.shape[0]

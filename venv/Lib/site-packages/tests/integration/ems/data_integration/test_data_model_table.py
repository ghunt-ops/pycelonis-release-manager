import pandas as pd
import pytest
from pycelonis_core.utils.errors import PyCelonisHTTPStatusError


@pytest.mark.vcr()
class TestDataModelTable:
    def test_data_model_tables(self, pycelonis_data_pool, pycelonis_data_model):
        # Test add table to data model
        TABLE_NAME = "TEST_TABLE"
        df = pd.DataFrame({"TEST_COLUMN": [1, 2, 3]})
        data_pool_table = pycelonis_data_pool.create_table(df, TABLE_NAME)
        data_model_table = pycelonis_data_model.add_table(TABLE_NAME, alias=TABLE_NAME)

        # Test data model table exists within data model
        assert pycelonis_data_model.get_table(data_model_table.id) == data_model_table
        assert data_model_table.id in [dm_table.id for dm_table in pycelonis_data_model.get_tables()]

        # Test data model table has same columns as data pool table
        assert set([col.name for col in data_pool_table.get_columns()]) == set(
            [col.name for col in data_model_table.get_columns()]
        )

        # Test sync data model table
        original_alias = data_model_table.alias
        data_model_table.alias = data_model_table.alias + "_UPDATED"
        data_model_table.sync()
        assert data_model_table.name == original_alias

        # Test update data model table
        new_alias = data_model_table.alias + "_UPDATED"
        data_model_table.alias = new_alias
        data_model_table.update()
        assert data_model_table.alias == new_alias

        # Test create table with same alias fails
        with pytest.raises(PyCelonisHTTPStatusError):
            pycelonis_data_model.add_table(TABLE_NAME, alias=data_model_table.alias)

        # Test create table with different alias works
        pycelonis_data_model.add_table(TABLE_NAME, alias=data_model_table.alias + "_DUPLICATE")
        assert len(pycelonis_data_model.get_tables()) == 2

        # Test data model reload with new table is working
        pycelonis_data_model.reload(wait=True)

        # Test table deletion removes all tables
        for table in pycelonis_data_model.get_tables():
            table.delete()
        assert len(pycelonis_data_model.get_tables()) == 0

        # Test data model table representation
        representation = repr(data_model_table)
        for attribute in data_model_table.__main_attributes__():
            assert attribute in representation

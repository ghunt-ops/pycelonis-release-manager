import pandas as pd
import pytest
from pycelonis_core.utils.errors import PyCelonisNotFoundError


@pytest.mark.vcr()
class TestProcessConfiguration:
    def test_process_configuration(self, pycelonis_data_pool, pycelonis_data_model):
        # Setup tables to test process configuration
        ACTIVITY_TABLE = "ACTIVITY_TABLE"
        ACTIVITY_COLUMN = "ACTIVITY_EN"
        CASE_ID_COLUMN = "CASE_ID"
        TIMESTAMP_COLUMN = "EVENTTIME"

        activity_df = pd.DataFrame(
            {
                CASE_ID_COLUMN: [1, 2, 3],
                ACTIVITY_COLUMN: ["ACTIVITY_A", "ACTIVITY_B", "ACTIVITY_C"],
                TIMESTAMP_COLUMN: [pd.to_datetime("2020-10-10") for _ in range(3)],
            }
        )
        pycelonis_data_pool.create_table(activity_df, ACTIVITY_TABLE)
        activity_table = pycelonis_data_model.add_table(ACTIVITY_TABLE)

        # Test create process configuration
        process_configuration = pycelonis_data_model.create_process_configuration(
            activity_table_id=activity_table.id,
            case_id_column=CASE_ID_COLUMN,
            activity_column=ACTIVITY_COLUMN,
            timestamp_column=TIMESTAMP_COLUMN,
        )

        # Test process configuration exists within data model
        assert pycelonis_data_model.get_process_configuration(process_configuration.id) == process_configuration
        assert process_configuration.id in [config.id for config in pycelonis_data_model.get_process_configurations()]

        # Test sync process configuration
        original_case_id_column = process_configuration.case_id_column
        process_configuration.case_id_column = process_configuration.case_id_column + "_UPDATED"
        process_configuration.sync()
        assert process_configuration.case_id_column == original_case_id_column

        # Test update process configuration
        new_case_id_column = process_configuration.case_id_column + "_UPDATED"
        process_configuration.case_id_column = new_case_id_column
        process_configuration.update()
        assert process_configuration.case_id_column == new_case_id_column

        # Test delete process configuration
        process_configuration.delete()
        assert process_configuration.id not in [
            config.id for config in pycelonis_data_model.get_process_configurations()
        ]
        with pytest.raises(PyCelonisNotFoundError):
            pycelonis_data_model.get_process_configuration(process_configuration.id)

        # Test process configuration representation
        representation = repr(process_configuration)
        for attribute in process_configuration.__main_attributes__():
            assert attribute in representation

import json

import pandas as pd
import pytest
from pycelonis.ems.apps import PublishedSpace
from pycelonis.ems.apps.content_node.analysis.component import DataComponent
from pycelonis.ems.data_integration.data_model import DataModel
from pycelonis.pql.pql import PQL, PQLColumn
from pycelonis.service.process_analytics.service import KpiTransport, ProcessAnalyticsService
from pycelonis_testing.ems.data_model.fixtures import get_persistent_data_model

from .....assets import ANALYSIS_ASSET, ANALYSIS_SINGLE_COMPONENT_ASSET


@pytest.fixture(scope="function")
def persistent_data_model(pycelonis_celonis, override_pycelonis_ems_fixtures):
    tables = {
        "ACTIVITY_TABLE": pd.DataFrame(
            {
                "ACTIVITY_EN": ["ACTIVITY1", "ACTIVITY2"],
            }
        ),
    }

    return get_persistent_data_model(
        pycelonis_celonis,
        "PYCELONIS_ANALYSIS_QUERY_RESOLUTION",
        tables,
        override=override_pycelonis_ems_fixtures,
    )


@pytest.mark.vcr
@pytest.mark.xdist_group(name="studio")
class TestAnalysis:
    def test_analysis(self, pycelonis_celonis, pycelonis_space, pycelonis_package, pycelonis_data_model):
        # Test create analysis
        analysis = pycelonis_package.create_analysis(
            "TEST_ANALYSIS",
            data_model_id=pycelonis_data_model.id,
        )
        pycelonis_package.publish()

        # Test analysis exists within pycelonis_package
        assert pycelonis_package.get_content_node(analysis.id).id == analysis.id

        published_space = pycelonis_celonis.apps.get_space(pycelonis_space.id)
        published_package = published_space.get_package(pycelonis_package.id)
        published_analysis = published_package.get_content_node(analysis.id)
        content = published_analysis.get_content()

        assert content.analysis.id == published_analysis.id
        assert len(content.kpis) == 0
        assert content.draft.id == published_analysis.id
        assert content.draft.title is None  # None as no title set
        assert content.draft.document is None  # None as content is empty
        assert content.data_model_id == pycelonis_data_model.id

        # Test content representation
        representation = repr(content.draft)
        for attribute in content.draft.__main_attributes__():
            assert attribute in representation

        # update title from serialized content
        updated_title = "NEW_TITLE_123"
        content = json.loads(analysis.serialized_content)
        content["draft"]["title"] = updated_title
        analysis.serialized_content = json.dumps(content, sort_keys=False)
        analysis.update()

        assert updated_title in analysis.serialized_content

    def test_query_resolution(
        self, pycelonis_celonis, pycelonis_space, pycelonis_package, persistent_data_model: DataModel
    ):
        analysis = pycelonis_package.create_analysis(
            "TEST_ANALYSIS_QUERY",
            data_model_id=persistent_data_model.id,
        )
        content = json.loads(analysis.serialized_content)
        content["draft"]["document"] = {
            "components": [],
            "variables": [
                {
                    "name": "TEST_VARIABLE",
                    "type": "text_replacement",
                    "value": '"ACTIVITY_TABLE"."ACTIVITY_EN"',
                }
            ],
        }
        analysis.serialized_content = json.dumps(content)
        analysis.update()

        ProcessAnalyticsService.post_analysis_v2_api_analysis_analysis_id_kpi(
            pycelonis_celonis.client,
            analysis_id=analysis.id,
            request_body=KpiTransport(name="TEST_KPI", template="COUNT(<%=TEST_VARIABLE%>)"),
        )

        pycelonis_package.publish()
        published_space: PublishedSpace = pycelonis_celonis.apps.get_space(pycelonis_space.id)
        published_package = published_space.get_package(pycelonis_package.id)
        published_analysis = published_package.get_analysis(analysis.id)

        query = (
            PQL()
            + PQLColumn(name="KPI", query='KPI("TEST_KPI")')
            + PQLColumn(
                name="VARIABLE",
                query="<%=TEST_VARIABLE%>",
            )
        )
        data_query, query_environment = published_analysis.resolve_query(query)
        df = persistent_data_model.export_data_frame(data_query, query_environment)
        assert df.shape == (2, 2)

    def test_analysis_components(
        self, pycelonis_celonis, pycelonis_space, pycelonis_package, persistent_data_model: DataModel
    ):
        analysis = pycelonis_package.create_analysis(
            "TEST_ANALYSIS_COMPONENT",
            data_model_id=persistent_data_model.id,
        )
        content = json.loads(analysis.serialized_content)

        # Set analysis content with single sheet that contains all supported components
        with open(ANALYSIS_ASSET, "r") as document_content:
            content["draft"]["document"] = json.load(document_content)
        analysis.serialized_content = json.dumps(content)
        analysis.update()

        pycelonis_package.publish()
        published_space: PublishedSpace = pycelonis_celonis.apps.get_space(pycelonis_space.id)
        published_package = published_space.get_package(pycelonis_package.id)
        published_analysis = published_package.get_analysis(analysis.id)
        published_sheet = published_analysis.get_content().draft.document.sheets[0]

        olap_table = published_sheet.components.find("#{OLAP Table}", search_attribute="title")
        self._verify_component_query(
            persistent_data_model,
            olap_table,
            n_columns=2,
            n_filters=1,
            n_order_by_columns=1,
        )

        column_chart = published_sheet.components.find("#{Column Chart}", search_attribute="title")
        self._verify_component_query(
            persistent_data_model,
            column_chart,
            n_columns=2,
            n_filters=1,
            n_order_by_columns=1,
        )

        pie_chart = published_sheet.components.find("#{Pie Chart}", search_attribute="title")
        self._verify_component_query(
            persistent_data_model,
            pie_chart,
            n_columns=2,
            n_filters=1,
            n_order_by_columns=1,
        )

        donut_chart = published_sheet.components.find("#{Donut Chart}", search_attribute="title")
        self._verify_component_query(
            persistent_data_model,
            donut_chart,
            n_columns=2,
            n_filters=1,
            n_order_by_columns=1,
        )

        line_chart = published_sheet.components.find("#{Line Chart}", search_attribute="title")
        self._verify_component_query(
            persistent_data_model,
            line_chart,
            n_columns=2,
            n_filters=1,
            n_order_by_columns=1,
        )

        area_chart = published_sheet.components.find("#{Area Chart}", search_attribute="title")
        self._verify_component_query(
            persistent_data_model,
            area_chart,
            n_columns=2,
            n_filters=1,
            n_order_by_columns=1,
        )

        marker_chart = published_sheet.components.find("#{Marker Chart}", search_attribute="title")
        self._verify_component_query(
            persistent_data_model,
            marker_chart,
            n_columns=2,
            n_filters=1,
            n_order_by_columns=1,
        )

        bubble_plot = published_sheet.components.find("#{Bubble Plot}", search_attribute="title")
        self._verify_component_query(
            persistent_data_model,
            bubble_plot,
            n_columns=2,
            n_filters=1,
            n_order_by_columns=1,
        )

        gauge = published_sheet.components.find("#{Gauge}", search_attribute="title")
        self._verify_component_query(persistent_data_model, gauge, n_columns=1, n_filters=1, n_order_by_columns=0)

        fill = published_sheet.components.find("#{Fill}", search_attribute="title")
        self._verify_component_query(persistent_data_model, fill, n_columns=1, n_filters=1, n_order_by_columns=0)

        number = published_sheet.components.find("#{Number}", search_attribute="title")
        self._verify_component_query(
            persistent_data_model,
            number,
            n_columns=1,
            n_filters=1,
            n_order_by_columns=0,
        )

        radial = published_sheet.components.find("#{Radial}", search_attribute="title")
        self._verify_component_query(
            persistent_data_model,
            radial,
            n_columns=1,
            n_filters=1,
            n_order_by_columns=0,
        )

        world_map = published_sheet.components.find("#{World Map}", search_attribute="title")
        self._verify_component_query(
            persistent_data_model,
            world_map,
            n_columns=3,
            n_filters=1,
            n_order_by_columns=0,
        )

        boxplot = published_sheet.components.find("#{Boxplot}", search_attribute="title")
        self._verify_component_query(
            persistent_data_model,
            boxplot,
            n_columns=2,
            n_filters=1,
            n_order_by_columns=0,
        )

        pivot_table = published_sheet.components.find("#{Pivot Table}", search_attribute="title")
        self._verify_component_query(
            persistent_data_model,
            pivot_table,
            n_columns=3,
            n_filters=1,
            n_order_by_columns=0,
        )

    def _verify_component_query(
        self,
        data_model: DataModel,
        component: DataComponent,
        n_columns: int,
        n_filters: int,
        n_order_by_columns: int,
    ):
        query = component.get_query()
        assert len(query.columns) == n_columns
        assert len(query.filters) == n_filters
        assert len(query.order_by_columns) == n_order_by_columns
        assert not data_model.export_data_frame(query).empty

    def test_component_with_translated_name_in_query_column(
        self, pycelonis_celonis, pycelonis_space, pycelonis_package, persistent_data_model: DataModel
    ):
        analysis = pycelonis_package.create_analysis(
            "TEST_ANALYSIS_SINGLE_COMPONENT",
            data_model_id=persistent_data_model.id,
        )
        content = json.loads(analysis.serialized_content)

        with open(ANALYSIS_SINGLE_COMPONENT_ASSET, "r") as document_content:
            content["draft"]["document"] = json.load(document_content)
        analysis.serialized_content = json.dumps(content)
        analysis.update()

        pycelonis_package.publish()
        published_space: PublishedSpace = pycelonis_celonis.apps.get_space(pycelonis_space.id)
        published_package = published_space.get_package(pycelonis_package.id)
        published_analysis = published_package.get_analysis(analysis.id)
        published_sheet = published_analysis.get_content().draft.document.sheets[0]

        olap_table = published_sheet.components.find("#{OLAP Table}", search_attribute="title")
        query_columns = olap_table.get_columns()
        raw_columns = olap_table._raw_columns

        assert query_columns[0].name == raw_columns[0]["translatedName"]
        assert query_columns[1].name == raw_columns[1]["name"]
        assert query_columns[2].name == raw_columns[2]["name"]

    def test_table_get_columns_can_exclude_hidden_columns(
        self, pycelonis_celonis, pycelonis_space, pycelonis_package, persistent_data_model: DataModel
    ):
        analysis = pycelonis_package.create_analysis(
            "TEST_ANALYSIS_SINGLE_COMPONENT",
            data_model_id=persistent_data_model.id,
        )
        content = json.loads(analysis.serialized_content)

        with open(ANALYSIS_SINGLE_COMPONENT_ASSET, "r") as document_content:
            content["draft"]["document"] = json.load(document_content)
        analysis.serialized_content = json.dumps(content)
        analysis.update()

        pycelonis_package.publish()
        published_space: PublishedSpace = pycelonis_celonis.apps.get_space(pycelonis_space.id)
        published_package = published_space.get_package(pycelonis_package.id)
        published_analysis = published_package.get_analysis(analysis.id)
        published_sheet = published_analysis.get_content().draft.document.sheets[0]

        olap_table = published_sheet.components.find("#{OLAP Table}", search_attribute="title")
        query_columns = olap_table.get_columns(exclude_hidden_columns=True)
        raw_columns = olap_table._raw_columns

        assert raw_columns[1]["notIncluded"] is True
        assert "TEST_COL" in raw_columns[1]["name"]
        assert len(query_columns) == 2
        assert "TEST_COL" not in query_columns[0].name and "TEST_COL" not in query_columns[1].name

import pytest
from pycelonis_core.utils.errors import PyCelonisNotFoundError


@pytest.mark.vcr()
@pytest.mark.xdist_group(name="studio")
class TestContentNode:
    def test_content_node(self, pycelonis_space, pycelonis_package, pycelonis_celonis):
        published_space = pycelonis_celonis.apps.get_space(pycelonis_space.id)

        # Test create analysis
        analysis = pycelonis_package.create_analysis("TEST_ANALYSIS")

        # Package not in published space as it's not published yet
        assert pycelonis_package.id not in [p.id for p in published_space.get_packages()]

        # Test pycelonis_package in published space after publishing
        pycelonis_package.publish()
        assert pycelonis_package.id in [p.id for p in published_space.get_packages()]

        published_package = published_space.get_package(pycelonis_package.id)

        # Test analysis exists within pycelonis_package
        assert published_package.get_content_node(analysis.id).id == analysis.id
        assert analysis.id in [f.id for f in published_package.get_analyses()]

        # Test new analysis does not exist within published pycelonis_package before publishing
        analysis2 = pycelonis_package.create_analysis("TEST_ANALYSIS2")
        assert analysis2.id not in [a.id for a in published_package.get_analyses()]

        pycelonis_package.publish()
        assert analysis2.id in [a.id for a in published_package.get_analyses()]

        # Test get analysis from different pycelonis_package fails
        package2 = pycelonis_space.create_package("TEST_PACKAGE_2")
        analysis2 = package2.create_analysis("TEST_ANALYSIS")
        package2.publish()

        with pytest.raises(PyCelonisNotFoundError):
            published_package.get_content_node(analysis2.id)

        published_package2 = published_space.get_package(package2.id)
        assert published_package2.get_content_node(analysis2.id).id == analysis2.id

        # Test analysis representation
        representation = repr(analysis)
        for attribute in analysis.__main_attributes__():
            assert attribute in representation

import json
import logging
import os
import pathlib
import typing

import pandas as pd
import pytest
from dotenv import load_dotenv
from pycelonis import _get_api_token
from pycelonis_testing.ems.data_model.fixtures import get_persistent_data_model
from pycelonis_testing.util import get_fixture_name
from pycelonis_testing import vcr, vcr_config  # noqa
from tests.integration.data_connection_utils import _get_data_connection

load_dotenv()

logging.getLogger("vcr").setLevel(logging.WARNING)
logging.getLogger("httpx").setLevel(logging.WARNING)


@pytest.fixture(scope="function")
def scoped_data_job(pycelonis_data_pool, big_query_data_connection, request):
    name = get_fixture_name("SCOPED_DATA_JOB", request.node.name)
    scoped_data_job = pycelonis_data_pool.create_job(name, big_query_data_connection.id)

    yield scoped_data_job

    scoped_data_job.delete()


@pytest.fixture(scope="function")
def extraction(scoped_data_job, request):
    name = get_fixture_name("EXTRACTION", request.node.name)
    extraction = scoped_data_job.create_extraction(name)

    yield extraction

    extraction.delete()


@pytest.fixture(scope="session")
def big_query_config() -> typing.Dict:
    return json.loads(os.environ["BIG_QUERY_CONFIG"], strict=False)


@pytest.fixture(scope="function")
def big_query_data_connection(pycelonis_data_pool, big_query_config, request):
    name = get_fixture_name("DATA_CONNECTION", request.node.name)
    return _get_data_connection(pycelonis_data_pool, big_query_config, name)


@pytest.fixture(scope="function")
def single_table_data_model(pycelonis_celonis, pycelonis_data_pool, override_pycelonis_ems_fixtures):
    tables = {
        "TEST_TABLE": pd.DataFrame(
            {
                "INT_COLUMN": [0, 1, 2],
                "INT_MIXED": [-1, 2, -3],
                "INT_COLUMN_NONE": [0, None, 2],
                "FLOAT_COLUMN": [0.5, 1.5, 2.5],
                "FLOAT_COLUMN_NONE": [0.5, None, 2.5],
                "STRING_COLUMN": ["aa", "bb", "cc"],
                "STRING_COLUMN_NONE": ["aa", None, "cc"],
                "DATETIME_COLUMN": [pd.to_datetime(dt) for dt in ["2010", "2011", "2012"]],
                "DATETIME_COLUMN_NONE": [pd.to_datetime(dt) for dt in ["2010", None, "2012"]],
            }
        ),
    }
    foreign_keys = []
    process_configurations = []

    return get_persistent_data_model(
        pycelonis_celonis,
        pycelonis_data_pool.name,
        tables,
        foreign_keys,
        process_configurations,
        override=override_pycelonis_ems_fixtures,
    )


@pytest.fixture(scope="function")
def default_data_model(pycelonis_celonis, pycelonis_data_pool, override_pycelonis_ems_fixtures):
    tables = {
        "TEST_TABLE": pd.DataFrame(
            {
                "INT_COLUMN": [0, 1, 2],
            }
        ),
    }
    foreign_keys = []
    process_configurations = []

    return get_persistent_data_model(
        pycelonis_celonis,
        pycelonis_data_pool.name,
        tables,
        foreign_keys,
        process_configurations,
        override=override_pycelonis_ems_fixtures,
    )


@pytest.fixture(scope="session")
def access_token_file(tmp_path_factory):
    token = _get_api_token()
    fn = tmp_path_factory.mktemp("access_token") / "access_token.txt"
    pathlib.Path(fn).write_text(token)
    return fn

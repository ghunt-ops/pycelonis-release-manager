import typing

from pycelonis.ems.data_integration.data_connection import DataConnection
from pycelonis.service.integration.service import AnonymizationAlgorithm
from pycelonis_core.base.base_model import PyCelonisBaseModel

try:
    from pydantic.v1 import Field  # type: ignore
except ImportError:
    from pydantic import Field  # type: ignore


class DatabaseConnectionConfigurationTransport(PyCelonisBaseModel):
    type_: typing.Optional["str"] = Field(alias="type")
    template_id: typing.Optional["str"] = Field(alias="templateId")
    server_name: typing.Optional["str"] = Field(alias="serverName")
    port: typing.Optional["int"] = Field(alias="port")
    database_name: typing.Optional["str"] = Field(alias="databaseName")
    service_name: typing.Optional["str"] = Field(alias="serviceName")
    warehouse_name: typing.Optional["str"] = Field(alias="warehouseName")
    schema_name: typing.Optional["str"] = Field(alias="schemaName")
    connection_string_additional: typing.Optional["str"] = Field(alias="connectionStringAdditional")
    username: typing.Optional["str"] = Field(alias="username")
    password: typing.Optional["str"] = Field(alias="password")
    use_custom_string: typing.Optional["bool"] = Field(alias="useCustomString")
    custom_string: typing.Optional["str"] = Field(alias="customString")
    custom_driver_class: typing.Optional["str"] = Field(alias="customDriverClass")
    parallel_tables: typing.Optional["int"] = Field(alias="parallelTables")
    connection_timeout: typing.Optional["int"] = Field(alias="connectionTimeout")
    certificate_validation_enabled: typing.Optional["bool"] = Field(alias="certificateValidationEnabled")
    region: typing.Optional["str"] = Field(alias="region")
    output_location: typing.Optional["str"] = Field(alias="outputLocation")
    live_data_connection: typing.Optional["bool"] = Field(alias="liveDataConnection")
    extract_row_id: typing.Optional["bool"] = Field(alias="extractRowId")
    authentication_method: typing.Optional["str"] = Field(alias="authenticationMethod")
    client_id: typing.Optional["str"] = Field(alias="clientId")
    client_secret: typing.Optional["str"] = Field(alias="clientSecret")
    principal_id: typing.Optional["str"] = Field(alias="principalId")
    principal_secret: typing.Optional["str"] = Field(alias="principalSecret")
    service_account_email_id: typing.Optional["str"] = Field(alias="serviceAccountEmailId")
    service_account_credentials: typing.Optional["str"] = Field(alias="serviceAccountCredentials")
    use_uplink: typing.Optional["bool"] = Field(alias="useUplink")


class DatabaseDataSource(PyCelonisBaseModel):
    id: typing.Optional["str"] = Field(alias="id")
    name: typing.Optional["str"] = Field(alias="name")
    pool_id: typing.Optional["str"] = Field(alias="poolId")
    type_: typing.Optional["str"] = Field(alias="type")
    metadata: typing.Optional["str"] = Field(alias="metadata")
    uplink_id: typing.Optional["str"] = Field(alias="uplinkId")
    connected: typing.Optional["bool"] = Field(alias="connected")
    locked: typing.Optional["bool"] = Field(alias="locked")
    uplink_name: typing.Optional["str"] = Field(alias="uplinkName")
    signature: typing.Optional["str"] = Field(alias="signature")
    use_uplink: typing.Optional["bool"] = Field(alias="useUplink")
    internal_system_id: typing.Optional["str"] = Field(alias="internalSystemId")
    internal_system_selected: typing.Optional["bool"] = Field(alias="internalSystemSelected")
    configuration: typing.Optional["typing.List[typing.Any]"] = Field(alias="configuration")
    target_schema_name: typing.Optional["str"] = Field(alias="targetSchemaName")
    exported: typing.Optional["bool"] = Field(alias="exported")
    export_available: typing.Optional["bool"] = Field(alias="exportAvailable")
    extractor_port: typing.Optional["int"] = Field(alias="extractorPort")
    anonymization_algorithm: typing.Optional["AnonymizationAlgorithm"] = Field(alias="anonymizationAlgorithm")
    salt_id: typing.Optional["str"] = Field(alias="saltId")
    custom_extractor_id: typing.Optional["str"] = Field(alias="customExtractorId")
    custom_extractor_name: typing.Optional["str"] = Field(alias="customExtractorName")
    creator_user_id: typing.Optional["str"] = Field(alias="creatorUserId")
    creator_username: typing.Optional["str"] = Field(alias="creatorUsername")
    config: typing.Optional["DatabaseConnectionConfigurationTransport"] = Field(alias="config")
    imported: typing.Optional["bool"] = Field(alias="imported")
    configured: typing.Optional["bool"] = Field(alias="configured")
    parameter_name: typing.Optional["str"] = Field(alias="parameterName")
    normalized_name: typing.Optional["str"] = Field(alias="normalizedName")


def _get_data_connection(data_pool, big_query_config, data_connection_name):
    database_data_source_transport = data_pool.client.request(
        method="POST",
        url="integration/api/datasource/database",
        parse_json=True,
        type_=DatabaseDataSource,
        json=DatabaseDataSource(
            name=data_connection_name,
            type_="database",
            config=DatabaseConnectionConfigurationTransport(**big_query_config),
            pool_id=data_pool.id,
        ).json_dict(by_alias=True),
    )
    return DataConnection.from_transport(data_pool.client, database_data_source_transport)

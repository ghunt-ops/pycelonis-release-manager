import logging
import sys
from unittest.mock import MagicMock, patch

from pycelonis import setup_ml_workbench_logging, setup_ml_workbench_tracking
from pycelonis_core.utils.ml_workbench import INTERNAL_TRACKING_LOGGER, TRACKING_LOGGER


class TestMLWorkbenchLogging:
    @patch("logging.getLogger")
    def test_setup_ml_workbench_logging_set_levels(self, mock_logger):
        setup_ml_workbench_logging()

        mock_logger.assert_any_call("urllib3")
        mock_logger.assert_any_call("ddtrace")
        mock_logger.assert_any_call("pycelonis")

    @patch("logging.Formatter")
    def test_setup_ml_workbench_logging_formatter(self, mock_formatter):
        setup_ml_workbench_logging()

        mock_formatter.asser_called_once_with("[%(asctime)s] %(levelname)s: %(message)s")

    @patch("logging.StreamHandler")
    def test_setup_ml_workbench_logging_handler(self, mock_handler):
        setup_ml_workbench_logging()

        mock_handler.assert_any_call(sys.stderr)
        mock_handler.assert_any_call(sys.stdout)

    @patch.object(logging.StreamHandler, "setLevel")
    def test_setup_ml_workbench_logging_handler_level(self, mock_level):
        setup_ml_workbench_logging()

        mock_level.assert_any_call(logging.WARNING)
        mock_level.assert_any_call(logging.DEBUG)


process_mock = MagicMock()
process_mock.name.return_value = "jupyter-noteboo"
type(process_mock).pid = 1


@patch("logging.FileHandler", MagicMock())
class TestMLWorkbenchTracking:
    @patch("psutil.process_iter", MagicMock(return_value=iter([process_mock])))
    def test_setup_ml_workbench_tracking_set_levels(self):
        with patch("logging.getLogger") as mock_logger:
            setup_ml_workbench_tracking()

            mock_logger.assert_any_call(TRACKING_LOGGER)

    @patch("psutil.process_iter", MagicMock(return_value=iter([process_mock])))
    def test_setup_ml_workbench_internal_tracking_set_levels(self):
        with patch("logging.getLogger") as mock_logger:
            setup_ml_workbench_tracking()

            mock_logger.assert_any_call(INTERNAL_TRACKING_LOGGER)

    @patch("psutil.process_iter", MagicMock(return_value=iter([process_mock])))
    def test_setup_ml_workbench_tracking_handler(self):
        with patch("logging.FileHandler") as mock_handler:
            setup_ml_workbench_tracking()

            mock_handler.assert_any_call("/proc/1/fd/1")

    @patch("psutil.process_iter", MagicMock(return_value=iter([process_mock])))
    def test_do_not_setup_ddtrace_if_ddtrace_not_installed(self, monkeypatch):
        monkeypatch.setitem(sys.modules, "ddtrace", None)
        with patch("logging.FileHandler") as mock_handler:
            setup_ml_workbench_tracking()

            mock_handler.assert_any_call("/proc/1/fd/1")

import pytest
from httpx import Timeout
from pycelonis_core.client import KeyType
from pycelonis_core.client.client import Client
from pycelonis_core.utils.errors import PyCelonisValueError


class TestBlockingClient:
    def test_blocking_client_setup(self):
        BASE_URL = "https://base_url"
        API_TOKEN = "API_TOKEN"
        KEY_TYPE = KeyType.USER_KEY
        USER_AGENT = "TEST_USER_AGENT"
        TIMEOUT = 120
        RETRIES = 3
        DELAY = 3

        blocking_client = Client(
            base_url=BASE_URL,
            api_token=API_TOKEN,
            key_type=KEY_TYPE,
            user_agent=USER_AGENT,
            timeout=TIMEOUT,
            retries=RETRIES,
            delay=DELAY,
        )

        assert blocking_client.base_url == BASE_URL
        assert blocking_client._get_request_headers() == {
            "authorization": f"Bearer {API_TOKEN}",
            "user-agent": USER_AGENT,
        }
        assert blocking_client.client.timeout == Timeout(TIMEOUT)
        assert not blocking_client.client.trust_env

        assert blocking_client.client._transport.retries == RETRIES
        assert blocking_client.client._transport.delay == DELAY
        assert blocking_client.client._transport.status_forcelist == [429, 502, 503, 504]
        assert blocking_client.client._transport.allowed_methods == ["HEAD", "GET", "PUT", "POST", "DELETE", "OPTIONS"]

    def test_blocking_client_should_support_callable_api_token(self):
        blocking_client = Client(
            base_url="https://base_url",
            api_token=lambda base_url: "API_TOKEN",  # type: ignore
            key_type=KeyType.BEARER,
            user_agent="TEST_USER_AGENT",
        )
        assert blocking_client._get_request_headers() == {
            "authorization": "Bearer API_TOKEN",
            "user-agent": "TEST_USER_AGENT",
        }

    def test_request_headers_override_regular_headers(self):
        blocking_client = Client(
            base_url="https://base_url",
            api_token="API_TOKEN",
            key_type=KeyType.BEARER,
            user_agent="TEST_USER_AGENT",
        )
        assert blocking_client._get_request_headers(headers={"authorization": "TEST"}) == {
            "authorization": "TEST",
            "user-agent": "TEST_USER_AGENT",
        }

    def test_blocking_client_request_raises_value_error_if_both_request_body_and_content_set(self):
        BASE_URL = "https://base_url"
        API_TOKEN = "API_TOKEN"
        KEY_TYPE = KeyType.USER_KEY
        USER_AGENT = "TEST_USER_AGENT"

        blocking_client = Client(
            base_url=BASE_URL,
            api_token=API_TOKEN,
            key_type=KEY_TYPE,
            user_agent=USER_AGENT,
        )

        with pytest.raises(PyCelonisValueError):
            blocking_client.request("GET", "URL", request_body={}, content="TEST")

    def test_blocking_client_request_raises_value_error_if_both_request_body_and_files_set(self):
        BASE_URL = "https://base_url"
        API_TOKEN = "API_TOKEN"
        KEY_TYPE = KeyType.USER_KEY
        USER_AGENT = "TEST_USER_AGENT"

        blocking_client = Client(
            base_url=BASE_URL,
            api_token=API_TOKEN,
            key_type=KEY_TYPE,
            user_agent=USER_AGENT,
        )

        with pytest.raises(PyCelonisValueError):
            blocking_client.request("GET", "URL", request_body={}, files={})

    def test_blocking_client_request_raises_value_error_if_both_request_body_and_json_set(self):
        BASE_URL = "https://base_url"
        API_TOKEN = "API_TOKEN"
        KEY_TYPE = KeyType.USER_KEY
        USER_AGENT = "TEST_USER_AGENT"

        blocking_client = Client(
            base_url=BASE_URL,
            api_token=API_TOKEN,
            key_type=KEY_TYPE,
            user_agent=USER_AGENT,
        )

        with pytest.raises(PyCelonisValueError):
            blocking_client.request("GET", "URL", request_body={}, json={})

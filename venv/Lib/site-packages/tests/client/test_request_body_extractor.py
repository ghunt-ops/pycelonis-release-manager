import io
import typing

import pytest
from pycelonis_core.base.base_model import PyCelonisBaseModel
from pycelonis_core.client.request_body_extractor import RequestBodyExtractor
from pycelonis_core.utils.errors import PyCelonisTypeError


class TestRequestBodyExtractor:
    def test_extract_request_body_from_base_model(self):
        class PyCelonisBaseModelTest(PyCelonisBaseModel):
            name: typing.Optional[str]

        NAME = "TEST_NAME"
        base_model = PyCelonisBaseModelTest(name=NAME)

        content, files, json = RequestBodyExtractor().extract(base_model)

        assert content is None
        assert files is None
        assert json == {"name": NAME}

    def test_extract_request_body_from_list_of_base_models(self):
        class PyCelonisBaseModelTest(PyCelonisBaseModel):
            name: typing.Optional[str]

        NAME1 = "TEST_NAME1"
        NAME2 = "TEST_NAME2"
        base_model1 = PyCelonisBaseModelTest(name=NAME1)
        base_model2 = PyCelonisBaseModelTest(name=NAME2)

        content, files, json = RequestBodyExtractor().extract([base_model1, base_model2])

        assert content is None
        assert files is None
        assert json == [{"name": NAME1}, {"name": NAME2}]

    def test_extract_request_body_from_tuple_of_base_models(self):
        class PyCelonisBaseModelTest(PyCelonisBaseModel):
            name: typing.Optional[str]

        NAME1 = "TEST_NAME1"
        NAME2 = "TEST_NAME2"
        base_model1 = PyCelonisBaseModelTest(name=NAME1)
        base_model2 = PyCelonisBaseModelTest(name=NAME2)

        content, files, json = RequestBodyExtractor().extract((base_model1, base_model2))

        assert content is None
        assert files is None
        assert json == ({"name": NAME1}, {"name": NAME2})

    def test_extract_request_body_from_dict_of_base_models(self):
        class PyCelonisBaseModelTest(PyCelonisBaseModel):
            name: typing.Optional[str]

        NAME1 = "TEST_NAME1"
        NAME2 = "TEST_NAME2"
        base_model1 = PyCelonisBaseModelTest(name=NAME1)
        base_model2 = PyCelonisBaseModelTest(name=NAME2)

        content, files, json = RequestBodyExtractor().extract({"model1": base_model1, "model2": base_model2})

        assert content is None
        assert files is None
        assert json == {"model1": {"name": NAME1}, "model2": {"name": NAME2}}

    @pytest.mark.parametrize(
        "request_body",
        [True, 123, 123.456],
    )
    def test_extract_request_body_from_primitive_type(self, request_body):
        content, files, json = RequestBodyExtractor().extract(request_body)

        assert content is None
        assert files is None
        assert json == request_body

    def test_extract_request_body_from_string(self):
        TEST_STRING = "TEST_STRING"
        content, files, json = RequestBodyExtractor().extract(TEST_STRING)

        assert content == TEST_STRING
        assert files is None
        assert json is None

    def test_extract_request_body_from_bytesio(self):
        TEST_BYTE_STRING = b"TEST_STRING"

        with io.BytesIO(TEST_BYTE_STRING) as f:
            content, files, json = RequestBodyExtractor().extract(f)

            assert content is None
            assert files is None
            assert json == f

    def test_extract_request_body_from_buffered_reader(self):
        TEST_BYTE_STRING = b"TEST_STRING"

        with io.BytesIO(TEST_BYTE_STRING) as f:
            with io.BufferedReader(f) as buffered_reader:
                content, files, json = RequestBodyExtractor().extract(buffered_reader)

                assert content is None
                assert files is None
                assert json == buffered_reader

    def test_extract_request_body_from_unsupported_object_raises_type_error(self):
        with pytest.raises(PyCelonisTypeError):
            RequestBodyExtractor().extract(RequestBodyExtractor())

    def test_extract_request_body_from_multipart_dict(self):
        TEST_BYTE_STRING = b"TEST_STRING"

        with io.BytesIO(TEST_BYTE_STRING) as f:
            multipart_input = {"file": f}
            content, files, json = RequestBodyExtractor().extract(multipart_input)

            assert content is None
            assert files == multipart_input
            assert json is None

    def test_extract_request_body_from_multipart_tuple(self):
        TEST_BYTE_STRING = b"TEST_STRING"

        with io.BytesIO(TEST_BYTE_STRING) as f:
            multipart_input = {"file": ("file_name", f)}
            content, files, json = RequestBodyExtractor().extract(multipart_input)

            assert content is None
            assert files == multipart_input
            assert json is None

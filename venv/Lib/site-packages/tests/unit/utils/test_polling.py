from unittest.mock import Mock, patch

import pytest
from pycelonis.utils.polling import poll


class TestPoll:
    @patch("time.sleep", return_value=None)
    def test_poll_returns_immediately(self, patched_time_sleep: Mock):
        poll(target=lambda: True, sleep=3)

        patched_time_sleep.assert_not_called()

    @patch("time.sleep", return_value=None)
    def test_poll_returns_after_condition_is_true(self, patched_time_sleep: Mock):
        return_values = [True, False]
        poll(target=lambda: return_values.pop(), sleep=3)

        patched_time_sleep.assert_called_once_with(0.1)

    @patch("time.sleep", return_value=None)
    def test_poll_returns_after_condition_is_true_and_prints_message(self, patched_time_sleep: Mock):
        TEST_MESSAGE = "TEST_MESSAGE"
        return_values = [True]
        pbar = Mock()
        pbar.update = Mock()
        pbar.set_postfix_str = Mock()
        tqdm_mock = Mock(return_value=pbar)

        with patch("tqdm.auto.tqdm", tqdm_mock):
            poll(target=lambda: return_values.pop(), message=lambda target: f"{TEST_MESSAGE}_{target}", sleep=3)

        patched_time_sleep.assert_not_called()
        pbar.update.assert_called_once()
        pbar.set_postfix_str.assert_called_once_with(f"{TEST_MESSAGE}_True")

    @patch("time.sleep", return_value=None)
    def test_poll_returns_after_condition_is_true_with_wait_for_parameter(self, patched_time_sleep: Mock):
        return_values = [False, True]
        poll(target=lambda: return_values.pop(), wait_for=lambda target: not target, sleep=3)

        patched_time_sleep.assert_called_once_with(0.1)

    @patch("time.sleep", return_value=None)
    def test_poll_fails_due_to_error(self, patched_time_sleep: Mock):
        def error_function():
            raise ValueError()

        with pytest.raises(ValueError):
            poll(target=error_function, wait_for=lambda target: not target, sleep=3)

    @patch("time.sleep", return_value=None)
    def test_poll_returns_after_condition_is_true_with_exponential_backoff(self, patched_time_sleep: Mock):
        return_values = [False, True, True, True, True, True, True]

        poll(target=lambda: return_values.pop(), wait_for=lambda target: not target, sleep=3)

        assert len(patched_time_sleep.call_args_list) == 6
        assert patched_time_sleep.call_args_list[0][0][0] == pytest.approx(0.1)
        assert patched_time_sleep.call_args_list[1][0][0] == pytest.approx(0.3)
        assert patched_time_sleep.call_args_list[2][0][0] == pytest.approx(0.9)
        assert patched_time_sleep.call_args_list[3][0][0] == pytest.approx(2.7)
        assert patched_time_sleep.call_args_list[4][0][0] == pytest.approx(3)
        assert patched_time_sleep.call_args_list[5][0][0] == pytest.approx(3)

    @patch("time.sleep", return_value=None)
    def test_poll_returns_after_condition_is_true_with_exponential_backoff_non_default_values(
        self, patched_time_sleep: Mock
    ):
        return_values = [False, True, True, True, True, True, True]

        poll(
            target=lambda: return_values.pop(),
            wait_for=lambda target: not target,
            sleep=3,
            backoff_interval=0.2,
            exponential_rate=4,
        )

        assert len(patched_time_sleep.call_args_list) == 6
        assert patched_time_sleep.call_args_list[0][0][0] == pytest.approx(0.2)
        assert patched_time_sleep.call_args_list[1][0][0] == pytest.approx(0.8)
        assert patched_time_sleep.call_args_list[2][0][0] == pytest.approx(3)
        assert patched_time_sleep.call_args_list[3][0][0] == pytest.approx(3)
        assert patched_time_sleep.call_args_list[4][0][0] == pytest.approx(3)
        assert patched_time_sleep.call_args_list[5][0][0] == pytest.approx(3)

    @patch("time.sleep", return_value=None)
    def test_poll_returns_after_condition_is_true_with_exponential_backoff_non_default_values_max_overflow(
        self, patched_time_sleep: Mock
    ):
        return_values = [False, True, True, True, True, True, True]

        poll(
            target=lambda: return_values.pop(),
            wait_for=lambda target: not target,
            sleep=3,
            backoff_interval=10000000,
            exponential_rate=1e100,
        )

        assert len(patched_time_sleep.call_args_list) == 6

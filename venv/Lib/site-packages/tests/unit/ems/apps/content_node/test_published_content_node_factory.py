import pytest
from pycelonis.ems.apps.content_node import PublishedContentNode, PublishedContentNodeFactory
from pycelonis.ems.apps.content_node.action_flow import PublishedActionFlow
from pycelonis.ems.apps.content_node.analysis import PublishedAnalysis
from pycelonis.ems.apps.content_node.folder import PublishedFolder
from pycelonis.ems.apps.content_node.package import PublishedPackage
from pycelonis.ems.apps.content_node.simulation import PublishedSimulation
from pycelonis.ems.apps.content_node.skill import PublishedSkill
from pycelonis.ems.apps.content_node.view import PublishedView
from pycelonis.ems.studio.content_node import AssetType
from pycelonis.service.package_manager.service import ContentNodeType


class TestPublishedContentNodeFactory:
    @pytest.mark.parametrize(
        "node_type,asset_type,node_class",
        [
            (ContentNodeType.ASSET, AssetType.ANALYSIS.value, PublishedAnalysis),
            (ContentNodeType.ASSET, AssetType.SCENARIO.value, PublishedActionFlow),
            (ContentNodeType.ASSET, AssetType.BOARD.value, PublishedView),
            (ContentNodeType.ASSET, AssetType.SIMULATION_ASSET.value, PublishedSimulation),
            (ContentNodeType.ASSET, AssetType.SKILL.value, PublishedSkill),
            (
                ContentNodeType.ASSET,
                "NEW_ASSET",
                PublishedContentNode,
            ),  # Unknown assets are instantiated as ContentNode
            (ContentNodeType.FOLDER, None, PublishedFolder),
            (ContentNodeType.PACKAGE, None, PublishedPackage),
        ],
    )
    def test_content_node_factory_creates_right_instance(
        self, mock_client, example_content_node_transport, node_type, asset_type, node_class
    ):
        example_content_node_transport.node_type = node_type
        example_content_node_transport.asset_type = asset_type

        content_node = PublishedContentNodeFactory.get_published_content_node(
            mock_client, example_content_node_transport
        )

        assert isinstance(content_node, node_class)
        assert content_node.client == mock_client
        assert content_node.dict() == example_content_node_transport.dict()

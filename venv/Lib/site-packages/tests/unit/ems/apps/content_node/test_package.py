from unittest.mock import Mock

import pytest
from pycelonis.ems.apps.content_node import PublishedContentNode
from pycelonis.ems.apps.content_node.analysis import PublishedAnalysis
from pycelonis.ems.apps.content_node.folder import PublishedFolder
from pycelonis.ems.apps.content_node.simulation import PublishedSimulation
from pycelonis.ems.apps.content_node.view import PublishedView
from pycelonis.ems.studio.content_node import AssetType
from pycelonis.service.package_manager.service import ContentNodeType, PackageManagerService
from pycelonis_core.utils.errors import PyCelonisNotFoundError


class TestPackage:
    def test_synced_published_package_has_synced_values(self, example_published_package, example_package_transport):
        UPDATED_NAME = "NEW_NAME"
        example_package_transport.name = UPDATED_NAME  # Simulate change in EMS
        PackageManagerService.get_api_final_nodes_id = Mock(return_value=example_package_transport)

        example_published_package.sync()

        PackageManagerService.get_api_final_nodes_id.assert_called_once_with(
            example_published_package.client,
            example_published_package.id,
        )
        assert example_published_package.dict() == example_package_transport.dict()


class TestGetContentNode:
    def test_get_published_content_node_returns_content_node(
        self, example_published_package, example_content_node_transport
    ):
        example_content_node_transport.root_node_id = example_published_package.id
        PackageManagerService.get_api_final_nodes_id = Mock(return_value=example_content_node_transport)

        content_node = example_published_package.get_content_node(example_content_node_transport.id)

        PackageManagerService.get_api_final_nodes_id.assert_called_once_with(
            example_published_package.client,
            example_content_node_transport.id,
        )
        assert isinstance(content_node, PublishedContentNode)
        assert content_node.dict() == example_content_node_transport.dict()

    def test_get_published_content_node_not_in_same_package_throws_value_error(
        self, example_published_package, example_content_node_transport
    ):
        example_content_node_transport.root_node_id = "OTHER_PACKAGE_ID"
        PackageManagerService.get_api_final_nodes_id = Mock(return_value=example_content_node_transport)

        with pytest.raises(PyCelonisNotFoundError):
            _ = example_published_package.get_content_node(example_content_node_transport.id)

        PackageManagerService.get_api_final_nodes_id.assert_called_once_with(
            example_published_package.client,
            example_content_node_transport.id,
        )

    def test_get_published_content_nodes_returns_list_of_content_nodes(
        self, example_published_package, example_content_node_transport, example_package_transport
    ):
        example_content_node_transport2 = example_content_node_transport.copy()
        example_content_node_transport2.name = "NEW_NAME"
        PackageManagerService.get_api_final_nodes = Mock(
            return_value=[example_content_node_transport, example_content_node_transport2, example_package_transport]
        )

        content_nodes = example_published_package.get_content_nodes()

        PackageManagerService.get_api_final_nodes.assert_called_once_with(
            example_published_package.client, example_published_package.space_id
        )
        assert len(content_nodes) == 2
        assert isinstance(content_nodes[0], PublishedContentNode)
        assert isinstance(content_nodes[1], PublishedContentNode)
        assert content_nodes[0].dict() == example_content_node_transport.dict()
        assert content_nodes[1].dict() == example_content_node_transport2.dict()

    def test_get_published_content_nodes_with_asset_type_returns_list_of_content_nodes(
        self, example_published_package, example_content_node_transport, example_package_transport
    ):
        example_content_node_transport1 = example_content_node_transport.copy()
        example_content_node_transport1.node_type = ContentNodeType.ASSET
        example_content_node_transport1.asset_type = AssetType.BOARD.value
        example_content_node_transport2 = example_content_node_transport1.copy()
        example_content_node_transport2.name = "NEW_NAME"
        PackageManagerService.get_api_final_nodes = Mock(
            return_value=[
                example_content_node_transport,
                example_content_node_transport1,
                example_content_node_transport2,
                example_package_transport,
            ]
        )

        content_nodes = example_published_package.get_content_nodes(asset_type=AssetType.BOARD)

        PackageManagerService.get_api_final_nodes.assert_called_once_with(
            example_published_package.client, example_published_package.space_id
        )
        assert len(content_nodes) == 2
        assert isinstance(content_nodes[0], PublishedView)
        assert isinstance(content_nodes[1], PublishedView)
        assert content_nodes[0].dict() == example_content_node_transport1.dict()
        assert content_nodes[1].dict() == example_content_node_transport2.dict()

    def test_get_published_content_nodes_with_node_type_returns_list_of_content_nodes(
        self, example_published_package, example_content_node_transport, example_package_transport
    ):
        example_content_node_transport1 = example_content_node_transport.copy()
        example_content_node_transport1.node_type = ContentNodeType.ASSET
        example_content_node_transport1.asset_type = AssetType.BOARD.value
        example_content_node_transport2 = example_content_node_transport1.copy()
        example_content_node_transport2.name = "NEW_NAME"
        PackageManagerService.get_api_final_nodes = Mock(
            return_value=[
                example_content_node_transport,
                example_content_node_transport1,
                example_content_node_transport2,
                example_package_transport,
            ]
        )

        content_nodes = example_published_package.get_content_nodes(node_type=ContentNodeType.ASSET)

        PackageManagerService.get_api_final_nodes.assert_called_once_with(
            example_published_package.client, example_published_package.space_id
        )
        assert len(content_nodes) == 2
        assert isinstance(content_nodes[0], PublishedView)
        assert isinstance(content_nodes[1], PublishedView)
        assert content_nodes[0].dict() == example_content_node_transport1.dict()
        assert content_nodes[1].dict() == example_content_node_transport2.dict()


class TestGetAnalysis:
    def test_get_analysis_returns_analysis(self, example_published_package, example_analysis_transport):
        example_analysis_transport.root_node_id = example_published_package.id
        PackageManagerService.get_api_final_nodes_id = Mock(return_value=example_analysis_transport)

        analysis = example_published_package.get_analysis(example_analysis_transport.id)

        PackageManagerService.get_api_final_nodes_id.assert_called_once_with(
            example_published_package.client,
            example_analysis_transport.id,
        )
        assert isinstance(analysis, PublishedAnalysis)
        assert analysis.dict() == example_analysis_transport.dict()

    def test_get_analyses_returns_analyses(
        self, example_published_package, example_analysis_transport, example_folder_transport
    ):
        example_analysis_transport2 = example_analysis_transport.copy()
        example_analysis_transport2.root_node_id = "NONEXISTENT_ID"
        PackageManagerService.get_api_final_nodes = Mock(
            return_value=[example_analysis_transport, example_analysis_transport2, example_folder_transport]
        )

        analyses = example_published_package.get_analyses()

        PackageManagerService.get_api_final_nodes.assert_called_once_with(
            example_published_package.client, example_published_package.space_id
        )
        assert len(analyses) == 1
        assert analyses[0] == example_analysis_transport


class TestGetFolder:
    def test_get_folder_returns_folder(self, example_published_package, example_folder_transport):
        example_folder_transport.root_node_id = example_published_package.id
        PackageManagerService.get_api_final_nodes_id = Mock(return_value=example_folder_transport)

        folder = example_published_package.get_folder(example_folder_transport.id)

        PackageManagerService.get_api_final_nodes_id.assert_called_once_with(
            example_published_package.client,
            example_folder_transport.id,
        )
        assert isinstance(folder, PublishedFolder)
        assert folder.dict() == example_folder_transport.dict()

    def test_get_folders_returns_folders(
        self, example_published_package, example_analysis_transport, example_folder_transport
    ):
        example_folder_transport2 = example_folder_transport.copy()
        example_folder_transport2.root_node_id = "NONEXISTENT_ID"
        PackageManagerService.get_api_final_nodes = Mock(
            return_value=[example_analysis_transport, example_folder_transport2, example_folder_transport]
        )

        folders = example_published_package.get_folders()

        PackageManagerService.get_api_final_nodes.assert_called_once_with(
            example_published_package.client, example_published_package.space_id
        )
        assert len(folders) == 1
        assert folders[0] == example_folder_transport


class TestGetSimulation:
    def test_get_simulation_returns_simulation(self, example_published_package, example_simulation_transport):
        example_simulation_transport.root_node_id = example_published_package.id
        PackageManagerService.get_api_final_nodes_id = Mock(return_value=example_simulation_transport)

        simulation = example_published_package.get_simulation(example_simulation_transport.id)

        PackageManagerService.get_api_final_nodes_id.assert_called_once_with(
            example_published_package.client,
            example_simulation_transport.id,
        )
        assert isinstance(simulation, PublishedSimulation)
        assert simulation.dict() == example_simulation_transport.dict()

    def test_get_simulations_returns_simulations(
        self, example_published_package, example_simulation_transport, example_folder_transport
    ):
        example_simulation_transport2 = example_simulation_transport.copy()
        example_simulation_transport2.root_node_id = "NONEXISTENT_ID"
        PackageManagerService.get_api_final_nodes = Mock(
            return_value=[example_simulation_transport, example_simulation_transport2, example_folder_transport]
        )

        simulations = example_published_package.get_simulations()

        PackageManagerService.get_api_final_nodes.assert_called_once_with(
            example_published_package.client, example_published_package.space_id
        )
        assert len(simulations) == 1
        assert simulations[0] == example_simulation_transport


class TestGetView:
    def test_get_view_returns_view(self, example_published_package, example_view_transport):
        example_view_transport.root_node_id = example_published_package.id
        PackageManagerService.get_api_final_nodes_id = Mock(return_value=example_view_transport)

        view = example_published_package.get_view(example_view_transport.id)

        PackageManagerService.get_api_final_nodes_id.assert_called_once_with(
            example_published_package.client,
            example_view_transport.id,
        )
        assert isinstance(view, PublishedView)
        assert view.dict() == example_view_transport.dict()

    def test_get_views_returns_views(self, example_published_package, example_view_transport, example_folder_transport):
        example_view_transport2 = example_view_transport.copy()
        example_view_transport2.root_node_id = "NONEXISTENT_ID"
        PackageManagerService.get_api_final_nodes = Mock(
            return_value=[example_view_transport, example_view_transport2, example_folder_transport]
        )

        views = example_published_package.get_views()

        PackageManagerService.get_api_final_nodes.assert_called_with(
            example_published_package.client, example_published_package.space_id
        )
        assert len(views) == 1
        assert views[0] == example_view_transport

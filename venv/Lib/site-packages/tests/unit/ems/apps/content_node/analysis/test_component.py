import pytest
from pycelonis.ems.apps.content_node.analysis.component import (
    AnalysisComponent,
    Boxplot,
    ComponentFactory,
    PivotTable,
    PQLTable,
    SingleKPI,
    WorldMap,
)


class TestSingleKPI:
    def test_single_kpi_query(self):
        single_kpi_raw = {
            "id": "adaa1411-efb1-44c6-ade2-c2eb1d5d3049",
            "type": "single-kpi",
            "title": "TEST KPI",
            "formula": {
                "text": 'COUNT_TABLE("CASE_NEXT_ACTIVITY")',
                "name": "Single KPI",
            },
            "componentFilter": "",
        }

        single_kpi = SingleKPI(**single_kpi_raw)
        query = single_kpi.get_query()
        columns = single_kpi.get_columns()
        filter_ = single_kpi.get_filter()

        assert len(query.columns) == 1
        assert len(query.filters) == 0

        assert query.columns[0] == columns[0]
        assert filter_ is None

        assert query.columns[0].name == "Single KPI"
        assert query.columns[0].query == 'COUNT_TABLE("CASE_NEXT_ACTIVITY")'

    def test_single_kpi_query_with_component_filter(self):
        single_kpi_raw = {
            "id": "adaa1411-efb1-44c6-ade2-c2eb1d5d3049",
            "type": "single-kpi",
            "title": "TEST KPI",
            "formula": {
                "text": 'COUNT_TABLE("CASE_NEXT_ACTIVITY")',
                "name": "Single KPI",
            },
            "componentFilter": 'FILTER "ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN" = \'ACTIVITY3\';',
        }

        single_kpi = SingleKPI(**single_kpi_raw)
        query = single_kpi.get_query()
        columns = single_kpi.get_columns()
        filter_ = single_kpi.get_filter()

        assert len(query.columns) == 1
        assert len(query.filters) == 1

        assert query.columns[0] == columns[0]
        assert query.filters[0] == filter_

        assert query.columns[0].name == "Single KPI"
        assert query.columns[0].query == 'COUNT_TABLE("CASE_NEXT_ACTIVITY")'

        assert query.filters[0].query == 'FILTER "ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN" = \'ACTIVITY3\';'


class TestPQLTable:
    def test_empty_pql_table_query(self):
        pql_table_raw = {
            "id": "3d1f221b-229b-43f7-a5af-aa48a569f72a",
            "type": "pql-table",
            "title": "TEST_TABLE",
            "axis0": [],
            "axis1": [],
            "axis2": [],
            "componentFilter": "",
        }

        table = PQLTable(**pql_table_raw)
        query = table.get_query()
        columns = table.get_columns()
        filter_ = table.get_filter()
        order_by_columns = table.get_order_by_columns()

        assert len(query.columns) == 0
        assert len(query.filters) == 0
        assert len(query.order_by_columns) == 0

        assert query.columns == columns
        assert filter_ is None
        assert query.order_by_columns == order_by_columns

    def test_empty_pql_table_query_with_component_filter(self):
        pql_table_raw = {
            "id": "3d1f221b-229b-43f7-a5af-aa48a569f72a",
            "type": "pql-table",
            "title": "TEST_TABLE",
            "axis0": [],
            "axis1": [],
            "axis2": [],
            "componentFilter": 'FILTER "ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN" = \'ACTIVITY3\';',
        }

        table = PQLTable(**pql_table_raw)
        query = table.get_query()
        columns = table.get_columns()
        filter_ = table.get_filter()
        order_by_columns = table.get_order_by_columns()

        assert len(query.columns) == 0
        assert len(query.filters) == 1
        assert len(query.order_by_columns) == 0

        assert query.columns == columns
        assert filter_ == query.filters[0]
        assert query.order_by_columns == order_by_columns

        assert query.filters[0].query == 'FILTER "ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN" = \'ACTIVITY3\';'

    @pytest.mark.parametrize("ascending", ["ASC", "DESC"])
    def test_pql_table_query_axis0_column(self, ascending):
        pql_table_raw = {
            "id": "3d1f221b-229b-43f7-a5af-aa48a569f72a",
            "type": "pql-table",
            "title": "TEST_TABLE",
            "axis0": [
                {
                    "text": '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN"',
                    "name": "TEST_COLUMN",
                    "sorting": ascending,
                    "sortingIndex": 0,
                },
            ],
            "axis1": [],
            "axis2": [],
            "componentFilter": "",
        }

        table = PQLTable(**pql_table_raw)
        query = table.get_query()
        columns = table.get_columns()
        filter_ = table.get_filter()
        order_by_columns = table.get_order_by_columns()

        assert len(query.columns) == 1
        assert len(query.filters) == 0
        assert len(query.order_by_columns) == 1

        assert query.columns == columns
        assert filter_ is None
        assert query.order_by_columns == order_by_columns

        assert query.columns[0].name == "TEST_COLUMN"
        assert query.columns[0].query == '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN"'

        assert query.order_by_columns[0].query == '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN"'
        assert query.order_by_columns[0].ascending == (ascending == "ASC")

    def test_pql_table_query_multiple_axis0_column(self):
        pql_table_raw = {
            "id": "3d1f221b-229b-43f7-a5af-aa48a569f72a",
            "type": "pql-table",
            "title": "TEST_TABLE",
            "axis0": [
                {
                    "text": '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN0"',
                    "name": "TEST_COLUMN0",
                    "sorting": "ASC",
                    "sortingIndex": 0,
                },
                {
                    "text": '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN1"',
                    "name": "TEST_COLUMN1",
                    "sorting": "ASC",
                    "sortingIndex": 1,
                },
            ],
            "axis1": [],
            "axis2": [],
            "componentFilter": "",
        }

        table = PQLTable(**pql_table_raw)
        query = table.get_query()
        columns = table.get_columns()
        filter_ = table.get_filter()
        order_by_columns = table.get_order_by_columns()

        assert len(query.columns) == 2
        assert len(query.filters) == 0
        assert len(query.order_by_columns) == 2

        assert query.columns == columns
        assert filter_ is None
        assert query.order_by_columns == order_by_columns

        assert query.columns[0].name == "TEST_COLUMN0"
        assert query.columns[0].query == '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN0"'
        assert query.columns[1].name == "TEST_COLUMN1"
        assert query.columns[1].query == '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN1"'

        assert query.order_by_columns[0].query == '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN0"'
        assert query.order_by_columns[0].ascending
        assert query.order_by_columns[1].query == '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN1"'
        assert query.order_by_columns[1].ascending

    def test_pql_table_query_multiple_columns(self):
        pql_table_raw = {
            "id": "3d1f221b-229b-43f7-a5af-aa48a569f72a",
            "type": "pql-table",
            "title": "TEST_TABLE",
            "axis0": [
                {
                    "text": '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN0"',
                    "name": "TEST_COLUMN0",
                    "sorting": "ASC",
                    "sortingIndex": 1,
                },
            ],
            "axis1": [
                {
                    "text": '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN1"',
                    "name": "TEST_COLUMN1",
                }
            ],
            "axis2": [
                {
                    "text": '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN2"',
                    "name": "TEST_COLUMN2",
                    "sorting": "ASC",
                    "sortingIndex": 0,
                }
            ],
            "componentFilter": "",
        }

        table = PQLTable(**pql_table_raw)
        query = table.get_query()
        columns = table.get_columns()
        filter_ = table.get_filter()
        order_by_columns = table.get_order_by_columns()

        assert len(query.columns) == 3
        assert len(query.filters) == 0
        assert len(query.order_by_columns) == 2

        assert query.columns == columns
        assert filter_ is None
        assert query.order_by_columns == order_by_columns

        assert query.columns[0].name == "TEST_COLUMN0"
        assert query.columns[0].query == '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN0"'

        assert query.columns[1].name == "TEST_COLUMN1"
        assert query.columns[1].query == '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN1"'

        assert query.columns[2].name == "TEST_COLUMN2"
        assert query.columns[2].query == '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN2"'

        # Assert order of order by columns is according to sorting index
        assert query.order_by_columns[0].query == '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN2"'
        assert query.order_by_columns[1].query == '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN0"'

    def test_pql_table_translated_name_true(self):
        pql_table_raw = {
            "id": "3d1f221b-229b-43f7-a5af-aa48a569f72a",
            "type": "pql-table",
            "title": "TEST_TABLE",
            "axis0": [
                {
                    "text": '"ACTIVITY_TABLE"."ACTIVITY_EN0"',
                    "name": "TEST_COLUMN0",
                    "type": "dimension",
                    "sorting": "ASC",
                    "sortingIndex": 0,
                    "translatedName": "ACTIVITY_EN",
                },
                {
                    "text": '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN1"',
                    "name": "TEST_COLUMN1",
                    "sorting": "ASC",
                    "sortingIndex": 1,
                },
            ],
            "axis1": [],
            "axis2": [],
            "componentFilter": "",
        }

        table = PQLTable(**pql_table_raw)
        columns = table.get_columns()

        assert columns[0].name == "ACTIVITY_EN"
        assert columns[1].name == "TEST_COLUMN1"

    def test_pql_table_translated_name_false(self):
        pql_table_raw = {
            "id": "3d1f221b-229b-43f7-a5af-aa48a569f72a",
            "type": "pql-table",
            "title": "TEST_TABLE",
            "axis0": [
                {
                    "text": '"ACTIVITY_TABLE"."ACTIVITY_EN0"',
                    "name": "TEST_COLUMN0",
                    "type": "dimension",
                    "sorting": "ASC",
                    "sortingIndex": 0,
                    "translatedName": "ACTIVITY_EN",
                },
            ],
            "axis1": [],
            "axis2": [],
            "componentFilter": "",
        }

        table = PQLTable(**pql_table_raw)
        columns = table.get_columns(use_translated_names=False)

        assert columns[0].name == "TEST_COLUMN0"


class TestPivotTable:
    def test_pivot_table_multiple_columns(self):
        pivot_table_raw = {
            "id": "3d1f221b-229b-43f7-a5af-aa48a569f72a",
            "type": "pivot",
            "title": "TEST_TABLE",
            "axis0": [
                {
                    "text": '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN0"',
                    "name": "TEST_COLUMN0",
                },
            ],
            "axis1": [
                {
                    "text": '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN1"',
                    "name": "TEST_COLUMN1",
                }
            ],
            "axis2": [
                {
                    "text": '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN2"',
                    "name": "TEST_COLUMN2",
                }
            ],
            "componentFilter": "",
        }

        table = PivotTable(**pivot_table_raw)
        query = table.get_query()
        columns = table.get_columns()
        filter_ = table.get_filter()

        assert len(query.columns) == 3
        assert len(query.filters) == 0

        assert query.columns == columns
        assert filter_ is None

        assert query.columns[0].name == "TEST_COLUMN0"
        assert query.columns[0].query == '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN0"'

        assert query.columns[1].name == "TEST_COLUMN1"
        assert query.columns[1].query == '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN1"'

        assert query.columns[2].name == "TEST_COLUMN2"
        assert query.columns[2].query == '"ACTIVITY_NEXT_ACTIVITY"."ACTIVITY_EN2"'


class TestBoxplot:
    def test_boxplot_multiple_columns(self):
        boxplot_raw = {
            "id_": "3d1f221b-229b-43f7-a5af-aa48a569f72a",
            "type": "boxplot",
            "title": "TEST_TABLE",
            "dimension": {
                "text": '"ACTIVITY_TABLE"."ACTIVITY_EN"',
                "name": "Dimension",
                "translatedName": "Dimension",
                "translatedText": '"ACTIVITY_TABLE"."ACTIVITY_EN"',
            },
            "distribution": {
                "text": 'MONTH("ACTIVITY_TABLE"."_CELONIS_CHANGE_DATE")',
                "name": "Distribution",
                "translatedName": "Distribution",
                "translatedText": 'MONTH("ACTIVITY_TABLE"."_CELONIS_CHANGE_DATE")',
            },
            "componentFilter": "",
        }

        table = Boxplot(**boxplot_raw)
        query = table.get_query()
        columns = table.get_columns()
        filter_ = table.get_filter()

        assert len(query.columns) == 2
        assert len(query.filters) == 0

        assert query.columns == columns
        assert filter_ is None

        assert query.columns[0].name == "Dimension"
        assert query.columns[0].query == '"ACTIVITY_TABLE"."ACTIVITY_EN"'

        assert query.columns[1].name == "Distribution"
        assert query.columns[1].query == 'MONTH("ACTIVITY_TABLE"."_CELONIS_CHANGE_DATE")'


class TestWorldMap:
    def test_world_map_multiple_columns(self):
        world_map = {
            "id_": "3d1f221b-229b-43f7-a5af-aa48a569f72a",
            "type": "boxplot",
            "title": "TEST_TABLE",
            "tooltipFormula": {"text": '"ACTIVITY_TABLE"."ACTIVITY_EN"'},
            "formula": {"text": "'DE'", "name": "location"},
            "kpiFormula": {"text": 'COUNT_TABLE("ACTIVITY_TABLE")', "name": "KPI", "translatedName": "KPI"},
            "componentFilter": "",
        }

        table = WorldMap(**world_map)
        query = table.get_query()
        columns = table.get_columns()
        filter_ = table.get_filter()

        assert len(query.columns) == 3
        assert len(query.filters) == 0

        assert query.columns == columns
        assert filter_ is None

        assert query.columns[0].name == "location"
        assert query.columns[0].query == "'DE'"

        assert query.columns[1].name == "KPI"
        assert query.columns[1].query == 'COUNT_TABLE("ACTIVITY_TABLE")'

        assert query.columns[2].name == "TooltipFormula"
        assert query.columns[2].query == '"ACTIVITY_TABLE"."ACTIVITY_EN"'


class TestComponentFactory:
    @pytest.mark.parametrize(
        "raw_component,parsed_component_class",
        [
            (
                {
                    "id_": "3d1f221b-229b-43f7-a5af-aa48a569f72a",
                    "type": "pql-table",
                    "title": "TEST_TABLE",
                    "axis0": [],
                    "axis1": [],
                    "axis2": [],
                    "componentFilter": "",
                },
                PQLTable,
            ),
            (
                {
                    "id_": "3d1f221b-229b-43f7-a5af-aa48a569f72a",
                    "type": "single-kpi",
                    "title": "TEST_TABLE",
                    "formula": {
                        "text": 'COUNT_TABLE("CASE_NEXT_ACTIVITY")',
                        "name": "Single KPI",
                    },
                    "componentFilter": "",
                },
                SingleKPI,
            ),
            (
                {
                    "id_": "3d1f221b-229b-43f7-a5af-aa48a569f72a",
                    "type": "unsupported-component",
                    "title": "TEST_TABLE",
                    "formula": {
                        "text": 'COUNT_TABLE("CASE_NEXT_ACTIVITY")',
                        "name": "Single KPI",
                    },
                    "componentFilter": "",
                },
                AnalysisComponent,
            ),
            (
                {
                    "id_": "3d1f221b-229b-43f7-a5af-aa48a569f72a",
                    "type": "pivot",
                    "title": "TEST_TABLE",
                    "axis0": [],
                    "axis1": [],
                    "axis2": [],
                    "componentFilter": "",
                },
                PivotTable,
            ),
            (
                {
                    "id_": "3d1f221b-229b-43f7-a5af-aa48a569f72a",
                    "type": "boxplot",
                    "title": "TEST_TABLE",
                    "dimension": {},
                    "distribution": {},
                    "componentFilter": "",
                },
                Boxplot,
            ),
            (
                {
                    "id_": "3d1f221b-229b-43f7-a5af-aa48a569f72a",
                    "type": "world-map",
                    "title": "TEST_TABLE",
                    "formula": {},
                    "kpiFormula": {},
                    "tooltipFormula": {},
                    "componentFilter": "",
                },
                WorldMap,
            ),
        ],
    )
    def test_get_component_returns_proper_component(self, raw_component, parsed_component_class):
        assert ComponentFactory.get_component(AnalysisComponent(**raw_component)) == parsed_component_class(
            **raw_component
        )

    def test_get_components_returns_proper_components(self):
        single_kpi = AnalysisComponent(
            **{
                "id_": "3d1f221b-229b-43f7-a5af-aa48a569f72a",
                "type": "single-kpi",
                "title": "TEST_TABLE",
                "formula": {
                    "text": 'COUNT_TABLE("CASE_NEXT_ACTIVITY")',
                    "name": "Single KPI",
                },
                "componentFilter": "",
            }
        )
        pql_table = AnalysisComponent(
            **{
                "id_": "3d1f221b-229b-43f7-a5af-aa48a569f72a",
                "type": "pql-table",
                "title": "TEST_TABLE",
                "axis0": [],
                "axis1": [],
                "axis2": [],
                "componentFilter": "",
            }
        )

        components = ComponentFactory.get_components([single_kpi, pql_table])

        assert components[0] == SingleKPI(**single_kpi.dict())
        assert components[1] == PQLTable(**pql_table.dict())

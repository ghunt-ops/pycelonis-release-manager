from pycelonis.ems.apps.content_node.analysis.content import (
    AnalysisComponent,
    AnalysisContent,
    AnalysisDocument,
    AnalysisDraft,
    AnalysisInfo,
    AnalysisSheet,
)
from pycelonis.service.process_analytics.service import KpiTransport
from pycelonis_core.base.collection import CelonisCollection


class TestPublishedAnalysisContent:
    def test_published_analysis_content_has_correct_property_types(self, analysis_content):
        content = AnalysisContent(**analysis_content)

        assert isinstance(content.analysis, AnalysisInfo)
        assert isinstance(content.kpis, CelonisCollection)
        assert isinstance(content.draft, AnalysisDraft)

    def test_published_analysis_has_variables_property(self, analysis_content):
        content = AnalysisContent(**analysis_content)
        draft = content.draft
        document = draft.document

        assert document.variables is None

    def test_analysis_kpis_have_correct_property_types(self, analysis_content):
        kpis = AnalysisContent(**analysis_content).kpis

        assert isinstance(kpis, CelonisCollection)
        assert all([isinstance(kpi, KpiTransport) for kpi in kpis])

    def test_analysis_draft_has_correct_property_types(self, analysis_content):
        draft = AnalysisContent(**analysis_content).draft

        assert isinstance(draft, AnalysisDraft)

    def test_analysis_document_has_correct_property_types(self, analysis_content):
        document = AnalysisContent(**analysis_content).draft.document

        assert isinstance(document, AnalysisDocument)
        assert document.sheets == document.components

    def test_analysis_sheets_have_correct_property_types(self, analysis_content):
        sheets = AnalysisContent(**analysis_content).draft.document.sheets

        assert isinstance(sheets, CelonisCollection)
        assert all([isinstance(sheet, AnalysisSheet) for sheet in sheets])

    def test_analysis_sheet_components_have_correct_property_types(self, analysis_content):
        components = AnalysisContent(**analysis_content).draft.document.sheets[0].components

        assert isinstance(components, CelonisCollection)
        assert all([isinstance(sheet, AnalysisComponent) for sheet in components])


class TestAnalysisDocument:
    def test_analysis_document_filter(self):
        raw_document = {
            "id": "4059c58d-138f-4384-95f6-17f2bf6f1995",
            "name": "TEST_ANALYSIS_COMPONENT",
            "components": [],
            "statelessLoadScript": 'FILTER "ACTIVITY_TABLE"."ACTIVITY_EN" = \'ACTIVITY1\';',
        }

        document = AnalysisDocument(**raw_document)
        document_filter = document.get_filter()

        assert document_filter.query == 'FILTER "ACTIVITY_TABLE"."ACTIVITY_EN" = \'ACTIVITY1\';'

    def test_analysis_document_empty_filter(self):
        raw_document = {
            "id": "4059c58d-138f-4384-95f6-17f2bf6f1995",
            "name": "TEST_ANALYSIS_COMPONENT",
            "components": [],
            "statelessLoadScript": "",
        }

        document = AnalysisDocument(**raw_document)
        document_filter = document.get_filter()

        assert document_filter is None


class TestAnalysisSheet:
    def test_analysis_sheet_filter(self):
        raw_sheet = {
            "id": "c3bcbcb4-967d-4b9d-a851-f0bcf59f10fe",
            "name": "Test Sheet",
            "sheet_filter": {"text": 'FILTER "ACTIVITY_TABLE"."ACTIVITY_EN" = \'ACTIVITY1\';'},
            "components": [],
        }

        sheet = AnalysisSheet(**raw_sheet)
        sheet_filter = sheet.get_filter()

        assert sheet_filter.query == 'FILTER "ACTIVITY_TABLE"."ACTIVITY_EN" = \'ACTIVITY1\';'

    def test_analysis_sheet_empty_filter(self):
        raw_sheet = {
            "id": "c3bcbcb4-967d-4b9d-a851-f0bcf59f10fe",
            "name": "Test Sheet",
            "sheet_filter": {"text": ""},
            "components": [],
        }

        sheet = AnalysisSheet(**raw_sheet)
        sheet_filter = sheet.get_filter()

        assert sheet_filter is None

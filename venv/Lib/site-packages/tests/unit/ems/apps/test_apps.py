from unittest.mock import Mock

import pytest
from pycelonis.ems.apps import Apps, PublishedSpace
from pycelonis.service.package_manager.service import PackageManagerService


@pytest.fixture()
def apps(mock_client):
    return Apps(mock_client)


class TestApps:
    def test_get_published_space_returns_space(self, apps, example_space_transport):
        PackageManagerService.get_api_spaces_id = Mock()
        PackageManagerService.get_api_spaces_id.return_value = example_space_transport

        space = apps.get_space(example_space_transport.id)

        PackageManagerService.get_api_spaces_id.assert_called_with(
            apps.client,
            example_space_transport.id,
        )
        assert isinstance(space, PublishedSpace)
        assert space.dict() == example_space_transport.dict()

    def test_get_published_spaces_returns_list_of_spaces(self, apps, example_space_transport):
        example_space_transport2 = example_space_transport.copy()
        example_space_transport2.name = "NEW_NAME"

        PackageManagerService.get_api_spaces = Mock()
        PackageManagerService.get_api_spaces.return_value = [example_space_transport, example_space_transport2]

        spaces = apps.get_spaces()

        PackageManagerService.get_api_spaces.assert_called_with(
            apps.client,
        )
        assert len(spaces) == 2
        assert isinstance(spaces[0], PublishedSpace)
        assert isinstance(spaces[1], PublishedSpace)
        assert spaces[0].dict() == example_space_transport.dict()
        assert spaces[1].dict() == example_space_transport2.dict()

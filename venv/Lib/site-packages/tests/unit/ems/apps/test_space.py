from unittest.mock import Mock

import pytest
from pycelonis.ems.apps import PublishedSpace
from pycelonis.ems.apps.content_node.package import PublishedPackage
from pycelonis.service.package_manager.service import PackageManagerService
from pycelonis_core.utils.errors import PyCelonisNotFoundError


class TestPublishedSpace:
    def test_published_space_from_transport_has_same_values_as_transport(self, mock_client, example_space_transport):
        space = PublishedSpace.from_transport(mock_client, example_space_transport)

        assert isinstance(space, PublishedSpace)
        assert space.client == mock_client
        assert space.dict() == example_space_transport.dict()

    def test_synced_published_space_has_synced_values(self, example_published_space, example_space_transport):
        UPDATED_NAME = "NEW_NAME"

        space, remote_space_transport = example_published_space, example_space_transport
        remote_space_transport.name = UPDATED_NAME  # Simulate change in EMS

        PackageManagerService.get_api_spaces_id = Mock()
        PackageManagerService.get_api_spaces_id.return_value = remote_space_transport

        space.sync()

        PackageManagerService.get_api_spaces_id.assert_called_once_with(
            space.client,
            space.id,
        )
        assert space.dict() == remote_space_transport.dict()


class TestGetPackage:
    def test_get_published_package_returns_package(self, example_published_space, example_package_transport):
        example_package_transport.space_id = example_published_space.id
        PackageManagerService.get_api_final_nodes_id = Mock(return_value=example_package_transport)

        package = example_published_space.get_package(example_package_transport.id)

        PackageManagerService.get_api_final_nodes_id.assert_called_with(
            example_published_space.client,
            example_package_transport.id,
        )
        assert isinstance(package, PublishedPackage)
        assert package.dict() == example_package_transport.dict()

    def test_get_published_package_with_content_node_id_raises_error(
        self, example_published_space, example_content_node_transport
    ):
        PackageManagerService.get_api_final_nodes_id = Mock(return_value=example_content_node_transport)

        with pytest.raises(PyCelonisNotFoundError):
            _ = example_published_space.get_package(example_content_node_transport.id)

        PackageManagerService.get_api_final_nodes_id.assert_called_with(
            example_published_space.client,
            example_content_node_transport.id,
        )

    def test_get_published_packages_returns_list_of_packages(
        self, example_published_space, example_package_transport, example_content_node_transport
    ):
        example_package_transport2 = example_package_transport.copy()
        example_package_transport2.name = "NEW_NAME"
        PackageManagerService.get_api_final_nodes = Mock(
            return_value=[example_package_transport, example_package_transport2, example_content_node_transport]
        )

        packages = example_published_space.get_packages()

        PackageManagerService.get_api_final_nodes.assert_called_with(
            example_published_space.client, example_published_space.id
        )
        assert len(packages) == 2
        assert isinstance(packages[0], PublishedPackage)
        assert isinstance(packages[1], PublishedPackage)
        assert packages[0].dict() == example_package_transport.dict()
        assert packages[1].dict() == example_package_transport2.dict()

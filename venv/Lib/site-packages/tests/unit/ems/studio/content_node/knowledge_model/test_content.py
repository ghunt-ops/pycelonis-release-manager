from unittest.mock import Mock

import pytest
from pycelonis.ems.studio.content_node.knowledge_model import FinalKnowledgeModelContent
from pycelonis.errors import PyCelonisQueryResolutionError
from pycelonis.service.integration.service import DataQuery, QueryEnvironment
from pycelonis.service.semantic_layer.service import (
    BaseMetadata,
    FinalLayerTransport,
    FinalModelOptions,
    PostBatchQueryTransport,
    SemanticLayerService,
)
from pycelonis_core.base.collection import CelonisCollection


@pytest.fixture(scope="function")
def example_post_batch_query_transport_no_query_environment():
    return PostBatchQueryTransport(
        **{
            "analysis_commands": [
                {
                    "id": None,
                    "request": {
                        "cube_id": None,
                        "commands": [
                            {
                                "computation_id": 0,
                                "queries": ['TABLE (\nKPI("test_kpi") AS "KPI"\n)\nNOLIMIT;'],
                                "is_transient": False,
                            }
                        ],
                    },
                }
            ],
        }
    )


@pytest.fixture(scope="function")
def example_post_batch_query_transport_more_requests():
    return PostBatchQueryTransport(
        **{
            "analysis_commands": [
                {
                    "id": None,
                    "request": {  # noqa
                        "cube_id": None,
                        "commands": [
                            {
                                "computation_id": 0,
                                "queries": ['TABLE (\nKPI("test_kpi") AS "KPI"\n)\nNOLIMIT;'],
                                "is_transient": False,
                            }
                        ],
                    },
                    "request": {  # noqa
                        "cube_id": None,
                        "commands": [
                            {
                                "computation_id": 0,
                                "queries": ['TABLE (\nKPI("test_kpi") AS "KPI"\n)\nNOLIMIT;'],
                                "is_transient": False,
                            }
                        ],
                    },
                }
            ],
        }
    )


@pytest.fixture(scope="function")
def example_post_batch_query_transport_no_requests():
    return PostBatchQueryTransport(
        **{
            "analysis_commands": [{"id": None}],
        }
    )


@pytest.fixture(scope="function")
def example_post_batch_query_transport_no_commands():
    return PostBatchQueryTransport(**{})


@pytest.fixture(scope="function")
def example_post_batch_query_transport_more_commands():
    return PostBatchQueryTransport(
        **{
            "analysis_commands": [{"id": None}],  # noqa
            "analysis_commands": [{"id": None}],  # noqa
        }
    )


class TestKnowledgeModel:
    @pytest.mark.parametrize(
        "final_options",
        [True, False],
    )
    def test_get_content_node_returns_knowledge_model_content(
        self, final_options, example_package, example_knowledge_model, example_knowledge_model_content
    ):
        SemanticLayerService.post_api_layer_id_name_final = Mock(return_value=example_knowledge_model_content)

        content = example_knowledge_model.get_content(
            with_variable_replacement=final_options,
            with_autogenerated_data_model_data=final_options,
            with_default_values=final_options,
            validate_pql=final_options,
            with_unknown_variables_validation=final_options,
        )

        SemanticLayerService.post_api_layer_id_name_final.assert_called_once_with(
            example_package.client,
            example_knowledge_model.root_with_key,
            FinalModelOptions(
                with_variable_replacement=final_options,
                with_autogenerated_data_model_data=final_options,
                with_default_values=final_options,
                validate_pql=final_options,
                with_unknown_variables_validation=final_options,
            ),
        )
        assert isinstance(content, FinalKnowledgeModelContent)
        assert isinstance(content.kpis, CelonisCollection)
        assert isinstance(content.records, CelonisCollection)
        assert isinstance(content.variables, CelonisCollection)
        assert isinstance(content.filters, CelonisCollection)
        assert isinstance(content.activities, CelonisCollection)
        assert isinstance(content.actions, CelonisCollection)
        assert isinstance(content.anomalies, CelonisCollection)
        assert isinstance(content.event_logs, CelonisCollection)
        assert isinstance(content.custom_objects, CelonisCollection)

    @pytest.mark.parametrize(
        "custom_objects",
        [
            [BaseMetadata(**{"id": "TEST_LIST", "custom_attributes": {"TEST_ATTRIBUTE": {"TEST": "TEST"}}})],
            [BaseMetadata(**{"id": "TEST_DICT", "custom_attributes": [{"TEST": "TEST"}]})],
            [BaseMetadata(**{"id": "TEST_STRING", "custom_attributes": "string_attribute"})],
            [BaseMetadata(**{"id": "TEST_STRING_CONTAINING_FLOAT", "custom_attributes": "1.0"})],
            [BaseMetadata(**{"id": "TEST_STRING_CONTAINING_INT", "custom_attributes": "1"})],
            [BaseMetadata(**{"id": "TEST_STRING_CONTAINING_BOOL", "custom_attributes": "True"})],
            [BaseMetadata(**{"id": "TEST_INT", "custom_attributes": 1})],
            [BaseMetadata(**{"id": "TEST_BOOL", "custom_attributes": True})],
            [BaseMetadata(**{"id": "TEST_FLOAT", "custom_attributes": 1.0})],
        ],
    )
    def test_get_content_node_with_custom_attributes_returns_knowledge_model_content(
        self, example_knowledge_model, example_knowledge_model_content, custom_objects
    ):
        adjusted_content = FinalLayerTransport(**example_knowledge_model_content.json_dict())
        adjusted_content.layer.custom_objects = custom_objects
        SemanticLayerService.post_api_layer_id_name_final = Mock(return_value=adjusted_content)

        content = example_knowledge_model.get_content()

        assert content.custom_objects[0].dict() == custom_objects[0].dict()
        assert isinstance(content.custom_objects[0].dict(), type(custom_objects[0].dict()))

    def test_resolve_query_return(
        self,
        example_package,
        example_knowledge_model,
        example_post_batch_query_transport,
        example_query,
        example_layer_compute_transport,
        example_knowledge_model_content,
    ):
        SemanticLayerService.post_api_layer_id_name_final = Mock(return_value=example_knowledge_model_content)
        SemanticLayerService.post_api_knowledge_model_resolve_query = Mock(
            return_value=example_post_batch_query_transport
        )

        data_query, query_environment = example_knowledge_model.resolve_query(example_query)

        SemanticLayerService.post_api_knowledge_model_resolve_query.assert_called_once_with(
            example_package.client, example_layer_compute_transport
        )

        assert isinstance(data_query, DataQuery)
        assert isinstance(query_environment, QueryEnvironment)
        assert data_query.queries == example_query.queries

    @pytest.mark.parametrize(
        "value",
        [
            "example_post_batch_query_transport_no_query_environment",
            "example_post_batch_query_transport_more_requests",
            "example_post_batch_query_transport_no_requests",
            "example_post_batch_query_transport_more_commands",
            "example_post_batch_query_transport_no_commands",
        ],
    )
    def test_resolve_query_components(
        self,
        value,
        request,
        example_package,
        example_knowledge_model,
        example_query,
        example_layer_compute_transport,
        example_knowledge_model_content,
    ):
        SemanticLayerService.post_api_layer_id_name_final = Mock(return_value=example_knowledge_model_content)
        SemanticLayerService.post_api_knowledge_model_resolve_query = Mock(return_value=request.getfixturevalue(value))

        with pytest.raises(PyCelonisQueryResolutionError):
            example_knowledge_model.resolve_query(example_query)

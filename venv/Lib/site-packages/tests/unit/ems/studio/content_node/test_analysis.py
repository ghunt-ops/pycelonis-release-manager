from unittest.mock import Mock

from pycelonis.service.package_manager.service import PackageManagerService
from pycelonis.service.process_analytics.service import ProcessAnalyticsService


class TestAnalysis:
    def test_updated_analysis_has_updated_values(self, example_analysis, example_analysis_transport):
        UPDATED_SERIALIZED_CONTENT = (
            '{"key": "TEST_ANALYSIS_UPDATED","transportId": "ID","description": "TEST_DESCRIPTION"}'
        )

        example_analysis.serialized_content = UPDATED_SERIALIZED_CONTENT  # Simulate local change
        example_analysis_transport.serialized_content = UPDATED_SERIALIZED_CONTENT  # Simulate change in EMS

        ProcessAnalyticsService.put_analysis_v2_api_analysis_analysis_id_autosave_scope = Mock()
        ProcessAnalyticsService.put_analysis_v2_api_analysis_analysis_id_autosave = Mock()
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_analysis_transport)

        example_analysis.update()

        ProcessAnalyticsService.put_analysis_v2_api_analysis_analysis_id_autosave_scope.assert_called_once_with(
            example_analysis.client, example_analysis.id, example_analysis._get_content().draft
        )
        ProcessAnalyticsService.put_analysis_v2_api_analysis_analysis_id_autosave.assert_called_once_with(
            example_analysis.client, example_analysis.id, example_analysis._get_content().draft, release=False
        )
        PackageManagerService.get_api_nodes_id.assert_called_once_with(example_analysis.client, example_analysis.id)
        assert example_analysis.dict() == example_analysis_transport.dict()

from unittest.mock import Mock

import pytest
from pycelonis.ems.studio.content_node.variable import Variable
from pycelonis.service.package_manager.service import PackageManagerService
from pycelonis_core.utils.errors import PyCelonisNotFoundError


class TestVariable:
    def test_variable_from_transport_has_same_values_as_transport(
        self, mock_client, example_package, example_variable_transport
    ):
        variable = Variable.from_transport(mock_client, example_package.key, example_variable_transport)

        assert isinstance(variable, Variable)
        assert variable.client == mock_client
        assert variable.dict(exclude={"package_key"}) == example_variable_transport.dict()

    def test_updated_variable_has_updated_values(self, example_variable, example_variable_transport):
        UPDATED_VALUE = "VALUE_NEW"
        UPDATED_DESCRIPTION = "DESCRIPTION_NEW"

        example_variable.value = UPDATED_VALUE  # Simulate local change
        example_variable_transport.value = UPDATED_VALUE  # Simulate change in EMS
        example_variable_transport.description = UPDATED_DESCRIPTION  # Simulate change in EMS
        PackageManagerService.put_api_nodes_by_package_key_package_key_variables_key = Mock(
            return_value=example_variable_transport
        )

        example_variable.update()

        PackageManagerService.put_api_nodes_by_package_key_package_key_variables_key.assert_called_once_with(
            example_variable.client,
            example_variable.package_key,
            example_variable.key,
            example_variable,
        )
        assert example_variable.dict(exclude={"package_key"}) == example_variable_transport.dict()

    def test_synced_variable_has_synced_values(self, example_variable, example_variable_transport):
        UPDATED_DESCRIPTION = "DESCRIPTION_NEW"

        example_variable_transport.description = UPDATED_DESCRIPTION  # Simulate change in EMS
        PackageManagerService.get_api_nodes_by_package_key_package_key_variables_definitions_with_values = Mock(
            return_value=[example_variable_transport]
        )

        example_variable.sync()

        PackageManagerService.get_api_nodes_by_package_key_package_key_variables_definitions_with_values.assert_called_once_with(
            example_variable.client, example_variable.package_key
        )
        assert example_variable.dict(exclude={"package_key"}) == example_variable_transport.dict()

    def test_sync_variable_raises_error_if_variable_does_not_exist(self, example_variable, example_variable_transport):
        PackageManagerService.get_api_nodes_by_package_key_package_key_variables_definitions_with_values = Mock(
            return_value=[]
        )

        with pytest.raises(PyCelonisNotFoundError):
            example_variable.sync()

        PackageManagerService.get_api_nodes_by_package_key_package_key_variables_definitions_with_values.assert_called_once_with(
            example_variable.client, example_variable.package_key
        )

    def test_delete_variable_deletes_correct_variable(self, example_variable):
        PackageManagerService.delete_api_nodes_by_package_key_package_key_variables_key = Mock()

        example_variable.delete()

        PackageManagerService.delete_api_nodes_by_package_key_package_key_variables_key.assert_called_once_with(
            example_variable.client,
            example_variable.package_key,
            example_variable.key,
        )

from unittest.mock import Mock

import pytest
from pycelonis.ems.studio.content_node import AssetType, ContentNode
from pycelonis.ems.studio.content_node.action_flow import ActionFlow
from pycelonis.ems.studio.content_node.analysis import Analysis
from pycelonis.ems.studio.content_node.folder import Folder
from pycelonis.ems.studio.content_node.knowledge_model import KnowledgeModel
from pycelonis.ems.studio.content_node.simulation import Simulation
from pycelonis.ems.studio.content_node.skill import Skill
from pycelonis.ems.studio.content_node.variable import Variable
from pycelonis.ems.studio.content_node.view import View
from pycelonis.errors import PyCelonisNotSupportedError
from pycelonis.service.package_manager.service import (
    ActivatePackageTransport,
    ContentNodeType,
    PackageDeleteTransport,
    PackageHistoryTransport,
    PackageManagerService,
    PackageVersionTransport,
    SaveContentNodeTransport,
    VariableDefinitionWithValue,
)
from pycelonis.service.process_analytics.service import AnalysisPackageConfig, ProcessAnalyticsService
from pycelonis.service.semantic_layer.service import FinalModelOptions, SemanticLayerService, YamlMetadata
from pycelonis.utils.yaml import dump_yaml
from pycelonis_core.utils.errors import PyCelonisNotFoundError


class TestPackage:
    def test_synced_package_has_synced_values(self, example_package, example_package_transport):
        UPDATED_NAME = "NEW_NAME"
        example_package_transport.name = UPDATED_NAME  # Simulate change in EMS
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_package_transport)

        example_package.sync()

        PackageManagerService.get_api_nodes_id.assert_called_once_with(
            example_package.client,
            example_package.id,
        )
        assert example_package.dict() == example_package_transport.dict()

    def test_update_package_not_supported(self, example_package):
        with pytest.raises(PyCelonisNotSupportedError):
            example_package.update()

    def test_delete_package_deletes_correct_package(self, example_package):
        PackageManagerService.post_api_packages_delete_id = Mock()

        example_package.delete()

        PackageManagerService.post_api_packages_delete_id.assert_called_once_with(
            example_package.client,
            example_package.id,
            PackageDeleteTransport(**example_package.json_dict()),
            soft_delete_package=False,
        )


class TestPackageHistory:
    def test_publish_with_version_set(self, example_package):
        NEW_VERSION = "1.1.1"
        NODE_IDS_TO_EXCLUDE = ["80728d7f-0609-4e31-a221-106eed97dd5f"]
        PackageManagerService.post_api_packages_key_activate = Mock()
        activate_package_transport = ActivatePackageTransport(
            package_key=example_package.key, version=NEW_VERSION, node_ids_to_exclude=NODE_IDS_TO_EXCLUDE
        )

        example_package.publish(version=NEW_VERSION, node_ids_to_exclude=NODE_IDS_TO_EXCLUDE)

        PackageManagerService.post_api_packages_key_activate.assert_called_once_with(
            example_package.client, example_package.key, activate_package_transport
        )

    def test_activate_publish_version_set(self, example_package):
        NEW_VERSION = "1.1.1"
        NODE_IDS_TO_EXCLUDE = ["80728d7f-0609-4e31-a221-106eed97dd5f"]
        activate_package_transport = ActivatePackageTransport(
            package_key=example_package.key, version=NEW_VERSION, node_ids_to_exclude=NODE_IDS_TO_EXCLUDE
        )
        PackageManagerService.get_api_packages_id_next_version = Mock(
            return_value=PackageHistoryTransport(version=NEW_VERSION)
        )
        PackageManagerService.post_api_packages_key_activate = Mock()

        example_package.publish(node_ids_to_exclude=NODE_IDS_TO_EXCLUDE)

        PackageManagerService.get_api_packages_id_next_version.assert_called_once_with(
            example_package.client, example_package.id
        )
        PackageManagerService.post_api_packages_key_activate.assert_called_once_with(
            example_package.client, example_package.key, activate_package_transport
        )

    def test_get_package_history(self, example_package):
        package_history_transport = [PackageHistoryTransport(version="1.1.1")]
        PackageManagerService.get_api_packages_id_history = Mock(return_value=package_history_transport)

        package_history = example_package.get_history()

        PackageManagerService.get_api_packages_id_history.assert_called_once_with(
            example_package.client, example_package.id
        )
        assert package_history == package_history_transport

    def test_load_version(self, example_package):
        PACKAGE_VERSION = "1.1.1"
        ROOT_DRAFT_ID = "8024ad7a-36d9-418e-9cbd-6ac2d6436ef9"
        package_version_transport = PackageVersionTransport(
            package_key=example_package.key,
            version=PACKAGE_VERSION,
            root_draft_id=ROOT_DRAFT_ID,
        )
        PackageManagerService.post_api_packages_id_load_version = Mock()

        example_package.load_version(version=PACKAGE_VERSION, root_draft_id=ROOT_DRAFT_ID)

        PackageManagerService.post_api_packages_id_load_version.assert_called_once_with(
            example_package.client, example_package.id, package_version_transport
        )


class TestGetContentNode:
    def test_get_content_node_returns_content_node(self, example_package, example_content_node_transport):
        example_content_node_transport.root_node_id = example_package.id
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_content_node_transport)

        content_node = example_package.get_content_node(example_content_node_transport.id)

        PackageManagerService.get_api_nodes_id.assert_called_once_with(
            example_package.client,
            example_content_node_transport.id,
        )
        assert isinstance(content_node, ContentNode)
        assert content_node.dict() == example_content_node_transport.dict()

    def test_get_content_node_not_in_same_package_throws_value_error(
        self, example_package, example_content_node_transport
    ):
        example_content_node_transport.root_node_id = "OTHER_PACKAGE_ID"
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_content_node_transport)

        with pytest.raises(PyCelonisNotFoundError):
            _ = example_package.get_content_node(example_content_node_transport.id)

        PackageManagerService.get_api_nodes_id.assert_called_once_with(
            example_package.client,
            example_content_node_transport.id,
        )

    def test_get_content_nodes_returns_list_of_content_nodes(self, example_package, example_content_node_transport):
        example_content_node_transport2 = example_content_node_transport.copy()
        example_content_node_transport2.name = "NEW_NAME"
        PackageManagerService.get_api_nodes_by_root_key_root_key = Mock(
            return_value=[example_content_node_transport, example_content_node_transport2]
        )

        content_nodes = example_package.get_content_nodes()

        PackageManagerService.get_api_nodes_by_root_key_root_key.assert_called_once_with(
            example_package.client, example_package.key, asset_type=None, node_type=None
        )
        assert len(content_nodes) == 2
        assert isinstance(content_nodes[0], ContentNode)
        assert isinstance(content_nodes[1], ContentNode)
        assert content_nodes[0].dict() == example_content_node_transport.dict()
        assert content_nodes[1].dict() == example_content_node_transport2.dict()

    def test_get_content_nodes_with_asset_type_returns_list_of_content_nodes(
        self, example_package, example_content_node_transport
    ):
        example_content_node_transport.node_type = ContentNodeType.ASSET
        example_content_node_transport.asset_type = AssetType.BOARD.value
        example_content_node_transport2 = example_content_node_transport.copy()
        example_content_node_transport2.name = "NEW_NAME"
        PackageManagerService.get_api_nodes_by_root_key_root_key = Mock(
            return_value=[example_content_node_transport, example_content_node_transport2]
        )

        content_nodes = example_package.get_content_nodes(asset_type=AssetType.BOARD)

        PackageManagerService.get_api_nodes_by_root_key_root_key.assert_called_once_with(
            example_package.client, example_package.key, asset_type=AssetType.BOARD.value, node_type=None
        )
        assert len(content_nodes) == 2
        assert isinstance(content_nodes[0], View)
        assert isinstance(content_nodes[1], View)
        assert content_nodes[0].dict() == example_content_node_transport.dict()
        assert content_nodes[1].dict() == example_content_node_transport2.dict()

    def test_get_content_nodes_with_node_type_returns_list_of_content_nodes(
        self, example_package, example_content_node_transport
    ):
        example_content_node_transport.node_type = ContentNodeType.ASSET
        example_content_node_transport.asset_type = AssetType.BOARD.value
        example_content_node_transport1 = example_content_node_transport.copy()
        example_content_node_transport1.name = "NEW_NAME"
        PackageManagerService.get_api_nodes_by_root_key_root_key = Mock(
            return_value=[
                example_content_node_transport,
                example_content_node_transport1,
            ]
        )

        content_nodes = example_package.get_content_nodes(node_type=ContentNodeType.ASSET)

        PackageManagerService.get_api_nodes_by_root_key_root_key.assert_called_once_with(
            example_package.client, example_package.key, asset_type=None, node_type=ContentNodeType.ASSET.value
        )
        assert len(content_nodes) == 2
        assert isinstance(content_nodes[0], View)
        assert isinstance(content_nodes[1], View)
        assert content_nodes[0].dict() == example_content_node_transport.dict()
        assert content_nodes[1].dict() == example_content_node_transport1.dict()


class TestGetActionFlow:
    def test_get_action_flows_returns_list_of_action_flows(self, example_package, example_action_flow_transport):
        example_action_flow_transport2 = example_action_flow_transport.copy()
        example_action_flow_transport2.key = "NEW_ACTION_FLOW"
        PackageManagerService.get_api_nodes_by_root_key_root_key = Mock(
            return_value=[
                example_action_flow_transport,
                example_action_flow_transport2,
            ]
        )

        action_flows = example_package.get_action_flows()

        PackageManagerService.get_api_nodes_by_root_key_root_key.assert_called_once_with(
            example_package.client, example_package.key, asset_type=AssetType.SCENARIO.value, node_type=None
        )
        assert len(action_flows) == 2
        assert isinstance(action_flows[0], ActionFlow)
        assert isinstance(action_flows[1], ActionFlow)
        assert action_flows[0].dict() == example_action_flow_transport.dict()
        assert action_flows[1].dict() == example_action_flow_transport2.dict()

    def test_get_action_flow_returns_action_flow(self, example_package, example_action_flow_transport):
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_action_flow_transport)

        action_flow = example_package.get_action_flow(example_action_flow_transport.id)

        PackageManagerService.get_api_nodes_id.assert_called_once_with(
            example_package.client, example_action_flow_transport.id
        )
        assert isinstance(action_flow, ActionFlow)
        assert action_flow.dict() == example_action_flow_transport.dict()

    def test_get_nonexistent_action_flow_throws_not_found_error(
        self, example_package, example_knowledge_model_transport
    ):
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_knowledge_model_transport)

        with pytest.raises(PyCelonisNotFoundError):
            example_package.get_action_flow(example_knowledge_model_transport.id)


class TestCreateAndGetAnalysis:
    @pytest.mark.parametrize(
        "analysis_name,analysis_key,analysis_key_set",
        [
            ("TEST_CONTENT_NODE", "TEST_CONTENT_NODE_KEY", "TEST_CONTENT_NODE_KEY"),
            ("TEST_CONTENT_NODE", None, "TEST_CONTENT_NODE"),  # Defaults to folder name
        ],
    )
    def test_create_analysis_returns_new_analysis(
        self,
        example_package,
        example_analysis_transport,
        example_analysis_package_transport,
        analysis_name,
        analysis_key,
        analysis_key_set,
    ):
        DATAMODEL_ID = "TEST_ID"
        create_analysis_transport = AnalysisPackageConfig(
            name=analysis_name,
            key=analysis_key_set,
            parent_node_id=example_package.id,
            data_model_id=DATAMODEL_ID,
            change_default_event_log=False,
        )
        example_analysis_transport.name = analysis_name  # Simulate change in EMS
        example_analysis_transport.key = analysis_key_set  # Simulate change in EMS
        ProcessAnalyticsService.post_analysis_v2_api_analysis = Mock(return_value=example_analysis_package_transport)
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_analysis_transport)

        analysis = example_package.create_analysis(analysis_name, key=analysis_key, data_model_id=DATAMODEL_ID)

        ProcessAnalyticsService.post_analysis_v2_api_analysis.assert_called_once_with(
            example_package.client,
            create_analysis_transport,
        )
        PackageManagerService.get_api_nodes_id.assert_called_once_with(
            example_package.client,
            example_analysis_package_transport.analysis.id,
        )
        assert isinstance(analysis, Analysis)
        assert analysis.dict() == example_analysis_transport.dict()

    def test_get_analyses_returns_list_of_analyses(self, example_package, example_analysis_transport):
        example_analysis_transport2 = example_analysis_transport.copy()
        example_analysis_transport2.key = "NEW_ANALYSIS"
        PackageManagerService.get_api_nodes_by_root_key_root_key = Mock(
            return_value=[
                example_analysis_transport,
                example_analysis_transport2,
            ]
        )

        analyses = example_package.get_analyses()

        PackageManagerService.get_api_nodes_by_root_key_root_key.assert_called_once_with(
            example_package.client, example_package.key, asset_type=AssetType.ANALYSIS.value, node_type=None
        )
        assert len(analyses) == 2
        assert isinstance(analyses[0], Analysis)
        assert isinstance(analyses[1], Analysis)
        assert analyses[0].dict() == example_analysis_transport.dict()
        assert analyses[1].dict() == example_analysis_transport2.dict()

    def test_get_analysis_returns_analysis(self, example_package, example_analysis_transport):
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_analysis_transport)

        analysis = example_package.get_analysis(example_analysis_transport.id)

        PackageManagerService.get_api_nodes_id.assert_called_once_with(
            example_package.client, example_analysis_transport.id
        )
        assert isinstance(analysis, Analysis)
        assert analysis.dict() == example_analysis_transport.dict()

    def test_get_nonexistent_analysis_throws_not_found_error(self, example_package, example_knowledge_model_transport):
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_knowledge_model_transport)

        with pytest.raises(PyCelonisNotFoundError):
            example_package.get_analysis(example_knowledge_model_transport.id)


class TestCreateAndGetFolder:
    @pytest.mark.parametrize(
        "folder_name,folder_key,folder_key_set",
        [
            ("TEST_CONTENT_NODE", "TEST_CONTENT_NODE_KEY", "TEST_CONTENT_NODE_KEY"),
            ("TEST_CONTENT_NODE", None, "TEST_CONTENT_NODE"),  # Defaults to folder name
        ],
    )
    def test_create_folder_returns_new_folder(
        self, example_package, example_content_node_transport, folder_name, folder_key, folder_key_set
    ):
        FOLDER_PUBLIC_AVAILABLE = False
        create_content_node_transport = SaveContentNodeTransport(
            name=folder_name,
            key=folder_key_set,
            node_type=ContentNodeType.FOLDER,
            parent_node_id=example_package.id,
            public_available=FOLDER_PUBLIC_AVAILABLE,
        )
        example_content_node_transport.name = folder_name  # Simulate change in EMS
        example_content_node_transport.public_available = FOLDER_PUBLIC_AVAILABLE
        PackageManagerService.post_api_nodes = Mock(return_value=example_content_node_transport)

        folder = example_package.create_folder(folder_name, key=folder_key, public_available=FOLDER_PUBLIC_AVAILABLE)

        PackageManagerService.post_api_nodes.assert_called_once_with(
            example_package.client,
            create_content_node_transport.json_dict(by_alias=True, exclude_unset=True),
        )
        assert isinstance(folder, Folder)
        assert folder.dict() == example_content_node_transport.dict()

    def test_get_folders_returns_list_of_folders(self, example_package, example_content_node_transport):
        example_content_node_transport2 = example_content_node_transport.copy()
        example_content_node_transport2.name = "NEW_NAME"

        PackageManagerService.get_api_nodes_by_root_key_root_key = Mock(
            return_value=[
                example_content_node_transport,
                example_content_node_transport2,
            ]
        )

        content_nodes = example_package.get_folders()

        PackageManagerService.get_api_nodes_by_root_key_root_key.assert_called_once_with(
            example_package.client, example_package.key, asset_type=None, node_type=ContentNodeType.FOLDER.value
        )
        assert len(content_nodes) == 2
        assert isinstance(content_nodes[0], Folder)
        assert isinstance(content_nodes[1], Folder)
        assert content_nodes[0].dict() == example_content_node_transport.dict()
        assert content_nodes[1].dict() == example_content_node_transport2.dict()

    def test_get_folder_returns_folder(self, example_package, example_content_node_transport):
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_content_node_transport)

        folder = example_package.get_folder(example_content_node_transport.id)

        PackageManagerService.get_api_nodes_id.assert_called_once_with(
            example_package.client, example_content_node_transport.id
        )
        assert isinstance(folder, Folder)
        assert folder.dict() == example_content_node_transport.dict()

    def test_get_nonexistent_folder_throws_not_found_error(self, example_package, example_knowledge_model_transport):
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_knowledge_model_transport)

        with pytest.raises(PyCelonisNotFoundError):
            example_package.get_folder(example_knowledge_model_transport.id)


class TestCreateAndGetKnowledgeModel:
    def test_create_knowledge_model_returns_new_knowledge_model(
        self, example_package, example_knowledge_model_transport
    ):
        WITH_AUTOGENERATED_DATA_MODEL_DATA = False
        WITH_VARIABLE_REPLACEMENT = False
        CONTENT = {
            "kind": "BASE",
            "metadata": {
                "key": example_knowledge_model_transport.key,
                "displayName": example_knowledge_model_transport.name,
            },
            "dataModelId": "ID",
        }
        create_content_node_transport = YamlMetadata(
            parent_node_id=example_package.id,
            final_model_options=FinalModelOptions(
                with_autogenerated_data_model_data=WITH_AUTOGENERATED_DATA_MODEL_DATA,
                with_variable_replacement=WITH_VARIABLE_REPLACEMENT,
            ),
            content=dump_yaml(CONTENT),
        )
        example_knowledge_model_transport.serialized_content = dump_yaml(CONTENT)  # Simulate change in EMS
        SemanticLayerService.post_api_semantic_models = Mock(return_value=example_knowledge_model_transport)

        knowledge_model = example_package.create_knowledge_model(
            CONTENT, with_autogenerated_data_model_data=False, with_variable_replacement=False
        )

        SemanticLayerService.post_api_semantic_models.assert_called_once_with(
            example_package.client,
            create_content_node_transport,
        )
        assert isinstance(knowledge_model, KnowledgeModel)
        assert knowledge_model.dict() == example_knowledge_model_transport.dict()

    def test_get_knowledge_models_returns_list_of_knowledge_models(
        self, example_package, example_knowledge_model_transport
    ):
        example_knowledge_model_transport2 = example_knowledge_model_transport.copy()
        example_knowledge_model_transport2.key = "NEW_KM"
        PackageManagerService.get_api_nodes_by_root_key_root_key = Mock(
            return_value=[
                example_knowledge_model_transport,
                example_knowledge_model_transport2,
            ]
        )

        knowledge_models = example_package.get_knowledge_models()

        PackageManagerService.get_api_nodes_by_root_key_root_key.assert_called_once_with(
            example_package.client, example_package.key, asset_type=AssetType.SEMANTIC_MODEL.value, node_type=None
        )
        assert len(knowledge_models) == 2
        assert isinstance(knowledge_models[0], KnowledgeModel)
        assert isinstance(knowledge_models[1], KnowledgeModel)
        assert knowledge_models[0].dict() == example_knowledge_model_transport.dict()
        assert knowledge_models[1].dict() == example_knowledge_model_transport2.dict()

    def test_get_knowledge_model_returns_knowledge_model(self, example_package, example_knowledge_model_transport):
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_knowledge_model_transport)

        knowledge_model = example_package.get_knowledge_model(example_knowledge_model_transport.id)

        PackageManagerService.get_api_nodes_id.assert_called_once_with(
            example_package.client, example_knowledge_model_transport.id
        )
        assert isinstance(knowledge_model, KnowledgeModel)
        assert knowledge_model.dict() == example_knowledge_model_transport.dict()

    def test_get_nonexistent_knowledge_model_throws_not_found_error(self, example_package, example_analysis_transport):
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_analysis_transport)

        with pytest.raises(PyCelonisNotFoundError):
            example_package.get_knowledge_model(example_analysis_transport.id)


class TestGetSimulation:
    def test_get_simulations_returns_list_of_simulations(self, example_package, example_simulation_transport):
        example_simulation_transport2 = example_simulation_transport.copy()
        example_simulation_transport2.key = "NEW_SIMULATION"
        PackageManagerService.get_api_nodes_by_root_key_root_key = Mock(
            return_value=[
                example_simulation_transport,
                example_simulation_transport2,
            ]
        )

        simulations = example_package.get_simulations()

        PackageManagerService.get_api_nodes_by_root_key_root_key.assert_called_once_with(
            example_package.client, example_package.key, asset_type=AssetType.SIMULATION_ASSET.value, node_type=None
        )
        assert len(simulations) == 2
        assert isinstance(simulations[0], Simulation)
        assert isinstance(simulations[1], Simulation)
        assert simulations[0].dict() == example_simulation_transport.dict()
        assert simulations[1].dict() == example_simulation_transport2.dict()

    def test_get_simulation_returns_simulation(self, example_package, example_simulation_transport):
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_simulation_transport)

        simulation = example_package.get_simulation(example_simulation_transport.id)

        PackageManagerService.get_api_nodes_id.assert_called_once_with(
            example_package.client, example_simulation_transport.id
        )
        assert isinstance(simulation, Simulation)
        assert simulation.dict() == example_simulation_transport.dict()

    def test_get_nonexistent_simulation_throws_not_found_error(
        self, example_package, example_knowledge_model_transport
    ):
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_knowledge_model_transport)

        with pytest.raises(PyCelonisNotFoundError):
            example_package.get_simulation(example_knowledge_model_transport.id)


class TestGetSkill:
    def test_get_skills_returns_list_of_skills(self, example_package, example_skill_transport):
        example_skill_transport2 = example_skill_transport.copy()
        example_skill_transport2.key = "NEW_SKILL"
        PackageManagerService.get_api_nodes_by_root_key_root_key = Mock(
            return_value=[
                example_skill_transport,
                example_skill_transport2,
            ]
        )

        skills = example_package.get_skills()

        PackageManagerService.get_api_nodes_by_root_key_root_key.assert_called_once_with(
            example_package.client, example_package.key, asset_type=AssetType.SKILL.value, node_type=None
        )
        assert len(skills) == 2
        assert isinstance(skills[0], Skill)
        assert isinstance(skills[1], Skill)
        assert skills[0].dict() == example_skill_transport.dict()
        assert skills[1].dict() == example_skill_transport2.dict()

    def test_get_skill_returns_skill(self, example_package, example_skill_transport):
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_skill_transport)

        skill = example_package.get_skill(example_skill_transport.id)

        PackageManagerService.get_api_nodes_id.assert_called_once_with(
            example_package.client, example_skill_transport.id
        )
        assert isinstance(skill, Skill)
        assert skill.dict() == example_skill_transport.dict()

    def test_get_nonexistent_skill_throws_not_found_error(self, example_package, example_knowledge_model_transport):
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_knowledge_model_transport)

        with pytest.raises(PyCelonisNotFoundError):
            example_package.get_skill(example_knowledge_model_transport.id)


class TestCreateGetVariable:
    def test_create_variable_returns_new_variable(self, example_package, example_variable_transport):
        KEY = "KEY"
        VALUE = "VALUE"
        TYPE = "DATA_MODEL"
        TEST_VARIABLE_DESCRIPTION = "TEST_DESCRIPTION"

        create_variable_transport = VariableDefinitionWithValue(
            key=KEY, value=VALUE, type_=TYPE, description=TEST_VARIABLE_DESCRIPTION, runtime=True
        )
        example_variable_transport.key = KEY  # Simulate change in EMS
        example_variable_transport.value = VALUE  # Simulate change in EMS
        example_variable_transport.type_ = TYPE  # Simulate change in EMS
        example_variable_transport.description = TEST_VARIABLE_DESCRIPTION  # Simulate change in EMS
        PackageManagerService.post_api_nodes_by_package_key_package_key_variables = Mock(
            return_value=example_variable_transport
        )

        variable = example_package.create_variable(
            key=KEY, value=VALUE, type_=TYPE, description=TEST_VARIABLE_DESCRIPTION
        )

        PackageManagerService.post_api_nodes_by_package_key_package_key_variables.assert_called_once_with(
            example_package.client,
            example_package.key,
            create_variable_transport,
        )
        assert isinstance(variable, Variable)
        assert variable.package_key == example_package.key
        assert variable.dict(exclude={"package_key"}) == example_variable_transport.dict()

    def test_get_variable_returns_variable(self, example_package, example_variable_transport):
        PackageManagerService.get_api_nodes_by_package_key_package_key_variables_definitions_with_values = Mock(
            return_value=[example_variable_transport]
        )

        variable = example_package.get_variable(example_variable_transport.key)

        PackageManagerService.get_api_nodes_by_package_key_package_key_variables_definitions_with_values.assert_called_once_with(
            example_package.client,
            example_package.key,
            None,
        )
        assert isinstance(variable, Variable)
        assert variable.package_key == example_package.key
        assert variable.dict(exclude={"package_key"}) == example_variable_transport.dict()

    def test_get_variable_with_nonexistent_id_raises_error(self, example_package, example_variable_transport):
        PackageManagerService.get_api_nodes_by_package_key_package_key_variables_definitions_with_values = Mock(
            return_value=[]
        )

        with pytest.raises(PyCelonisNotFoundError):
            _ = example_package.get_variable(example_variable_transport.key)

        PackageManagerService.get_api_nodes_by_package_key_package_key_variables_definitions_with_values.assert_called_once_with(
            example_package.client,
            example_package.key,
            None,
        )

    def test_get_variables_returns_list_of_variables(self, example_package, example_variable_transport):
        example_variable_transport2 = example_variable_transport.copy()
        example_variable_transport2.value = "NEW_VALUE"
        PackageManagerService.get_api_nodes_by_package_key_package_key_variables_definitions_with_values = Mock(
            return_value=[example_variable_transport, example_variable_transport2]
        )

        variables = example_package.get_variables()

        PackageManagerService.get_api_nodes_by_package_key_package_key_variables_definitions_with_values.assert_called_once_with(
            example_package.client,
            example_package.key,
            None,
        )
        assert len(variables) == 2
        assert isinstance(variables[0], Variable)
        assert isinstance(variables[1], Variable)

        assert variables[0].package_key == example_package.key
        assert variables[1].package_key == example_package.key
        assert variables[0].dict(exclude={"package_key"}) == example_variable_transport.dict()
        assert variables[1].dict(exclude={"package_key"}) == example_variable_transport2.dict()


class TestGetView:
    def test_get_views_returns_list_of_views(self, example_package, example_view_transport):
        example_view_transport2 = example_view_transport.copy()
        example_view_transport2.key = "NEW_VIEW"
        PackageManagerService.get_api_nodes_by_root_key_root_key = Mock(
            return_value=[
                example_view_transport,
                example_view_transport2,
            ]
        )

        views = example_package.get_views()

        PackageManagerService.get_api_nodes_by_root_key_root_key.assert_any_call(
            example_package.client, example_package.key, asset_type=AssetType.BOARD.value, node_type=None
        )
        PackageManagerService.get_api_nodes_by_root_key_root_key.assert_called_with(
            example_package.client, example_package.key, asset_type=AssetType.BOARD_V2.value, node_type=None
        )
        assert len(views) == 4
        assert isinstance(views[0], View)
        assert isinstance(views[1], View)
        assert views[0].dict() == example_view_transport.dict()
        assert views[1].dict() == example_view_transport2.dict()

    def test_get_view_returns_view(self, example_package, example_view_transport):
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_view_transport)

        view = example_package.get_view(example_view_transport.id)

        PackageManagerService.get_api_nodes_id.assert_called_once_with(
            example_package.client, example_view_transport.id
        )
        assert isinstance(view, View)
        assert view.dict() == example_view_transport.dict()

    def test_get_nonexistent_view_throws_not_found_error(self, example_package, example_knowledge_model_transport):
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_knowledge_model_transport)

        with pytest.raises(PyCelonisNotFoundError):
            example_package.get_view(example_knowledge_model_transport.id)

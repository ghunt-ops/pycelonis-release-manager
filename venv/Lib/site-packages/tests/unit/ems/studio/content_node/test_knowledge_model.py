from unittest.mock import Mock

from pycelonis.service.semantic_layer.service import FinalModelOptions, SemanticLayerService, YamlMetadata


class TestKnowledgeModel:
    def test_updated_knowledge_model_has_updated_values(
        self, example_knowledge_model, example_knowledge_model_transport
    ):
        UPDATED_SERIALIZED_CONTENT = (
            "kind: BASE\nmetadata:\n  key: TEST_KM_BASE\n  displayName: TEST_KM_BASE_UPDATED\ndataModelId: ID\n"
        )

        example_knowledge_model.serialized_content = UPDATED_SERIALIZED_CONTENT  # Simulate local change
        example_knowledge_model_transport.serialized_content = UPDATED_SERIALIZED_CONTENT  # Simulate change in EMS

        yaml_metadata_transport = YamlMetadata(
            id=example_knowledge_model.id,
            final_model_options=FinalModelOptions(
                with_autogenerated_data_model_data=True,
                with_variable_replacement=True,
            ),
            content=example_knowledge_model.serialized_content,
        )
        SemanticLayerService.post_api_semantic_models = Mock(return_value=example_knowledge_model_transport)

        example_knowledge_model.update()

        SemanticLayerService.post_api_semantic_models.assert_called_once_with(
            example_knowledge_model.client,
            yaml_metadata_transport,
        )
        assert example_knowledge_model.dict() == example_knowledge_model_transport.dict()

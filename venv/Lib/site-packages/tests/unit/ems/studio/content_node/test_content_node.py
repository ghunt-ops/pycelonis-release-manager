from datetime import datetime
from unittest.mock import Mock

from pycelonis.ems.studio.content_node import ContentNode
from pycelonis.service.package_manager.service import PackageManagerService, SaveContentNodeTransport


class TestContentNode:
    def test_content_node_from_transport_has_same_values_as_transport(
        self, mock_client, example_content_node_transport
    ):
        content_node = ContentNode.from_transport(mock_client, example_content_node_transport)

        assert isinstance(content_node, ContentNode)
        assert content_node.client == mock_client
        assert content_node.dict() == example_content_node_transport.dict()

    def test_updated_content_node_has_updated_values(self, example_content_node, example_content_node_transport):
        UPDATED_NAME = "NEW_NAME"
        UPDATED_CHANGE_DATE = datetime(year=2000, month=1, day=1)

        example_content_node.name = UPDATED_NAME  # Simulate local change
        example_content_node_transport.name = UPDATED_NAME  # Simulate change in EMS
        example_content_node_transport.change_date = UPDATED_CHANGE_DATE  # Simulate change in EMS
        save_content_node_transport = SaveContentNodeTransport(**example_content_node.json_dict())
        PackageManagerService.put_api_nodes_id = Mock(return_value=example_content_node_transport)

        example_content_node.update()

        PackageManagerService.put_api_nodes_id.assert_called_once_with(
            example_content_node.client,
            example_content_node.id,
            save_content_node_transport,
        )
        assert example_content_node.dict() == example_content_node_transport.dict()

    def test_synced_content_node_has_synced_values(self, example_content_node, example_content_node_transport):
        UPDATED_NAME = "NEW_NAME"

        example_content_node_transport.name = UPDATED_NAME  # Simulate change in EMS
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_content_node_transport)

        example_content_node.sync()

        PackageManagerService.get_api_nodes_id.assert_called_once_with(
            example_content_node.client,
            example_content_node.id,
        )
        assert example_content_node.dict() == example_content_node_transport.dict()

    def test_delete_content_node_deletes_correct_content_node(self, example_content_node):
        PackageManagerService.delete_api_nodes_id = Mock()

        example_content_node.delete()

        PackageManagerService.delete_api_nodes_id.assert_called_once_with(
            example_content_node.client, example_content_node.id
        )


class TestContentNodeType:
    def test_is_package(self, example_package_transport):
        assert ContentNode.is_package(example_package_transport)

    def test_is_not_package(self, example_analysis_transport):
        assert not ContentNode.is_package(example_analysis_transport)

    def test_is_folder(self, example_folder_transport):
        assert ContentNode.is_folder(example_folder_transport)

    def test_is_not_folder(self, example_package):
        assert not ContentNode.is_folder(example_package)

    def test_is_analysis(self, example_analysis_transport):
        assert ContentNode.is_analysis(example_analysis_transport)

    def test_is_not_analysis(self, example_package):
        assert not ContentNode.is_analysis(example_package)

    def test_is_knowledge_model(self, example_knowledge_model_transport):
        assert ContentNode.is_knowledge_model(example_knowledge_model_transport)

    def test_is_not_knowledge_model(self, example_package):
        assert not ContentNode.is_knowledge_model(example_package)

    def test_is_action_flow(self, example_action_flow_transport):
        assert ContentNode.is_action_flow(example_action_flow_transport)

    def test_is_not_action_flow(self, example_package):
        assert not ContentNode.is_action_flow(example_package)

    def test_is_view(self, example_view_transport):
        assert ContentNode.is_view(example_view_transport)

    def test_is_not_view(self, example_package):
        assert not ContentNode.is_view(example_package)

    def test_is_simulation(self, example_simulation_transport):
        assert ContentNode.is_simulation(example_simulation_transport)

    def test_is_not_simulation(self, example_package):
        assert not ContentNode.is_simulation(example_package)

    def test_is_skill(self, example_skill_transport):
        assert ContentNode.is_skill(example_skill_transport)

    def test_is_not_skill(self, example_package):
        assert not ContentNode.is_skill(example_package)

from unittest.mock import Mock

from pycelonis.service.blueprint.service import Blueprint, BoardAssetType, BoardUpsertRequest


class TestView:
    def test_updated_view_has_updated_values(self, example_view, example_view_transport):
        UPDATED_SERIALIZED_CONTENT = 'metadata:\n  key: "test123"\n  template: false\n  name: "test123"'

        example_view.serialized_content = UPDATED_SERIALIZED_CONTENT  # Simulate local change
        example_view_transport.serialized_content = UPDATED_SERIALIZED_CONTENT  # Simulate change in EMS

        board_upsert_request = BoardUpsertRequest(
            id=example_view.id,
            configuration=example_view.serialized_content,
            parent_node_id=example_view.parent_node_id,
            parent_node_key=example_view.parent_node_key,
            root_node_key=example_view.root_node_key,
            board_asset_type=BoardAssetType.BOARD,
        )
        Blueprint.put_api_boards_board_id = Mock(return_value=example_view_transport)

        example_view.update()

        Blueprint.put_api_boards_board_id.assert_called_once_with(
            example_view.client,
            board_id=example_view.id,
            request_body=board_upsert_request,
        )
        assert example_view.dict() == example_view_transport.dict()

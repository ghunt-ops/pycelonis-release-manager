from unittest.mock import Mock

import pytest
from pycelonis.ems.studio import Space, Studio
from pycelonis.service.package_manager.service import PackageManagerService, SpaceSaveTransport


@pytest.fixture()
def studio(mock_client):
    return Studio(mock_client)


class TestStudio:
    def test_create_space_returns_new_space(self, studio, example_space_transport):
        SPACE_NAME = "TEST_SPACE"

        create_space_transport = SpaceSaveTransport(name=SPACE_NAME, icon_reference="earth")
        example_space_transport.name = SPACE_NAME  # Simulate change in EMS

        PackageManagerService.post_api_spaces = Mock()
        PackageManagerService.post_api_spaces.return_value = example_space_transport

        space = studio.create_space(SPACE_NAME)

        PackageManagerService.post_api_spaces.assert_called_with(
            studio.client,
            create_space_transport,
        )
        assert isinstance(space, Space)
        assert space.dict() == example_space_transport.dict()

    def test_get_space_returns_space(self, studio, example_space_transport):
        PackageManagerService.get_api_spaces_id = Mock()
        PackageManagerService.get_api_spaces_id.return_value = example_space_transport

        space = studio.get_space(example_space_transport.id)

        PackageManagerService.get_api_spaces_id.assert_called_with(
            studio.client,
            example_space_transport.id,
        )
        assert isinstance(space, Space)
        assert space.dict() == example_space_transport.dict()

    def test_get_spaces_returns_list_of_spaces(self, studio, example_space_transport):
        example_space_transport2 = example_space_transport.copy()
        example_space_transport2.name = "NEW_NAME"

        PackageManagerService.get_api_spaces = Mock()
        PackageManagerService.get_api_spaces.return_value = [example_space_transport, example_space_transport2]

        spaces = studio.get_spaces()

        PackageManagerService.get_api_spaces.assert_called_with(
            studio.client,
        )
        assert len(spaces) == 2
        assert isinstance(spaces[0], Space)
        assert isinstance(spaces[1], Space)
        assert spaces[0].dict() == example_space_transport.dict()
        assert spaces[1].dict() == example_space_transport2.dict()

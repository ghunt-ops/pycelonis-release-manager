from datetime import datetime
from unittest.mock import Mock

import pytest
from pycelonis.ems.studio import Space
from pycelonis.ems.studio.content_node.package import Package
from pycelonis.service.package_manager.service import (
    ContentNodeType,
    PackageManagerService,
    SaveContentNodeTransport,
    SpaceDeleteTransport,
    SpaceDetailsTransport,
)
from pycelonis_core.utils.errors import PyCelonisNotFoundError


class TestSpace:
    def test_space_from_transport_has_same_values_as_transport(self, mock_client, example_space_transport):
        space = Space.from_transport(mock_client, example_space_transport)

        assert isinstance(space, Space)
        assert space.client == mock_client
        assert space.dict() == example_space_transport.dict()

    def test_updated_space_has_updated_values(self, example_space, example_space_transport):
        UPDATED_NAME = "NEW_NAME"
        UPDATED_CHANGE_DATE = datetime(year=2000, month=1, day=1)

        example_space.name = UPDATED_NAME  # Simulate local change
        example_space_transport.name = UPDATED_NAME  # Simulate change in EMS
        example_space_transport.change_date = UPDATED_CHANGE_DATE  # Simulate change in EMS

        PackageManagerService.put_api_spaces_id = Mock()
        PackageManagerService.put_api_spaces_id.return_value = example_space_transport

        example_space.update()

        PackageManagerService.put_api_spaces_id.assert_called_once_with(
            example_space.client,
            example_space.id,
            SpaceDetailsTransport(**example_space.json_dict()),
        )
        assert example_space.dict() == example_space_transport.dict()

    def test_synced_space_has_synced_values(self, example_space, example_space_transport):
        UPDATED_NAME = "NEW_NAME"

        space, remote_space_transport = example_space, example_space_transport
        remote_space_transport.name = UPDATED_NAME  # Simulate change in EMS

        PackageManagerService.get_api_spaces_id = Mock()
        PackageManagerService.get_api_spaces_id.return_value = remote_space_transport

        space.sync()

        PackageManagerService.get_api_spaces_id.assert_called_once_with(
            space.client,
            space.id,
        )
        assert space.dict() == remote_space_transport.dict()

    def test_delete_space_deletes_correct_space(self, example_space):
        PackageManagerService.post_api_spaces_delete_id = Mock()

        example_space.delete()

        PackageManagerService.post_api_spaces_delete_id.assert_called_once_with(
            example_space.client,
            example_space.id,
            SpaceDeleteTransport(**example_space.json_dict()),
            soft_delete_packages=False,
        )


class TestCreateAndGetPackage:
    @pytest.mark.parametrize(
        "package_name,package_key,package_key_set",
        [
            ("TEST_PACKAGE", "TEST_PACKAGE_KEY", "TEST_PACKAGE_KEY"),
            ("TEST_PACKAGE", None, "TEST_PACKAGE"),  # Defaults to package name
        ],
    )
    def test_create_package_returns_new_package(
        self, example_space, example_package_transport, package_name, package_key, package_key_set
    ):
        PACKAGE_PUBLIC_AVAILABLE = False
        create_package_transport = SaveContentNodeTransport(
            name=package_name,
            key=package_key_set,
            space_id=example_space.id,
            node_type=ContentNodeType.PACKAGE,
            serialized_content="variables: []\ndependencies: []\n",
            public_available=PACKAGE_PUBLIC_AVAILABLE,
        )
        example_package_transport.name = package_name  # Simulate change in EMS
        example_package_transport.public_available = PACKAGE_PUBLIC_AVAILABLE
        PackageManagerService.post_api_nodes = Mock(return_value=example_package_transport)

        package = example_space.create_package(package_name, key=package_key, public_available=PACKAGE_PUBLIC_AVAILABLE)

        PackageManagerService.post_api_nodes.assert_called_with(
            example_space.client,
            create_package_transport.json_dict(by_alias=True, exclude_unset=True),
        )
        assert isinstance(package, Package)
        assert package.dict() == example_package_transport.dict()

    def test_get_package_returns_package(self, example_space, example_package_transport):
        example_package_transport.space_id = example_space.id
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_package_transport)

        package = example_space.get_package(example_package_transport.id)

        PackageManagerService.get_api_nodes_id.assert_called_with(
            example_space.client,
            example_package_transport.id,
        )
        assert isinstance(package, Package)
        assert package.dict() == example_package_transport.dict()

    def test_get_package_different_space_raises_error(self, example_space, example_package_transport):
        example_package_transport.space_id = "OTHER_SPACE_ID"
        PackageManagerService.get_api_nodes_id = Mock(return_value=example_package_transport)

        with pytest.raises(PyCelonisNotFoundError):
            _ = example_space.get_package(example_package_transport.id)

        PackageManagerService.get_api_nodes_id.assert_called_with(
            example_space.client,
            example_package_transport.id,
        )

    def test_get_packages_returns_list_of_packages(
        self, example_space, example_package_transport, example_content_node_transport
    ):
        example_package_transport2 = example_package_transport.copy()
        example_package_transport2.name = "NEW_NAME"
        PackageManagerService.get_api_nodes_tree = Mock(
            return_value=[example_package_transport, example_package_transport2, example_content_node_transport]
        )

        packages = example_space.get_packages()

        PackageManagerService.get_api_nodes_tree.assert_called_with(example_space.client, example_space.id)
        assert len(packages) == 2
        assert isinstance(packages[0], Package)
        assert isinstance(packages[1], Package)
        assert packages[0].dict() == example_package_transport.dict()
        assert packages[1].dict() == example_package_transport2.dict()

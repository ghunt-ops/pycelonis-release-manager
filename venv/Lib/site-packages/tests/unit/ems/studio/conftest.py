import pytest
from pycelonis.ems.studio import Space
from pycelonis.ems.studio.content_node import ContentNode
from pycelonis.ems.studio.content_node.package import Package
from pycelonis.ems.studio.content_node.variable import Variable
from pycelonis.ems.studio.content_node.view import View
from pycelonis.pql.pql import PQL, PQLColumn
from pycelonis.service.package_manager.service import ContentNodeTransport, VariableDefinitionWithValue
from pycelonis.service.process_analytics.service import AnalysisPackageTransport
from pycelonis.service.semantic_layer.service import FinalLayerTransport, LayerComputeTransport, PostBatchQueryTransport


@pytest.fixture(scope="function")
def example_space(mock_client, example_space_transport):
    return Space.from_transport(mock_client, example_space_transport)


@pytest.fixture(scope="function")
def example_content_node(mock_client, example_content_node_transport):
    return ContentNode.from_transport(mock_client, example_content_node_transport)


@pytest.fixture(scope="function")
def example_knowledge_model_transport():
    return ContentNodeTransport(
        **{
            "root": False,
            "asset": True,
            "root_with_key": "TEST_PACKAGE.TEST_KM_BASE",
            "base": None,
            "object_id": "67b0c1de-372c-475e-b78b-46a4f94cf418",
            "identifier": "TEST_KM_BASE",
            "tenant_id": None,
            "id": "67b0c1de-372c-475e-b78b-46a4f94cf418",
            "key": "TEST_KM_BASE",
            "name": "TEST_KM_BASE",
            "root_node_key": "TEST_PACKAGE",
            "asset_type": "SEMANTIC_MODEL",
            "node_type": "ASSET",
            "parent_node_key": "TEST_PACKAGE",
            "parent_node_id": None,
            "invalid_content": False,
            "serialized_content": "kind: BASE\nmetadata:\n  key: TEST_KM_BASE\n  displayName: TEST_KM_BASE\n"
            "dataModelId: ID\n",
            "serialization_type": "YAML",
            "draft_id": "518fdb44-5166-4b5d-ba7b-3172f55d393c",
            "working_draft_id": "518fdb44-5166-4b5d-ba7b-3172f55d393c",
            "activated_draft_id": None,
            "show_in_viewer_mode": False,
            "public_available": False,
            "root_node_id": "ff98f938-3352-4602-9ec1-ef672616b941",
            "order": 0,
            "source": None,
            "asset_metadata_transport": {
                "used_variables": [],
                "related_assets": [],
                "metadata": {"key": "TEST_KM_BASE", "displayName": "TEST_KM_BASE"},
            },
            "space_id": "3dffca7e-1d86-4ce8-b899-3397c78231a5",
            "change_date": 1648806370660,
        }
    )


@pytest.fixture(scope="function")
def example_knowledge_model(mock_client, example_knowledge_model_transport):
    return ContentNode.from_transport(mock_client, example_knowledge_model_transport)


@pytest.fixture(scope="function")
def example_action_flow_transport():
    return ContentNodeTransport(
        **{
            "root": False,
            "asset": True,
            "root_with_key": "TEST_PACKAGE.ttewt",
            "base": None,
            "object_id": "f9474995-4da8-4f40-9f7d-35dfc1f847ce",
            "identifier": "ttewt",
            "tenant_id": None,
            "id": "f9474995-4da8-4f40-9f7d-35dfc1f847ce",
            "key": "ttewt",
            "name": "ttewt",
            "root_node_key": "TEST_PACKAGE",
            "asset_type": "SCENARIO",
            "node_type": "ASSET",
            "parent_node_key": "TEST_PACKAGE",
            "parent_node_id": None,
            "invalid_content": False,
            "serialized_content": '{"scenarioId":"6987","version":"","sensorType":null,"webhookUrl":null,'
            '"tenantId":"abf2d618-47d0-4d8b-9fbc-b00365e05861","key":"testtt.ttewt",'
            '"rootNodeId":"5f38d2ba-b56c-4527-83cf-c369ae2af3c7"}',
            "serialization_type": "JSON",
            "draft_id": "60210220-2b24-4c9e-8a5b-e2a4484d7acc",
            "working_draft_id": "60210220-2b24-4c9e-8a5b-e2a4484d7acc",
            "activated_draft_id": "60210220-2b24-4c9e-8a5b-e2a4484d7acc",
            "show_in_viewer_mode": False,
            "public_available": False,
            "root_node_id": "ff98f938-3352-4602-9ec1-ef672616b941",
            "order": 4,
            "source": None,
            "asset_metadata_transport": {"used_variables": [], "related_assets": [], "metadata": None},
            "space_id": "3dffca7e-1d86-4ce8-b899-3397c78231a5",
            "change_date": 1649859364450,
        }
    )


@pytest.fixture(scope="function")
def example_skill_transport():
    return ContentNodeTransport(
        **{
            "root": False,
            "asset": True,
            "root_with_key": "TEST_PACKAGE.dddd",
            "base": None,
            "object_id": "ab243383-3fb0-475c-a7f2-2e2369845529",
            "identifier": "dddd",
            "tenant_id": None,
            "id": "ab243383-3fb0-475c-a7f2-2e2369845529",
            "key": "dddd",
            "name": "dddd",
            "root_node_key": "TEST_PACKAGE",
            "asset_type": "SKILL",
            "node_type": "ASSET",
            "parent_node_key": "TEST_PACKAGE",
            "parent_node_id": None,
            "invalid_content": False,
            "serialized_content": '{"key":"dddd","name":"dddd","inactive":false}',
            "serialization_type": "JSON",
            "draft_id": "fbd635ce-7720-4df2-94c4-2c11c5d6f26e",
            "working_draft_id": "fbd635ce-7720-4df2-94c4-2c11c5d6f26e",
            "activated_draft_id": None,
            "show_in_viewer_mode": False,
            "public_available": False,
            "root_node_id": "ff98f938-3352-4602-9ec1-ef672616b941",
            "order": 0,
            "source": None,
            "asset_metadata_transport": {"used_variables": [], "related_assets": [], "metadata": None},
            "space_id": "3dffca7e-1d86-4ce8-b899-3397c78231a5",
            "change_date": 1653293448828,
        }
    )


@pytest.fixture(scope="function")
def example_knowledge_model_content():
    return FinalLayerTransport(
        **{
            "id": "67b0c1de-372c-475e-b78b-46a4f94cf418",
            "layer": {
                "kpis": [],
                "records": [],
                "variables": [],
                "filters": [],
                "activities": [],
                "actions": [],
                "anomalies": [],
                "event_logs": [],
                "event_logs_metadata": {"event_logs": [], "transitions": [], "kpi_views": []},
                "custom_objects": [],
                "id": "TEST_PACKAGE.TEST_KM_BASE",
                "tenantId": None,
                "kind": "BASE",
                "base": None,
                "metadata": {
                    "key": "TEST_PACKAGE.TEST_KM_BASE",
                    "display_name": "test-km",
                    "version": None,
                },
                "data_model_id": "7abc3293-d8a1-4bc2-8fed-721abf5bdb0c",
                "broken": None,
                "node_entity_id": "1fedd86c-b0e1-4bc5-a402-8d9ceb1fced7",
            },
            "yaml_object": "",
        }
    )


@pytest.fixture(scope="function")
def example_package(mock_client, example_package_transport):
    return Package.from_transport(mock_client, example_package_transport)


@pytest.fixture(scope="function")
def example_variable_transport():
    return VariableDefinitionWithValue(
        **{
            "value": "VALUE",
            "key": "KEY",
            "type": "DATA_MODEL",
            "description": None,
            "source": None,
            "runtime": False,
            "metadata": None,
            "package_key": "NEW_NODE31",
        }
    )


@pytest.fixture(scope="function")
def example_variable(mock_client, example_package, example_variable_transport):
    return Variable.from_transport(mock_client, example_package.key, example_variable_transport)


@pytest.fixture(scope="function")
def example_analysis_package_transport():
    return AnalysisPackageTransport(
        **{
            "analysis": {
                "id": "2b3a2c9c-b831-4228-8468-87d27db3ec00",
                "tenant_id": None,
                "name": "TEST_ANALYSIS",
                "key": None,
                "description": None,
                "deleted": False,
                "transport_id": None,
                "last_published_draft_id": "2b3a2c9c-b831-4228-8468-87d27db3ec00",
                "auto_save_id": None,
                "process_id": None,
                "create_date": None,
                "favourite": False,
                "content_id": None,
                "content_version": 0,
                "tags": None,
                "application_id": "",
                "global_app": False,
                "public_link": False,
                "last_published_date": None,
                "last_published_user": None,
            },
            "kpis": None,
            "draft": {
                "id": "2b3a2c9c-b831-4228-8468-87d27db3ec00",
                "title": None,
                "document": None,
                "last_change_date": 1649324105385,
                "last_change_user_id": "DELETED",
                "last_change_user_name": "deleted-user@celonis.cloud(Deleted User)",
                "locked_until_date": "0",
                "source_id": None,
            },
            "data_model_id": None,
            "knowledge_model_key": None,
            "next_draft_creation_date_time": None,
        }
    )


@pytest.fixture(scope="function")
def example_analysis(mock_client, example_analysis_transport):
    return ContentNode.from_transport(mock_client, example_analysis_transport)


@pytest.fixture(scope="function")
def example_query():
    return PQL(
        columns=[PQLColumn(name="KPI", query='KPI("test_kpi")')],
        filters=[],
        order_by_columns=[],
        distinct=False,
        limit=None,
        offset=None,
    )


@pytest.fixture(scope="function")
def example_layer_compute_transport():
    return LayerComputeTransport(
        **{
            "caller_info": None,
            "layer": {
                "kind": "BASE",
                "metadata": {"key": "TEST_PACKAGE.TEST_KM_BASE", "display_name": "test-km", "version": None},
                "base": None,
                "data_model_id": "7abc3293-d8a1-4bc2-8fed-721abf5bdb0c",
                "records": [],
                "kpis": [],
                "filters": [],
                "variables": [],
                "activities": [],
                "event_logs_metadata": {"event_logs": [], "transitions": [], "kpi_views": []},
                "anomalies": [],
                "event_logs": [],
                "custom_objects": [],
                "id": "TEST_PACKAGE.TEST_KM_BASE",
                "tenant_id": None,
                "actions": [],
                "node_entity_id": "1fedd86c-b0e1-4bc5-a402-8d9ceb1fced7",
            },
            "request": {
                "batch_request": {
                    "variables": [],
                    "requests": [
                        {
                            "id_": None,
                            "request": {
                                "cube_id": None,
                                "commands": [
                                    {
                                        "computation_id": None,
                                        "queries": ['TABLE (\nKPI("test_kpi") AS "KPI"\n)\nNOLIMIT;'],
                                        "is_transient": None,
                                    }
                                ],
                            },
                        }
                    ],
                },
                "filters": None,
            },
            "draft": True,
        }
    )


@pytest.fixture(scope="function")
def example_post_batch_query_transport():
    return PostBatchQueryTransport(
        **{
            "analysis_commands": [
                {
                    "id_": None,
                    "request": {
                        "cube_id": None,
                        "commands": [
                            {
                                "computation_id": 0,
                                "queries": ['TABLE (\nKPI("test_kpi") AS "KPI"\n)\nNOLIMIT;'],
                                "is_transient": False,
                            }
                        ],
                    },
                }
            ],
            "query_environment": {
                "accelerator_session_id": "12b41fe5-b4b1-4d6c-8e48-a5c9ce16850e",
                "process_id": "dbc39f25-57ff-4f4e-bbf9-525a49fb6ec6",
                "user_id": "0fb7943d-ea53-46ff-acb6-43d796bff2fc",
                "user_name": None,
                "load_script": "",
                "kpi_infos": {
                    "kpis": {
                        "COUNT_TABLE__ACTIVITY_TABLE": {
                            "name": "COUNT_TABLE__ACTIVITY_TABLE",
                            "template": 'COUNT_TABLE("ACTIVITY_TABLE")',
                            "parameter_count": 0,
                            "error": None,
                            "formula": 'COUNT_TABLE("ACTIVITY_TABLE")',
                        },
                        "FILTERED_COUNT": {
                            "name": "FILTERED_COUNT",
                            "template": "COUNT(CASE WHEN {p1} THEN 0 ELSE NULL END)",
                            "parameter_count": 1,
                            "error": None,
                            "formula": "COUNT(CASE WHEN {p1} THEN 0 ELSE NULL END)",
                        },
                        "RATIO": {
                            "name": "RATIO",
                            "template": "AVG(CASE WHEN {p1} THEN 1 ELSE 0 END)",
                            "parameter_count": 1,
                            "error": None,
                            "formula": "AVG(CASE WHEN {p1} THEN 1 ELSE 0 END)",
                        },
                        "test_kpi": {
                            "name": "test_kpi",
                            "template": 'COUNT ( "ACTIVITY_TABLE"."ACTIVITY_EN" )',
                            "parameter_count": 0,
                            "error": None,
                            "formula": 'COUNT ( "ACTIVITY_TABLE"."ACTIVITY_EN" )',
                        },
                    }
                },
                "data_permission_rules": [],
                "data_permission_strategy": "AND",
            },
        }
    )


@pytest.fixture(scope="function")
def example_knowledge_model_content_query_resolution():
    return FinalLayerTransport(
        **{
            "id_": "PYTHON_CORE_PACKAGE_TEST_KNOWLEDGE_MODEL_435C5A55.test-km-PYTHON_CORE_SPACE_TEST_KNOWLEDGE_MODEL_FA2E6FA0",
            "layer": {
                "kind": "BASE",
                "metadata": {
                    "key": "test-km-PYTHON_CORE_SPACE_TEST_KNOWLEDGE_MODEL_FA2E6FA0",
                    "display_name": "test-km",
                    "version": None,
                },
                "base": None,
                "data_model_id": "ef6eebe3-7f05-4444-9de3-a70d9d55e81b",
                "records": [],
                "kpis": [],
                "filters": [],
                "variables": [],
                "activities": [],
                "event_logs_metadata": {"event_logs": [], "transitions": [], "kpi_views": []},
                "anomalies": [],
                "event_logs": [],
                "custom_objects": [],
                "id_": "PYTHON_CORE_PACKAGE_TEST_KNOWLEDGE_MODEL_435C5A55.test-km-PYTHON_CORE_SPACE_TEST_KNOWLEDGE_MODEL_FA2E6FA0",
                "tenant_id": "7fc37a4b-afd3-41cf-9bb4-79c4217ce2a2",
                "actions": [],
                "node_entity_id": "6425fd29-b879-49ce-97e1-fe1f14c51f5c",
            },
            "yaml_object": "kind: BASE\nmetadata:\n  key: test-km-PYTHON_CORE_SPACE_TEST_KNOWLEDGE_MODEL_FA2E6FA0\n  displayName: test-km\ndataModelId: ef6eebe3-7f05-4444-9de3-a70d9d55e81b\nrecords: []\nkpis: []\nfilters: []\nvariables: []\nactivities: []\neventLogsMetadata:\n  eventLogs: []\n  transitions: []\n  kpiViews: []\nanomalies: []\neventLogs: []\ncustomObjects: []\nid: PYTHON_CORE_PACKAGE_TEST_KNOWLEDGE_MODEL_435C5A55.test-km-PYTHON_CORE_SPACE_TEST_KNOWLEDGE_MODEL_FA2E6FA0\ntenantId: 7fc37a4b-afd3-41cf-9bb4-79c4217ce2a2\nactions: []\nnodeEntityId: 6425fd29-b879-49ce-97e1-fe1f14c51f5c\n",
        }
    )


@pytest.fixture(scope="function")
def example_view(mock_client, example_view_transport):
    return View.from_transport(mock_client, example_view_transport)

from unittest.mock import Mock

import pytest
from pycelonis.ems.data_integration.data_model_table import DataModelTable
from pycelonis.ems.data_integration.data_model_table_column import DataModelTableColumn
from pycelonis.service.integration.service import IntegrationService, PoolColumn
from pycelonis_core.base.collection import CelonisCollection


class TestDataModelTable:
    def test_data_model_from_transport_has_same_values_as_transport(
        self, mock_client, example_data_model, example_data_model_table_transport
    ):
        data_model_table = DataModelTable.from_transport(
            mock_client, example_data_model.data_pool_id, example_data_model_table_transport
        )

        assert isinstance(data_model_table, DataModelTable)
        assert data_model_table.client == mock_client
        assert data_model_table.dict(exclude={"data_pool_id"}) == example_data_model_table_transport.dict()
        assert data_model_table.data_pool_id == example_data_model.data_pool_id

        # OCPM compatibility attributes
        assert hasattr(data_model_table, "augmentation")
        assert not data_model_table.from_business_graph_schema

    def test_updated_data_model_has_updated_values(self, example_data_model_table, example_data_model_table_transport):
        UPDATED_ALIAS = "NEW_NAME"
        UPDATED_USE_DIRECT_STORAGE = True

        example_data_model_table.alias = UPDATED_ALIAS  # Simulate local change
        example_data_model_table_transport.alias = UPDATED_ALIAS  # Simulate change in EMS
        example_data_model_table_transport.use_direct_storage = UPDATED_USE_DIRECT_STORAGE  # Simulate change in EMS
        IntegrationService.put_api_pools_pool_id_data_model_data_model_id_tables_id = Mock(
            return_value=example_data_model_table_transport
        )

        example_data_model_table.update()

        IntegrationService.put_api_pools_pool_id_data_model_data_model_id_tables_id.assert_called_once_with(
            example_data_model_table.client,
            example_data_model_table.data_pool_id,
            example_data_model_table.data_model_id,
            example_data_model_table.id,
            example_data_model_table,
        )
        assert example_data_model_table.dict(exclude={"data_pool_id"}) == example_data_model_table_transport.dict()

    def test_synced_data_model_has_synced_values(self, example_data_model_table, example_data_model_table_transport):
        UPDATED_ALIAS = "NEW_NAME"

        example_data_model_table_transport.alias = UPDATED_ALIAS  # Simulate change in EMS
        IntegrationService.get_api_pools_pool_id_data_model_data_model_id_tables_id = Mock(
            return_value=example_data_model_table_transport
        )

        example_data_model_table.sync()

        IntegrationService.get_api_pools_pool_id_data_model_data_model_id_tables_id.assert_called_once_with(
            example_data_model_table.client,
            example_data_model_table.data_pool_id,
            example_data_model_table.data_model_id,
            example_data_model_table.id,
        )
        assert example_data_model_table.dict(exclude={"data_pool_id"}) == example_data_model_table_transport.dict()

    def test_delete_data_model_deletes_correct_data_model(self, example_data_model_table):
        IntegrationService.delete_api_pools_pool_id_data_model_data_model_id_tables_table_id = Mock()

        example_data_model_table.delete()

        IntegrationService.delete_api_pools_pool_id_data_model_data_model_id_tables_table_id.assert_called_once_with(
            example_data_model_table.client,
            example_data_model_table.data_pool_id,
            example_data_model_table.data_model_id,
            example_data_model_table.id,
        )

    def test_getter_attributes(self, example_data_model_table):
        for attr in example_data_model_table.__getter_attributes__():
            with pytest.warns(UserWarning):
                getattr(example_data_model_table, attr)
            assert hasattr(example_data_model_table, f"get_{attr}")


class TestDataModelTableColumns:
    def test_get_columns(self, example_data_model_table):
        EXAMPLE_COLUMNS = [PoolColumn(name="TEST")]
        IntegrationService.get_api_pools_pool_id_data_model_data_model_id_tables_table_id_columns = Mock(
            return_value=EXAMPLE_COLUMNS
        )

        columns = example_data_model_table.get_columns()

        IntegrationService.get_api_pools_pool_id_data_model_data_model_id_tables_table_id_columns.assert_called_once_with(
            example_data_model_table.client,
            example_data_model_table.data_pool_id,
            example_data_model_table.data_model_id,
            example_data_model_table.id,
        )
        assert isinstance(columns, CelonisCollection)
        assert isinstance(columns[0], DataModelTableColumn)
        assert len(columns) == 1
        assert columns[0].data_pool_id == example_data_model_table.data_pool_id
        assert columns[0].data_model_id == example_data_model_table.data_model_id
        assert columns[0].table_name == example_data_model_table.name
        assert columns[0].table_alias == example_data_model_table.alias
        assert columns[0].name == "TEST"

from unittest.mock import Mock

from pycelonis.ems.data_integration.process_configuration import ProcessConfiguration
from pycelonis.service.integration.service import IntegrationService


class TestProcessConfiguration:
    def test_process_configuration_from_transport_has_same_values_as_transport(
        self, mock_client, example_data_model, example_data_model_configuration_transport
    ):
        process_configuration = ProcessConfiguration.from_transport(
            mock_client, example_data_model.pool_id, example_data_model_configuration_transport
        )

        assert isinstance(process_configuration, ProcessConfiguration)
        assert process_configuration.client == mock_client
        assert process_configuration.dict(exclude={"data_pool_id"}) == example_data_model_configuration_transport.dict()

    def test_updated_process_configuration_has_updated_values(
        self, example_process_configuration, example_data_model_configuration_transport
    ):
        UPDATED_TIMESTAMP_COLUMN = "EVENTTIME_2"
        UPDATED_CASE_ID_COLUMN = "CASE_ID_COL_2"

        example_process_configuration.timestamp_column = UPDATED_TIMESTAMP_COLUMN  # Simulate local change
        example_data_model_configuration_transport.timestamp_column = UPDATED_TIMESTAMP_COLUMN  # Simulate change in EMS
        example_data_model_configuration_transport.case_id_column = UPDATED_CASE_ID_COLUMN  # Simulate change in EMS
        IntegrationService.put_api_pools_pool_id_data_models_data_model_id_process_configurations = Mock(
            return_value=example_data_model_configuration_transport
        )

        example_process_configuration.update()

        IntegrationService.put_api_pools_pool_id_data_models_data_model_id_process_configurations.assert_called_once_with(
            example_process_configuration.client,
            example_process_configuration.data_pool_id,
            example_process_configuration.data_model_id,
            example_process_configuration,
        )
        assert (
            example_process_configuration.dict(exclude={"data_pool_id"})
            == example_data_model_configuration_transport.dict()
        )

    def test_synced_process_configuration_has_synced_values(
        self, example_process_configuration, example_data_model_configuration_transport
    ):
        UPDATED_CASE_ID_COLUMN = "NEW_ID"

        example_data_model_configuration_transport.case_id_column = UPDATED_CASE_ID_COLUMN  # Simulate change in EMS
        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_process_configurations_activity_table_activity_table_id = Mock(
            return_value=example_data_model_configuration_transport
        )

        example_process_configuration.sync()

        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_process_configurations_activity_table_activity_table_id.assert_called_once_with(
            example_process_configuration.client,
            example_process_configuration.data_pool_id,
            example_process_configuration.data_model_id,
            example_process_configuration.activity_table_id,
        )
        assert (
            example_process_configuration.dict(exclude={"data_pool_id"})
            == example_data_model_configuration_transport.dict()
        )

    def test_delete_process_configuration_deletes_correct_process_configuration(self, example_process_configuration):
        IntegrationService.delete_api_pools_pool_id_data_models_data_model_id_process_configurations_process_configuration_id = Mock()

        example_process_configuration.delete()

        IntegrationService.delete_api_pools_pool_id_data_models_data_model_id_process_configurations_process_configuration_id.assert_called_once_with(
            example_process_configuration.client,
            example_process_configuration.data_pool_id,
            example_process_configuration.data_model_id,
            example_process_configuration.id,
        )

from unittest.mock import Mock

from pycelonis.ems.data_integration.table_extraction import TableExtraction
from pycelonis.service.integration.service import IntegrationService


class TestTableExtraction:
    def test_table_extraction_from_transport_has_same_values_as_transport(
        self, mock_client, example_extraction, example_table_extraction_transport
    ):
        table_extraction = TableExtraction.from_transport(
            mock_client,
            example_extraction.pool_id,
            example_extraction.job_id,
            example_extraction.id,
            example_table_extraction_transport,
        )

        assert isinstance(table_extraction, TableExtraction)
        assert table_extraction.client == mock_client
        assert (
            table_extraction.dict(exclude={"data_pool_id", "extraction_id"})
            == example_table_extraction_transport.dict()
        )
        assert table_extraction.data_pool_id == example_extraction.pool_id
        assert table_extraction.extraction_id == example_extraction.id

    def test_updated_table_extraction_has_updated_values(
        self, example_table_extraction, example_table_extraction_transport
    ):
        UPDATED_NAME = "NEW_NAME"
        UPDATED_CHANGED_DATE_COLUMN = "CHANGED_DATE"

        example_table_extraction.table_name = UPDATED_NAME  # Simulate local change
        example_table_extraction_transport.table_name = UPDATED_NAME  # Simulate change in EMS
        example_table_extraction_transport.change_date_column = UPDATED_CHANGED_DATE_COLUMN  # Simulate change in EMS
        IntegrationService.put_api_pools_pool_id_jobs_job_id_extractions_extraction_id_tables = Mock(
            return_value=[example_table_extraction_transport]
        )

        example_table_extraction.update()

        IntegrationService.put_api_pools_pool_id_jobs_job_id_extractions_extraction_id_tables.assert_called_once_with(
            example_table_extraction.client,
            example_table_extraction.data_pool_id,
            example_table_extraction.job_id,
            example_table_extraction.extraction_id,
            [example_table_extraction],
        )
        assert (
            example_table_extraction.dict(exclude={"data_pool_id", "extraction_id"})
            == example_table_extraction_transport.dict()
        )

    def test_synced_table_extraction_has_synced_values(
        self, example_table_extraction, example_table_extraction_transport
    ):
        UPDATED_NAME = "NEW_NAME"

        example_table_extraction_transport.table_name = UPDATED_NAME  # Simulate change in EMS
        IntegrationService.get_api_pools_pool_id_jobs_job_id_extractions_extraction_id_tables_table_id = Mock(
            return_value=example_table_extraction_transport
        )

        example_table_extraction.sync()

        IntegrationService.get_api_pools_pool_id_jobs_job_id_extractions_extraction_id_tables_table_id.assert_called_once_with(
            example_table_extraction.client,
            example_table_extraction.data_pool_id,
            example_table_extraction.job_id,
            example_table_extraction.task_id,
            example_table_extraction.id,
        )
        assert (
            example_table_extraction.dict(exclude={"data_pool_id", "extraction_id"})
            == example_table_extraction_transport.dict()
        )

    def test_delete_table_extraction_deletes_correct_table_extraction(self, example_table_extraction):
        IntegrationService.delete_api_pools_pool_id_jobs_job_id_extractions_extraction_id_tables_table_id = Mock()

        example_table_extraction.delete()

        IntegrationService.delete_api_pools_pool_id_jobs_job_id_extractions_extraction_id_tables_table_id.assert_called_once_with(
            example_table_extraction.client,
            example_table_extraction.data_pool_id,
            example_table_extraction.job_id,
            example_table_extraction.extraction_id,
            example_table_extraction.id,
        )

import io
from datetime import datetime
from unittest.mock import Mock, mock_open, patch

import pandas as pd
import pytest
from pycelonis.ems.data_integration.data_export import DataExport
from pycelonis.ems.data_integration.data_model import DataModel
from pycelonis.ems.data_integration.data_model_table import DataModelTable
from pycelonis.ems.data_integration.foreign_key import ForeignKey
from pycelonis.ems.data_integration.process_configuration import ProcessConfiguration
from pycelonis.errors import (
    PyCelonisDataExportNotEnabledError,
    PyCelonisLoadInProgressError,
    PyCelonisReloadFailedError,
)
from pycelonis.pql.pql import PQL, PQLColumn
from pycelonis.service.integration.service import (
    DataCommand,
    DataExportRequest,
    DataModelConfiguration,
    DataModelDataLoadHistoryTransport,
    DataModelForeignKeyColumnTransport,
    DataModelForeignKeyTransport,
    DataModelLoadInfoTransport,
    DataModelLoadStatus,
    DataModelLoadSyncTransport,
    DataModelTableTransport,
    DataQuery,
    ExportType,
    IntegrationService,
    NameMappingTransport,
    QueryEnvironment,
)
from pycelonis_core.utils.errors import (
    PyCelonisNotFoundError,
    PyCelonisPermissionError,
    PyCelonisTypeError,
)


class TestDataModel:
    def test_data_model_from_transport_has_same_values_as_transport(self, mock_client, example_data_model_transport):
        data_model = DataModel.from_transport(mock_client, example_data_model_transport)

        assert isinstance(data_model, DataModel)
        assert data_model.client == mock_client
        assert data_model.dict() == example_data_model_transport.dict()

    def test_updated_data_model_has_updated_values(self, example_data_model, example_data_model_transport):
        UPDATED_NAME = "NEW_NAME"
        UPDATED_CHANGED_DATE = datetime(year=2000, month=1, day=1)

        example_data_model.name = UPDATED_NAME  # Simulate local change
        example_data_model_transport.name = UPDATED_NAME  # Simulate change in EMS
        example_data_model_transport.changed_date = UPDATED_CHANGED_DATE  # Simulate change in EMS
        IntegrationService.put_api_pools_pool_id_data_models_data_model_id = Mock(
            return_value=example_data_model_transport
        )

        example_data_model.update()

        IntegrationService.put_api_pools_pool_id_data_models_data_model_id.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
            example_data_model,
        )
        assert example_data_model.dict() == example_data_model_transport.dict()

    def test_synced_data_model_has_synced_values(self, example_data_model, example_data_model_transport):
        UPDATED_NAME = "NEW_NAME"

        example_data_model_transport.name = UPDATED_NAME  # Simulate change in EMS
        IntegrationService.get_api_pools_pool_id_data_models_data_model_id = Mock(
            return_value=example_data_model_transport
        )

        example_data_model.sync()

        IntegrationService.get_api_pools_pool_id_data_models_data_model_id.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
        )
        assert example_data_model.dict() == example_data_model_transport.dict()

    def test_delete_data_model_deletes_correct_data_model(self, example_data_model):
        IntegrationService.delete_api_pools_pool_id_data_models_data_model_id = Mock()

        example_data_model.delete()

        IntegrationService.delete_api_pools_pool_id_data_models_data_model_id.assert_called_once_with(
            example_data_model.client, example_data_model.pool_id, example_data_model.id
        )

    def test_getter_attributes(self, example_data_model):
        for attr in example_data_model.__getter_attributes__():
            with pytest.warns(UserWarning):
                getattr(example_data_model, attr)
            assert hasattr(example_data_model, f"get_{attr}")


class TestDataModelReload:
    @pytest.mark.parametrize(
        "load_status",
        [DataModelLoadStatus.RUNNING, DataModelLoadStatus.CANCELLING, DataModelLoadStatus.LOST_CONNECTION],
    )
    def test_reload_with_load_in_progress_throws_load_in_progress_error(self, load_status, example_data_model):
        load_sync_transport = DataModelLoadSyncTransport(
            load_info=DataModelLoadInfoTransport(
                current_compute_load=DataModelDataLoadHistoryTransport(load_status=load_status)
            )
        )
        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_load_history_load_info_sync = Mock(
            return_value=load_sync_transport
        )

        with pytest.raises(PyCelonisLoadInProgressError):
            example_data_model.reload(wait=False)
        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_load_history_load_info_sync.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
        )

    @pytest.mark.parametrize(
        "current_compute_load",
        [
            DataModelDataLoadHistoryTransport(load_status=DataModelLoadStatus.SUCCESS),
            DataModelDataLoadHistoryTransport(load_status=DataModelLoadStatus.ERROR),
            DataModelDataLoadHistoryTransport(load_status=DataModelLoadStatus.WARNING),
            DataModelDataLoadHistoryTransport(load_status=DataModelLoadStatus.CANCELED),
            None,  # No current compute load
        ],
    )
    def test_reload_with_no_load_in_progress_starts_reload(self, current_compute_load, example_data_model):
        load_sync_transport = DataModelLoadSyncTransport(
            load_info=DataModelLoadInfoTransport(current_compute_load=current_compute_load)
        )
        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_load_history_load_info_sync = Mock(
            return_value=load_sync_transport
        )
        IntegrationService.post_api_pools_pool_id_data_models_data_model_id_reload = Mock()

        example_data_model.reload(wait=False)

        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_load_history_load_info_sync.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
        )
        IntegrationService.post_api_pools_pool_id_data_models_data_model_id_reload.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
            force_complete=True,
        )

    def test_reload_with_no_load_info_starts_reload(self, example_data_model):
        load_sync_transport = DataModelLoadSyncTransport(load_info=None)
        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_load_history_load_info_sync = Mock(
            return_value=load_sync_transport
        )
        IntegrationService.post_api_pools_pool_id_data_models_data_model_id_reload = Mock()

        example_data_model.reload(wait=False)

        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_load_history_load_info_sync.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
        )
        IntegrationService.post_api_pools_pool_id_data_models_data_model_id_reload.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
            force_complete=True,
        )

    def test_reload_without_force_complete_starts_reload_from_cache(self, example_data_model):
        load_sync_transport = DataModelLoadSyncTransport(load_info=None)
        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_load_history_load_info_sync = Mock(
            return_value=load_sync_transport
        )
        IntegrationService.post_api_pools_pool_id_data_models_data_model_id_reload = Mock()

        example_data_model.reload(force_complete=False, wait=False)

        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_load_history_load_info_sync.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
        )
        IntegrationService.post_api_pools_pool_id_data_models_data_model_id_reload.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
            force_complete=False,
        )

    @patch("time.sleep", return_value=None)
    @pytest.mark.parametrize(
        "final_load_sync_transport",
        [
            DataModelLoadSyncTransport(
                load_info=DataModelLoadInfoTransport(
                    current_compute_load=DataModelDataLoadHistoryTransport(load_status=DataModelLoadStatus.SUCCESS),
                )
            ),
            DataModelLoadSyncTransport(
                load_info=DataModelLoadInfoTransport(
                    current_compute_load=DataModelDataLoadHistoryTransport(load_status=DataModelLoadStatus.WARNING),
                )
            ),
        ],
    )
    def test_successful_reload_with_wait_raises_no_error(
        self, patched_time_sleep: Mock, final_load_sync_transport, example_data_model
    ):
        success_load_sync_transport = DataModelLoadSyncTransport(
            load_info=DataModelLoadInfoTransport(
                current_compute_load=DataModelDataLoadHistoryTransport(load_status=DataModelLoadStatus.SUCCESS),
            )
        )
        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_load_history_load_info_sync = Mock(
            side_effect=[
                success_load_sync_transport,
                success_load_sync_transport,
                final_load_sync_transport,
            ]
        )
        IntegrationService.post_api_pools_pool_id_data_models_data_model_id_reload = Mock()

        example_data_model.reload(wait=True)

        IntegrationService.post_api_pools_pool_id_data_models_data_model_id_reload.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
            force_complete=True,
        )
        patched_time_sleep.assert_not_called()  # Not called as status is immediately success
        assert (
            IntegrationService.get_api_pools_pool_id_data_models_data_model_id_load_history_load_info_sync.call_count
            == 3
        )

    @patch("time.sleep", return_value=None)
    @pytest.mark.parametrize(
        "final_load_sync_transport",
        [
            DataModelLoadSyncTransport(
                load_info=DataModelLoadInfoTransport(
                    current_compute_load=DataModelDataLoadHistoryTransport(load_status=DataModelLoadStatus.CANCELED),
                )
            ),
            DataModelLoadSyncTransport(
                load_info=DataModelLoadInfoTransport(
                    current_compute_load=DataModelDataLoadHistoryTransport(load_status=DataModelLoadStatus.ERROR),
                )
            ),
        ],
    )
    def test_failed_reload_with_wait_raises_error(
        self, patched_time_sleep: Mock, final_load_sync_transport, example_data_model
    ):
        success_load_sync_transport = DataModelLoadSyncTransport(
            load_info=DataModelLoadInfoTransport(
                current_compute_load=DataModelDataLoadHistoryTransport(load_status=DataModelLoadStatus.SUCCESS),
            )
        )
        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_load_history_load_info_sync = Mock(
            side_effect=[
                success_load_sync_transport,
                success_load_sync_transport,
                final_load_sync_transport,
            ]
        )
        IntegrationService.post_api_pools_pool_id_data_models_data_model_id_reload = Mock()

        with pytest.raises(PyCelonisReloadFailedError):
            example_data_model.reload(wait=True)

        IntegrationService.post_api_pools_pool_id_data_models_data_model_id_reload.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
            force_complete=True,
        )
        patched_time_sleep.assert_not_called()  # Not called as status is immediately success
        assert (
            IntegrationService.get_api_pools_pool_id_data_models_data_model_id_load_history_load_info_sync.call_count
            == 3
        )

    def test_partial_reload_starts_reload(self, example_data_model, example_data_model_table):
        load_sync_transport = DataModelLoadSyncTransport(load_info=None)
        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_load_history_load_info_sync = Mock(
            return_value=load_sync_transport
        )
        IntegrationService.post_api_v1_data_pools_pool_id_data_models_data_model_id_load_partial_sync = Mock()

        example_data_model.partial_reload([example_data_model_table.id])

        IntegrationService.post_api_v1_data_pools_pool_id_data_models_data_model_id_load_partial_sync.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
            [example_data_model_table.id],
        )
        assert (
            IntegrationService.get_api_pools_pool_id_data_models_data_model_id_load_history_load_info_sync.call_count
            == 3
        )


class TestCreateDataExport:
    def test_create_data_export_returns_data_export(self, example_data_export_transport, example_data_model):
        QUERY = PQL() + PQLColumn(query="TEST", name="TEST")
        EXPORT_TYPE = ExportType.CSV
        QUERY_ENVIRONMENT = QueryEnvironment(process_id="TEST_ID")

        create_data_export_request = DataExportRequest(
            data_command=DataCommand(commands=[DataQuery(queries=QUERY.queries)]),
            export_type=EXPORT_TYPE,
            query_environment=QUERY_ENVIRONMENT,
        )
        example_data_export_transport.export_type = EXPORT_TYPE
        IntegrationService.post_api_v1_compute_data_model_id_export_query = Mock(
            return_value=example_data_export_transport
        )

        data_export = example_data_model.create_data_export(QUERY, EXPORT_TYPE, QUERY_ENVIRONMENT)
        IntegrationService.post_api_v1_compute_data_model_id_export_query(
            example_data_model.client,
            example_data_model.id,
            create_data_export_request,
        )
        assert isinstance(data_export, DataExport)
        assert data_export.export_type == EXPORT_TYPE

    def test_create_data_export_raises_not_supported_error(self, example_data_export_transport, example_data_model):
        QUERY = PQL() + PQLColumn(query="TEST", name="TEST")
        EXPORT_TYPE = ExportType.CSV
        QUERY_ENVIRONMENT = QueryEnvironment(process_id="TEST_ID")

        example_data_export_transport.export_type = EXPORT_TYPE
        IntegrationService.post_api_v1_compute_data_model_id_export_query = Mock(side_effect=PyCelonisPermissionError)

        with pytest.raises(PyCelonisDataExportNotEnabledError):
            example_data_model.create_data_export(QUERY, EXPORT_TYPE, QUERY_ENVIRONMENT)

    def test_export_data_frame_returns_concatenated_data_frame(self, example_data_export, example_data_model):
        QUERY = PQL() + PQLColumn(query="TEST", name="TEST")
        QUERY_ENVIRONMENT = QueryEnvironment(process_id="TEST_ID")

        DF = pd.DataFrame({"TEST": [1, 2, 3, 4]})
        CHUNK1, CHUNK2 = io.BytesIO(), io.BytesIO()
        DF.iloc[:2].reset_index(drop=True).to_parquet(CHUNK1)
        DF.iloc[2:].reset_index(drop=True).to_parquet(CHUNK2)
        object.__setattr__(
            example_data_model,
            "create_data_export",
            Mock(return_value=example_data_export),
        )  # Workaround due to PyDantic not allowing to override functions
        object.__setattr__(example_data_export, "wait_for_execution", Mock())
        object.__setattr__(example_data_export, "get_chunks", Mock(return_value=[CHUNK1, CHUNK2]))

        df = example_data_model.export_data_frame(QUERY, QUERY_ENVIRONMENT)

        example_data_model.create_data_export.assert_called_once_with(
            QUERY, ExportType.PARQUET, query_environment=QUERY_ENVIRONMENT, use_api_v2=False
        )
        example_data_export.wait_for_execution.assert_called_once()
        example_data_export.get_chunks.assert_called_once()
        pd.testing.assert_frame_equal(df, DF)


class TestAddAndGetDataModelTables:
    def test_add_data_model_table_returns_added_data_model_table(
        self, example_data_model, example_data_model_table_transport
    ):
        DATA_MODEL_TABLE_NAME = "TEST_TABLE"
        DATA_MODEL_TABLE_ALIAS = "TEST_TABLE123"
        DATA_MODEL_TABLE_DIRECT_STORAGE = True

        create_data_model_table_transport = DataModelTableTransport(
            name=DATA_MODEL_TABLE_NAME,
            alias=DATA_MODEL_TABLE_ALIAS,
            columns=[],
            use_direct_storage=DATA_MODEL_TABLE_DIRECT_STORAGE,
        )
        example_data_model_table_transport.name = DATA_MODEL_TABLE_NAME  # Simulate change in EMS
        example_data_model_table_transport.alias = DATA_MODEL_TABLE_ALIAS  # Simulate change in EMS
        example_data_model_table_transport.use_direct_storage = DATA_MODEL_TABLE_DIRECT_STORAGE
        IntegrationService.post_api_pools_pool_id_data_model_data_model_id_tables = Mock(
            return_value=[example_data_model_table_transport]
        )

        data_model_table = example_data_model.add_table(
            DATA_MODEL_TABLE_NAME,
            DATA_MODEL_TABLE_ALIAS,
            use_direct_storage=DATA_MODEL_TABLE_DIRECT_STORAGE,
        )

        IntegrationService.post_api_pools_pool_id_data_model_data_model_id_tables.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
            [create_data_model_table_transport],
        )
        assert isinstance(data_model_table, DataModelTable)
        assert data_model_table.dict(exclude={"data_pool_id"}) == example_data_model_table_transport.dict()

    def test_get_tables(self, example_data_model, example_data_model_table_transport):
        IntegrationService.get_api_pools_pool_id_data_model_data_model_id_tables = Mock(
            return_value=[example_data_model_table_transport]
        )

        tables = example_data_model.get_tables()

        IntegrationService.get_api_pools_pool_id_data_model_data_model_id_tables.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
        )
        assert len(tables) == 1
        assert tables[0].dict(exclude={"data_pool_id"}) == example_data_model_table_transport.dict()

    def test_get_data_model_table_returns_data_model_table(
        self, example_data_model, example_data_model_table_transport
    ):
        IntegrationService.get_api_pools_pool_id_data_model_data_model_id_tables_id = Mock(
            return_value=example_data_model_table_transport
        )

        data_model_table = example_data_model.get_table(example_data_model_table_transport.id)

        IntegrationService.get_api_pools_pool_id_data_model_data_model_id_tables_id.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
            example_data_model_table_transport.id,
        )
        assert isinstance(data_model_table, DataModelTable)
        assert data_model_table.dict(exclude={"data_pool_id"}) == example_data_model_table_transport.dict()


class TestCreateAndGetForeignKey:
    def test_create_foreign_key_returns_new_foreign_key(self, example_data_model, example_foreign_key_transport):
        SOURCE_TABLE_ID = "TEST_ID1"
        TARGET_TABLE_ID = "TEST_ID1"
        COLUMNS = [("COL1", "COL_1"), ("COL2", "COL_2")]

        create_foreign_key_transport = DataModelForeignKeyTransport(
            source_table_id=SOURCE_TABLE_ID,
            target_table_id=TARGET_TABLE_ID,
            columns=[
                DataModelForeignKeyColumnTransport(source_column_name=col[0], target_column_name=col[1])
                for col in COLUMNS
            ],
        )
        example_foreign_key_transport.data_model_id = example_data_model.id  # Simulate change in EMS
        IntegrationService.post_api_pools_pool_id_data_models_data_model_id_foreign_keys = Mock(
            return_value=example_foreign_key_transport
        )

        foreign_key = example_data_model.create_foreign_key(
            source_table_id=SOURCE_TABLE_ID,
            target_table_id=TARGET_TABLE_ID,
            columns=COLUMNS,
        )

        IntegrationService.post_api_pools_pool_id_data_models_data_model_id_foreign_keys.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
            create_foreign_key_transport,
        )
        assert isinstance(foreign_key, ForeignKey)
        assert foreign_key.data_pool_id == example_data_model.pool_id
        assert foreign_key.dict(exclude={"data_pool_id"}) == example_foreign_key_transport.dict()

    @pytest.mark.parametrize(
        "columns",
        [[("COL1")], "COL1"],
    )
    def test_create_foreign_key_wrong_column_format_raises_type_error(
        self, example_data_model, example_foreign_key_transport, columns
    ):
        SOURCE_TABLE_ID = "TEST_ID1"
        TARGET_TABLE_ID = "TEST_ID1"

        with pytest.raises(PyCelonisTypeError):
            example_data_model.create_foreign_key(
                source_table_id=SOURCE_TABLE_ID,
                target_table_id=TARGET_TABLE_ID,
                columns=columns,
            )

    def test_get_foreign_key_returns_foreign_key(self, example_data_model, example_foreign_key_transport):
        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_foreign_keys_id = Mock(
            return_value=example_foreign_key_transport
        )

        foreign_key = example_data_model.get_foreign_key(example_foreign_key_transport.id)

        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_foreign_keys_id.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
            example_foreign_key_transport.id,
        )
        assert isinstance(foreign_key, ForeignKey)
        assert foreign_key.data_pool_id == example_data_model.pool_id
        assert foreign_key.dict(exclude={"data_pool_id"}) == example_foreign_key_transport.dict()

    def test_get_foreign_keys_returns_list_of_foreign_keys(self, example_data_model, example_foreign_key_transport):
        example_foreign_key_transport2 = example_foreign_key_transport.copy()
        example_foreign_key_transport2.source_table_id = "NEW_ID"
        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_foreign_keys = Mock(
            return_value=[example_foreign_key_transport, example_foreign_key_transport2]
        )

        foreign_keys = example_data_model.get_foreign_keys()

        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_foreign_keys.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
        )
        assert len(foreign_keys) == 2
        assert isinstance(foreign_keys[0], ForeignKey)
        assert isinstance(foreign_keys[1], ForeignKey)

        assert foreign_keys[0].data_pool_id == example_data_model.pool_id
        assert foreign_keys[1].data_pool_id == example_data_model.pool_id
        assert foreign_keys[0].dict(exclude={"data_pool_id"}) == example_foreign_key_transport.dict()
        assert foreign_keys[1].dict(exclude={"data_pool_id"}) == example_foreign_key_transport2.dict()


class TestAddAndGetNameMapping:
    def test_get_name_mapping_returns_name_mappings(self, example_data_model, example_name_mapping_transport):
        example_name_mapping_transport2 = example_name_mapping_transport.copy()
        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_name_mapping = Mock(
            return_value=[
                example_name_mapping_transport,
                example_name_mapping_transport2,
            ]
        )

        name_mappings = example_data_model.get_name_mappings()

        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_name_mapping.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
        )

        assert len(name_mappings) == 2
        assert isinstance(name_mappings[0], NameMappingTransport)
        assert isinstance(name_mappings[1], NameMappingTransport)

    def test_delete_name_mapping_deletes_correct_name_mappings(self, example_data_model):
        IntegrationService.delete_api_pools_pool_id_data_models_data_model_id_name_mapping = Mock()

        example_data_model.delete_name_mappings()

        IntegrationService.delete_api_pools_pool_id_data_models_data_model_id_name_mapping.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
        )

    def test_upload_name_mappings(self, example_data_model):
        file = Mock(io.BytesIO)
        IntegrationService.post_api_pools_pool_id_data_models_data_model_id_name_mapping_file = Mock()

        example_data_model._upload_name_mappings(file)

        IntegrationService.post_api_pools_pool_id_data_models_data_model_id_name_mapping_file(
            example_data_model.client, example_data_model.pool_id, example_data_model.id, {"file": file}
        )

    def test_add_name_mappings(self, example_data_model):
        mock_file_path = "mock_file_path.xlx"
        mock_text = "mock_text".encode()
        name_mappings_mock = Mock()

        object.__setattr__(example_data_model, "_upload_name_mappings", Mock())
        object.__setattr__(
            example_data_model,
            "get_name_mappings",
            Mock(return_value=name_mappings_mock),
        )

        with patch("builtins.open", mock_open(read_data=mock_text)):
            name_mappings = example_data_model.add_name_mappings(mock_file_path)

        assert name_mappings == name_mappings_mock
        example_data_model._upload_name_mappings.assert_called_once()
        example_data_model.get_name_mappings.assert_called_once()


class TestCreateAndGetProcessConfiguration:
    def test_create_process_configuration_returns_new_process_configuration(
        self, example_data_model, example_data_model_configuration_transport
    ):
        ACTIVITY_TABLE_ID = "ACTIVITY_TABLE_ID"
        CASE_ID_COLUMN = "CASE_ID"
        ACTIVITY_COLUMN = "ACTIVITY"
        EVENTTIME_COLUMN = "EVENTTIME"
        USE_PARALLEL_PROCESS = True

        create_process_configuration_transport = DataModelConfiguration(
            activity_table_id=ACTIVITY_TABLE_ID,
            case_id_column=CASE_ID_COLUMN,
            activity_column=ACTIVITY_COLUMN,
            timestamp_column=EVENTTIME_COLUMN,
            use_parallel_process=USE_PARALLEL_PROCESS,
        )
        example_data_model_configuration_transport.data_model_id = example_data_model.id  # Simulate change in EMS
        example_data_model_configuration_transport.use_parallel_process = USE_PARALLEL_PROCESS
        IntegrationService.put_api_pools_pool_id_data_models_data_model_id_process_configurations = Mock(
            return_value=example_data_model_configuration_transport
        )

        process_configuration = example_data_model.create_process_configuration(
            activity_table_id=ACTIVITY_TABLE_ID,
            case_id_column=CASE_ID_COLUMN,
            activity_column=ACTIVITY_COLUMN,
            timestamp_column=EVENTTIME_COLUMN,
            use_parallel_process=USE_PARALLEL_PROCESS,
        )

        IntegrationService.put_api_pools_pool_id_data_models_data_model_id_process_configurations.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
            create_process_configuration_transport,
        )
        assert isinstance(process_configuration, ProcessConfiguration)
        assert process_configuration.data_pool_id == example_data_model.pool_id
        assert process_configuration.dict(exclude={"data_pool_id"}) == example_data_model_configuration_transport.dict()

    def test_get_process_configuration_returns_process_configuration(
        self, example_data_model, example_data_model_configuration_transport
    ):
        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_process_configurations = Mock(
            return_value=[example_data_model_configuration_transport]
        )

        process_configuration = example_data_model.get_process_configuration(
            example_data_model_configuration_transport.id
        )

        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_process_configurations.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
        )
        assert isinstance(process_configuration, ProcessConfiguration)
        assert process_configuration.data_pool_id == example_data_model.pool_id
        assert process_configuration.dict(exclude={"data_pool_id"}) == example_data_model_configuration_transport.dict()

    def test_get_process_configuration_with_nonexistent_id_raises_error(
        self, example_data_model, example_data_model_configuration_transport
    ):
        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_process_configurations = Mock(
            return_value=[]
        )

        with pytest.raises(PyCelonisNotFoundError):
            _ = example_data_model.get_process_configuration(example_data_model_configuration_transport.id)

        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_process_configurations.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
        )

    def test_get_process_configurations_returns_list_of_process_configurations(
        self, example_data_model, example_data_model_configuration_transport
    ):
        example_data_model_configuration_transport2 = example_data_model_configuration_transport.copy()
        example_data_model_configuration_transport2.activity_table_id = "NEW_ID"
        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_process_configurations = Mock(
            return_value=[
                example_data_model_configuration_transport,
                example_data_model_configuration_transport2,
            ]
        )

        process_configurations = example_data_model.get_process_configurations()

        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_process_configurations.assert_called_once_with(
            example_data_model.client,
            example_data_model.pool_id,
            example_data_model.id,
        )
        assert len(process_configurations) == 2
        assert isinstance(process_configurations[0], ProcessConfiguration)
        assert isinstance(process_configurations[1], ProcessConfiguration)

        assert process_configurations[0].data_pool_id == example_data_model.pool_id
        assert process_configurations[1].data_pool_id == example_data_model.pool_id
        assert (
            process_configurations[0].dict(exclude={"data_pool_id"})
            == example_data_model_configuration_transport.dict()
        )
        assert (
            process_configurations[1].dict(exclude={"data_pool_id"})
            == example_data_model_configuration_transport2.dict()
        )

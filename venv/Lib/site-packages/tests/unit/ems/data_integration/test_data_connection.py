from unittest.mock import Mock

import pytest
from pycelonis.ems.data_integration.data_connection import DataConnection
from pycelonis.service.integration.service import DataSourceAvailableTables, DataSourceTable, IntegrationService


class TestDataConnection:
    def test_data_connection_from_transport_has_same_values_as_transport(
        self, mock_client, example_data_source_transport
    ):
        data_connection = DataConnection.from_transport(mock_client, example_data_source_transport)

        assert isinstance(data_connection, DataConnection)
        assert data_connection.client == mock_client
        assert data_connection.dict() == example_data_source_transport.dict()

    def test_synced_data_connection_has_synced_values(self, example_data_connection, example_data_source_transport):
        UPDATED_NAME = "NEW_NAME"

        example_data_source_transport.name = UPDATED_NAME  # Simulate change in EMS
        IntegrationService.get_api_pools_pool_id_data_sources_data_source_id = Mock(
            return_value=example_data_source_transport
        )

        example_data_connection.sync()

        IntegrationService.get_api_pools_pool_id_data_sources_data_source_id.assert_called_once_with(
            example_data_connection.client,
            example_data_connection.pool_id,
            example_data_connection.id,
        )
        assert example_data_connection.dict() == example_data_source_transport.dict()

    def test_delete_data_connection_deletes_correct_data_connection(self, example_data_connection):
        IntegrationService.delete_api_pools_pool_id_data_sources_data_source_id = Mock()

        example_data_connection.delete()

        IntegrationService.delete_api_pools_pool_id_data_sources_data_source_id.assert_called_once_with(
            example_data_connection.client, example_data_connection.pool_id, example_data_connection.id
        )


class TestTableSearch:
    @pytest.mark.parametrize(
        "search_string",
        [None, "TEST_TABLE"],
    )
    def test_get_tables_returns_tables(self, example_data_connection, search_string):
        IntegrationService.get_api_pools_pool_id_data_sources_data_source_id_search_tables = Mock(
            return_value=DataSourceAvailableTables(
                available_tables=[DataSourceTable(name="TEST_TABLE1"), DataSourceTable(name="TEST_TABLE2")]
            )
        )

        tables = example_data_connection.get_tables(search_string)

        assert len(tables) == 2
        assert tables[0].name == "TEST_TABLE1"
        assert tables[1].name == "TEST_TABLE2"
        IntegrationService.get_api_pools_pool_id_data_sources_data_source_id_search_tables.assert_called_once_with(
            example_data_connection.client,
            example_data_connection.pool_id,
            example_data_connection.id,
            search_string=search_string,
        )

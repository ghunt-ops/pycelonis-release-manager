import io
from unittest.mock import Mock, patch

import numpy as np
import pandas as pd
import pytest
from pycelonis.ems.data_integration.data_push_job import DataPushJob
from pycelonis.errors import PyCelonisDataPushExecutionFailedError, PyCelonisDataPushJobNotNew
from pycelonis.service.data_ingestion.service import DataIngestionService, JobStatus
from pycelonis_core.utils.errors import PyCelonisValueError


class TestDataPushJob:
    def test_data_push_job_from_transport_has_same_values_as_transport(
        self, mock_client, example_data_push_job_transport
    ):
        data_push_job = DataPushJob.from_transport(mock_client, example_data_push_job_transport)

        assert isinstance(data_push_job, DataPushJob)
        assert data_push_job.client == mock_client
        assert data_push_job.dict() == example_data_push_job_transport.dict()

    def test_synced_data_push_job_has_synced_values(self, example_data_push_job, example_data_push_job_transport):
        UPDATED_TARGET_NAME = "NEW_NAME"

        example_data_push_job_transport.target_name = UPDATED_TARGET_NAME  # Simulate change in EMS
        DataIngestionService.get_api_v1_data_push_pool_id_jobs_id = Mock(return_value=example_data_push_job_transport)

        example_data_push_job.sync()

        DataIngestionService.get_api_v1_data_push_pool_id_jobs_id.assert_called_once_with(
            example_data_push_job.client,
            example_data_push_job.data_pool_id,
            example_data_push_job.id,
        )
        assert example_data_push_job.dict() == example_data_push_job_transport.dict()

    def test_delete_data_push_job_deletes_correct_data_push_job(self, example_data_push_job):
        DataIngestionService.delete_api_v1_data_push_pool_id_jobs_id = Mock()

        example_data_push_job.delete()

        DataIngestionService.delete_api_v1_data_push_pool_id_jobs_id.assert_called_once_with(
            example_data_push_job.client, example_data_push_job.data_pool_id, example_data_push_job.id
        )


class TestDataPushJobChunksAndExecution:
    def test_add_file_chunk(self, example_data_push_job):
        file = Mock(io.BytesIO)
        DataIngestionService.post_api_v1_data_push_pool_id_jobs_id_chunks_upserted = Mock()

        example_data_push_job.add_file_chunk(file)

        DataIngestionService.post_api_v1_data_push_pool_id_jobs_id_chunks_upserted.assert_called_with(
            example_data_push_job.client,
            example_data_push_job.data_pool_id,
            example_data_push_job.id,
            {"file": ("file", file)},
        )

    @pytest.mark.parametrize(
        "chunk_size",
        list(range(1, 4)),
    )
    def test_add_data_frame_chunks(self, example_data_push_job, chunk_size):
        df = pd.DataFrame({"TEST": list(range(3))})
        object.__setattr__(
            example_data_push_job, "add_file_chunk", Mock()
        )  # Workaround due to PyDantic not allowing to override functions

        example_data_push_job.add_data_frame(df, chunk_size=chunk_size)

        assert example_data_push_job.add_file_chunk.call_count == np.ceil(df.shape[0] / chunk_size)

    def test_add_empty_data_frame_chunk_raises_value_error(self, example_data_push_job):
        df = pd.DataFrame({"TEST": []})

        with pytest.raises(ValueError):
            example_data_push_job.add_data_frame(df)

    def test_add_invalid_data_frame_chunk_raises_value_error(self, example_data_push_job):
        df = pd.DataFrame({"TEST": ["a", "b", ["c", "d"]]})

        with pytest.raises(PyCelonisValueError):
            example_data_push_job.add_data_frame(df)

    def test_get_chunks(self, example_data_push_job):
        example_chunk = Mock()
        DataIngestionService.get_api_v1_data_push_pool_id_jobs_id_chunks = Mock(return_value=[example_chunk])

        example_data_push_job.get_chunks()

        DataIngestionService.get_api_v1_data_push_pool_id_jobs_id_chunks.assert_called_once_with(
            example_data_push_job.client, example_data_push_job.data_pool_id, example_data_push_job.id
        )

    @pytest.mark.parametrize(
        "job_status",
        [JobStatus.QUEUED, JobStatus.RUNNING, JobStatus.DONE, JobStatus.ERROR],
    )
    def test_execute_with_not_new_data_push_job_raises_error(
        self, job_status, example_data_push_job, example_data_push_job_transport
    ):
        example_data_push_job_transport.status = job_status
        DataIngestionService.get_api_v1_data_push_pool_id_jobs_id = Mock(return_value=example_data_push_job_transport)

        with pytest.raises(PyCelonisDataPushJobNotNew):
            example_data_push_job.execute(wait=False)
        DataIngestionService.get_api_v1_data_push_pool_id_jobs_id.assert_called_once_with(
            example_data_push_job.client, example_data_push_job.data_pool_id, example_data_push_job.id
        )

    def test_execute_with_new_data_push_job_starts_execution(
        self, example_data_push_job, example_data_push_job_transport
    ):
        example_data_push_job_transport.status = JobStatus.NEW
        DataIngestionService.get_api_v1_data_push_pool_id_jobs_id = Mock(return_value=example_data_push_job_transport)
        DataIngestionService.post_api_v1_data_push_pool_id_jobs_id = Mock()

        example_data_push_job.execute(wait=False)

        DataIngestionService.get_api_v1_data_push_pool_id_jobs_id.assert_called_once_with(
            example_data_push_job.client, example_data_push_job.data_pool_id, example_data_push_job.id
        )
        DataIngestionService.post_api_v1_data_push_pool_id_jobs_id.assert_called_once_with(
            example_data_push_job.client, example_data_push_job.data_pool_id, example_data_push_job.id
        )

    @patch("time.sleep", return_value=None)
    def test_successful_reload_with_wait_raises_no_error(
        self, patched_time_sleep: Mock, example_data_push_job, example_data_push_job_transport
    ):
        example_data_push_job_transport.status = JobStatus.NEW
        example_data_push_job_transport_done = example_data_push_job.copy()
        example_data_push_job_transport_done.status = JobStatus.DONE
        DataIngestionService.get_api_v1_data_push_pool_id_jobs_id = Mock(
            side_effect=[
                example_data_push_job_transport,
                example_data_push_job_transport_done,
                example_data_push_job_transport_done,
            ]
        )
        DataIngestionService.post_api_v1_data_push_pool_id_jobs_id = Mock()

        example_data_push_job.execute(wait=True)

        DataIngestionService.post_api_v1_data_push_pool_id_jobs_id.assert_called_once_with(
            example_data_push_job.client, example_data_push_job.data_pool_id, example_data_push_job.id
        )
        patched_time_sleep.assert_not_called()  # Not called as status is immediately success
        assert DataIngestionService.get_api_v1_data_push_pool_id_jobs_id.call_count == 3

    @patch("time.sleep", return_value=None)
    def test_failed_reload_with_wait_raises_error(
        self, patched_time_sleep: Mock, example_data_push_job, example_data_push_job_transport
    ):
        example_data_push_job_transport.status = JobStatus.NEW
        example_data_push_job_transport_error = example_data_push_job.copy()
        example_data_push_job_transport_error.status = JobStatus.ERROR
        DataIngestionService.get_api_v1_data_push_pool_id_jobs_id = Mock(
            side_effect=[
                example_data_push_job_transport,
                example_data_push_job_transport_error,
                example_data_push_job_transport_error,
            ]
        )
        DataIngestionService.post_api_v1_data_push_pool_id_jobs_id = Mock()

        with pytest.raises(PyCelonisDataPushExecutionFailedError):
            example_data_push_job.execute(wait=True)

        DataIngestionService.post_api_v1_data_push_pool_id_jobs_id.assert_called_once_with(
            example_data_push_job.client, example_data_push_job.data_pool_id, example_data_push_job.id
        )
        patched_time_sleep.assert_not_called()  # Not called as status is immediately error
        assert DataIngestionService.get_api_v1_data_push_pool_id_jobs_id.call_count == 3

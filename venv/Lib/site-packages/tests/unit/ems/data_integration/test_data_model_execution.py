from unittest.mock import Mock

import pytest
from pycelonis.ems.data_integration.data_model_execution import DataModelExecution
from pycelonis.service.integration.service import IntegrationService
from pycelonis_core.utils.errors import PyCelonisNotFoundError


class TestDataModelExecution:
    def test_data_model_execution_from_transport_has_same_values_as_transport(
        self, mock_client, example_data_pool, example_data_model_execution_transport
    ):
        data_model_execution = DataModelExecution.from_transport(
            mock_client, example_data_pool.id, example_data_model_execution_transport
        )

        assert isinstance(data_model_execution, DataModelExecution)
        assert data_model_execution.client == mock_client
        assert data_model_execution.data_pool_id == example_data_pool.id
        assert data_model_execution.dict(exclude={"data_pool_id"}) == example_data_model_execution_transport.dict()

    def test_synced_data_model_execution_has_synced_values(
        self, example_data_model_execution, example_data_model_execution_transport
    ):
        UPDATED_DISABLED = True

        example_data_model_execution_transport.disabled = UPDATED_DISABLED  # Simulate change in EMS
        IntegrationService.get_api_pools_pool_id_jobs_job_id_loads = Mock(
            return_value=[example_data_model_execution_transport]
        )

        example_data_model_execution.sync()

        IntegrationService.get_api_pools_pool_id_jobs_job_id_loads.assert_called_once_with(
            example_data_model_execution.client,
            example_data_model_execution.data_pool_id,
            example_data_model_execution.job_id,
        )
        assert (
            example_data_model_execution.dict(exclude={"data_pool_id"}) == example_data_model_execution_transport.dict()
        )

    def test_sync_data_model_execution_raises_error_if_data_model_execution_does_not_exist(
        self, example_data_model_execution, example_data_model_execution_transport
    ):
        IntegrationService.get_api_pools_pool_id_jobs_job_id_loads = Mock(return_value=[])

        with pytest.raises(PyCelonisNotFoundError):
            example_data_model_execution.sync()

        IntegrationService.get_api_pools_pool_id_jobs_job_id_loads.assert_called_once_with(
            example_data_model_execution.client,
            example_data_model_execution.data_pool_id,
            example_data_model_execution.job_id,
        )

    def test_delete_data_model_deletes_correct_data_model(self, example_data_model_execution):
        IntegrationService.delete_api_pools_pool_id_jobs_job_id_loads_id = Mock()

        example_data_model_execution.delete()

        IntegrationService.delete_api_pools_pool_id_jobs_job_id_loads_id.assert_called_once_with(
            example_data_model_execution.client,
            example_data_model_execution.data_pool_id,
            example_data_model_execution.job_id,
            example_data_model_execution.id,
        )

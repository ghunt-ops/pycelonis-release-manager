from unittest.mock import Mock

import pytest
from pycelonis.ems.data_integration import DataIntegration, DataPool, DataPoolTransport
from pycelonis.service.integration.service import IntegrationService


@pytest.fixture()
def data_integration(mock_client):
    return DataIntegration(mock_client)


class TestDataIntegration:
    def test_create_data_pool_returns_new_data_pool(self, data_integration, example_data_pool_transport):
        DATA_POOL_NAME = "TEST_DATA_POOL"
        DATA_POOL_DESCRIPTION = "TEST_DATA_POOL_DESCRIPTION"

        create_data_pool_transport = DataPoolTransport(name=DATA_POOL_NAME, description=DATA_POOL_DESCRIPTION)
        example_data_pool_transport.name = DATA_POOL_NAME  # Simulate change in EMS
        example_data_pool_transport.description = DATA_POOL_DESCRIPTION
        IntegrationService.post_api_pools = Mock(return_value=example_data_pool_transport)

        data_pool = data_integration.create_data_pool(DATA_POOL_NAME, description=DATA_POOL_DESCRIPTION)

        IntegrationService.post_api_pools.assert_called_with(
            data_integration.client,
            create_data_pool_transport,
        )
        assert isinstance(data_pool, DataPool)
        assert data_pool.dict() == example_data_pool_transport.dict()

    def test_get_data_pool_returns_data_pool(self, data_integration, example_data_pool_transport):
        IntegrationService.get_api_pools_id = Mock(return_value=example_data_pool_transport)

        data_pool = data_integration.get_data_pool(example_data_pool_transport.id)

        IntegrationService.get_api_pools_id.assert_called_with(
            data_integration.client,
            example_data_pool_transport.id,
        )
        assert isinstance(data_pool, DataPool)
        assert data_pool.dict() == example_data_pool_transport.dict()

    def test_get_data_pools_returns_list_of_data_pools(self, data_integration, example_data_pool_transport):
        example_data_pool_transport2 = example_data_pool_transport.copy()
        example_data_pool_transport2.name = "NEW_NAME"
        IntegrationService.get_api_pools = Mock(
            return_value=[example_data_pool_transport, example_data_pool_transport2]
        )

        data_pools = data_integration.get_data_pools()

        IntegrationService.get_api_pools.assert_called_with(
            data_integration.client,
        )
        assert len(data_pools) == 2
        assert isinstance(data_pools[0], DataPool)
        assert isinstance(data_pools[1], DataPool)
        assert data_pools[0].dict() == example_data_pool_transport.dict()
        assert data_pools[1].dict() == example_data_pool_transport2.dict()

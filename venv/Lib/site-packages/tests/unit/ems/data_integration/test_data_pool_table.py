from unittest.mock import Mock

import pytest
from pycelonis.ems.data_integration import DataPool
from pycelonis.ems.data_integration.data_pool_table import DataPoolTable
from pycelonis.service.data_ingestion.service import JobType
from pycelonis.service.integration.service import IntegrationService, PoolColumn
from pycelonis_core.utils.errors import PyCelonisNotFoundError


class TestDataPoolTable:
    def test_data_pool_table_from_transport_has_same_values_as_transport(
        self, mock_client, example_data_pool, example_pool_table_transport
    ):
        data_pool_table = DataPoolTable.from_transport(mock_client, example_data_pool.id, example_pool_table_transport)

        assert isinstance(data_pool_table, DataPoolTable)
        assert data_pool_table.client == mock_client
        assert data_pool_table.dict(exclude={"data_pool_id"}) == example_pool_table_transport.dict()
        assert data_pool_table.data_pool_id == example_data_pool.id

    def test_synced_data_pool_table_has_synced_values(self, example_pool_table, example_pool_table_transport):
        UPDATED_SOURCE_NAME = "NEW_NAME"

        example_pool_table_transport.data_source_name = UPDATED_SOURCE_NAME  # Simulate change in EMS
        IntegrationService.get_api_pools_id_tables = Mock(return_value=[example_pool_table_transport])

        example_pool_table.sync()

        IntegrationService.get_api_pools_id_tables.assert_called_once_with(
            example_pool_table.client,
            example_pool_table.data_pool_id,
        )
        assert example_pool_table.dict(exclude={"data_pool_id"}) == example_pool_table_transport.dict()

    def test_sync_throws_not_found_if_table_deleted(self, example_pool_table, example_pool_table_transport):
        IntegrationService.get_api_pools_id_tables = Mock(return_value=[])

        with pytest.raises(PyCelonisNotFoundError):
            example_pool_table.sync()

        IntegrationService.get_api_pools_id_tables.assert_called_once_with(
            example_pool_table.client,
            example_pool_table.data_pool_id,
        )

    def test_getter_attributes(self, example_pool_table):
        for attr in example_pool_table.__getter_attributes__():
            with pytest.warns(UserWarning):
                getattr(example_pool_table, attr)
            assert hasattr(example_pool_table, f"get_{attr}")

    def test_append_creates_data_push_job_and_appends_rows(
        self, example_data_pool, example_pool_table, example_pool_table_transport
    ):
        DF = Mock()
        TABLE_NAME = example_pool_table_transport.name
        CHUNK_SIZE = 100
        data_push_job_mock = Mock()
        data_push_job_mock.add_data_frame = Mock()
        data_push_job_mock.execute = Mock()
        data_push_job_mock.delete = Mock()
        DataPool.create_data_push_job_from = Mock(return_value=data_push_job_mock)

        example_pool_table.append(
            df=DF,
            chunk_size=CHUNK_SIZE,
        )

        DataPool.create_data_push_job_from.assert_called_once_with(
            client=example_pool_table.client,
            data_pool_id=example_pool_table.data_pool_id,
            target_name=TABLE_NAME,
            type_=JobType.DELTA,
            keys=None,
            connection_id=None,
            column_config=None,
        )
        data_push_job_mock.add_data_frame.assert_called_once_with(DF, chunk_size=CHUNK_SIZE, index=False)
        data_push_job_mock.execute.assert_called_once_with()
        data_push_job_mock.delete.assert_called_once_with()

    def test_upsert_creates_data_push_job_and_upserts_rows(
        self, example_data_pool, example_pool_table, example_pool_table_transport
    ):
        DF = Mock()
        TABLE_NAME = example_pool_table_transport.name
        CHUNK_SIZE = 100
        KEYS = ["TEST_KEY"]
        data_push_job_mock = Mock()
        data_push_job_mock.add_data_frame = Mock()
        data_push_job_mock.execute = Mock()
        data_push_job_mock.delete = Mock()
        DataPool.create_data_push_job_from = Mock(return_value=data_push_job_mock)

        example_pool_table.upsert(
            df=DF,
            keys=KEYS,
            chunk_size=CHUNK_SIZE,
        )

        DataPool.create_data_push_job_from.assert_called_once_with(
            client=example_pool_table.client,
            data_pool_id=example_pool_table.data_pool_id,
            target_name=TABLE_NAME,
            type_=JobType.DELTA,
            keys=KEYS,
            connection_id=None,
            column_config=None,
        )
        data_push_job_mock.add_data_frame.assert_called_once_with(DF, chunk_size=CHUNK_SIZE, index=False)
        data_push_job_mock.execute.assert_called_once_with()
        data_push_job_mock.delete.assert_called_once_with()


class TestDataPoolTableColumn:
    def test_get_columns(self, example_pool_table):
        EXAMPLE_COLUMNS = [PoolColumn(name="TEST")]
        IntegrationService.get_api_pools_id_columns = Mock(return_value=EXAMPLE_COLUMNS)

        columns = example_pool_table.get_columns()

        IntegrationService.get_api_pools_id_columns.assert_called_once_with(
            example_pool_table.client,
            example_pool_table.data_pool_id,
            table_name=example_pool_table.name,
            schema_name=example_pool_table.data_source_id,
        )
        assert columns == EXAMPLE_COLUMNS

from unittest.mock import Mock, patch

import pytest
from pycelonis.ems.data_integration.data_export import DataExport
from pycelonis.errors import PyCelonisDataExportFailedError, PyCelonisDataExportRunningError
from pycelonis.service.integration.service import ExportStatus, IntegrationService


class TestDataExport:
    def test_data_export_from_transport_has_same_values_as_transport(
        self, mock_client, example_data_model, example_data_export_transport
    ):
        data_export = DataExport.from_transport(mock_client, example_data_model.id, example_data_export_transport)

        assert isinstance(data_export, DataExport)
        assert data_export.client == mock_client
        assert data_export.data_model_id == example_data_model.id
        assert data_export.dict(exclude={"data_model_id"}) == example_data_export_transport.dict()

    def test_get_chunks_raises_error_if_still_running(self, example_data_export, example_data_export_transport):
        example_data_export_transport.export_status = ExportStatus.RUNNING
        IntegrationService.get_api_v1_compute_data_model_id_export_export_id = Mock(
            return_value=example_data_export_transport
        )

        with pytest.raises(PyCelonisDataExportRunningError):
            list(example_data_export.get_chunks())

        IntegrationService.get_api_v1_compute_data_model_id_export_export_id.assert_called_once_with(
            example_data_export.client, example_data_export.data_model_id, example_data_export.id
        )

    @pytest.mark.parametrize(
        "export_status",
        [ExportStatus.EXPIRED, ExportStatus.FAILED],
    )
    def test_get_chunks_raises_error_if_failed(self, example_data_export, example_data_export_transport, export_status):
        example_data_export_transport.export_status = export_status
        IntegrationService.get_api_v1_compute_data_model_id_export_export_id = Mock(
            return_value=example_data_export_transport
        )

        with pytest.raises(PyCelonisDataExportFailedError):
            list(example_data_export.get_chunks())

        IntegrationService.get_api_v1_compute_data_model_id_export_export_id.assert_called_once_with(
            example_data_export.client, example_data_export.data_model_id, example_data_export.id
        )

    def test_get_chunks_returns_non_chunked_results(self, example_data_export, example_data_export_transport):
        example_data_export_transport.export_status = ExportStatus.DONE
        example_data_export_transport.export_chunks = None
        BYTE_STRING = b"test_bytes"

        IntegrationService.get_api_v1_compute_data_model_id_export_export_id = Mock(
            return_value=example_data_export_transport
        )
        IntegrationService.get_api_v1_compute_data_model_id_export_export_id_result = Mock(return_value=BYTE_STRING)

        chunks = list(example_data_export.get_chunks())

        assert len(chunks) == 1
        assert chunks[0] == BYTE_STRING
        IntegrationService.get_api_v1_compute_data_model_id_export_export_id.assert_called_once_with(
            example_data_export.client, example_data_export.data_model_id, example_data_export.id
        )
        IntegrationService.get_api_v1_compute_data_model_id_export_export_id_result.assert_called_once_with(
            example_data_export.client, example_data_export.data_model_id, example_data_export.id
        )

    def test_get_chunks_returns_chunked_results(self, example_data_export, example_data_export_transport):
        example_data_export_transport.export_status = ExportStatus.DONE
        example_data_export_transport.export_chunks = 2
        BYTE_STRING1 = b"test_bytes1"
        BYTE_STRING2 = b"test_bytes2"

        IntegrationService.get_api_v1_compute_data_model_id_export_export_id = Mock(
            return_value=example_data_export_transport
        )
        example_data_export.client.request = Mock(side_effect=[BYTE_STRING1, BYTE_STRING2])

        chunks = list(example_data_export.get_chunks())

        assert len(chunks) == 2
        assert chunks[0] == BYTE_STRING1
        assert chunks[1] == BYTE_STRING2
        IntegrationService.get_api_v1_compute_data_model_id_export_export_id.assert_called_once_with(
            example_data_export.client, example_data_export.data_model_id, example_data_export.id
        )
        assert example_data_export.client.request.call_count == 2

    @patch("time.sleep", return_value=None)
    def test_wait_for_execution_returns_after_export_done(
        self, patched_time_sleep, example_data_export, example_data_export_transport
    ):
        example_data_export_transport.export_status = ExportStatus.DONE
        IntegrationService.get_api_v1_compute_data_model_id_export_export_id = Mock(
            return_value=example_data_export_transport
        )

        example_data_export.wait_for_execution()

        patched_time_sleep.assert_not_called()  # Not called as status is immediately success
        IntegrationService.get_api_v1_compute_data_model_id_export_export_id.assert_called_once_with(
            example_data_export.client, example_data_export.data_model_id, example_data_export.id
        )

from unittest.mock import Mock

from pycelonis.ems.data_integration.pool_variable import PoolVariable
from pycelonis.service.integration.service import IntegrationService


class TestPoolVariable:
    def test_pool_variable_from_transport_has_same_values_as_transport(
        self, mock_client, example_pool_variable_transport
    ):
        pool_variable = PoolVariable.from_transport(mock_client, example_pool_variable_transport)

        assert isinstance(pool_variable, PoolVariable)
        assert pool_variable.client == mock_client
        assert pool_variable.dict() == example_pool_variable_transport.dict()

    def test_updated_pool_variable_has_updated_values(self, example_pool_variable, example_pool_variable_transport):
        UPDATED_NAME = "NEW_NAME"

        example_pool_variable.name = UPDATED_NAME  # Simulate local change
        example_pool_variable_transport.name = UPDATED_NAME  # Simulate change in EMS
        IntegrationService.put_api_pools_pool_id_variables_id = Mock(return_value=example_pool_variable_transport)

        example_pool_variable.update()

        IntegrationService.put_api_pools_pool_id_variables_id.assert_called_once_with(
            example_pool_variable.client,
            example_pool_variable.pool_id,
            example_pool_variable.id,
            example_pool_variable,
        )
        assert example_pool_variable.dict() == example_pool_variable_transport.dict()

    def test_delete_pool_variable_deletes_correct_pool_variable(self, example_pool_variable):
        IntegrationService.delete_api_pools_pool_id_variables_id = Mock()

        example_pool_variable.delete()

        IntegrationService.delete_api_pools_pool_id_variables_id.assert_called_once_with(
            example_pool_variable.client, example_pool_variable.pool_id, example_pool_variable.id
        )

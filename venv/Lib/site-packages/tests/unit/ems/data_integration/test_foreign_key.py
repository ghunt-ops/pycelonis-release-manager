from unittest.mock import Mock

from pycelonis.ems.data_integration.foreign_key import ForeignKey
from pycelonis.service.integration.service import IntegrationService


class TestForeignKey:
    def test_foreign_key_from_transport_has_same_values_as_transport(
        self, mock_client, example_data_model, example_foreign_key_transport
    ):
        foreign_key = ForeignKey.from_transport(mock_client, example_data_model.pool_id, example_foreign_key_transport)

        assert isinstance(foreign_key, ForeignKey)
        assert foreign_key.client == mock_client
        assert foreign_key.data_pool_id == example_data_model.pool_id
        assert foreign_key.dict(exclude={"data_pool_id"}) == example_foreign_key_transport.dict()

    def test_updated_foreign_key_has_updated_values(self, example_foreign_key, example_foreign_key_transport):
        SOURCE_TABLE_ID = "TEST_ID1"
        TARGET_TABLE_ID = "TEST_ID2"

        example_foreign_key.source_table_id = SOURCE_TABLE_ID  # Simulate local change
        example_foreign_key_transport.source_table_id = SOURCE_TABLE_ID  # Simulate change in EMS
        example_foreign_key_transport.target_table_id = TARGET_TABLE_ID  # Simulate change in EMS
        IntegrationService.put_api_pools_pool_id_data_models_data_model_id_foreign_keys_id = Mock(
            return_value=example_foreign_key_transport
        )

        example_foreign_key.update()

        IntegrationService.put_api_pools_pool_id_data_models_data_model_id_foreign_keys_id.assert_called_once_with(
            example_foreign_key.client,
            example_foreign_key.data_pool_id,
            example_foreign_key.data_model_id,
            example_foreign_key.id,
            example_foreign_key,
        )
        assert example_foreign_key.dict(exclude={"data_pool_id"}) == example_foreign_key_transport.dict()

    def test_synced_foreign_key_has_synced_values(self, example_foreign_key, example_foreign_key_transport):
        SOURCE_TABLE_ID = "TEST_ID1"

        example_foreign_key_transport.source_table_id = SOURCE_TABLE_ID  # Simulate change in EMS
        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_foreign_keys_id = Mock(
            return_value=example_foreign_key_transport
        )

        example_foreign_key.sync()

        IntegrationService.get_api_pools_pool_id_data_models_data_model_id_foreign_keys_id.assert_called_once_with(
            example_foreign_key.client,
            example_foreign_key.data_pool_id,
            example_foreign_key.data_model_id,
            example_foreign_key.id,
        )
        assert example_foreign_key.dict(exclude={"data_pool_id"}) == example_foreign_key_transport.dict()

    def test_delete_foreign_key_deletes_correct_foreign_key(self, example_foreign_key):
        IntegrationService.delete_api_pools_pool_id_data_models_data_model_id_foreign_keys_id = Mock()

        example_foreign_key.delete()

        IntegrationService.delete_api_pools_pool_id_data_models_data_model_id_foreign_keys_id.assert_called_once_with(
            example_foreign_key.client,
            example_foreign_key.data_pool_id,
            example_foreign_key.data_model_id,
            example_foreign_key.id,
        )

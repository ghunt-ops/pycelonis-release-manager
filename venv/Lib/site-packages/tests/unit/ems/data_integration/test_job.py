from datetime import datetime
from unittest.mock import Mock, patch

import pytest
from pycelonis.ems.data_integration.data_model_execution import DataModelExecution
from pycelonis.ems.data_integration.job import Job
from pycelonis.ems.data_integration.table_extraction import TableExtraction
from pycelonis.ems.data_integration.task import Task
from pycelonis.errors import PyCelonisExecutionFailedError, PyCelonisExecutionInProgressError
from pycelonis.service.integration.service import (
    DataModelExecutionTableItem,
    DataModelExecutionTransport,
    EntityStatus,
    ExecutionItemWithPageTransport,
    ExecutionStatus,
    ExtractionMode,
    ExtractionWithTablesTransport,
    IntegrationService,
    JobExecutionConfiguration,
    NewTaskInstanceTransport,
    TableExtractionTransport,
    TaskInstanceTransport,
    TaskType,
)
from pycelonis_core.utils.errors import PyCelonisNotFoundError


class TestJob:
    def test_job_from_transport_has_same_values_as_transport(self, mock_client, example_job_transport):
        job = Job.from_transport(mock_client, example_job_transport)

        assert isinstance(job, Job)
        assert job.client == mock_client
        assert job.dict() == example_job_transport.dict()

    def test_updated_job_has_updated_values(self, example_job, example_job_transport):
        UPDATED_NAME = "NEW_NAME"
        UPDATED_TIME_STAMP = datetime(year=2000, month=1, day=1)

        example_job.name = UPDATED_NAME  # Simulate local change
        example_job_transport.name = UPDATED_NAME  # Simulate change in EMS
        example_job_transport.time_stamp = UPDATED_TIME_STAMP  # Simulate change in EMS
        IntegrationService.put_api_pools_pool_id_jobs_id = Mock(return_value=example_job_transport)

        example_job.update()

        IntegrationService.put_api_pools_pool_id_jobs_id.assert_called_once_with(
            example_job.client,
            example_job.data_pool_id,
            example_job.id,
            example_job,
        )
        assert example_job.dict() == example_job_transport.dict()

    def test_synced_job_has_synced_values(self, example_job, example_job_transport):
        UPDATED_NAME = "NEW_NAME"

        example_job_transport.name = UPDATED_NAME  # Simulate change in EMS
        IntegrationService.get_api_pools_pool_id_jobs_id = Mock(return_value=example_job_transport)

        example_job.sync()

        IntegrationService.get_api_pools_pool_id_jobs_id.assert_called_once_with(
            example_job.client,
            example_job.data_pool_id,
            example_job.id,
        )
        assert example_job.dict() == example_job_transport.dict()

    def test_delete_job_deletes_correct_job(self, example_job):
        IntegrationService.delete_api_pools_pool_id_jobs_job_id = Mock()

        example_job.delete()

        IntegrationService.delete_api_pools_pool_id_jobs_job_id.assert_called_once_with(
            example_job.client, example_job.data_pool_id, example_job.id
        )

    def test_cancel_job_cancels_correct_job(self, example_job):
        IntegrationService.post_api_pools_pool_id_jobs_job_id_cancel = Mock()

        example_job.cancel_execution()

        IntegrationService.post_api_pools_pool_id_jobs_job_id_cancel.assert_called_once_with(
            example_job.client, example_job.data_pool_id, example_job.id
        )


class TestJobExecution:
    @pytest.mark.parametrize(
        "execution_status",
        [ExecutionStatus.RUNNING, ExecutionStatus.QUEUED],
    )
    def test_execution_with_execution_in_progress_throws_execution_in_progress_error(
        self, execution_status, example_job
    ):
        entity_status = EntityStatus(
            id=example_job.id,
            status=execution_status,
        )
        IntegrationService.get_api_pools_pool_id_logs_status = Mock(return_value=[entity_status])

        with pytest.raises(PyCelonisExecutionInProgressError):
            example_job.execute(wait=False)
        IntegrationService.get_api_pools_pool_id_logs_status.assert_called_once_with(
            example_job.client, example_job.data_pool_id
        )

    @pytest.mark.parametrize(
        "execution_status,mode",
        [
            (ExecutionStatus.SUCCESS, ExtractionMode.DELTA),
            (ExecutionStatus.CANCEL, ExtractionMode.DELTA),
            (ExecutionStatus.CANCEL, ExtractionMode.FULL),
            (ExecutionStatus.FAIL, ExtractionMode.FULL),
        ],
    )
    def test_execution_with_no_execution_in_progress_starts_execution(self, execution_status, mode, example_job):
        entity_status = EntityStatus(
            id=example_job.id,
            status=execution_status,
        )
        job_execution_configuration = JobExecutionConfiguration(
            pool_id=example_job.data_pool_id,
            job_id=example_job.id,
            mode=mode,
            execute_only_subset_of_transformations=False,
            transformations=[],
            execute_only_subset_of_extractions=False,
            extractions=[],
            load_only_subset_of_data_models=False,
            data_models=[],
        )

        IntegrationService.get_api_pools_pool_id_logs_status = Mock(return_value=[entity_status])
        IntegrationService.post_api_pools_pool_id_jobs_job_id_execute = Mock()

        example_job.execute(wait=False, mode=mode)

        IntegrationService.get_api_pools_pool_id_logs_status.assert_called_once_with(
            example_job.client, example_job.data_pool_id
        )
        IntegrationService.post_api_pools_pool_id_jobs_job_id_execute.assert_called_once_with(
            example_job.client, example_job.data_pool_id, example_job.id, job_execution_configuration
        )

    def test_partial_execution_with_no_execution_in_progress_starts_execution(self, example_job):
        entity_status = EntityStatus(
            id=example_job.id,
            status=ExecutionStatus.SUCCESS,
        )
        job_execution_configuration = JobExecutionConfiguration(
            pool_id=example_job.data_pool_id,
            job_id=example_job.id,
            mode=ExtractionMode.DELTA,
            execute_only_subset_of_transformations=True,
            transformations=[],
            execute_only_subset_of_extractions=True,
            extractions=[],
            load_only_subset_of_data_models=True,
            data_models=[],
        )

        IntegrationService.get_api_pools_pool_id_logs_status = Mock(return_value=[entity_status])
        IntegrationService.post_api_pools_pool_id_jobs_job_id_execute = Mock()

        example_job.execute(
            wait=False, transformation_ids=[], extraction_configurations=[], data_model_execution_configurations=[]
        )

        IntegrationService.get_api_pools_pool_id_logs_status.assert_called_once_with(
            example_job.client, example_job.data_pool_id
        )
        IntegrationService.post_api_pools_pool_id_jobs_job_id_execute.assert_called_once_with(
            example_job.client, example_job.data_pool_id, example_job.id, job_execution_configuration
        )

    @patch("time.sleep", return_value=None)
    def test_successful_execution_with_wait_raises_no_error(self, patched_time_sleep: Mock, example_job):
        running_entity_status = EntityStatus(
            id=example_job.id,
            status=ExecutionStatus.SUCCESS,
        )
        success_entity_status = EntityStatus(
            id=example_job.id,
            status=ExecutionStatus.SUCCESS,
        )
        IntegrationService.get_api_pools_pool_id_logs_status = Mock(
            side_effect=[
                [success_entity_status],
                [running_entity_status],
                [success_entity_status],
            ]
        )
        IntegrationService.execute_job = Mock()

        example_job.execute(wait=True)

        patched_time_sleep.assert_not_called()  # Not called as status is immediately success
        assert IntegrationService.get_api_pools_pool_id_logs_status.call_count == 3

    @patch("time.sleep", return_value=None)
    @pytest.mark.parametrize(
        "final_execution_status",
        [
            ExecutionStatus.FAIL,
            ExecutionStatus.CANCEL,
        ],
    )
    def test_failed_execution_with_wait_raises_error(
        self, patched_time_sleep: Mock, final_execution_status, example_job
    ):
        running_entity_status = EntityStatus(
            id=example_job.id,
            status=ExecutionStatus.SUCCESS,
        )
        success_entity_status = EntityStatus(
            id=example_job.id,
            status=ExecutionStatus.SUCCESS,
        )
        final_entity_status = EntityStatus(
            id=example_job.id,
            status=final_execution_status,
        )
        IntegrationService.get_api_pools_pool_id_logs_status = Mock(
            side_effect=[
                [success_entity_status],
                [running_entity_status],
                [final_entity_status],
            ]
        )
        IntegrationService.execute_job = Mock()
        execution_item_with_page_transport = ExecutionItemWithPageTransport(execution_items=[])
        IntegrationService.get_api_pools_pool_id_logs_job_id_executions = Mock(
            return_value=execution_item_with_page_transport
        )

        with pytest.raises(PyCelonisExecutionFailedError):
            example_job.execute(wait=True)

        patched_time_sleep.assert_not_called()  # Not called as status is immediately error
        assert IntegrationService.get_api_pools_pool_id_logs_status.call_count == 3


class TestCreateAndGetTask:
    def test_create_task_returns_new_task(self, example_job, example_task_transport):
        TASK_NAME = "TEST_TASK"
        TASK_DESCRIPTION = "TEST_DESCRIPTION"
        TASK_ORDER = 2

        new_task_instance_transport = NewTaskInstanceTransport(
            name=TASK_NAME,
            job_id=example_job.id,
            task_type=TaskType.TRANSFORMATION,
            description=TASK_DESCRIPTION,
            execution_order=TASK_ORDER,
        )
        example_task_transport.name = TASK_NAME
        example_task_transport.description = TASK_DESCRIPTION
        example_task_transport.execution_order = TASK_ORDER
        IntegrationService.post_api_pools_pool_id_jobs_job_id_tasks = Mock(return_value=example_task_transport)

        task = example_job.create_task(TASK_NAME, TaskType.TRANSFORMATION, TASK_DESCRIPTION, execution_order=TASK_ORDER)

        IntegrationService.post_api_pools_pool_id_jobs_job_id_tasks.assert_called_once_with(
            example_job.client, example_job.data_pool_id, example_job.id, new_task_instance_transport
        )
        assert isinstance(task, Task)
        assert task.dict() == example_task_transport.dict()

    def test_create_transformation_task_returns_transformation_task(self, example_job, example_task_transport):
        TASK_NAME = "TEST_TASK"
        TASK_DESCRIPTION = "TEST_DESCRIPTION"
        TASK_ORDER = 2

        new_task_instance_transport = NewTaskInstanceTransport(
            name=TASK_NAME,
            job_id=example_job.id,
            task_type=TaskType.TRANSFORMATION,
            description=TASK_DESCRIPTION,
            execution_order=TASK_ORDER,
        )

        example_task_transport.name = TASK_NAME
        example_task_transport.description = TASK_DESCRIPTION
        example_task_transport.execution_order = TASK_ORDER
        IntegrationService.post_api_pools_pool_id_jobs_job_id_tasks = Mock(return_value=example_task_transport)

        transformation_task = example_job.create_transformation(TASK_NAME, TASK_DESCRIPTION, execution_order=TASK_ORDER)

        IntegrationService.post_api_pools_pool_id_jobs_job_id_tasks.assert_called_once_with(
            example_job.client, example_job.data_pool_id, example_job.id, new_task_instance_transport
        )
        assert isinstance(transformation_task, Task)
        assert transformation_task.dict() == example_task_transport.dict()

    def test_get_task_returns_task(self, example_job, example_task_transport):
        IntegrationService.get_api_pools_pool_id_jobs_job_id_tasks = Mock(return_value=[example_task_transport])

        task = example_job.get_task(example_task_transport.id)

        IntegrationService.get_api_pools_pool_id_jobs_job_id_tasks.assert_called_once_with(
            example_job.client, example_job.data_pool_id, example_job.id
        )
        assert isinstance(task, Task)
        assert task.dict() == example_task_transport.dict()

    def test_get_tasks_returns_list_of_tasks(self, example_job, example_task_transport):
        example_task_transport2 = example_task_transport.copy()
        example_task_transport2.name = "TEST_TASK2"
        IntegrationService.get_api_pools_pool_id_jobs_job_id_tasks = Mock(
            return_value=[example_task_transport, example_task_transport2]
        )

        tasks = example_job.get_tasks()

        IntegrationService.get_api_pools_pool_id_jobs_job_id_tasks.assert_called_once_with(
            example_job.client, example_job.data_pool_id, example_job.id
        )
        assert len(tasks) == 2
        assert isinstance(tasks[0], Task)
        assert isinstance(tasks[1], Task)
        assert tasks[0].dict() == example_task_transport.dict()
        assert tasks[1].dict() == example_task_transport2.dict()

    def test_get_transformations_and_extractions_returns_list_of_transformations_and_extractions(
        self, example_job, example_task_transport
    ):
        example_transformation1 = TaskInstanceTransport(
            **{
                "id": "TEST_ID_TRANSFORMATION_1",
                "task_type": TaskType.TRANSFORMATION,
                "job_id": "eb21d518-28dd-47e7-98f7-f88f2c6ca326",
                "pool_id": "ab21d518-28dd-47e7-98f7-f88f2c6ca326",
                "task_id": "bcdef518-28dd-47e7-98f7-f88f2c6ca326",
            }
        )
        example_transformation2 = TaskInstanceTransport(
            **{
                "id": "TEST_ID_TRANSFORMATION_2",
                "task_type": TaskType.TRANSFORMATION,
                "job_id": "eb21d518-28dd-47e7-98f7-f88f2c6ca326",
                "pool_id": "ab21d518-28dd-47e7-98f7-f88f2c6ca326",
                "task_id": "bcdef518-28dd-47e7-98f7-f88f2c6ca326",
            }
        )
        example_extraction1 = TaskInstanceTransport(
            **{
                "id": "TEST_ID_EXTRACTION_1",
                "task_type": TaskType.EXTRACTION,
                "job_id": "eb21d518-28dd-47e7-98f7-f88f2c6ca326",
                "pool_id": "ab21d518-28dd-47e7-98f7-f88f2c6ca326",
                "task_id": "bcdef518-28dd-47e7-98f7-f88f2c6ca326",
            }
        )
        example_extraction2 = TaskInstanceTransport(
            **{
                "id": "TEST_ID_EXTRACTION_2",
                "task_type": TaskType.EXTRACTION,
                "job_id": "eb21d518-28dd-47e7-98f7-f88f2c6ca326",
                "pool_id": "ab21d518-28dd-47e7-98f7-f88f2c6ca326",
                "task_id": "bcdef518-28dd-47e7-98f7-f88f2c6ca326",
            }
        )
        IntegrationService.get_api_pools_pool_id_jobs_job_id_tasks = Mock(
            return_value=[example_transformation1, example_transformation2, example_extraction1, example_extraction2]
        )

        transformations = example_job.get_transformations()

        assert len(transformations) == 2
        assert isinstance(transformations[0], Task)
        assert isinstance(transformations[1], Task)
        assert transformations[0].dict() == example_transformation1.dict()
        assert transformations[1].dict() == example_transformation2.dict()

        extractions = example_job.get_extractions()

        assert len(extractions) == 2
        assert isinstance(extractions[0], Task)
        assert isinstance(extractions[1], Task)
        assert extractions[0].dict() == example_extraction1.dict()
        assert extractions[1].dict() == example_extraction2.dict()


class TestCreateAndGetDataModelExecution:
    def test_create_data_model_execution_returns_new_data_model_execution(
        self, example_job, example_data_model_execution_transport
    ):
        DATA_MODEL_ID = "TEST_ID"
        TABLE_IDS = ["ID1"]

        create_data_model_execution_transport = DataModelExecutionTransport(
            data_model_id=DATA_MODEL_ID,
            job_id=example_job.id,
            tables=[DataModelExecutionTableItem(id=TABLE_IDS[0])],
            partial_load=True,
        )
        example_data_model_execution_transport.data_model_id = DATA_MODEL_ID  # Simulate change in EMS
        example_data_model_execution_transport.tables = None
        example_data_model_execution_transport2 = example_data_model_execution_transport.copy(deep=True)
        example_data_model_execution_transport2.tables = [
            DataModelExecutionTableItem(id=TABLE_IDS[0], alias_or_name="TEST_TABLE", selected=True)
        ]
        IntegrationService.post_api_pools_pool_id_jobs_job_id_loads = Mock(
            return_value=example_data_model_execution_transport
        )
        IntegrationService.get_api_pools_pool_id_jobs_job_id_loads = Mock(
            return_value=[example_data_model_execution_transport2]
        )

        data_model_execution = example_job.create_data_model_execution(DATA_MODEL_ID, table_ids=TABLE_IDS)

        IntegrationService.post_api_pools_pool_id_jobs_job_id_loads.assert_called_once_with(
            example_job.client,
            example_job.data_pool_id,
            example_job.id,
            create_data_model_execution_transport,
        )
        IntegrationService.get_api_pools_pool_id_jobs_job_id_loads.assert_called_once_with(
            example_job.client,
            example_job.data_pool_id,
            example_job.id,
        )
        assert isinstance(data_model_execution, DataModelExecution)
        assert data_model_execution.dict(exclude={"data_pool_id"}) == example_data_model_execution_transport2.dict()

    def test_get_data_model_execution_returns_data_model_execution(
        self, example_job, example_data_model_execution_transport
    ):
        IntegrationService.get_api_pools_pool_id_jobs_job_id_loads = Mock(
            return_value=[example_data_model_execution_transport]
        )

        data_model_execution = example_job.get_data_model_execution(example_data_model_execution_transport.id)

        IntegrationService.get_api_pools_pool_id_jobs_job_id_loads.assert_called_once_with(
            example_job.client,
            example_job.data_pool_id,
            example_job.id,
        )
        assert isinstance(data_model_execution, DataModelExecution)
        assert data_model_execution.dict(exclude={"data_pool_id"}) == example_data_model_execution_transport.dict()

    def test_get_data_model_execution_raises_error_if_execution_does_not_exist(self, example_job):
        IntegrationService.get_api_pools_pool_id_jobs_job_id_loads = Mock(return_value=[])

        with pytest.raises(PyCelonisNotFoundError):
            example_job.get_data_model_execution("TEST_ID")

        IntegrationService.get_api_pools_pool_id_jobs_job_id_loads.assert_called_once_with(
            example_job.client,
            example_job.data_pool_id,
            example_job.id,
        )

    def test_get_data_model_executions_returns_list_of_data_model_executions(
        self, example_job, example_data_model_execution_transport
    ):
        example_data_model_execution_transport2 = example_data_model_execution_transport.copy()
        example_data_model_execution_transport.data_model_id = "NEW_ID"
        IntegrationService.get_api_pools_pool_id_jobs_job_id_loads = Mock(
            return_value=[example_data_model_execution_transport, example_data_model_execution_transport2]
        )

        data_model_executions = example_job.get_data_model_executions()

        IntegrationService.get_api_pools_pool_id_jobs_job_id_loads.assert_called_once_with(
            example_job.client,
            example_job.data_pool_id,
            example_job.id,
        )
        assert len(data_model_executions) == 2
        assert isinstance(data_model_executions[0], DataModelExecution)
        assert isinstance(data_model_executions[1], DataModelExecution)
        assert data_model_executions[0].dict(exclude={"data_pool_id"}) == example_data_model_execution_transport.dict()
        assert data_model_executions[1].dict(exclude={"data_pool_id"}) == example_data_model_execution_transport2.dict()


class TestCreateAndGetTableExtraction:
    def test_create_table_extraction_returns_new_table_extraction(
        self, example_extraction, example_table_extraction_transport
    ):
        TABLE_NAME = "TEST_TABLE"
        SCHEMA_NAME = "TEST_DATA_MODEL_DESCRIPTION"

        create_table_extraction_transport = TableExtractionTransport(
            table_name=TABLE_NAME,
            schema_name=SCHEMA_NAME,
            task_id=example_extraction.task_id,
            job_id=example_extraction.job_id,
            connector_specific_configuration=[],
            calculated_columns=[],
        )
        example_table_extraction_transport.table_name = TABLE_NAME  # Simulate change in EMS
        example_table_extraction_transport.schema_name = SCHEMA_NAME
        IntegrationService.post_api_pools_pool_id_jobs_job_id_extractions_extraction_id_tables = Mock(
            return_value=[example_table_extraction_transport]
        )

        table_extraction = example_extraction.create_table_extraction(TABLE_NAME, SCHEMA_NAME)

        IntegrationService.post_api_pools_pool_id_jobs_job_id_extractions_extraction_id_tables.assert_called_once_with(
            example_extraction.client,
            example_extraction.pool_id,
            example_extraction.job_id,
            example_extraction.id,
            [create_table_extraction_transport],
        )
        assert isinstance(table_extraction, TableExtraction)
        assert (
            table_extraction.dict(exclude={"data_pool_id", "extraction_id"})
            == example_table_extraction_transport.dict()
        )

    def test_get_table_extraction_returns_table_extraction(
        self, example_extraction, example_table_extraction_transport
    ):
        IntegrationService.get_api_pools_pool_id_jobs_job_id_extractions_extraction_id_tables_table_id = Mock(
            return_value=example_table_extraction_transport
        )

        table_extraction = example_extraction.get_table_extraction(example_table_extraction_transport.id)

        IntegrationService.get_api_pools_pool_id_jobs_job_id_extractions_extraction_id_tables_table_id.assert_called_once_with(
            example_extraction.client,
            example_extraction.pool_id,
            example_extraction.job_id,
            example_extraction.id,
            example_table_extraction_transport.id,
        )
        assert isinstance(table_extraction, TableExtraction)
        assert (
            table_extraction.dict(exclude={"data_pool_id", "extraction_id"})
            == example_table_extraction_transport.dict()
        )
        assert table_extraction.data_pool_id == example_extraction.pool_id
        assert table_extraction.extraction_id == example_extraction.id

    def test_get_table_extractions_returns_list_of_table_extractions(
        self, example_extraction, example_table_extraction_transport
    ):
        example_table_extraction_transport2 = example_table_extraction_transport.copy()
        example_table_extraction_transport2.table_name = "NEW_NAME"
        IntegrationService.get_api_pools_pool_id_jobs_job_id_extractions_extraction_id_expanded = Mock(
            return_value=ExtractionWithTablesTransport(
                tables=[example_table_extraction_transport, example_table_extraction_transport2]
            )
        )

        table_extractions = example_extraction.get_table_extractions()

        IntegrationService.get_api_pools_pool_id_jobs_job_id_extractions_extraction_id_expanded.assert_called_once_with(
            example_extraction.client,
            example_extraction.pool_id,
            example_extraction.job_id,
            example_extraction.id,
        )
        assert len(table_extractions) == 2
        assert isinstance(table_extractions[0], TableExtraction)
        assert isinstance(table_extractions[1], TableExtraction)
        assert (
            table_extractions[0].dict(exclude={"data_pool_id", "extraction_id"})
            == example_table_extraction_transport.dict()
        )
        assert (
            table_extractions[1].dict(exclude={"data_pool_id", "extraction_id"})
            == example_table_extraction_transport2.dict()
        )

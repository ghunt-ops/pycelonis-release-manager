from unittest.mock import Mock

from pycelonis.ems.data_integration.task import Task
from pycelonis.ems.data_integration.task_variable import TaskVariable
from pycelonis.service.integration.service import (
    FilterParserDataType,
    IntegrationService,
    TaskUpdate,
    TaskVariableTransport,
    VariableSettingsTransport,
    VariableType,
    VariableValueTransport,
)


class TestTask:
    def test_task_from_transport_has_same_values_as_transport(self, mock_client, example_task_transport):
        task = Task.from_transport(mock_client, example_task_transport)

        assert isinstance(task, Task)
        assert task.client == mock_client
        assert task.dict() == example_task_transport.dict()

    def test_updated_task_has_updated_values(self, example_task, example_task_transport):
        UPDATED_NAME = "NEW_NAME"
        UPDATED_DESCRIPTION = "NEW_DESCRIPTION"

        example_task.name = UPDATED_NAME  # Simulate local change
        example_task_transport.name = UPDATED_NAME  # Simulate change in EMS
        example_task_transport.description = UPDATED_DESCRIPTION  # Simulate change in EMS
        IntegrationService.put_api_pools_pool_id_jobs_job_id_tasks_task_instance_id = Mock(
            return_value=example_task_transport
        )
        original_task = example_task.copy(deep=True)

        example_task.update()

        IntegrationService.put_api_pools_pool_id_jobs_job_id_tasks_task_instance_id.assert_called_once_with(
            example_task.client,
            example_task.data_pool_id,
            example_task.job_id,
            example_task.id,
            TaskUpdate(**original_task.dict()),
        )
        assert example_task.dict() == example_task_transport.dict()

    def test_synced_task_has_synced_values(self, example_task, example_task_transport):
        UPDATED_NAME = "NEW_NAME"

        example_task_transport.name = UPDATED_NAME  # Simulate change in EMS
        IntegrationService.get_api_pools_pool_id_jobs_job_id_tasks = Mock(return_value=[example_task_transport])

        example_task.sync()

        IntegrationService.get_api_pools_pool_id_jobs_job_id_tasks.assert_called_once_with(
            example_task.client,
            example_task.data_pool_id,
            example_task.job_id,
        )
        assert example_task.dict() == example_task_transport.dict()

    def test_delete_task_deletes_correct_task(self, example_task):
        IntegrationService.delete_api_pools_pool_id_jobs_job_id_tasks_task_instance_id = Mock()

        example_task.delete()

        IntegrationService.delete_api_pools_pool_id_jobs_job_id_tasks_task_instance_id.assert_called_once_with(
            example_task.client, example_task.pool_id, example_task.job_id, example_task.id
        )

    def test_disable_task_disables_correct_task(self, example_task):
        IntegrationService.delete_api_pools_pool_id_jobs_job_id_tasks_task_instance_id_enabled = Mock()

        example_task.disable()

        IntegrationService.delete_api_pools_pool_id_jobs_job_id_tasks_task_instance_id_enabled.assert_called_once_with(
            example_task.client, example_task.pool_id, example_task.job_id, example_task.id
        )

    def test_enable_task_enables_correct_task(self, example_task):
        IntegrationService.post_api_pools_pool_id_jobs_job_id_tasks_task_instance_id_enabled = Mock()

        example_task.enable()

        IntegrationService.post_api_pools_pool_id_jobs_job_id_tasks_task_instance_id_enabled.assert_called_once_with(
            example_task.client, example_task.pool_id, example_task.job_id, example_task.id
        )


class TestUpdateAndGetStatement:
    def test_get_statement(self, example_task, example_transformation_task_statement_transport):
        TEST_STATEMENT = "DROP TABLE IF EXISTS TEST_TABLE"

        example_transformation_task_statement_transport.statement = TEST_STATEMENT
        IntegrationService.get_api_pools_pool_id_jobs_job_id_transformations_transformation_id_statement = Mock(
            return_value=example_transformation_task_statement_transport
        )

        statement = example_task.get_statement()

        IntegrationService.get_api_pools_pool_id_jobs_job_id_transformations_transformation_id_statement.assert_called_once_with(
            example_task.client, example_task.pool_id, example_task.job_id, example_task.id
        )
        assert statement == TEST_STATEMENT

    def test_update_statement(self, example_task, example_transformation_task_statement_transport):
        NEW_STATEMENT = "DROP TABLE IF EXISTS TEST_TABLE2"

        example_transformation_task_statement_transport.statement = NEW_STATEMENT
        IntegrationService.put_api_pools_pool_id_jobs_job_id_transformations_transformation_id_statement = Mock(
            return_value=example_transformation_task_statement_transport
        )

        example_task.update_statement(NEW_STATEMENT)

        IntegrationService.put_api_pools_pool_id_jobs_job_id_transformations_transformation_id_statement.assert_called_once_with(
            example_task.client, example_task.pool_id, example_task.job_id, example_task.id, NEW_STATEMENT
        )


class TestCreateAndGetTaskVariable:
    def test_create_task_variable_returns_task_variable(
        self, mock_client, example_data_pool, example_task, example_task_variable_transport
    ):
        VARIABLE_NAME = "VARIABLE_NAME"
        PLACEHOLDER = "PLACEHOLDER"
        DATA_TYPE = FilterParserDataType.STRING
        VAR_TYPE = VariableType.PUBLIC_CONSTANT
        VALUES = [VariableValueTransport(value="TEST_VALUE", task_instance_id=None)]

        create_task_variable = TaskVariableTransport(
            name=VARIABLE_NAME,
            placeholder=PLACEHOLDER,
            data_type=DATA_TYPE,
            type_=VAR_TYPE,
            values=VALUES,
            pool_id=example_task.pool_id,
            task_id=example_task.task_id,
            settings=VariableSettingsTransport(pool_variable_id=None),
        )

        IntegrationService.post_api_pools_pool_id_tasks_task_instance_id_variables = Mock(
            return_value=example_task_variable_transport
        )

        task_variable = example_task.create_task_variable(name=VARIABLE_NAME, placeholder=PLACEHOLDER, values=VALUES)

        IntegrationService.post_api_pools_pool_id_tasks_task_instance_id_variables.assert_called_once_with(
            example_data_pool.client, example_task.pool_id, example_task.id, create_task_variable
        )
        assert isinstance(task_variable, TaskVariable)
        assert task_variable.dict() == TaskVariable.from_transport(mock_client, example_task_variable_transport).dict()

    def test_get_task_variables_returns_task_variables(self, example_task, example_task_variable_transport):
        IntegrationService.get_api_pools_pool_id_tasks_task_instance_id_variables = Mock(
            return_value=[example_task_variable_transport]
        )

        task_variables = example_task.get_task_variables()

        IntegrationService.get_api_pools_pool_id_tasks_task_instance_id_variables.assert_called_once_with(
            example_task.client,
            example_task.pool_id,
            example_task.id,
        )
        assert len(task_variables) == 1
        assert isinstance(task_variables[0], TaskVariable)
        assert task_variables[0].dict() == example_task_variable_transport.dict()

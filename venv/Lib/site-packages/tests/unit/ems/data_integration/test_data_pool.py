from datetime import datetime
from unittest.mock import Mock

import pytest
from pycelonis.ems.data_integration.data_connection import DataConnection
from pycelonis.ems.data_integration.data_model import DataModel
from pycelonis.ems.data_integration.data_pool import DataPool, PoolVariable
from pycelonis.ems.data_integration.job import Job
from pycelonis.errors import PyCelonisTableAlreadyExistsError
from pycelonis.service.data_ingestion.service import DataIngestionService
from pycelonis.service.data_ingestion.service import DataPushJob
from pycelonis.service.data_ingestion.service import DataPushJob as DataPushJobBase
from pycelonis.service.data_ingestion.service import JobType
from pycelonis.service.integration.service import (
    DataModelTransport,
    ExecutionStatus,
    FilterParserDataType,
    IntegrationService,
    JobTransport,
    PoolVariableTransport,
    VariableType,
    VariableValueTransport,
)
from pycelonis_core.utils.errors import PyCelonisNotFoundError, PyCelonisValueError


class TestDataPool:
    def test_data_pool_from_transport_has_same_values_as_transport(self, mock_client, example_data_pool_transport):
        data_pool = DataPool.from_transport(mock_client, example_data_pool_transport)

        assert isinstance(data_pool, DataPool)
        assert data_pool.client == mock_client
        assert data_pool.dict() == example_data_pool_transport.dict()

    def test_updated_data_pool_has_updated_values(self, example_data_pool, example_data_pool_transport):
        UPDATED_NAME = "NEW_NAME"
        UPDATED_TIME_STAMP = datetime(year=2000, month=1, day=1)

        example_data_pool.name = UPDATED_NAME  # Simulate local change
        example_data_pool_transport.name = UPDATED_NAME  # Simulate change in EMS
        example_data_pool_transport.time_stamp = UPDATED_TIME_STAMP  # Simulate change in EMS
        IntegrationService.put_api_pools_id = Mock(return_value=example_data_pool_transport)

        example_data_pool.update()

        IntegrationService.put_api_pools_id.assert_called_once_with(
            example_data_pool.client,
            example_data_pool.id,
            example_data_pool,
        )
        assert example_data_pool.dict() == example_data_pool_transport.dict()

    def test_synced_data_pool_has_synced_values(self, example_data_pool, example_data_pool_transport):
        UPDATED_NAME = "NEW_NAME"

        data_pool, remote_data_pool_transport = example_data_pool, example_data_pool_transport
        remote_data_pool_transport.name = UPDATED_NAME  # Simulate change in EMS
        IntegrationService.get_api_pools_id = Mock(return_value=remote_data_pool_transport)

        data_pool.sync()

        IntegrationService.get_api_pools_id.assert_called_once_with(
            data_pool.client,
            data_pool.id,
        )
        assert data_pool.dict() == remote_data_pool_transport.dict()

    def test_delete_data_pool_deletes_correct_data_pool(self, example_data_pool):
        IntegrationService.delete_api_pools_id = Mock()

        example_data_pool.delete()

        IntegrationService.delete_api_pools_id.assert_called_once_with(example_data_pool.client, example_data_pool.id)


class TestGetDataConnection:
    def test_get_data_connection_returns_data_connection(self, example_data_pool, example_data_source_transport):
        IntegrationService.get_api_pools_pool_id_data_sources_data_source_id = Mock(
            return_value=example_data_source_transport
        )

        data_connection = example_data_pool.get_data_connection(example_data_source_transport.id)

        IntegrationService.get_api_pools_pool_id_data_sources_data_source_id.assert_called_once_with(
            example_data_pool.client,
            example_data_pool.id,
            example_data_source_transport.id,
        )
        assert isinstance(data_connection, DataConnection)
        assert data_connection.dict() == example_data_source_transport.dict()

    def test_get_data_connections_returns_list_of_data_connections(
        self, example_data_pool, example_data_source_transport
    ):
        example_data_source_transport2 = example_data_source_transport.copy()
        example_data_source_transport2.name = "NEW_NAME"
        IntegrationService.get_api_pools_pool_id_data_sources = Mock(
            return_value=[example_data_source_transport, example_data_source_transport2]
        )

        data_connections = example_data_pool.get_data_connections()

        IntegrationService.get_api_pools_pool_id_data_sources.assert_called_once_with(
            example_data_pool.client,
            example_data_pool.id,
        )
        assert len(data_connections) == 2
        assert isinstance(data_connections[0], DataConnection)
        assert isinstance(data_connections[1], DataConnection)
        assert data_connections[0].dict() == example_data_source_transport.dict()
        assert data_connections[1].dict() == example_data_source_transport2.dict()


class TestCreateAndGetDataModel:
    def test_create_data_model_returns_new_data_model(self, example_data_pool, example_data_model_transport):
        DATA_MODEL_NAME = "TEST_DATA_MODEL"
        DATA_MODEL_DESCRIPTION = "TEST_DATA_MODEL_DESCRIPTION"

        create_data_model_transport = DataModelTransport(name=DATA_MODEL_NAME, description=DATA_MODEL_DESCRIPTION)
        example_data_model_transport.name = DATA_MODEL_NAME  # Simulate change in EMS
        example_data_model_transport.description = DATA_MODEL_DESCRIPTION
        IntegrationService.post_api_pools_pool_id_data_models = Mock(return_value=example_data_model_transport)

        data_model = example_data_pool.create_data_model(DATA_MODEL_NAME, description=DATA_MODEL_DESCRIPTION)

        IntegrationService.post_api_pools_pool_id_data_models.assert_called_once_with(
            example_data_pool.client,
            example_data_pool.id,
            create_data_model_transport,
        )
        assert isinstance(data_model, DataModel)
        assert data_model.dict() == example_data_model_transport.dict()

    def test_get_data_model_returns_data_model(self, example_data_pool, example_data_model_transport):
        IntegrationService.get_api_pools_pool_id_data_models_data_model_id = Mock(
            return_value=example_data_model_transport
        )

        data_model = example_data_pool.get_data_model(example_data_model_transport.id)

        IntegrationService.get_api_pools_pool_id_data_models_data_model_id.assert_called_once_with(
            example_data_pool.client,
            example_data_pool.id,
            example_data_model_transport.id,
        )
        assert isinstance(data_model, DataModel)
        assert data_model.dict() == example_data_model_transport.dict()

    def test_get_data_models_returns_list_of_data_models(self, example_data_pool, example_data_model_transport):
        example_data_model_transport2 = example_data_model_transport.copy()
        example_data_model_transport2.name = "NEW_NAME"
        IntegrationService.get_api_pools_pool_id_data_models = Mock(
            return_value=[example_data_model_transport, example_data_model_transport2]
        )

        data_models = example_data_pool.get_data_models()

        IntegrationService.get_api_pools_pool_id_data_models.assert_called_once_with(
            example_data_pool.client,
            example_data_pool.id,
        )
        assert len(data_models) == 2
        assert isinstance(data_models[0], DataModel)
        assert isinstance(data_models[1], DataModel)
        assert data_models[0].dict() == example_data_model_transport.dict()
        assert data_models[1].dict() == example_data_model_transport2.dict()


class TestCreateAndGetDataPoolTables:
    def test_get_tables(self, example_data_pool, example_pool_table_transport, example_pool_table):
        IntegrationService.get_api_pools_id_tables = Mock(return_value=[example_pool_table_transport])

        tables = example_data_pool.get_tables()

        IntegrationService.get_api_pools_id_tables.assert_called_once_with(
            example_data_pool.client, example_data_pool.id
        )
        assert tables == [example_pool_table]

    def test_get_table(self, example_data_pool, example_pool_table_transport, example_pool_table):
        IntegrationService.get_api_pools_id_tables = Mock(return_value=[example_pool_table_transport])

        table = example_data_pool.get_table(name="TEST")

        IntegrationService.get_api_pools_id_tables.assert_called_once_with(
            example_data_pool.client, example_data_pool.id
        )
        assert table == example_pool_table

    def test_get_table_throws_error_if_table_does_not_exist(
        self, example_data_pool, example_pool_table_transport, example_pool_table
    ):
        IntegrationService.get_api_pools_id_tables = Mock(return_value=[example_pool_table_transport])

        with pytest.raises(PyCelonisNotFoundError):
            example_data_pool.get_table(name="NONEXISTENT")

        IntegrationService.get_api_pools_id_tables.assert_called_once_with(
            example_data_pool.client, example_data_pool.id
        )

    def test_create_table_raises_error_if_not_replace_and_table_exists(
        self, example_data_pool, example_pool_table_transport
    ):
        IntegrationService.get_api_pools_id_tables = Mock(return_value=[example_pool_table_transport])

        with pytest.raises(PyCelonisTableAlreadyExistsError):
            example_data_pool.create_table(Mock(), example_pool_table_transport.name)

        IntegrationService.get_api_pools_id_tables.assert_called_once_with(
            example_data_pool.client, example_data_pool.id
        )

    def test_create_table_raises_error_if_not_replace_and_table_exists_with_same_data_source_id(
        self, example_data_pool, example_pool_table_transport
    ):
        data_source_id = "NEW_ID"
        example_pool_table_transport.data_source_id = data_source_id
        IntegrationService.get_api_pools_id_tables = Mock(return_value=[example_pool_table_transport])

        with pytest.raises(PyCelonisTableAlreadyExistsError):
            example_data_pool.create_table(Mock(), example_pool_table_transport.name, data_source_id=data_source_id)

        IntegrationService.get_api_pools_id_tables.assert_called_once_with(
            example_data_pool.client, example_data_pool.id
        )

    def test_create_table_raises_error_if_no_column_config_and_table_exists(
        self, example_data_pool, example_pool_table_transport
    ):
        IntegrationService.get_api_pools_id_tables = Mock(return_value=[example_pool_table_transport])

        with pytest.raises(PyCelonisValueError):
            example_data_pool.create_table(Mock(), example_pool_table_transport.name, drop_if_exists=True)

        IntegrationService.get_api_pools_id_tables.assert_called_once_with(
            example_data_pool.client, example_data_pool.id
        )

    @pytest.mark.parametrize(
        "column_config",
        [None, Mock()],
    )
    def test_create_table_creates_table(self, example_data_pool, column_config):
        DF = Mock()
        TABLE_NAME = "TEST_TABLE"
        DROP_IF_EXISTS = True
        CHUNK_SIZE = 100
        DATA_SOURCE_ID = "TEST_ID"

        data_push_job_mock = Mock()
        data_push_job_mock.add_data_frame = Mock()
        data_push_job_mock.execute = Mock()
        data_push_job_mock.delete = Mock()
        table_mock = Mock()
        object.__setattr__(
            example_data_pool, "_table_is_in_data_pool", Mock(return_value=True)
        )  # Workaround due to PyDantic not allowing to override functions
        object.__setattr__(
            example_data_pool, "create_data_push_job", Mock(return_value=data_push_job_mock)
        )  # Workaround due to PyDantic not allowing to override functions
        object.__setattr__(
            example_data_pool, "get_table", Mock(return_value=table_mock)
        )  # Workaround due to PyDantic not allowing to override functions

        table = example_data_pool.create_table(
            df=DF,
            table_name=TABLE_NAME,
            drop_if_exists=DROP_IF_EXISTS,
            column_config=column_config,
            chunk_size=CHUNK_SIZE,
            force=True,
            data_source_id=DATA_SOURCE_ID,
        )

        example_data_pool._table_is_in_data_pool.assert_called_once_with(TABLE_NAME, DATA_SOURCE_ID)
        example_data_pool.create_data_push_job.assert_called_once_with(
            target_name=TABLE_NAME,
            type_=JobType.REPLACE,
            column_config=column_config,
            connection_id=DATA_SOURCE_ID,
        )
        example_data_pool.get_table.assert_called_once_with(TABLE_NAME, DATA_SOURCE_ID)
        assert table == table_mock


class TestCreateAndGetDataPushJob:
    def test_create_data_push_job_returns_new_data_push_job(self, example_data_pool, example_data_push_job_transport):
        TARGET_NAME = "TEST_DATA_PUSH_JOB"
        TYPE = JobType.REPLACE
        CONNECTION_ID = "124522552352"

        create_data_push_job_transport = DataPushJobBase(
            target_name=TARGET_NAME,
            data_pool_id=example_data_pool.id,
            type_=TYPE,
            connection_id=CONNECTION_ID,
        )
        example_data_push_job_transport.target_name = TARGET_NAME  # Simulate change in EMS
        example_data_push_job_transport.type_ = TYPE  # Simulate change in EMS
        example_data_push_job_transport.connection_id = CONNECTION_ID  # Simulate change in EMS
        DataIngestionService.post_api_v1_data_push_pool_id_jobs = Mock(return_value=example_data_push_job_transport)

        data_push_job = example_data_pool.create_data_push_job(
            target_name=TARGET_NAME, type=TYPE, connection_id=CONNECTION_ID
        )

        DataIngestionService.post_api_v1_data_push_pool_id_jobs.assert_called_once_with(
            example_data_pool.client,
            example_data_pool.id,
            create_data_push_job_transport,
        )
        assert isinstance(data_push_job, DataPushJob)
        assert data_push_job.dict() == example_data_push_job_transport.dict()

    def test_get_data_push_job_returns_data_push_job(self, example_data_pool, example_data_push_job_transport):
        DataIngestionService.get_api_v1_data_push_pool_id_jobs_id = Mock(return_value=example_data_push_job_transport)

        data_push_job = example_data_pool.get_data_push_job(example_data_push_job_transport.id)

        DataIngestionService.get_api_v1_data_push_pool_id_jobs_id.assert_called_once_with(
            example_data_pool.client,
            example_data_pool.id,
            example_data_push_job_transport.id,
        )
        assert isinstance(data_push_job, DataPushJob)
        assert data_push_job.dict() == example_data_push_job_transport.dict()

    def test_get_data_push_jobs_returns_list_of_data_push_jobs(
        self, example_data_pool, example_data_push_job_transport
    ):
        example_data_push_job_transport2 = example_data_push_job_transport.copy()
        example_data_push_job_transport2.target_name = "NEW_NAME"
        DataIngestionService.get_api_v1_data_push_pool_id_jobs = Mock(
            return_value=[example_data_push_job_transport, example_data_push_job_transport2]
        )

        data_push_jobs = example_data_pool.get_data_push_jobs()

        DataIngestionService.get_api_v1_data_push_pool_id_jobs.assert_called_once_with(
            example_data_pool.client,
            example_data_pool.id,
        )
        assert len(data_push_jobs) == 2
        assert isinstance(data_push_jobs[0], DataPushJob)
        assert isinstance(data_push_jobs[1], DataPushJob)
        assert data_push_jobs[0].dict() == example_data_push_job_transport.dict()
        assert data_push_jobs[1].dict() == example_data_push_job_transport2.dict()


class TestCreateAndGetJob:
    def test_create_job_returns_new_job(self, example_data_pool, example_job_transport):
        JOB_NAME = "TEST_JOB"
        EXECUTION_STATUS = ExecutionStatus.CANCEL

        create_job_transport = JobTransport(name=JOB_NAME, data_pool_id=example_data_pool.id, status=EXECUTION_STATUS)
        example_job_transport.name = JOB_NAME  # Simulate change in EMS
        example_job_transport.status = EXECUTION_STATUS
        IntegrationService.post_api_pools_pool_id_jobs = Mock(
            return_value=example_job_transport, status=EXECUTION_STATUS
        )

        job = example_data_pool.create_job(JOB_NAME, status=EXECUTION_STATUS)

        IntegrationService.post_api_pools_pool_id_jobs.assert_called_once_with(
            example_data_pool.client,
            example_data_pool.id,
            create_job_transport,
        )
        assert isinstance(job, Job)
        assert job.dict() == example_job_transport.dict()

    def test_get_job_returns_job(self, example_data_pool, example_job_transport):
        IntegrationService.get_api_pools_pool_id_jobs_id = Mock(return_value=example_job_transport)

        job = example_data_pool.get_job(example_job_transport.id)

        IntegrationService.get_api_pools_pool_id_jobs_id.assert_called_once_with(
            example_data_pool.client,
            example_data_pool.id,
            example_job_transport.id,
        )
        assert isinstance(job, Job)
        assert job.dict() == example_job_transport.dict()

    def test_get_jobs_returns_list_of_jobs(self, example_data_pool, example_job_transport):
        example_job_transport2 = example_job_transport.copy()
        example_job_transport2.name = "NEW_NAME"
        IntegrationService.get_api_pools_pool_id_jobs = Mock(
            return_value=[example_job_transport, example_job_transport2]
        )

        jobs = example_data_pool.get_jobs()

        IntegrationService.get_api_pools_pool_id_jobs.assert_called_once_with(
            example_data_pool.client,
            example_data_pool.id,
        )
        assert len(jobs) == 2
        assert isinstance(jobs[0], Job)
        assert isinstance(jobs[1], Job)
        assert jobs[0].dict() == example_job_transport.dict()
        assert jobs[1].dict() == example_job_transport2.dict()


class TestCreateAndGetPoolVariable:
    def test_create_pool_variable_returns_pool_variable(
        self, mock_client, example_data_pool, example_pool_variable_transport
    ):
        VARIABLE_NAME = "VARIABLE_NAME"
        PLACEHOLDER = "PLACEHOLDER"
        DATA_TYPE = FilterParserDataType.STRING
        VAR_TYPE = VariableType.PUBLIC_CONSTANT
        VALUES = [VariableValueTransport(value="TEST_VALUE")]

        create_pool_variable = PoolVariableTransport(
            name=VARIABLE_NAME,
            pool_id=example_data_pool.id,
            placeholder=PLACEHOLDER,
            data_type=DATA_TYPE,
            type_=VAR_TYPE,
            values=VALUES,
        )

        IntegrationService.post_api_pools_pool_id_variables = Mock(return_value=example_pool_variable_transport)

        pool_variable = example_data_pool.create_pool_variable(
            name=VARIABLE_NAME, placeholder=PLACEHOLDER, values=VALUES
        )

        IntegrationService.post_api_pools_pool_id_variables.assert_called_once_with(
            example_data_pool.client, example_data_pool.id, create_pool_variable
        )
        assert isinstance(pool_variable, PoolVariable)
        assert pool_variable.dict() == PoolVariable.from_transport(mock_client, example_pool_variable_transport).dict()

    def test_get_pool_variable_returns_pool_variable(self, example_data_pool, example_pool_variable_transport):
        pool_variable_id = example_pool_variable_transport.id
        IntegrationService.get_api_pools_pool_id_variables_id = Mock(return_value=example_pool_variable_transport)

        pool_variable = example_data_pool.get_pool_variable(pool_variable_id)

        IntegrationService.get_api_pools_pool_id_variables_id.assert_called_once_with(
            example_data_pool.client, example_data_pool.id, pool_variable_id
        )
        assert isinstance(pool_variable, PoolVariable)
        assert pool_variable.dict() == example_pool_variable_transport.dict()

    def test_get_pool_variables_returns_pool_variables(self, example_data_pool, example_pool_variable_transport):
        IntegrationService.get_api_pools_pool_id_variables = Mock(return_value=[example_pool_variable_transport])

        pool_variables = example_data_pool.get_pool_variables()

        IntegrationService.get_api_pools_pool_id_variables.assert_called_once_with(
            example_data_pool.client,
            example_data_pool.id,
        )
        assert len(pool_variables) == 1
        assert isinstance(pool_variables[0], PoolVariable)
        assert pool_variables[0].dict() == example_pool_variable_transport.dict()

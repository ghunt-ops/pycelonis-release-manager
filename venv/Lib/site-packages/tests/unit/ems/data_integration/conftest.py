import pytest
from pycelonis.ems.data_integration.data_connection import DataConnection
from pycelonis.ems.data_integration.data_export import DataExport
from pycelonis.ems.data_integration.data_model import DataModel
from pycelonis.ems.data_integration.data_model_execution import DataModelExecution
from pycelonis.ems.data_integration.data_model_table import DataModelTable
from pycelonis.ems.data_integration.data_pool import DataPool
from pycelonis.ems.data_integration.data_pool_table import DataPoolTable
from pycelonis.ems.data_integration.data_push_job import DataPushJob
from pycelonis.ems.data_integration.foreign_key import ForeignKey
from pycelonis.ems.data_integration.job import Job
from pycelonis.ems.data_integration.pool_variable import PoolVariable
from pycelonis.ems.data_integration.process_configuration import ProcessConfiguration
from pycelonis.ems.data_integration.table_extraction import TableExtraction
from pycelonis.ems.data_integration.task import Extraction, Task
from pycelonis.ems.data_integration.task_variable import TaskVariable
from pycelonis.service.data_ingestion.service import DataPushJob as DataPushJobBase
from pycelonis.service.integration.service import (
    DataExportStatusResponse,
    DataModelConfiguration,
    DataModelExecutionTransport,
    DataModelForeignKeyTransport,
    DataModelTableTransport,
    DataModelTransport,
    DataPoolTransport,
    DataSourceTransport,
    ExecutionStatus,
    FilterParserDataType,
    JobTransport,
    NameMappingTransport,
    PoolTable,
    PoolVariableTransport,
    TableExtractionTransport,
    TaskInstanceTransport,
    TaskType,
    TaskVariableTransport,
    TransformationTransport,
    VariableType,
    VariableValueTransport,
)


@pytest.fixture(scope="function")
def example_data_pool_transport():
    return DataPoolTransport(
        **{
            "id": "c1b33d2b-2ce9-4cf7-9322-0a283b9c0978",
            "name": "TEST 2.0",
            "description": None,
            "time_stamp": 1646057684124,
            "configuration_status": "CONFIGURED",
            "locked": False,
            "content_id": None,
            "content_version": 0,
            "tags": [],
            "original_id": None,
            "object_id": "c1b33d2b-2ce9-4cf7-9322-0a283b9c0978",
            "monitoring_target": False,
            "custom_monitoring_target": False,
            "custom_monitoring_target_active": False,
            "exported": False,
            "permissions": [
                "USE_ALL_DATA_MODELS",
                "DATA_PUSH_API",
                "ADMIN",
                "VIEW_DATA_POOL",
                "CONTINUOUS_DATA_PUSH_API",
                "EDIT_ALL_DATA_POOLS",
                "CREATE_DATA_POOL",
            ],
        }
    )


@pytest.fixture(scope="function")
def example_data_pool(mock_client, example_data_pool_transport):
    return DataPool.from_transport(mock_client, example_data_pool_transport)


@pytest.fixture(scope="function")
def example_data_model_transport():
    return DataModelTransport(
        **{
            "id": "5ca0cb21-293b-4069-a727-86df35e90679",
            "name": "TEST_DATA_MODEL",
            "description": None,
            "create_date": 1646061285285,
            "changed_date": None,
            "configuration_skipped": False,
            "pool_id": "c1b33d22-2ce9-4cf7-939d-0a283b9c0978",
            "process_configurations": [],
            "event_log_count": 0,
            "tables": [],
            "foreign_keys": [],
            "data_model_calendar_type": None,
            "factory_calendar": None,
            "custom_calendar": {
                "data_model_id": "5ca0cb21-293b-4069-a727-86df35e90679",
                "entries": [
                    {"id": None, "day": "MONDAY", "working_day": True, "start_time": 540, "end_time": 1020},
                    {"id": None, "day": "TUESDAY", "working_day": True, "start_time": 540, "end_time": 1020},
                    {"id": None, "day": "WEDNESDAY", "working_day": True, "start_time": 540, "end_time": 1020},
                    {"id": None, "day": "THURSDAY", "working_day": True, "start_time": 540, "end_time": 1020},
                    {"id": None, "day": "FRIDAY", "working_day": True, "start_time": 540, "end_time": 1020},
                    {"id": None, "day": "SATURDAY", "working_day": False, "start_time": 540, "end_time": 1020},
                    {"id": None, "day": "SUNDAY", "working_day": False, "start_time": 540, "end_time": 1020},
                ],
            },
            "unavailable": False,
            "editable": True,
            "original_id": None,
            "object_id": "5ca0cb21-293b-4069-a727-86df35e90679",
            "parent_object_id": None,
            "eventlog_automerge_enabled": False,
        }
    )


@pytest.fixture(scope="function")
def example_data_model(mock_client, example_data_model_transport):
    return DataModel.from_transport(mock_client, example_data_model_transport)


@pytest.fixture(scope="function")
def example_job_transport():
    return JobTransport(
        **{
            "name": "JOB",
            "id": "aa87b7ad-071d-4c38-95b1-d4e3660fc59f",
            "data_pool_id": "bbf67fa9-6d1f-4e1e-b485-261baa0892a5",
            "time_stamp": 1646301712932,
            "data_source_id": None,
            "status": ExecutionStatus.CANCEL,
            "current_execution_id": None,
        }
    )


@pytest.fixture(scope="function")
def example_job(mock_client, example_job_transport):
    return Job.from_transport(mock_client, example_job_transport)


@pytest.fixture(scope="function")
def example_data_push_job_transport():
    return DataPushJobBase(
        **{
            "id": "aa88a913-6c68-4358-8f12-0bbbdcf98afb",
            "keys": [],
            "target_name": "TEST",
            "last_modified": 1646910188553,
            "change_date": 1646910188553,
            "last_ping": None,
            "status": "NEW",
            "type_": None,
            "data_pool_id": "aa522855-9793-42d9-b3c1-7e602af88a6a",
            "connection_id": None,
            "target_schema": None,
            "file_type": None,
            "logs": None,
            "data_push_job": None,
            "table_schema": None,
            "csv_parsing_options": None,
            "upsert_strategy": None,
            "fallback_varchar_length": None,
            "mirror_target_names": [],
        }
    )


@pytest.fixture(scope="function")
def example_data_push_job(mock_client, example_data_push_job_transport):
    return DataPushJob.from_transport(mock_client, example_data_push_job_transport)


@pytest.fixture(scope="function")
def example_pool_table_transport():
    return PoolTable(
        **{
            "columns": [],
            "name": "TEST",
            "loader_source": None,
            "available": False,
            "data_source_id": None,
            "data_source_name": None,
            "type_": "TABLE",
            "schema_name": "aa5cfcdf-5bd6-4fbe-874e-bef399eb76ee",
        }
    )


@pytest.fixture(scope="function")
def example_pool_table(mock_client, example_data_pool_transport, example_pool_table_transport):
    return DataPoolTable.from_transport(mock_client, example_data_pool_transport.id, example_pool_table_transport)


@pytest.fixture(scope="function")
def example_data_model_table_transport():
    return DataModelTableTransport(
        **{
            "id": "ee0080f4-382b-4f6d-91f8-533bea20689a",
            "data_source_id": None,
            "name": "TEST_TABLE",
            "alias": "TEST_TABLE",
            "columns": [],
            "alias_or_name": "TEST_TABLE",
            "data_model_id": "5ca0cb21-293b-4069-a727-86df35e90679",
            "use_direct_storage": False,
            "from_business_graph_schema": False,
        }
    )


@pytest.fixture(scope="function")
def example_data_model_table(mock_client, example_data_model_transport, example_data_model_table_transport):
    return DataModelTable.from_transport(
        mock_client, example_data_model_transport.pool_id, example_data_model_table_transport
    )


@pytest.fixture(scope="function")
def example_data_model_configuration_transport():
    return DataModelConfiguration(
        **{
            "id": "8dd0f3d6-1777-42de-97c1-318944529557",
            "case_table_id": None,
            "case_id_column": "CASE_ID",
            "activity_column": "ACTIVITY_EN",
            "timestamp_column": "EVENTTIME",
            "sorting_column": None,
            "endTimestamp_column": None,
            "data_model_id": "a02894d0-945e-4cb8-afb6-8a4b25d790e8",
            "cost_column": None,
            "user_column": None,
            "activity_table_id": "c8e58a1c-dc19-489d-93dc-914e6a4bd668",
            "use_parallel_process": False,
            "parallel_process_parent_column": None,
            "parallel_process_child_column": None,
            "default_configuration": False,
        }
    )


@pytest.fixture(scope="function")
def example_process_configuration(
    mock_client, example_data_model_transport, example_data_model_configuration_transport
):
    return ProcessConfiguration.from_transport(
        mock_client, example_data_model_transport.pool_id, example_data_model_configuration_transport
    )


@pytest.fixture(scope="function")
def example_foreign_key_transport():
    return DataModelForeignKeyTransport(
        **{
            "id": "3028fc5f-a22b-4a59-a67b-91556d0fe5f1",
            "data_model_id": "dd2abd80-fbf7-4aac-ae99-a7c35e9b5af2",
            "source_table_id": "9fb8f4ec-84b4-429e-8622-e64159deb4e5",
            "target_table_id": "68f192aa-f293-4fcd-b5de-47591467c531",
            "columns": [
                {
                    "id": "d46b8484-760f-4819-8937-8fd9f1cfb8a5",
                    "source_column_name": "TEST_COL",
                    "target_column_name": "TEST_COL",
                }
            ],
            "data_pool_id": "32b58d89-8264-455c-86d6-705040dd6645",
        }
    )


@pytest.fixture(scope="function")
def example_foreign_key(mock_client, example_data_model_transport, example_foreign_key_transport):
    return ForeignKey.from_transport(mock_client, example_data_model_transport.pool_id, example_foreign_key_transport)


@pytest.fixture(scope="function")
def example_data_export_transport():
    return DataExportStatusResponse(
        **{
            "id": "0a0afc8b-24ba-428e-8e8e-23ee96502e3c",
            "export_status": "RUNNING",
            "message": None,
            "created": 1648027831260,
            "export_type": "PARQUET",
            "export_chunks": None,
        }
    )


@pytest.fixture(scope="function")
def example_data_export(mock_client, example_data_model_transport, example_data_export_transport):
    return DataExport.from_transport(mock_client, example_data_model_transport.id, example_data_export_transport)


@pytest.fixture(scope="function")
def example_task_transport():
    return TaskInstanceTransport(
        **{
            "id": "e3867967-a7fe-4d5a-af8b-0b42aa28721b",
            "pool_id": "a56c962c-e49c-464b-b2aa-d449d849d75b",
            "task_id": "689edd6c-a938-45bb-8a63-d066d56768ad",
            "task_type": TaskType.TRANSFORMATION,
            "template": False,
            "protection_status": None,
            "name": "TASK",
            "description": "DESCRIPTION",
            "job_id": "eb21d518-28dd-47e7-98f7-f88f2c6ca326",
            "created_at": 1648488881,
            "task_created_at": 1648488881,
            "execution_order": 1,
            "published": False,
            "disabled": False,
            "legal_agreement_accepted": False,
        }
    )


@pytest.fixture(scope="function")
def example_task(mock_client, example_task_transport):
    return Task.from_transport(mock_client, example_task_transport)


@pytest.fixture(scope="function")
def example_extraction_transport():
    return TaskInstanceTransport(
        **{
            "id": "aa867967-a7fe-4d5a-af8b-0b42aa28721b",
            "pool_id": "a56c962c-e49c-464b-b2aa-d449d849d75b",
            "task_id": "689edd6c-a938-45bb-8a63-d066d56768ad",
            "task_type": TaskType.EXTRACTION,
            "template": False,
            "protection_status": None,
            "name": "TASK",
            "description": "DESCRIPTION",
            "job_id": "eb21d518-28dd-47e7-98f7-f88f2c6ca326",
            "created_at": 1648488881,
            "task_created_at": 1648488881,
            "execution_order": 1,
            "published": False,
            "disabled": False,
            "legal_agreement_accepted": False,
        }
    )


@pytest.fixture(scope="function")
def example_extraction(mock_client, example_extraction_transport):
    return Extraction.from_transport(mock_client, example_extraction_transport)


@pytest.fixture(scope="function")
def example_transformation_task_statement_transport():
    return TransformationTransport(
        **{
            "statement": "DROP TABLE IF EXISTS TABLE",
            "id": "e3867967-a7fe-4d5a-af8b-0b42aa28721b",
            "pool_id": "a56c962c-e49c-464b-b2aa-d449d849d75b",
            "task_id": "689edd6c-a938-45bb-8a63-d066d56768ad",
            "task_type": TaskType.TRANSFORMATION,
            "template": False,
            "protection_status": None,
            "name": "TASK",
            "description": "DESCRIPTION",
            "job_id": "eb21d518-28dd-47e7-98f7-f88f2c6ca326",
            "created_at": 1648488881,
            "task_created_at": 1648488881,
            "execution_order": 1,
            "published": False,
            "disabled": False,
            "legal_agreement_accepted": False,
        }
    )


@pytest.fixture(scope="function")
def example_name_mapping_transport():
    return NameMappingTransport(
        **{
            "identifier": "VBAP.LSTANR",
            "translation": "Liefersteuerung Naturalrabatt",
            "language": "DE",
            "description": "",
            "mappingType": "column-mapping",
        }
    )


@pytest.fixture(scope="function")
def example_data_model_execution_transport():
    return DataModelExecutionTransport(
        **{
            "id": "ae9a186d-4723-45c2-9564-4a505a78bd0c",
            "data_model_id": "5ca0cb21-293b-4069-a727-86df35e90679",
            "job_id": "aa87b7ad-071d-4c38-95b1-d4e3660fc59f",
            "disabled": False,
            "partial_load": False,
            "data_model_name": "PYTEST_PYCELONIS_DATA_MODEL_test_data_model_execution_d24b67c7",
            "tables": [{"id": "88a65b15-fbb0-42b8-bb64-8733370beca8", "alias_or_name": "TEST_TABLE", "selected": True}],
        }
    )


@pytest.fixture(scope="function")
def example_data_model_execution(mock_client, example_data_pool, example_data_model_execution_transport):
    return DataModelExecution.from_transport(mock_client, example_data_pool.id, example_data_model_execution_transport)


@pytest.fixture(scope="function")
def example_data_source_transport():
    return DataSourceTransport(
        **{
            "target_schema_name": None,
            "configured": False,
            "signature": "DTrbBkL9h8bOoIjffp29tGzVfnAAAMmBOzOPGG7kh70=",
            "id": "0b0cf598-f125-4c90-83d5-ef0807d10e01",
            "name": "test_data_connection_c57b66c9",
            "pool_id": "758f1700-f7fe-42ac-9970-99e4aa20e027",
            "type": "bigquery",
            "metadata": None,
            "uplink_id": None,
            "connected": False,
            "uplink_name": None,
            "use_uplink": False,
            "configuration": None,
            "exported": False,
            "imported": False,
            "normalized_name": "TEST_DATA_CONNECTION_C57B66C9",
            "parameter_name": "DATASOURCE:TEST_DATA_CONNECTION_C57B66C9",
            "export_available": True,
            "extractor_port": None,
            "anonymization_algorithm": "SHA_1",
            "salt_id": None,
            "custom_extractor_id": None,
            "custom_extractor_name": None,
        }
    )


@pytest.fixture(scope="function")
def example_data_connection(mock_client, example_data_source_transport):
    return DataConnection.from_transport(mock_client, example_data_source_transport)


@pytest.fixture(scope="function")
def example_table_extraction_transport():
    return TableExtractionTransport(
        **{
            "id": "aa39bfeb-a334-4097-8b04-5525f81237e8",
            "task_id": "aa1ff7cb-8441-477c-8b23-f213a128b7dd",
            "table_execution_item_id": None,
            "table_name": "TABLE_NAME",
            "rename_target_table": False,
            "target_table_name": None,
            "columns": [],
            "joins": [],
            "dependent_tables": [],
            "filter_definition": None,
            "delta_filter_definition": None,
            "use_manual_p_ks": False,
            "schema_name": "schema.name",
            "creation_date_column": None,
            "creation_date_value_start": None,
            "creation_date_value_end": None,
            "creation_date_value_today": False,
            "change_date_column": None,
            "change_date_offset": 0,
            "change_date_offset_type": "DAYS",
            "creation_date_parameter_start": None,
            "creation_date_parameter_end": None,
            "job_id": "aa96a652-a9fc-401e-becc-92378e58262f",
            "parent_table": None,
            "depends_on": None,
            "table_extraction_type": "PARENT_TABLE",
            "parent": True,
            "column_value_table": None,
            "column_value_column": None,
            "column_value_target_column": None,
            "column_values_at_a_time": 0,
            "join_type": "NONE",
            "disabled": False,
            "disable_change_log": False,
            "connector_specific_configuration": [],
            "calculated_columns": [],
            "end_date_disabled": False,
            "data_push_delete_strategy": None,
            "data_pool_id": "aafd35d5-7d74-42b3-977a-23e1be378a3d",
            "extraction_id": "aa2867a7-6aa4-4bce-adb4-0ee7d7ae931e",
        }
    )


@pytest.fixture(scope="function")
def example_table_extraction(mock_client, example_job, example_extraction, example_table_extraction_transport):
    return TableExtraction.from_transport(
        mock_client,
        example_job.data_pool_id,
        example_job.id,
        example_extraction.id,
        example_table_extraction_transport,
    )


@pytest.fixture(scope="function")
def example_pool_variable_transport():
    return PoolVariableTransport(
        **{
            "id": "61b43402-c5c4-4945-92f2-7cb4c2451c92",
            "pool_id": "5ca0cb21-293b-4069-a727-86df35e90679",
            "name": "VARIABLE_NAME",
            "placeholder": "PLACEHOLDER",
            "data_type": FilterParserDataType.STRING,
            "type_": VariableType.PUBLIC_CONSTANT,
            "values": [VariableValueTransport(value="TEST_VALUE")],
        }
    )


@pytest.fixture(scope="function")
def example_pool_variable(mock_client, example_pool_variable_transport):
    return PoolVariable.from_transport(mock_client, example_pool_variable_transport)


@pytest.fixture(scope="function")
def example_task_variable_transport():
    return TaskVariableTransport(
        **{
            "id": "61b43402-c5c4-4945-92f2-7cb4c2451c92",
            "pool_id": "a56c962c-e49c-464b-b2aa-d449d849d75b",
            "name": "VARIABLE_NAME",
            "placeholder": "PLACEHOLDER",
            "data_type": FilterParserDataType.STRING,
            "type_": VariableType.PUBLIC_CONSTANT,
            "values": [
                VariableValueTransport(value="TEST_VALUE", task_instance_id="'ff98282a-1b42-475a-8422-d28642aac155'")
            ],
        }
    )


@pytest.fixture(scope="function")
def example_task_variable(mock_client, example_task_variable_transport):
    return TaskVariable.from_transport(mock_client, example_task_variable_transport)

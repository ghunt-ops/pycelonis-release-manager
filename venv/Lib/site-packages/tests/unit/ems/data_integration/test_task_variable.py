from unittest.mock import Mock

import pytest
from pycelonis.ems.data_integration.task_variable import TaskVariable
from pycelonis.service.integration.service import IntegrationService


class TestTaskVariable:
    def test_task_variable_from_transport_has_same_values_as_transport(
        self, mock_client, example_task_variable_transport
    ):
        task_variable = TaskVariable.from_transport(mock_client, example_task_variable_transport)

        assert isinstance(task_variable, TaskVariable)
        assert task_variable.client == mock_client
        assert task_variable.dict() == example_task_variable_transport.dict()

    def test_updated_task_variable_has_updated_values(self, example_task_variable, example_task_variable_transport):
        UPDATED_NAME = "NEW_NAME"

        example_task_variable.name = UPDATED_NAME  # Simulate local change
        example_task_variable_transport.name = UPDATED_NAME  # Simulate change in EMS
        IntegrationService.put_api_pools_pool_id_tasks_task_instance_id_variables_id = Mock(
            return_value=example_task_variable_transport
        )

        example_task_variable.update()

        IntegrationService.put_api_pools_pool_id_tasks_task_instance_id_variables_id.assert_called_once_with(
            example_task_variable.client,
            example_task_variable.pool_id,
            example_task_variable.values[0].task_instance_id,
            example_task_variable.id,
            example_task_variable,
        )
        assert example_task_variable.dict() == example_task_variable_transport.dict()

    def test_delete_task_variable_deletes_correct_task_variable(self, example_task_variable):
        IntegrationService.delete_api_pools_pool_id_tasks_task_instance_id_variables_id = Mock()

        example_task_variable.delete()

        IntegrationService.delete_api_pools_pool_id_tasks_task_instance_id_variables_id.assert_called_once_with(
            example_task_variable.client,
            example_task_variable.pool_id,
            example_task_variable.values[0].task_instance_id,
            example_task_variable.id,
        )

    def test_task_variable_raises_error_if_id_not_set(self, mock_client, example_task_variable_transport):
        example_task_variable_transport.id = None
        task_variable = TaskVariable.from_transport(mock_client, example_task_variable_transport)

        with pytest.raises(ValueError):
            task_variable.update()

        with pytest.raises(ValueError):
            task_variable.delete()

from pycelonis.errors import (
    PyCelonisDataPushExecutionFailedError,
    PyCelonisLoadInProgressError,
    PyCelonisReloadFailedError,
)
from pycelonis.service.data_ingestion.service import DataPushJob as DataPushJobBase
from pycelonis.service.data_ingestion.service import JobStatus
from pycelonis.service.integration.service import DataModelDataLoadHistoryTransport, DataModelLoadStatus
from pycelonis_core.utils.errors import PyCelonisError


class TestPyCelonisError:
    def test_pycelonis_error_sets_message(self):
        message = "TEST_MESSAGE"
        error = PyCelonisError(message)

        assert error.message == message


class TestLoadInProgressError:
    def test_load_in_progress_error_sets_message(self):
        error = PyCelonisLoadInProgressError()

        assert error.message == "There is already a data model reload in progress."


class TestReloadFailedError:
    def test_reload_failed_error_sets_message(self):
        error_message = "TEST_MESSAGE"
        current_compute_load = DataModelDataLoadHistoryTransport(
            load_status=DataModelLoadStatus.ERROR, message=error_message
        )

        error = PyCelonisReloadFailedError(current_compute_load.load_status, current_compute_load.message)

        assert error.message == f"ERROR {error_message}"

    def test_reload_failed_error_sets_message_without_load_status(self):
        error_message = "TEST_MESSAGE"
        current_compute_load = DataModelDataLoadHistoryTransport(message=error_message)

        error = PyCelonisReloadFailedError(current_compute_load.load_status, current_compute_load.message)

        assert error.message == error_message


class TestPyCelonisDataPushExecutionFailedError:
    def test_data_push_execution_failed_error(self):
        ERROR_LOG1 = "ERROR_LOG1"
        ERROR_LOG2 = "ERROR_LOG2"
        data_push_job_transport = DataPushJobBase(status=JobStatus.ERROR, logs=[ERROR_LOG1, ERROR_LOG2])

        error = PyCelonisDataPushExecutionFailedError(data_push_job_transport.status, data_push_job_transport.logs)

        assert error.message == f"Data push job execution failed. Status: ERROR.\nLogs:\n{ERROR_LOG1}\n{ERROR_LOG2}"

    def test_data_push_execution_failed_error_without_status(self):
        ERROR_LOG = "ERROR_LOG"
        data_push_job_transport = DataPushJobBase(logs=[ERROR_LOG])

        error = PyCelonisDataPushExecutionFailedError(data_push_job_transport.status, data_push_job_transport.logs)

        assert error.message == f"Data push job execution failed.\nLogs:\n{ERROR_LOG}"

    def test_data_push_execution_failed_error_without_logs(self):
        data_push_job_transport = DataPushJobBase(status=JobStatus.ERROR)

        error = PyCelonisDataPushExecutionFailedError(data_push_job_transport.status, data_push_job_transport.logs)

        assert error.message == "Data push job execution failed. Status: ERROR."

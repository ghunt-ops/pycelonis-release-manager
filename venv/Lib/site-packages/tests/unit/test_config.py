import pytest
from pycelonis.config import Config
from pycelonis_core.utils.errors import PyCelonisAttributeError


@pytest.mark.xdist_group(name="config")
class TestConfig:
    def setup_method(self):
        Config.reset()  # Resets config to default state before each test

    def teardown_method(self):
        Config.reset()  # Resets config to default state after each test

    def test_default_config(self):
        assert Config.POLLING_WAIT_SECONDS == Config._DEFAULT_CONFIG["POLLING_WAIT_SECONDS"]
        assert Config.DISABLE_TQDM == Config._DEFAULT_CONFIG["DISABLE_TQDM"]

    def test_change_config_value(self):
        Config.DISABLE_TQDM = True
        Config.POLLING_WAIT_SECONDS = 5

        assert Config.DISABLE_TQDM
        assert Config.POLLING_WAIT_SECONDS == 5

    def test_change_polling_wait_seconds_below_1_raises_value_error(self):
        with pytest.raises(ValueError):
            Config.POLLING_WAIT_SECONDS = 0.5

    def test_reset_config(self):
        Config.DISABLE_TQDM = True

        Config.reset()

        assert Config.POLLING_WAIT_SECONDS == Config._DEFAULT_CONFIG["POLLING_WAIT_SECONDS"]
        assert Config.DISABLE_TQDM == Config._DEFAULT_CONFIG["DISABLE_TQDM"]

    def test_load_config_loads_value(self):
        new_config = {"POLLING_WAIT_SECONDS": 5}

        Config.load(new_config)

        assert Config.POLLING_WAIT_SECONDS == new_config["POLLING_WAIT_SECONDS"]
        assert (
            Config.DISABLE_TQDM == Config._DEFAULT_CONFIG["DISABLE_TQDM"]
        )  # Value was not changed and remains default

    def test_load_invalid_parameter_raises_attribute_error(self):
        with pytest.raises(PyCelonisAttributeError):
            Config.load({"INVALID": 5})

    def test_set_invalid_parameter_raises_attribute_error(self):
        with pytest.raises(PyCelonisAttributeError):
            Config.INVALID = 5

    def test_export_config(self):
        assert Config.export() == Config._DEFAULT_CONFIG

import json
from unittest.mock import Mock, patch

import httpx
import pytest
from pycelonis import oauth2


class TestGetOAuth2Token:
    @patch("pycelonis.httpx.post")
    def test_oauth2(self, mocked_post):
        # Arrange
        client_id = "TEST_CLIENT_ID"
        client_secret = "TEST_CLIENT_SECRET"
        scope = "studio integration.data-pools"
        base_url = "https://TEST_URL"
        response_dict = {"access_token": "TEST_TOKEN", "scope": scope, "token_type": "Bearer", "expires_in": 899}
        mocked_post.return_value = httpx.Response(request=Mock(), content=json.dumps(response_dict), status_code=200)
        token_url = "https://TEST_URL/oauth2/token"

        # Act
        callable_f = oauth2(client_id, client_secret, scope)
        token = callable_f(base_url)

        # Assert
        call_args = mocked_post.call_args
        assert token == "TEST_TOKEN"
        assert token_url == call_args.args[0]
        assert call_args.kwargs["data"] == {"grant_type": "client_credentials", "scope": scope}
        assert isinstance(call_args.kwargs["auth"], httpx.BasicAuth)

    @patch("pycelonis.httpx.post")
    def test_oauth2_raises_status_error(self, mocked_post):
        # Arrange
        client_id = "TEST_CLIENT_ID"
        client_secret = "TEST_CLIENT_SECRET"
        scope = "studio integration.data-pools"
        base_url = "TEST_URL"
        mocked_post.return_value = httpx.Response(request=Mock(), status_code=400)

        # Act
        with pytest.raises(httpx.HTTPStatusError) as exc_info:
            callable_f = oauth2(client_id, client_secret, scope)
            callable_f(base_url)

        # Assert
        assert "400 Bad Request" in str(exc_info.value)

    @patch("pycelonis.httpx.post")
    def test_get_expired_token(self, mocked_post):
        # Arrange
        client_id = "TEST_CLIENT_ID"
        client_secret = "TEST_CLIENT_SECRET"
        scope = "studio integration.data-pools"
        base_url = "TEST_URL"
        responses = [
            {"access_token": "TEST_TOKEN_0", "expires_in": -1},
            {"access_token": "TEST_TOKEN_1", "expires_in": 0},
        ]

        mocked_post.side_effect = [
            httpx.Response(request=Mock(), content=json.dumps(responses[0]), status_code=200),
            httpx.Response(request=Mock(), content=json.dumps(responses[1]), status_code=200),
        ]

        # Act

        callable_f = oauth2(client_id, client_secret, scope)
        token1 = callable_f(base_url)
        token2 = callable_f(base_url)

        # Assert
        assert token1 == responses[0]["access_token"]
        assert token2 == responses[1]["access_token"]
        assert mocked_post.call_count == 2

    @patch("pycelonis.httpx.post")
    def test_get_unexpired_token(self, mocked_post):
        # Arrange
        client_id = "TEST_CLIENT_ID"
        client_secret = "TEST_CLIENT_SECRET"
        scope = "studio integration.data-pools"
        base_url = "TEST_URL"
        responses = [
            {"access_token": "TEST_TOKEN_0", "expires_in": 10000},
            {"access_token": "TEST_TOKEN_1", "expires_in": 0},
        ]
        mocked_post.side_effect = [
            httpx.Response(request=Mock(), content=json.dumps(responses[0]), status_code=200),
            httpx.Response(request=Mock(), content=json.dumps(responses[1]), status_code=200),
        ]

        # Act
        callable_f = oauth2(client_id, client_secret, scope)
        token1 = callable_f(base_url)
        token2 = callable_f(base_url)

        # Assert
        assert token1 == token2
        assert mocked_post.call_count == 1

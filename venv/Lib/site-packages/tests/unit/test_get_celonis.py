import logging
from unittest.mock import Mock, call, patch

import pycelonis
import pytest
from packaging.version import Version
from pycelonis import _get_latest_version, _infer_client, get_celonis
from pycelonis.service.team.service import TeamService, TeamTransport
from pycelonis_core.client import KeyType
from pycelonis_core.utils.errors import PyCelonisPermissionError, PyCelonisValueError
from pycelonis_core.utils.ml_workbench import INTERNAL_TRACKING_LOGGER, TRACKING_LOGGER


@patch("pycelonis.__version__", "2.0.0")
class TestGetCelonis:
    @patch("os.environ.get", return_value=None)
    def test_get_celonis_url_none_raises_error(self, patched_os_environ_get):
        with pytest.raises(PyCelonisValueError):
            get_celonis()

    @patch("os.environ.get", return_value=None)
    def test_get_celonis_api_token_none_raises_error(self, patched_os_environ_get):
        TEST_URL = "url.celonis.com"
        msg = "API token or OAuth credentials needed to be set in order to authenticate with PyCelonis client."
        with pytest.raises(PyCelonisValueError, match=msg):  # no env var set will default to reading token from file
            get_celonis(TEST_URL)

    @patch("pycelonis._get_latest_version", return_value=Version("2.0.0"))
    def test_get_celonis_latest_version_returns_celonis_object_key_type_given(
        self, patched_get_latest_version, mock_client
    ):
        TEST_URL = "https://url.celonis.com"
        TEST_API_TOKEN = "5ca0cb21-293b-4069-a727-86df35e90679"

        pycelonis.Client = Mock(return_value=mock_client)
        pycelonis.Celonis = Mock()

        get_celonis(
            base_url=TEST_URL,
            api_token=TEST_API_TOKEN,
            key_type=KeyType.APP_KEY,
            connect=False,
            permissions=False,
        )

        pycelonis.Client.assert_called_once_with(
            base_url=TEST_URL,
            api_token=TEST_API_TOKEN,
            key_type=KeyType.APP_KEY,
            user_agent="pycelonis/2.0.0",
            proxy=None,
            mounts=None,
            retries=0,
            delay=1,
            verify_ssl=False,
        )
        pycelonis.Celonis.assert_called_once_with(mock_client)

    def test_get_celonis_connect_is_true_permission_is_true(self, mock_client):
        TEST_URL = "https://url.celonis.com"
        TEST_API_TOKEN = "5ca0cb21-293b-4069-a727-86df35e90679"

        pycelonis.Client = Mock(return_value=mock_client)
        pycelonis.Celonis = Mock()
        TeamService.get_api_cloud = Mock()
        pycelonis._print_permissions = Mock()

        celonis = get_celonis(
            base_url=TEST_URL, api_token=TEST_API_TOKEN, key_type=KeyType.APP_KEY, connect=True, permissions=True
        )

        pycelonis.Client.assert_called_once_with(
            base_url=TEST_URL,
            api_token=TEST_API_TOKEN,
            key_type=KeyType.APP_KEY,
            user_agent="pycelonis/2.0.0",
            proxy=None,
            mounts=None,
            retries=0,
            delay=1,
            verify_ssl=False,
        )
        pycelonis.Celonis.assert_called_once_with(mock_client)
        TeamService.get_api_cloud.assert_called_once_with(mock_client)
        pycelonis._print_permissions.assert_called_once_with(celonis)

    @pytest.mark.parametrize("test_key_type", [KeyType.APP_KEY, "APP_KEY", None])
    def test_infer_client_returns_client_using_app_key(self, test_key_type):
        TEST_URL = "url.celonis.com"
        TEST_API_TOKEN = "5ca0cb21-293b-4069-a727-86df35e90679"

        pycelonis.Client = Mock()

        _infer_client(TEST_URL, TEST_API_TOKEN, test_key_type, user_agent="pycelonis/2.0.0", verify_ssl=False)

        pycelonis.Client.assert_called_once_with(
            base_url=TEST_URL,
            api_token=TEST_API_TOKEN,
            key_type=KeyType.APP_KEY,
            user_agent="pycelonis/2.0.0",
            proxy=None,
            mounts=None,
            verify_ssl=False,
        )

    def test_infer_client_raises_error_returns_client_using_user_key(self):
        TEST_URL = "url.celonis.com"
        TEST_API_TOKEN = "5ca0cb21-293b-4069-a727-86df35e90679"

        pycelonis.Client = Mock()
        TeamService.get_api_cloud = Mock(side_effect=PyCelonisPermissionError)

        with pytest.raises(PyCelonisPermissionError):
            _infer_client(TEST_URL, TEST_API_TOKEN, None, user_agent="pycelonis/2.0.0", verify_ssl=False)

        blocking_client_calls = [
            call(
                base_url=TEST_URL,
                api_token=TEST_API_TOKEN,
                key_type=KeyType.APP_KEY,
                user_agent="pycelonis/2.0.0",
                proxy=None,
                mounts=None,
                verify_ssl=False,
            ),
            call(
                base_url=TEST_URL,
                api_token=TEST_API_TOKEN,
                key_type=KeyType.USER_KEY,
                user_agent="pycelonis/2.0.0",
                proxy=None,
                mounts=None,
                verify_ssl=False,
            ),
        ]

        pycelonis.Client.assert_has_calls(blocking_client_calls)

    @pytest.mark.parametrize("key_type_env,key_type", [("USER_KEY", KeyType.USER_KEY), ("APP_KEY", KeyType.APP_KEY)])
    def test_get_celonis_key_type_env_sets_key_type(self, key_type_env, key_type, mock_client):
        TEST_URL = "https://url.celonis.com"
        TEST_API_TOKEN = "5ca0cb21-293b-4069-a727-86df35e90679"

        pycelonis.Client = Mock(return_value=mock_client)
        pycelonis.Celonis = Mock()

        with patch("os.environ.get", return_value=key_type_env):
            get_celonis(
                base_url=TEST_URL,
                api_token=TEST_API_TOKEN,
                connect=False,
                permissions=False,
                check_if_outdated=False,
            )

        pycelonis.Client.assert_called_once_with(
            base_url=TEST_URL,
            api_token=TEST_API_TOKEN,
            key_type=key_type,
            user_agent="pycelonis/2.0.0",
            proxy=None,
            mounts=None,
            retries=0,
            delay=1,
            verify_ssl=False,
        )

    def test_tracking_logger_disabled_if_tracking_disabled(self, mock_client):
        TEST_URL = "https://url.celonis.com"
        TEST_API_TOKEN = "5ca0cb21-293b-4069-a727-86df35e90679"

        tracking_logger = logging.getLogger(TRACKING_LOGGER)

        pycelonis.Client = Mock(return_value=mock_client)
        celonis_mock = Mock()
        celonis_mock.team = Mock()
        celonis_mock.team.get_team = Mock(return_value=TeamTransport(tracking_enabled=False))
        pycelonis.Celonis = Mock(return_value=celonis_mock)

        try:
            get_celonis(
                base_url=TEST_URL,
                api_token=TEST_API_TOKEN,
                key_type=KeyType.APP_KEY,
                connect=False,
                permissions=False,
                check_if_outdated=False,
            )

            assert tracking_logger.disabled
        finally:
            tracking_logger.disabled = False

    def test_internal_tracking_logger_not_disabled_if_tracking_disabled(self, mock_client):
        TEST_URL = "https://url.celonis.com"
        TEST_API_TOKEN = "5ca0cb21-293b-4069-a727-86df35e90679"

        internal_tracking_logger = logging.getLogger(INTERNAL_TRACKING_LOGGER)

        pycelonis.Client = Mock(return_value=mock_client)
        celonis_mock = Mock()
        celonis_mock.team = Mock()
        celonis_mock.team.get_team = Mock(return_value=TeamTransport(tracking_enabled=False))
        pycelonis.Celonis = Mock(return_value=celonis_mock)

        get_celonis(
            base_url=TEST_URL,
            api_token=TEST_API_TOKEN,
            key_type=KeyType.APP_KEY,
            connect=False,
            permissions=False,
            check_if_outdated=False,
        )

        assert not internal_tracking_logger.disabled

    def test_tracking_logger_enabled_if_tracking_enabled(self, mock_client):
        TEST_URL = "https://url.celonis.com"
        TEST_API_TOKEN = "5ca0cb21-293b-4069-a727-86df35e90679"

        tracking_logger = logging.getLogger(TRACKING_LOGGER)

        pycelonis.Client = Mock(return_value=mock_client)
        celonis_mock = Mock()
        celonis_mock.team = Mock()
        celonis_mock.team.get_team = Mock(return_value=TeamTransport(tracking_enabled=True))
        pycelonis.Celonis = Mock(return_value=celonis_mock)

        try:
            get_celonis(
                base_url=TEST_URL,
                api_token=TEST_API_TOKEN,
                key_type=KeyType.APP_KEY,
                connect=False,
                permissions=False,
                check_if_outdated=False,
            )

            assert not tracking_logger.disabled
        finally:
            tracking_logger.disabled = False

    def test_internal_tracking_logger_enabled_if_tracking_enabled(self, mock_client):
        TEST_URL = "https://url.celonis.com"
        TEST_API_TOKEN = "5ca0cb21-293b-4069-a727-86df35e90679"

        internal_tracking_logger = logging.getLogger(INTERNAL_TRACKING_LOGGER)

        pycelonis.Client = Mock(return_value=mock_client)
        celonis_mock = Mock()
        celonis_mock.team = Mock()
        celonis_mock.team.get_team = Mock(return_value=TeamTransport(tracking_enabled=True))
        pycelonis.Celonis = Mock(return_value=celonis_mock)

        get_celonis(
            base_url=TEST_URL,
            api_token=TEST_API_TOKEN,
            key_type=KeyType.APP_KEY,
            connect=False,
            permissions=False,
            check_if_outdated=False,
        )

        assert not internal_tracking_logger.disabled

    @patch("pycelonis.httpx.get")
    def test_get_latest_version(self, mock_get):
        mock_resp = Mock()
        mock_get.return_value = mock_resp
        mock_resp.text = "pycelonis-2.0.0.tar.gz, pycelonis-2.1.0.tar.gz, 2.9.0.tar.gz, 2.10.0.tar.gz"
        version = _get_latest_version()

        mock_get.assert_called_with("https://pypi.celonis.cloud/pycelonis/")
        assert str(version) == "2.10.0"

from unittest.mock import Mock

import pytest
from pycelonis.ems import DataModel
from pycelonis.ems.data_integration.data_model_table_column import DataModelTableColumn
from pycelonis.pql.saola_connector import DataModelSaolaConnector
from pycelonis.pql.series import Series
from pycelonis_core.client.client import Client
from saolapy.operator.base import QueryStringPQLOperator


class TestSeries:
    def test_data_model_saola_connector_passed(self):
        saola_connector = Mock()

        series = Series('"TEST"."COL"', saola_connector=saola_connector)

        assert series.saola_connector == saola_connector

    def test_raises_value_error_if_both_data_model_and_saola_connector_passed(self):
        data_model = DataModel(client=Mock(Client), id="TEST_ID", pool_id="TEST_POOL_ID")

        with pytest.raises(ValueError):
            _ = Series('"TEST"."COL"', data_model=data_model, saola_connector=DataModelSaolaConnector(data_model))

    def test_series_data_model_table_column_is_converted_to_string_pql_operator(self):
        column = DataModelTableColumn(
            client=Mock(Client),
            table_name="TEST_TABLE",
            name="TEST_COLUMN",
            data_model_id="DM_ID",
            data_pool_id="DP_ID",
        )

        series = Series(data=column)

        assert isinstance(series.data, QueryStringPQLOperator)
        assert series.data.query_string == '"TEST_TABLE"."TEST_COLUMN"'

    def test_series_data_model_table_column_with_alias_is_converted_to_string_pql_operator(self):
        column = DataModelTableColumn(
            client=Mock(Client),
            table_name="TEST_TABLE",
            table_alias="TEST_ALIAS",
            name="TEST_COLUMN",
            data_model_id="DM_ID",
            data_pool_id="DP_ID",
        )

        series = Series(data=column)

        assert isinstance(series.data, QueryStringPQLOperator)
        assert series.data.query_string == '"TEST_ALIAS"."TEST_COLUMN"'

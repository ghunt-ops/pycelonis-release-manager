from unittest.mock import MagicMock, Mock

import pytest
from pycelonis.ems import DataModel
from pycelonis.ems.apps.content_node.analysis import PublishedAnalysis
from pycelonis.ems.data_integration.data_model_table_column import DataModelTableColumn
from pycelonis.ems.studio.content_node.knowledge_model import KnowledgeModel
from pycelonis.pql.data_frame import DataFrame
from pycelonis.pql.saola_connector import AnalysisSaolaConnector, DataModelSaolaConnector, KnowledgeModelSaolaConnector
from pycelonis_core.client.client import Client
from saolapy.operator.base import QueryStringPQLOperator


class TestDataFrame:
    def test_data_model_saola_connector_created(self):
        data_model = DataModel(client=MagicMock(Client), id="TEST_ID", pool_id="TEST_POOL_ID")

        df = DataFrame({"TEST": '"TEST"."COL"'}, data_model=data_model)

        assert df.saola_connector.data_model == data_model
        assert not hasattr(df, "data_model")

    def test_data_model_saola_connector_passed(self):
        data_model = DataModel(client=MagicMock(Client), id="TEST_ID", pool_id="TEST_POOL_ID")

        df = DataFrame({"TEST": '"TEST"."COL"'}, saola_connector=DataModelSaolaConnector(data_model))

        assert df.saola_connector.data_model == data_model
        assert not hasattr(df, "data_model")

    def test_raises_value_error_if_both_data_model_and_saola_connector_passed(self):
        data_model = DataModel(client=Mock(Client), id="TEST_ID", pool_id="TEST_POOL_ID")

        with pytest.raises(ValueError):
            _ = DataFrame(
                {"TEST": '"TEST"."COL"'}, data_model=data_model, saola_connector=DataModelSaolaConnector(data_model)
            )

    def test_data_frame_data_model_table_column_is_converted_to_string_pql_operator(self):
        column = DataModelTableColumn(
            client=Mock(Client),
            table_name="TEST_TABLE",
            name="TEST_COLUMN",
            data_model_id="DM_ID",
            data_pool_id="DP_ID",
        )

        df = DataFrame({"TEST": column})

        assert isinstance(df["TEST"].data, QueryStringPQLOperator)
        assert df["TEST"].data.query_string == '"TEST_TABLE"."TEST_COLUMN"'

    def test_data_frame_data_model_table_multiple_columns_are_converted_to_string_pql_operator(self):
        column1 = DataModelTableColumn(
            client=Mock(Client),
            table_name="TEST_TABLE",
            name="TEST_COLUMN1",
            data_model_id="DM_ID",
            data_pool_id="DP_ID",
        )
        column2 = DataModelTableColumn(
            client=Mock(Client),
            table_name="TEST_TABLE",
            name="TEST_COLUMN2",
            data_model_id="DM_ID",
            data_pool_id="DP_ID",
        )

        df = DataFrame({"TEST1": column1, "TEST2": column2, "TEST3": '"TEST_TABLE"."TEST_COLUMN3"'})

        assert isinstance(df["TEST1"].data, QueryStringPQLOperator)
        assert df["TEST1"].data.query_string == '"TEST_TABLE"."TEST_COLUMN1"'
        assert isinstance(df["TEST2"].data, QueryStringPQLOperator)
        assert df["TEST2"].data.query_string == '"TEST_TABLE"."TEST_COLUMN2"'
        assert isinstance(df["TEST3"].data, QueryStringPQLOperator)
        assert df["TEST3"].data.query_string == '"TEST_TABLE"."TEST_COLUMN3"'

    def test_data_frame_data_model_table_column_with_alias_is_converted_to_string_pql_operator(self):
        column = DataModelTableColumn(
            client=Mock(Client),
            table_name="TEST_TABLE",
            table_alias="TEST_ALIAS",
            name="TEST_COLUMN",
            data_model_id="DM_ID",
            data_pool_id="DP_ID",
        )

        df = DataFrame({"TEST": column})

        assert isinstance(df["TEST"].data, QueryStringPQLOperator)
        assert df["TEST"].data.query_string == '"TEST_ALIAS"."TEST_COLUMN"'

    def test_data_frame_data_model_table_column_is_supported_by_set_item(self):
        column = DataModelTableColumn(
            client=Mock(Client),
            table_name="TEST_TABLE",
            name="TEST_COLUMN",
            data_model_id="DM_ID",
            data_pool_id="DP_ID",
        )

        df = DataFrame({"TEST": '"TEST"."COL"'})
        df["TEST"] = column

        assert isinstance(df["TEST"].data, QueryStringPQLOperator)
        assert df["TEST"].data.query_string == '"TEST_TABLE"."TEST_COLUMN"'

    def test_data_frame_multiple_data_model_table_column_is_supported_by_set_item(self):
        column1 = DataModelTableColumn(
            client=Mock(Client),
            table_name="TEST_TABLE",
            name="TEST_COLUMN1",
            data_model_id="DM_ID",
            data_pool_id="DP_ID",
        )
        column2 = DataModelTableColumn(
            client=Mock(Client),
            table_name="TEST_TABLE",
            name="TEST_COLUMN2",
            data_model_id="DM_ID",
            data_pool_id="DP_ID",
        )

        df = DataFrame({"TEST1": '"TEST"."COL"', "TEST2": '"TEST"."COL"'})
        df[["TEST1", "TEST2"]] = [column1, column2]

        assert isinstance(df["TEST1"].data, QueryStringPQLOperator)
        assert df["TEST1"].data.query_string == '"TEST_TABLE"."TEST_COLUMN1"'
        assert isinstance(df["TEST2"].data, QueryStringPQLOperator)
        assert df["TEST2"].data.query_string == '"TEST_TABLE"."TEST_COLUMN2"'

    def test_knowledge_model_saola_connector_passed(self):
        data_model = DataModel(client=MagicMock(Client), id="TEST_DM_ID", pool_id="TEST_POOL_ID")
        knowledge_model = KnowledgeModel(
            client=MagicMock(Client),
            id="TEST_KM_ID",
            key="TEST_KM_KEY",
            space_id="TEST_SPACE_ID",
            root_with_key="TEST_ROOT_KEY",
            root_node_key="TEST_ROOT_NODE_KEY",
        )

        df = DataFrame(
            {"TEST": '"TEST"."COL"'}, saola_connector=KnowledgeModelSaolaConnector(data_model, knowledge_model)
        )

        assert df.saola_connector.data_model == data_model
        assert df.saola_connector.knowledge_model == knowledge_model

    def test_analysis_saola_connector_passed(self):
        data_model = DataModel(client=MagicMock(Client), id="TEST_DM_ID", pool_id="TEST_POOL_ID")
        analysis = PublishedAnalysis(
            client=MagicMock(Client),
            id="TEST_PA_ID",
            key="TEST_PA_KEY",
            space_id="TEST_SPACE_ID",
            root_with_key="TEST_ROOT_KEY",
        )

        df = DataFrame({"TEST": '"TEST"."COL"'}, saola_connector=AnalysisSaolaConnector(data_model, analysis))

        assert df.saola_connector.data_model == data_model
        assert df.saola_connector.analysis == analysis

from unittest.mock import Mock

from pycelonis.pql.pql_debugger import PQLDebugger
from pycelonis.service.pql_language.service import (
    Diagnostic,
    Position,
    PqlBasicBatchParams,
    PqlBasicParams,
    PqlDiagnosticsBatchResponse,
    PqlDiagnosticsResponse,
    PqlLanguageService,
    PqlQueryType,
    Range,
)
from pycelonis_core.client.client import Client


class TestPQLDebugger:
    def test_debug_returns_list_with_no_error_message(self):
        query = "TEST_QUERY"
        batch_response = PqlDiagnosticsBatchResponse(results=[PqlDiagnosticsResponse(diagnostics=[])])
        mock_client = Mock(Client)
        data_model_id = "DATA_MODEL_ID"
        query_type = PqlQueryType.FILTER

        PqlLanguageService.post_api_lsp_publish_diagnostics_batch = Mock(return_value=batch_response)

        error_messages = PQLDebugger.debug(mock_client, data_model_id, query, query_type=query_type)

        assert len(error_messages) == 0
        PqlLanguageService.post_api_lsp_publish_diagnostics_batch.assert_called_once_with(
            mock_client,
            PqlBasicBatchParams(
                batch=[PqlBasicParams(query=query, query_type=query_type, data_model_id=data_model_id)]
            ),
        )

    def test_debug_returns_list_with_single_error_message(self):
        query = "TEST_QUERY"
        batch_response = PqlDiagnosticsBatchResponse(
            results=[
                PqlDiagnosticsResponse(
                    diagnostics=[
                        Diagnostic(
                            message="test_message",
                            range=Range(start=Position(line=0, character=1), end=Position(line=0, character=1)),
                        )
                    ]
                )
            ]
        )
        mock_client = Mock(Client)
        data_model_id = "DATA_MODEL_ID"
        query_type = PqlQueryType.FILTER

        PqlLanguageService.post_api_lsp_publish_diagnostics_batch = Mock(return_value=batch_response)

        error_messages = PQLDebugger.debug(mock_client, data_model_id, query, query_type=query_type)

        assert len(error_messages) == 1
        assert "test_message" in error_messages[0]
        assert query in error_messages[0]
        PqlLanguageService.post_api_lsp_publish_diagnostics_batch.assert_called_once_with(
            mock_client,
            PqlBasicBatchParams(
                batch=[PqlBasicParams(query=query, query_type=query_type, data_model_id=data_model_id)]
            ),
        )

    def test_debug_returns_list_with_multiple_error_messages(self):
        query = "TEST_QUERY"
        batch_response = PqlDiagnosticsBatchResponse(
            results=[
                PqlDiagnosticsResponse(
                    diagnostics=[
                        Diagnostic(
                            message="test_message1",
                            range=Range(start=Position(line=0, character=1), end=Position(line=0, character=1)),
                        ),
                        Diagnostic(
                            message="test_message2",
                            range=Range(start=Position(line=0, character=1), end=Position(line=0, character=1)),
                        ),
                    ]
                )
            ]
        )
        mock_client = Mock(Client)
        data_model_id = "DATA_MODEL_ID"
        query_type = PqlQueryType.FILTER

        PqlLanguageService.post_api_lsp_publish_diagnostics_batch = Mock(return_value=batch_response)

        error_messages = PQLDebugger.debug(mock_client, data_model_id, query, query_type=query_type)

        assert len(error_messages) == 2
        assert "test_message1" in error_messages[0]
        assert query in error_messages[0]
        assert "test_message2" in error_messages[1]
        assert query in error_messages[1]
        PqlLanguageService.post_api_lsp_publish_diagnostics_batch.assert_called_once_with(
            mock_client,
            PqlBasicBatchParams(
                batch=[PqlBasicParams(query=query, query_type=query_type, data_model_id=data_model_id)]
            ),
        )

    def test_debug_caches_results(self):
        query = "TEST_QUERY"
        batch_response = PqlDiagnosticsBatchResponse(results=[PqlDiagnosticsResponse(diagnostics=[])])
        mock_client = Mock(Client)
        data_model_id = "DATA_MODEL_ID"
        query_type = PqlQueryType.FILTER

        PqlLanguageService.post_api_lsp_publish_diagnostics_batch = Mock(return_value=batch_response)

        error_messages1 = PQLDebugger.debug(mock_client, data_model_id, query, query_type=query_type)
        error_messages2 = PQLDebugger.debug(mock_client, data_model_id, query, query_type=query_type)

        assert error_messages1 == error_messages2
        # Only called once as second time cache is used
        PqlLanguageService.post_api_lsp_publish_diagnostics_batch.assert_called_once_with(
            mock_client,
            PqlBasicBatchParams(
                batch=[PqlBasicParams(query=query, query_type=query_type, data_model_id=data_model_id)]
            ),
        )

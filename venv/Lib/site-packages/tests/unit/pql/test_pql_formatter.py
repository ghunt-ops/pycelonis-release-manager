from unittest.mock import Mock

from saolapy.pql.base import PQL, OrderByColumn, PQLColumn, PQLFilter
from saolapy.pql.formatter import OrderByColumnFormatter, PQLColumnFormatter, PQLFormatter


class TestPQLColumnFormatter:
    def test_format_pql_column(self):
        COLUMN = PQLColumn(name="NAME", query="QUERY")

        formatted_column = PQLColumnFormatter().format(COLUMN)

        assert formatted_column == 'QUERY AS "NAME"'


class TestOrderByColumnFormatter:
    def test_format_ascending_order_by_column(self):
        COLUMN = OrderByColumn(query="QUERY", ascending=True)

        formatted_column = OrderByColumnFormatter().format(COLUMN)

        assert formatted_column == "QUERY ASC"

    def test_format_descending_order_by_column(self):
        COLUMN = OrderByColumn(query="QUERY", ascending=False)

        formatted_column = OrderByColumnFormatter().format(COLUMN)

        assert formatted_column == "QUERY DESC"


class TestPQLFormatter:
    def test_format_query_with_single_column(self):
        QUERY = PQL(columns=[PQLColumn(name="NAME", query="QUERY")])
        COLUMN_PLACEHOLDER = "COLUMN_PLACEHOLDER"

        pql_column_formatter = Mock(PQLColumnFormatter)
        pql_column_formatter.format = Mock(return_value=COLUMN_PLACEHOLDER)
        pql_formatter = PQLFormatter(pql_column_formatter=pql_column_formatter)

        formatted_query = pql_formatter.format(QUERY)

        assert len(formatted_query) == 1  # Only table statement no filters
        assert formatted_query[-1] == f"TABLE (\n{COLUMN_PLACEHOLDER}\n)\nNOLIMIT;"

    def test_format_query_with_multiple_columns(self):
        QUERY = PQL(columns=[PQLColumn(name="NAME", query="QUERY"), PQLColumn(name="NAME2", query="QUERY")])
        COLUMN_PLACEHOLDER = "COLUMN_PLACEHOLDER"

        pql_column_formatter = Mock(PQLColumnFormatter)
        pql_column_formatter.format = Mock(return_value=COLUMN_PLACEHOLDER)

        pql_formatter = PQLFormatter(pql_column_formatter=pql_column_formatter)
        formatted_query = pql_formatter.format(QUERY)

        assert len(formatted_query) == 1  # Only table statement no filters
        assert formatted_query[-1] == f"TABLE (\n{COLUMN_PLACEHOLDER},\n{COLUMN_PLACEHOLDER}\n)\nNOLIMIT;"

    def test_format_query_with_single_filter(self):
        FILTER_STRING = "FILTER 1=1;"
        QUERY = PQL(filters=[PQLFilter(query=FILTER_STRING)])

        pql_formatter = PQLFormatter()
        formatted_query = pql_formatter.format(QUERY)

        assert len(formatted_query) == 2  # Filter + table statement
        assert formatted_query[0] == FILTER_STRING
        assert formatted_query[-1] == "TABLE (\n\n)\nNOLIMIT;"

    def test_format_query_with_multiple_filters(self):
        FILTER_STRING1 = "FILTER 1=1;"
        FILTER_STRING2 = "FILTER 2=2;"
        QUERY = PQL(filters=[PQLFilter(query=FILTER_STRING1), PQLFilter(query=FILTER_STRING2)])

        pql_formatter = PQLFormatter()
        formatted_query = pql_formatter.format(QUERY)

        assert len(formatted_query) == 3  # 2 Filter + table statement
        assert formatted_query[0] == FILTER_STRING1
        assert formatted_query[1] == FILTER_STRING2
        assert formatted_query[-1] == "TABLE (\n\n)\nNOLIMIT;"

    def test_format_query_with_single_order_by_column(self):
        QUERY = PQL(order_by_columns=[OrderByColumn(query="QUERY")])
        ORDER_BY_PLACEHOLDER = "ORDER_BY_PLACEHOLDER"

        order_by_column_formatter = Mock(OrderByColumnFormatter)
        order_by_column_formatter.format = Mock(return_value=ORDER_BY_PLACEHOLDER)
        pql_formatter = PQLFormatter(order_by_column_formatter=order_by_column_formatter)

        formatted_query = pql_formatter.format(QUERY)

        assert len(formatted_query) == 1  # Only table statement no filters
        assert formatted_query[-1] == f"TABLE (\n\n)\nORDER BY {ORDER_BY_PLACEHOLDER}\nNOLIMIT;"

    def test_format_query_with_multiple_order_by_columns(self):
        QUERY = PQL(order_by_columns=[OrderByColumn(query="QUERY"), OrderByColumn(query="QUERY")])
        ORDER_BY_PLACEHOLDER = "ORDER_BY_PLACEHOLDER"

        order_by_column_formatter = Mock(OrderByColumnFormatter)
        order_by_column_formatter.format = Mock(return_value=ORDER_BY_PLACEHOLDER)
        pql_formatter = PQLFormatter(order_by_column_formatter=order_by_column_formatter)

        formatted_query = pql_formatter.format(QUERY)

        assert len(formatted_query) == 1  # Only table statement no filters
        assert formatted_query[-1] == f"TABLE (\n\n)\nORDER BY {ORDER_BY_PLACEHOLDER}, {ORDER_BY_PLACEHOLDER}\nNOLIMIT;"

    def test_format_distinct_query(self):
        QUERY = PQL(distinct=True)

        pql_formatter = PQLFormatter()
        formatted_query = pql_formatter.format(QUERY)

        assert len(formatted_query) == 1  # Only table statement no filters
        assert formatted_query[-1] == "TABLE (DISTINCT\n\n)\nNOLIMIT;"

    def test_format_limit_query(self):
        LIMIT = 10
        QUERY = PQL(limit=LIMIT)

        pql_formatter = PQLFormatter()
        formatted_query = pql_formatter.format(QUERY)

        assert len(formatted_query) == 1  # Only table statement no filters
        assert formatted_query[-1] == f"TABLE (\n\n)\nLIMIT {LIMIT};"

    def test_format_offset_query(self):
        OFFSET = 10
        QUERY = PQL(offset=OFFSET)

        pql_formatter = PQLFormatter()
        formatted_query = pql_formatter.format(QUERY)

        assert len(formatted_query) == 1  # Only table statement no filters
        assert formatted_query[-1] == f"TABLE (\n\n)\nNOLIMIT OFFSET {OFFSET};"

    def test_format_full_query(self):
        COLUMN_PLACEHOLDER = "COLUMN_PLACEHOLDER"
        ORDER_BY_PLACEHOLDER = "ORDER_BY_PLACEHOLDER"
        FILTER_STRING1 = "FILTER 1=1;"
        FILTER_STRING2 = "FILTER 2=2;"
        LIMIT = 10
        OFFSET = 20

        pql_column_formatter = Mock(PQLColumnFormatter)
        pql_column_formatter.format = Mock(return_value=COLUMN_PLACEHOLDER)
        order_by_column_formatter = Mock(OrderByColumnFormatter)
        order_by_column_formatter.format = Mock(return_value=ORDER_BY_PLACEHOLDER)

        QUERY = PQL(
            columns=[PQLColumn(name="NAME", query="QUERY"), PQLColumn(name="NAME2", query="QUERY")],
            filters=[PQLFilter(query=FILTER_STRING1), PQLFilter(query=FILTER_STRING2)],
            order_by_columns=[OrderByColumn(query="QUERY"), OrderByColumn(query="QUERY")],
            distinct=True,
            limit=LIMIT,
            offset=OFFSET,
        )

        pql_formatter = PQLFormatter(
            pql_column_formatter=pql_column_formatter, order_by_column_formatter=order_by_column_formatter
        )
        formatted_query = pql_formatter.format(QUERY)

        assert len(formatted_query) == 3  # 2 Filter + table statement
        assert formatted_query[0] == FILTER_STRING1
        assert formatted_query[1] == FILTER_STRING2
        assert (
            formatted_query[-1] == f"TABLE (DISTINCT\n{COLUMN_PLACEHOLDER},\n{COLUMN_PLACEHOLDER}\n)\n"
            f"ORDER BY {ORDER_BY_PLACEHOLDER}, {ORDER_BY_PLACEHOLDER}\n"
            f"LIMIT {LIMIT} OFFSET {OFFSET};"
        )

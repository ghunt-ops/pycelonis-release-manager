from unittest.mock import Mock

import pytest
from pycelonis.pql.pql_parser import PQLParser
from pycelonis.service.pql_language.service import (
    Position,
    PqlBasicParams,
    PqlLanguageService,
    PqlParseTreeNodeTransport,
    PqlParseTreeResponse,
    PqlQueryType,
    Range,
)
from pycelonis_core.client.client import Client


class TestPQLParser:
    def test_extract_sub_query_cause_single_line_0_2(self):
        query = "TEST"
        range_ = Range(start=Position(line=0, character=0), end=Position(line=0, character=2))

        error_cause = PQLParser.extract_sub_query(query, range_.start, range_.end)

        assert error_cause == "TES"

    def test_extract_sub_query_cause_single_line_0_5(self):
        query = "TEST"
        range_ = Range(start=Position(line=0, character=0), end=Position(line=0, character=5))

        error_cause = PQLParser.extract_sub_query(query, range_.start, range_.end)

        assert error_cause == "TEST"

    def test_extract_sub_query_cause_single_line_1_5(self):
        query = "TEST"
        range_ = Range(start=Position(line=0, character=1), end=Position(line=0, character=5))

        error_cause = PQLParser.extract_sub_query(query, range_.start, range_.end)

        assert error_cause == "EST"

    def test_extract_sub_query_cause_single_line_1_2(self):
        query = "TEST"
        range_ = Range(start=Position(line=0, character=1), end=Position(line=0, character=2))

        error_cause = PQLParser.extract_sub_query(query, range_.start, range_.end)

        assert error_cause == "ES"

    def test_extract_sub_query_cause_multi_line(self):
        query = "TEST\nABC\nTEST"
        range_ = Range(start=Position(line=1, character=1), end=Position(line=1, character=2))

        error_cause = PQLParser.extract_sub_query(query, range_.start, range_.end)

        assert error_cause == "BC"

    def test_extract_sub_query_cause_across_multi_line(self):
        query = "TEST\nABC\nDEF\nTEST"
        range_ = Range(start=Position(line=1, character=1), end=Position(line=2, character=1))

        error_cause = PQLParser.extract_sub_query(query, range_.start, range_.end)

        assert error_cause == "BC\nDE"

    def test_extract_sub_query_cause_single_line_1_0_0_2(self):
        query = "TEST"
        range_ = Range(start=Position(line=1, character=0), end=Position(line=0, character=2))

        error_cause = PQLParser.extract_sub_query(query, range_.start, range_.end)

        assert error_cause == ""

    def test_extract_sub_query_cause_empty_query_single_line_1_2(self):
        query = ""
        range_ = Range(start=Position(line=1, character=0), end=Position(line=0, character=2))

        error_cause = PQLParser.extract_sub_query(query, range_.start, range_.end)

        assert error_cause == ""

    def test_convert_to_condition_returns_condition(self):
        query = "FILTER TEST_CONDITION;"
        parsed_tree = PqlParseTreeResponse(
            root=PqlParseTreeNodeTransport(
                children=[
                    PqlParseTreeNodeTransport(
                        rule_name="filterQuery",
                        children=[
                            PqlParseTreeNodeTransport(
                                begin=Position(
                                    line=0,
                                    character=7,
                                ),
                                end=Position(line=0, character=20),
                            )
                        ],
                    )
                ]
            )
        )
        mock_client = Mock(Client)
        data_model_id = "DATA_MODEL_ID"
        PqlLanguageService.post_api_lsp_parse_tree = Mock(return_value=parsed_tree)

        filter_expressions = PQLParser.convert_filter_to_expressions(mock_client, data_model_id, query)

        assert len(filter_expressions) == 1
        assert filter_expressions[0] == "TEST_CONDITION"
        PqlLanguageService.post_api_lsp_parse_tree.assert_called_once_with(
            mock_client, PqlBasicParams(query=query, query_type=PqlQueryType.FILTER, data_model_id=data_model_id)
        )

    def test_convert_to_condition_uses_caching(self):
        query = "FILTER TEST_CONDITION;"
        parsed_tree = PqlParseTreeResponse(
            root=PqlParseTreeNodeTransport(
                children=[
                    PqlParseTreeNodeTransport(
                        rule_name="filterQuery",
                        children=[
                            PqlParseTreeNodeTransport(
                                begin=Position(
                                    line=0,
                                    character=7,
                                ),
                                end=Position(line=0, character=20),
                            )
                        ],
                    )
                ]
            )
        )
        mock_client = Mock(Client)
        data_model_id = "DATA_MODEL_ID"
        PqlLanguageService.post_api_lsp_parse_tree = Mock(return_value=parsed_tree)

        filter_expressions1 = PQLParser.convert_filter_to_expressions(mock_client, data_model_id, query)
        filter_expressions2 = PQLParser.convert_filter_to_expressions(mock_client, data_model_id, query)
        assert filter_expressions1 == filter_expressions2
        PqlLanguageService.post_api_lsp_parse_tree.assert_called_once_with(
            mock_client, PqlBasicParams(query=query, query_type=PqlQueryType.FILTER, data_model_id=data_model_id)
        )

    def test_convert_to_condition_raises_value_error_due_to_no_filter_statement(self):
        query = "FILTER TEST_CONDITION;"
        parsed_tree = PqlParseTreeResponse(
            root=PqlParseTreeNodeTransport(
                children=[
                    PqlParseTreeNodeTransport(
                        rule_name="INVALID_QUERY",
                        children=[
                            PqlParseTreeNodeTransport(
                                begin=Position(
                                    line=0,
                                    character=7,
                                ),
                                end=Position(line=0, character=20),
                            )
                        ],
                    )
                ]
            )
        )
        mock_client = Mock(Client)
        data_model_id = "DATA_MODEL_ID"
        PqlLanguageService.post_api_lsp_parse_tree = Mock(return_value=parsed_tree)

        with pytest.raises(ValueError):
            _ = PQLParser.convert_filter_to_expressions(mock_client, data_model_id, query)

    def test_convert_to_condition_empty_root_returns_empty_list(self):
        query = "FILTER TEST_CONDITION;"
        parsed_tree = PqlParseTreeResponse(root=None)
        mock_client = Mock(Client)
        data_model_id = "DATA_MODEL_ID"
        PqlLanguageService.post_api_lsp_parse_tree = Mock(return_value=parsed_tree)

        filter_expressions = PQLParser.convert_filter_to_expressions(mock_client, data_model_id, query)

        assert len(filter_expressions) == 0

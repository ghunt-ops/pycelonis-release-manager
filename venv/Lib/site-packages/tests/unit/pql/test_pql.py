from unittest.mock import Mock

import pytest
from pycelonis.pql.pql import PQL, OrderByColumn, PQLColumn, PQLFilter

try:
    from pydantic.v1 import ValidationError
except ImportError:
    from pydantic import ValidationError


class TestPQLColumn:
    def test_pql_column_values_set(self):
        NAME = "NAME"
        QUERY = "QUERY"

        pql_column = PQLColumn(name=NAME, query=QUERY)

        assert pql_column.name == NAME
        assert pql_column.query == QUERY


class TestPQLFilter:
    def test_pql_filter_values_set(self):
        QUERY = "QUERY"

        pql_filter = PQLFilter(query=QUERY)

        assert pql_filter.query == QUERY


class TestOrderByColumn:
    def test_order_by_column_values_set(self):
        QUERY = "QUERY"
        ASCENDING = False

        order_by_column = OrderByColumn(query=QUERY, ascending=ASCENDING)

        assert order_by_column.query == QUERY
        assert order_by_column.ascending == ASCENDING


class TestPQL:
    def test_pql_values_set(self):
        COLUMNS = [PQLColumn(name="NAME", query="QUERY")]
        FILTERS = [PQLFilter(query="QUERY")]
        ORDER_BY_COLUMNS = [OrderByColumn(query="QUERY", ascending=False)]
        DISTINCT = True
        LIMIT = 10
        OFFSET = 10

        query = PQL(
            columns=COLUMNS,
            filters=FILTERS,
            order_by_columns=ORDER_BY_COLUMNS,
            distinct=DISTINCT,
            limit=LIMIT,
            offset=OFFSET,
        )

        assert query.columns == COLUMNS
        assert query.filters == FILTERS
        assert query.order_by_columns == ORDER_BY_COLUMNS
        assert query.distinct == DISTINCT
        assert query.limit == LIMIT
        assert query.offset == OFFSET

    def test_negative_offset_raises_error(self):
        with pytest.raises(ValidationError):
            PQL(offset=-10)

    def test_negative_limit_raises_error(self):
        with pytest.raises(ValidationError):
            PQL(limit=-10)

    def test_queries_calls_formatter(self):
        query = PQL()
        query._pql_formatter.format = Mock()

        _ = query.queries

        query._pql_formatter.format.assert_called_once_with(query)

    def test_add_column_adds_column(self):
        COLUMN = PQLColumn(name="NAME", query="QUERY")
        query = PQL()

        query += COLUMN

        assert query.columns == [COLUMN]

    def test_add_filter_adds_filter(self):
        FILTER = PQLFilter(query="QUERY")
        query = PQL()

        query += FILTER

        assert query.filters == [FILTER]

    def test_add_order_by_column_adds_order_by_column(self):
        ORDER_BY_COLUMN = OrderByColumn(query="QUERY", ascending=False)
        query = PQL()

        query += ORDER_BY_COLUMN

        assert query.order_by_columns == [ORDER_BY_COLUMN]

    def test_add_list_adds_elements_of_list(self):
        COLUMN = PQLColumn(name="NAME", query="QUERY")
        FILTER = PQLFilter(query="QUERY")
        ORDER_BY_COLUMN = OrderByColumn(query="QUERY", ascending=False)
        PQL_LIST = [COLUMN, FILTER, ORDER_BY_COLUMN]
        query = PQL()

        query += PQL_LIST

        assert query.columns == [COLUMN]
        assert query.filters == [FILTER]
        assert query.order_by_columns == [ORDER_BY_COLUMN]

    def test_add_invalid_type_raises_type_error(self):
        query = PQL()

        with pytest.raises(TypeError):
            query += 1

    def test_add_string_raises_type_error(self):
        query = PQL()

        with pytest.raises(TypeError):
            query += "INVALID"
